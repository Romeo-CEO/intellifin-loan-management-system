# Story 2.2: Role-Based Access Control

## Status
Draft

## Story
**As a** system administrator  
**I want** to define user roles and permissions  
**So that** users can only access appropriate functionality

## Acceptance Criteria
1. [ ] Role definitions (CEO, Manager, Officer, Analyst)
2. [ ] Permission matrix implementation
3. [ ] Role assignment interface
4. [ ] Permission inheritance
5. [ ] Audit trail for role changes
6. [ ] Step-up authentication for sensitive operations

## Detailed Implementation Steps

### Section 1: RBAC Foundation Setup
- [ ] Step 1: Create RBAC Domain Models and Infrastructure
  - **Task**: Set up role-based access control domain models, permission definitions, and basic infrastructure
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/Role.cs`: Role entity definition
    - `libs/IntelliFin.Shared.DomainModels/Entities/Permission.cs`: Permission entity definition
    - `libs/IntelliFin.Shared.DomainModels/Entities/RolePermission.cs`: Role-permission relationship
    - `libs/IntelliFin.Shared.DomainModels/Entities/UserRole.cs`: User-role relationship
    - `libs/IntelliFin.Shared.DomainModels/Enums/RoleType.cs`: Role type enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/PermissionType.cs`: Permission type enumeration
    - `libs/IntelliFin.Shared.DomainModels/ValueObjects/AccessLevel.cs`: Access level value object
  - **Step Dependencies**: Story 2.1 (User Authentication system complete)
  - **User Instructions**: Create comprehensive RBAC domain models with proper relationships, define role types and permission types, and set up access level value objects

### Section 2: Permission System Implementation
- [ ] Step 2: Implement Permission Management System
  - **Task**: Create permission management system with hierarchical permissions, resource-based access control, and action-based permissions
  - **Files**:
    - `apps/IntelliFin.IdentityService/Services/IPermissionService.cs`: Permission service interface
    - `apps/IntelliFin.IdentityService/Services/PermissionService.cs`: Permission service implementation
    - `apps/IntelliFin.IdentityService/Services/IPermissionMatrixService.cs`: Permission matrix service interface
    - `apps/IntelliFin.IdentityService/Services/PermissionMatrixService.cs`: Permission matrix service implementation
    - `apps/IntelliFin.IdentityService/Services/IResourcePermissionService.cs`: Resource permission service interface
    - `apps/IntelliFin.IdentityService/Services/ResourcePermissionService.cs`: Resource permission service implementation
    - `apps/IntelliFin.IdentityService/Models/PermissionRequest.cs`: Permission request model
    - `apps/IntelliFin.IdentityService/Models/PermissionResponse.cs`: Permission response model
    - `apps/IntelliFin.IdentityService/Models/PermissionMatrix.cs`: Permission matrix model
  - **Step Dependencies**: Step 1 (RBAC domain models)
  - **User Instructions**: Implement comprehensive permission management system with hierarchical permissions, resource-based access control, and action-based permissions for fine-grained access control

### Section 3: Role Management System
- [ ] Step 3: Implement Role Management and Assignment
  - **Task**: Create role management system with role assignment, permission inheritance, and role hierarchy
  - **Files**:
    - `apps/IntelliFin.IdentityService/Services/IRoleService.cs`: Role service interface
    - `apps/IntelliFin.IdentityService/Services/RoleService.cs`: Role service implementation
    - `apps/IntelliFin.IdentityService/Services/IRoleAssignmentService.cs`: Role assignment service interface
    - `apps/IntelliFin.IdentityService/Services/RoleAssignmentService.cs`: Role assignment service implementation
    - `apps/IntelliFin.IdentityService/Services/IRoleHierarchyService.cs`: Role hierarchy service interface
    - `apps/IntelliFin.IdentityService/Services/RoleHierarchyService.cs`: Role hierarchy service implementation
    - `apps/IntelliFin.IdentityService/Models/RoleRequest.cs`: Role request model
    - `apps/IntelliFin.IdentityService/Models/RoleResponse.cs`: Role response model
    - `apps/IntelliFin.IdentityService/Models/RoleAssignment.cs`: Role assignment model
  - **Step Dependencies**: Step 2 (Permission system)
  - **User Instructions**: Implement role management system with role assignment capabilities, permission inheritance, and role hierarchy for complex organizational structures

### Section 4: Authorization Middleware
- [ ] Step 4: Implement Authorization Middleware and Policies
  - **Task**: Create authorization middleware with policy-based authorization, resource-based authorization, and step-up authentication integration
  - **Files**:
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/IAuthorizationService.cs`: Authorization service interface
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/AuthorizationService.cs`: Authorization service implementation
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/AuthorizationMiddleware.cs`: Authorization middleware
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/PolicyAuthorizationHandler.cs`: Policy authorization handler
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/ResourceAuthorizationHandler.cs`: Resource authorization handler
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/StepUpAuthorizationHandler.cs`: Step-up authorization handler
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/AuthorizationPolicies.cs`: Authorization policies
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/AuthorizationExtensions.cs`: Authorization extensions
  - **Step Dependencies**: Step 3 (Role management system)
  - **User Instructions**: Implement comprehensive authorization middleware with policy-based authorization, resource-based authorization, and step-up authentication integration for sensitive operations

### Section 5: Branch-Based Access Control
- [ ] Step 5: Implement Branch-Based Access Control
  - **Task**: Create branch-based access control system with branch context enforcement, cross-branch access controls, and branch-specific permissions
  - **Files**:
    - `apps/IntelliFin.IdentityService/Services/IBranchAccessService.cs`: Branch access service interface
    - `apps/IntelliFin.IdentityService/Services/BranchAccessService.cs`: Branch access service implementation
    - `apps/IntelliFin.IdentityService/Services/IBranchContextService.cs`: Branch context service interface
    - `apps/IntelliFin.IdentityService/Services/BranchContextService.cs`: Branch context service implementation
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/BranchAuthorizationHandler.cs`: Branch authorization handler
    - `libs/IntelliFin.Shared.Infrastructure/Authorization/BranchContextMiddleware.cs`: Branch context middleware
    - `apps/IntelliFin.IdentityService/Models/BranchAccessRequest.cs`: Branch access request model
    - `apps/IntelliFin.IdentityService/Models/BranchAccessResponse.cs`: Branch access response model
    - `apps/IntelliFin.IdentityService/Models/BranchContext.cs`: Branch context model
  - **Step Dependencies**: Step 4 (Authorization middleware)
  - **User Instructions**: Implement branch-based access control with branch context enforcement, cross-branch access controls, and branch-specific permissions for multi-branch operations

### Section 6: CEO Authorization System
- [ ] Step 6: Implement CEO Authorization and Dual Control
  - **Task**: Create CEO authorization system with dual control requirements, CEO-specific permissions, and authorization workflows
  - **Files**:
    - `apps/IntelliFin.IdentityService/Services/ICeoAuthorizationService.cs`: CEO authorization service interface
    - `apps/IntelliFin.IdentityService/Services/CeoAuthorizationService.cs`: CEO authorization service implementation
    - `apps/IntelliFin.IdentityService/Services/IDualControlService.cs`: Dual control service interface
    - `apps/IntelliFin.IdentityService/Services/DualControlService.cs`: Dual control service implementation
    - `apps/IntelliFin.IdentityService/Services/ICeoWorkflowService.cs`: CEO workflow service interface
    - `apps/IntelliFin.IdentityService/Services/CeoWorkflowService.cs`: CEO workflow service implementation
    - `apps/IntelliFin.IdentityService/Models/CeoAuthorizationRequest.cs`: CEO authorization request model
    - `apps/IntelliFin.IdentityService/Models/DualControlRequest.cs`: Dual control request model
    - `apps/IntelliFin.IdentityService/Models/CeoWorkflow.cs`: CEO workflow model
  - **Step Dependencies**: Step 5 (Branch-based access control)
  - **User Instructions**: Implement CEO authorization system with dual control requirements, CEO-specific permissions, and authorization workflows for sensitive operations

### Section 7: BoZ Compliance Integration
- [ ] Step 7: Implement BoZ Compliance Officer Permissions
  - **Task**: Create BoZ compliance officer permissions with regulatory access controls, compliance reporting permissions, and audit trail access
  - **Files**:
    - `apps/IntelliFin.IdentityService/Services/IBozComplianceService.cs`: BoZ compliance service interface
    - `apps/IntelliFin.IdentityService/Services/BozComplianceService.cs`: BoZ compliance service implementation
    - `apps/IntelliFin.IdentityService/Services/IComplianceOfficerService.cs`: Compliance officer service interface
    - `apps/IntelliFin.IdentityService/Services/ComplianceOfficerService.cs`: Compliance officer service implementation
    - `apps/IntelliFin.IdentityService/Services/IRegulatoryAccessService.cs`: Regulatory access service interface
    - `apps/IntelliFin.IdentityService/Services/RegulatoryAccessService.cs`: Regulatory access service implementation
    - `apps/IntelliFin.IdentityService/Models/BozComplianceRequest.cs`: BoZ compliance request model
    - `apps/IntelliFin.IdentityService/Models/ComplianceOfficerPermissions.cs`: Compliance officer permissions model
    - `apps/IntelliFin.IdentityService/Models/RegulatoryAccess.cs`: Regulatory access model
  - **Step Dependencies**: Step 6 (CEO authorization system)
  - **User Instructions**: Implement BoZ compliance officer permissions with regulatory access controls, compliance reporting permissions, and audit trail access for regulatory compliance

### Section 8: RBAC API Controllers
- [ ] Step 8: Create RBAC API Controllers and Endpoints
  - **Task**: Implement RBAC controllers for role management, permission management, and user role assignment with proper validation and error handling
  - **Files**:
    - `apps/IntelliFin.IdentityService/Controllers/RoleController.cs`: Role management controller
    - `apps/IntelliFin.IdentityService/Controllers/PermissionController.cs`: Permission management controller
    - `apps/IntelliFin.IdentityService/Controllers/UserRoleController.cs`: User role assignment controller
    - `apps/IntelliFin.IdentityService/Controllers/BranchAccessController.cs`: Branch access controller
    - `apps/IntelliFin.IdentityService/Controllers/CeoAuthorizationController.cs`: CEO authorization controller
    - `apps/IntelliFin.IdentityService/Controllers/ComplianceController.cs`: Compliance permissions controller
    - `apps/IntelliFin.IdentityService/Validators/RoleValidators.cs`: Role validators
    - `apps/IntelliFin.IdentityService/Validators/PermissionValidators.cs`: Permission validators
  - **Step Dependencies**: Steps 1-7 (Complete RBAC system)
  - **User Instructions**: Create comprehensive RBAC API controllers for role management, permission management, and user role assignment with proper validation and error handling

### Section 9: Audit Trail Integration
- [ ] Step 9: Implement RBAC Audit Trail and Monitoring
  - **Task**: Set up comprehensive audit trail for RBAC operations, implement role change monitoring, and create compliance reporting
  - **Files**:
    - `apps/IntelliFin.IdentityService/Services/IRbacAuditService.cs`: RBAC audit service interface
    - `apps/IntelliFin.IdentityService/Services/RbacAuditService.cs`: RBAC audit service implementation
    - `apps/IntelliFin.IdentityService/Services/IRoleChangeMonitor.cs`: Role change monitor interface
    - `apps/IntelliFin.IdentityService/Services/RoleChangeMonitor.cs`: Role change monitor implementation
    - `apps/IntelliFin.IdentityService/Services/IComplianceReportingService.cs`: Compliance reporting service interface
    - `apps/IntelliFin.IdentityService/Services/ComplianceReportingService.cs`: Compliance reporting service implementation
    - `apps/IntelliFin.IdentityService/Models/RbacAuditEvent.cs`: RBAC audit event model
    - `apps/IntelliFin.IdentityService/Models/RoleChangeEvent.cs`: Role change event model
    - `apps/IntelliFin.IdentityService/Models/ComplianceReport.cs`: Compliance report model
  - **Step Dependencies**: Steps 1-8 (Complete RBAC system)
  - **User Instructions**: Implement comprehensive audit trail for RBAC operations, role change monitoring, and compliance reporting for regulatory requirements

### Section 10: Testing and Validation
- [ ] Step 10: Create Comprehensive Tests and Validation
  - **Task**: Create unit tests, integration tests, and end-to-end tests for the RBAC system, validate all acceptance criteria, and set up security testing
  - **Files**:
    - `apps/IntelliFin.IdentityService.Tests/Unit/RoleServiceTests.cs`: Role service unit tests
    - `apps/IntelliFin.IdentityService.Tests/Unit/PermissionServiceTests.cs`: Permission service unit tests
    - `apps/IntelliFin.IdentityService.Tests/Unit/AuthorizationServiceTests.cs`: Authorization service unit tests
    - `apps/IntelliFin.IdentityService.Tests/Integration/RbacIntegrationTests.cs`: RBAC integration tests
    - `apps/IntelliFin.IdentityService.Tests/E2E/RbacE2ETests.cs`: RBAC end-to-end tests
    - `apps/IntelliFin.IdentityService.Tests/Security/AuthorizationTests.cs`: Authorization security tests
    - `apps/IntelliFin.IdentityService.Tests/TestHelpers/RbacTestHelpers.cs`: RBAC test helpers
    - `apps/IntelliFin.IdentityService.Tests/TestHelpers/MockAuthorizationServices.cs`: Mock authorization services
  - **Step Dependencies**: Steps 1-9 (Complete RBAC implementation)
  - **User Instructions**: Create comprehensive test suite covering all RBAC services and controllers, implement security tests for authorization, and validate all acceptance criteria are met

## Dev Notes

### Previous Story Insights
[Source: Story 2.1 - User Authentication System]
- JWT authentication is implemented with token validation
- User sessions are managed with Redis
- Password hashing and validation are implemented
- Account lockout and security features are in place

### Data Models
[Source: docs/architecture/system-architecture.md#security-architecture]
RBAC system will use:
```sql
Role (id, name, description, type, isActive, createdAt, updatedAt)
Permission (id, name, description, resource, action, isActive, createdAt, updatedAt)
RolePermission (roleId, permissionId, grantedAt, grantedBy)
UserRole (userId, roleId, assignedAt, assignedBy, branchId)
Branch (id, name, code, isActive, createdAt, updatedAt)
```

### API Specifications
[Source: docs/architecture/system-architecture.md#security-architecture]
RBAC APIs:
- GET /api/roles - Get all roles
- POST /api/roles - Create new role
- PUT /api/roles/{id} - Update role
- DELETE /api/roles/{id} - Delete role
- GET /api/permissions - Get all permissions
- POST /api/user-roles - Assign role to user
- GET /api/user-roles/{userId} - Get user roles
- POST /api/authorization/check - Check user authorization

### Component Specifications
[Source: docs/architecture/tech-stack.md]
RBAC components:
- ASP.NET Core Identity 9.0 for role management
- Policy-based authorization
- Resource-based authorization
- Step-up authentication integration
- Branch-based access control
- Audit trail integration

### File Locations
[Source: docs/architecture/system-architecture.md]
RBAC files should be located in:
```
lms/
├── apps/
│   └── identity-service/         # Identity microservice
│       ├── Controllers/          # RBAC controllers
│       ├── Services/             # RBAC services
│       └── Models/               # RBAC models
├── libs/
│   └── shared/
│       └── infrastructure/       # Shared infrastructure
│           └── authorization/    # Authorization components
```

### Testing Requirements
[Source: docs/architecture/tech-stack.md]
RBAC testing standards:
- **Test Framework**: xUnit 3.0+ with ASP.NET Core TestServer
- **Test Location**: `apps/identity-service/tests/`
- **Coverage Requirements**: 95% for RBAC logic
- **Test Types**: Unit tests for services, integration tests for controllers
- **CI Integration**: All RBAC tests must pass in CI pipeline

### Technical Constraints
[Source: docs/architecture/tech-stack.md]
- ASP.NET Core Identity 9.0 with role management
- Policy-based authorization with custom policies
- Resource-based authorization for fine-grained control
- Step-up authentication for sensitive operations
- Branch-based access control for multi-branch operations
- BoZ compliance requirements for audit trails
- CEO dual authorization requirements

## Testing

### Testing Standards
[Source: docs/architecture/tech-stack.md]
- **Test Framework**: xUnit 3.0+ with ASP.NET Core TestServer
- **Test Location**: `apps/identity-service/tests/`
- **Coverage Requirements**: 95% for RBAC logic
- **Test Types**: Unit tests for services, integration tests for controllers
- **CI Integration**: All RBAC tests must pass in CI pipeline

### Test Scenarios
1. **Role Management Testing**
   - Test role creation and assignment
   - Test role hierarchy and inheritance
   - Test role deletion and cleanup
   - Test role permission management
2. **Permission Testing**
   - Test permission matrix implementation
   - Test resource-based permissions
   - Test action-based permissions
   - Test permission inheritance
3. **Authorization Testing**
   - Test policy-based authorization
   - Test resource-based authorization
   - Test step-up authentication
   - Test branch-based access control
4. **CEO Authorization Testing**
   - Test CEO dual authorization
   - Test CEO-specific permissions
   - Test CEO workflow authorization
   - Test sensitive operation controls
5. **Compliance Testing**
   - Test BoZ compliance officer permissions
   - Test regulatory access controls
   - Test audit trail for role changes
   - Test compliance reporting

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
