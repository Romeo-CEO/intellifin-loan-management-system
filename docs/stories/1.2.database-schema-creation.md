# Story 1.2: Database Schema Creation

## Status
Draft

## Story
**As a** system administrator  
**I want** to set up the complete database schema with all required tables  
**So that** the system has a solid foundation for all business operations

## Acceptance Criteria
1. [ ] All domain tables created (Client, Loan, Credit, GL, Collections, Communications, Audit)
2. [ ] Proper foreign key relationships established
3. [ ] Indexes created for performance optimization
4. [ ] Audit trail tables with append-only constraints
5. [ ] Database migration scripts created and tested
6. [ ] Data seeding scripts for reference data (loan products, GL accounts)

## Detailed Implementation Steps

### Section 1: Core Domain Models Setup
- [ ] Step 1: Create Client Management Domain Models
  - **Task**: Implement EF Core models for client management including Client, GovernmentEmployment, KycDocument, Address, and Contact entities with proper validation and relationships
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/Client.cs`: Client entity with NRC validation
    - `libs/IntelliFin.Shared.DomainModels/Entities/GovernmentEmployment.cs`: PMEC integration entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/KycDocument.cs`: Document management entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/Address.cs`: Address entity with validation
    - `libs/IntelliFin.Shared.DomainModels/Entities/Contact.cs`: Contact information entity
    - `libs/IntelliFin.Shared.DomainModels/ValueObjects/NrcNumber.cs`: NRC value object
    - `libs/IntelliFin.Shared.DomainModels/Enums/ClientStatus.cs`: Client status enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/DocumentType.cs`: Document type enumeration
  - **Step Dependencies**: Story 1.1 (Monorepo setup complete)
  - **User Instructions**: Create EF Core entities with proper data annotations, validation attributes, and configure entity relationships using Fluent API

### Section 2: Loan Origination Models
- [ ] Step 2: Create Loan Origination Domain Models
  - **Task**: Implement loan origination entities including LoanApplication, LoanProduct, CollateralAsset, UnderwritingNote, and ApprovalStep with business rule validation
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/LoanApplication.cs`: Loan application entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/LoanProduct.cs`: Loan product entity with rate caps
    - `libs/IntelliFin.Shared.DomainModels/Entities/CollateralAsset.cs`: Collateral management entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/UnderwritingNote.cs`: Underwriting notes entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/ApprovalStep.cs`: Approval workflow entity
    - `libs/IntelliFin.Shared.DomainModels/ValueObjects/Money.cs`: Money value object
    - `libs/IntelliFin.Shared.DomainModels/Enums/LoanProductType.cs`: Product type enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/ApplicationStatus.cs`: Application status enumeration
  - **Step Dependencies**: Step 1 (Client models)
  - **User Instructions**: Create loan origination entities with Money Lenders Act compliance (48% EAR cap), proper validation for loan amounts and terms, and configure relationships to client entities

### Section 3: Credit Assessment Models
- [ ] Step 3: Create Credit Assessment Domain Models
  - **Task**: Implement credit assessment entities for TransUnion integration including CreditReport and CreditAssessment with decision tracking
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/CreditReport.cs`: Credit report entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/CreditAssessment.cs`: Assessment decision entity
    - `libs/IntelliFin.Shared.DomainModels/ValueObjects/CreditScore.cs`: Credit score value object
    - `libs/IntelliFin.Shared.DomainModels/Enums/CreditStatus.cs`: Credit status enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/RiskLevel.cs`: Risk level enumeration
  - **Step Dependencies**: Step 1 (Client models)
  - **User Instructions**: Create credit assessment entities with TransUnion integration fields, proper validation for credit scores, and configure relationships to client and loan application entities

### Section 4: General Ledger Models
- [ ] Step 4: Create General Ledger Domain Models
  - **Task**: Implement general ledger entities including GLAccount, JournalEntry, and PostingRule with double-entry bookkeeping support and BoZ compliance
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/GLAccount.cs`: GL account entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/JournalEntry.cs`: Journal entry entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/PostingRule.cs`: Posting rule entity
    - `libs/IntelliFin.Shared.DomainModels/ValueObjects/AccountBalance.cs`: Account balance value object
    - `libs/IntelliFin.Shared.DomainModels/Enums/AccountType.cs`: Account type enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/EntryType.cs`: Journal entry type enumeration
  - **Step Dependencies**: Step 1 (Base models)
  - **User Instructions**: Create GL entities with BoZ-compliant chart of accounts structure, implement double-entry validation, and configure automated posting rules for transaction mapping

### Section 5: Collections and Payment Models
- [ ] Step 5: Create Collections and Payment Domain Models
  - **Task**: Implement collections entities including DeductionCycle, DeductionItem, and Payment with PMEC integration support and reconciliation capabilities
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/DeductionCycle.cs`: PMEC deduction cycle entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/DeductionItem.cs`: Individual deduction entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/Payment.cs`: Payment entity with reconciliation
    - `libs/IntelliFin.Shared.DomainModels/ValueObjects/PaymentAmount.cs`: Payment amount value object
    - `libs/IntelliFin.Shared.DomainModels/Enums/PaymentMethod.cs`: Payment method enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/DeductionStatus.cs`: Deduction status enumeration
  - **Step Dependencies**: Steps 1-2 (Client and loan models)
  - **User Instructions**: Create collections entities with PMEC integration fields, implement payment reconciliation logic, and configure relationships to loan applications and GL accounts

### Section 6: Communications Models
- [ ] Step 6: Create Communications Domain Models
  - **Task**: Implement communications entities including CommunicationsLog, NotificationTemplates, InAppNotifications, CommunicationRouting, and CustomerCommunicationPreferences
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/CommunicationsLog.cs`: Communication log entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/NotificationTemplates.cs`: Template entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/InAppNotifications.cs`: In-app notification entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/CommunicationRouting.cs`: Routing rules entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/CustomerCommunicationPreferences.cs`: Preferences entity
    - `libs/IntelliFin.Shared.DomainModels/Enums/CommunicationChannel.cs`: Channel enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/NotificationStatus.cs`: Status enumeration
  - **Step Dependencies**: Step 1 (Client models)
  - **User Instructions**: Create communications entities with delivery tracking, template personalization support, and configure routing rules for different communication channels

### Section 7: Audit and Security Models
- [ ] Step 7: Create Audit and Security Domain Models
  - **Task**: Implement audit trail entities including AuditEvent with append-only constraints and security models for user management
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Entities/AuditEvent.cs`: Audit event entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/User.cs`: User entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/Role.cs`: Role entity
    - `libs/IntelliFin.Shared.DomainModels/Entities/Branch.cs`: Branch entity
    - `libs/IntelliFin.Shared.DomainModels/Enums/AuditAction.cs`: Audit action enumeration
    - `libs/IntelliFin.Shared.DomainModels/Enums/UserStatus.cs`: User status enumeration
  - **Step Dependencies**: Step 1 (Base models)
  - **User Instructions**: Create audit entities with append-only constraints, implement user and role management, and configure branch-based access control

### Section 8: DbContext Configuration
- [ ] Step 8: Configure EF Core DbContext and Relationships
  - **Task**: Set up main DbContext with all entity configurations, relationships, and database-specific settings
  - **Files**:
    - `libs/IntelliFin.Shared.DomainModels/Data/LmsDbContext.cs`: Main database context
    - `libs/IntelliFin.Shared.DomainModels/Configurations/ClientConfiguration.cs`: Client entity configuration
    - `libs/IntelliFin.Shared.DomainModels/Configurations/LoanApplicationConfiguration.cs`: Loan application configuration
    - `libs/IntelliFin.Shared.DomainModels/Configurations/GLAccountConfiguration.cs`: GL account configuration
    - `libs/IntelliFin.Shared.DomainModels/Configurations/AuditEventConfiguration.cs`: Audit event configuration
    - `libs/IntelliFin.Shared.DomainModels/Configurations/IndexConfiguration.cs`: Database index configuration
  - **Step Dependencies**: Steps 1-7 (All domain models)
  - **User Instructions**: Configure DbContext with all entities, set up Fluent API configurations for relationships and constraints, and configure database-specific settings for SQL Server

### Section 9: Database Migration and Seeding
- [ ] Step 9: Create Database Migrations and Seed Data
  - **Task**: Generate EF Core migrations, create seed data scripts for reference data, and set up database initialization
  - **Files**:
    - `tools/database/migrations/InitialCreate.cs`: Initial database migration
    - `tools/database/migrations/SeedData.cs`: Seed data migration
    - `tools/database/scripts/seed-loan-products.sql`: Loan products seed script
    - `tools/database/scripts/seed-gl-accounts.sql`: GL accounts seed script
    - `tools/database/scripts/seed-reference-data.sql`: Reference data seed script
    - `tools/database/scripts/setup-audit-permissions.sql`: Audit permissions setup
    - `libs/IntelliFin.Shared.DomainModels/Data/SeedDataService.cs`: Seed data service
  - **Step Dependencies**: Step 8 (DbContext configuration)
  - **User Instructions**: Generate EF Core migrations, create seed data scripts with BoZ-compliant loan products and GL accounts, and set up database initialization with proper permissions

### Section 10: Performance Optimization
- [ ] Step 10: Implement Database Performance Optimization
  - **Task**: Create database indexes, configure query optimization, and set up performance monitoring
  - **Files**:
    - `tools/database/scripts/create-indexes.sql`: Performance indexes script
    - `tools/database/scripts/create-partitions.sql`: Table partitioning script
    - `tools/database/scripts/optimize-queries.sql`: Query optimization script
    - `libs/IntelliFin.Shared.DomainModels/Data/QueryOptimization.cs`: Query optimization utilities
    - `libs/IntelliFin.Shared.DomainModels/Data/PerformanceMonitoring.cs`: Performance monitoring
  - **Step Dependencies**: Step 9 (Migrations and seeding)
  - **User Instructions**: Create comprehensive database indexes for frequently queried fields, implement table partitioning for large tables, and set up performance monitoring and query optimization

## Dev Notes

### Previous Story Insights
[Source: Story 1.1 - Monorepo Infrastructure Setup]
- Nx workspace is set up with .NET 9.0
- All microservices projects are created
- Database connection strings are configured
- EF Core is installed in all relevant projects

### Data Models
[Source: docs/architecture/system-architecture.md#core-data-models]

**Client Management:**
```sql
Client (id, nrc, firstName, lastName, dob, branchId, status, createdAt, updatedAt)
GovernmentEmployment (clientId, pmecNumber, employerId, salary, verifiedAt)
KycDocument (id, clientId, type, objectKey, checksum, retentionAt, createdBy, createdAt)
Address (id, clientId, type, address, city, province, postalCode, isPrimary)
Contact (id, clientId, type, value, isPrimary, verifiedAt)
```

**Loan Origination:**
```sql
LoanApplication (id, clientId, productType, principal, termMonths, rateAPR, status, createdAt, approvedAt)
LoanProduct (id, name, type, calculationMethod, maxAmount, minAmount, maxTerm, minTerm, recurringCostComponentsJson, oneTimeFeesJson)
CollateralAsset (id, applicationId, type, description, value, insuredUntil, status)
UnderwritingNote (id, applicationId, underwriterId, decision, notes, createdAt)
ApprovalStep (id, applicationId, approverId, level, decision, comments, timestamp)
```

**Credit Assessment:**
```sql
CreditReport (id, clientId, score, rawBlobKey, cost, requestedAt, returnedAt, status)
CreditAssessment (id, applicationId, reportId, decision, riskLevel, createdAt)
```

**General Ledger:**
```sql
GLAccount (id, code, name, type, parentId, branchId, isActive)
JournalEntry (id, debitAccountId, creditAccountId, amount, currency, valueDate, ref, description, createdAt)
PostingRule (id, eventType, mappingJson, isActive)
```

**Collections:**
```sql
DeductionCycle (id, period, status, createdAt, completedAt)
DeductionItem (id, cycleId, loanId, expected, actual, variance, status)
Payment (id, loanId, amount, method, externalRef, postedAt, reconciledAt)
```

**Communications:**
```sql
CommunicationsLog (id, eventId, recipientId, recipientType, channel, templateId, content, personalizationData, status, gatewayResponse, createdAt, sentAt, deliveredAt, failureReason, retryCount, maxRetries)
NotificationTemplates (id, name, category, channel, language, subject, content, personalizationTokens, isActive, createdBy, createdAt, updatedBy, updatedAt, version)
InAppNotifications (id, userId, title, message, notificationType, actionUrl, isRead, createdAt, readAt, expiresAt)
CommunicationRouting (id, eventType, recipientType, channel, templateId, priority, isActive, createdAt)
CustomerCommunicationPreferences (id, customerId, preferenceType, enabled, channels, frequency, optOutDate, createdAt, updatedAt)
```

**Audit:**
```sql
AuditEvent (id, actorId, action, entity, entityId, timestamp, ip, detailsJson, branchId)
```

### API Specifications
[Source: docs/architecture/system-architecture.md#api-architecture]
Database will support all internal APIs:
- Client Management APIs: GET /api/clients, POST /api/clients, etc.
- Loan Origination APIs: POST /api/origination/applications, etc.
- Collections APIs: POST /api/collections/pemc/cycles, etc.
- Communications APIs: POST /api/communications/send, etc.
- General Ledger APIs: GET /api/gl/accounts/{id}/balance, etc.

### Component Specifications
[Source: docs/architecture/tech-stack.md]
Database components will use:
- SQL Server 2022 with Always On availability
- EF Core 9.0 for ORM
- Code-first migrations
- Connection pooling and performance optimization

### File Locations
[Source: docs/architecture/system-architecture.md]
Database files should be located in:
```
lms/
├── libs/
│   └── shared/
│       └── domain-models/        # EF Core models and DbContext
├── tools/
│   └── database/                 # Migration scripts and seeding
└── apps/
    └── {service}/                # Service-specific DbContext extensions
```

### Testing Requirements
[Source: docs/architecture/tech-stack.md]
Database testing standards:
- **Test Framework**: xUnit 3.0+ with EF Core InMemory provider
- **Test Location**: `{project}/tests/Database/`
- **Coverage Requirements**: 100% for data models and relationships
- **Test Types**: Unit tests for models, integration tests for DbContext
- **CI Integration**: Database tests must run in CI pipeline

### Technical Constraints
[Source: docs/architecture/tech-stack.md]
- SQL Server 2022 with Always On setup
- EF Core 9.0 with code-first approach
- Audit trail with append-only constraints
- BoZ compliance requirements for data retention
- Money Lenders Act compliance (48% EAR cap enforcement)
- Data sovereignty requirements (Zambian data centers)

## Testing

### Testing Standards
[Source: docs/architecture/tech-stack.md]
- **Test Framework**: xUnit 3.0+ with EF Core InMemory provider
- **Test Location**: `libs/shared/domain-models/tests/`
- **Coverage Requirements**: 100% for data models and relationships
- **Test Types**: Unit tests for models, integration tests for DbContext
- **CI Integration**: All database tests must pass in CI pipeline

### Test Scenarios
1. **Schema Validation**
   - Verify all tables are created correctly
   - Validate foreign key relationships
   - Test constraint enforcement
2. **Data Integrity**
   - Test audit trail append-only constraints
   - Verify BoZ compliance field validation
   - Test Money Lenders Act rate cap enforcement
3. **Performance**
   - Test index effectiveness
   - Validate query performance
   - Test migration script performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
