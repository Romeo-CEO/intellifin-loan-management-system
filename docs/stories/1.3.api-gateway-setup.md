# Story 1.3: API Gateway Setup

## Status
Draft

## Story
**As a** developer  
**I want** to set up the API Gateway with authentication and routing  
**So that** all microservices are properly exposed and secured

## Acceptance Criteria
1. [ ] .NET 9 Minimal API Gateway configured
2. [ ] JWT authentication middleware
3. [ ] Rate limiting and throttling
4. [ ] Request/response logging
5. [ ] Health check endpoints
6. [ ] CORS configuration for frontend

## Detailed Implementation Steps

### Section 1: API Gateway Foundation
- [ ] Step 1: Create API Gateway Project Structure
  - **Task**: Set up the main API Gateway project with .NET 9 Minimal APIs, configure project dependencies, and establish proper project organization
  - **Files**:
    - `apps/IntelliFin.ApiGateway/IntelliFin.ApiGateway.csproj`: Main project file
    - `apps/IntelliFin.ApiGateway/Program.cs`: Application entry point
    - `apps/IntelliFin.ApiGateway/appsettings.json`: Configuration settings
    - `apps/IntelliFin.ApiGateway/appsettings.Development.json`: Development settings
    - `apps/IntelliFin.ApiGateway/Properties/launchSettings.json`: Launch configuration
    - `apps/IntelliFin.ApiGateway/Extensions/ServiceCollectionExtensions.cs`: Service registration
    - `apps/IntelliFin.ApiGateway/Extensions/WebApplicationExtensions.cs`: Application configuration
  - **Step Dependencies**: Story 1.1 (Monorepo setup complete)
  - **User Instructions**: Create new .NET 9 Minimal API project, configure project references to shared libraries, and set up basic project structure with proper namespacing

### Section 2: Authentication and Authorization
- [ ] Step 2: Implement JWT Authentication Middleware
  - **Task**: Configure JWT token validation, implement token refresh mechanism, set up authentication policies, and configure step-up authentication support
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Middleware/JwtAuthenticationMiddleware.cs`: JWT authentication middleware
    - `apps/IntelliFin.ApiGateway/Middleware/TokenRefreshMiddleware.cs`: Token refresh middleware
    - `apps/IntelliFin.ApiGateway/Services/IAuthenticationService.cs`: Authentication service interface
    - `apps/IntelliFin.ApiGateway/Services/AuthenticationService.cs`: Authentication service implementation
    - `apps/IntelliFin.ApiGateway/Configuration/JwtConfiguration.cs`: JWT configuration
    - `apps/IntelliFin.ApiGateway/Configuration/AuthenticationPolicies.cs`: Authentication policies
    - `apps/IntelliFin.ApiGateway/Models/TokenResponse.cs`: Token response model
  - **Step Dependencies**: Step 1 (Project structure)
  - **User Instructions**: Implement JWT authentication middleware with token validation, configure authentication policies for different user roles, and set up step-up authentication for sensitive operations

### Section 3: Rate Limiting and Throttling
- [ ] Step 3: Implement Rate Limiting and Throttling
  - **Task**: Configure rate limiting policies, implement per-user rate limiting, set up throttling for external APIs, and configure rate limit headers
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Middleware/RateLimitingMiddleware.cs`: Rate limiting middleware
    - `apps/IntelliFin.ApiGateway/Middleware/ThrottlingMiddleware.cs`: Throttling middleware
    - `apps/IntelliFin.ApiGateway/Services/IRateLimitService.cs`: Rate limit service interface
    - `apps/IntelliFin.ApiGateway/Services/RateLimitService.cs`: Rate limit service implementation
    - `apps/IntelliFin.ApiGateway/Configuration/RateLimitConfiguration.cs`: Rate limit configuration
    - `apps/IntelliFin.ApiGateway/Models/RateLimitInfo.cs`: Rate limit information model
  - **Step Dependencies**: Step 1 (Project structure)
  - **User Instructions**: Implement rate limiting middleware with Redis backing, configure per-user and per-IP rate limits, and set up throttling for external API calls with proper headers

### Section 4: Request/Response Logging
- [ ] Step 4: Set Up Request/Response Logging
  - **Task**: Configure Serilog for structured logging, implement request/response middleware, set up correlation ID tracking, and configure log levels and filtering
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Middleware/RequestLoggingMiddleware.cs`: Request logging middleware
    - `apps/IntelliFin.ApiGateway/Middleware/ResponseLoggingMiddleware.cs`: Response logging middleware
    - `apps/IntelliFin.ApiGateway/Middleware/CorrelationIdMiddleware.cs`: Correlation ID middleware
    - `apps/IntelliFin.ApiGateway/Services/ILoggingService.cs`: Logging service interface
    - `apps/IntelliFin.ApiGateway/Services/LoggingService.cs`: Logging service implementation
    - `apps/IntelliFin.ApiGateway/Configuration/LoggingConfiguration.cs`: Logging configuration
    - `apps/IntelliFin.ApiGateway/Models/LogEntry.cs`: Log entry model
  - **Step Dependencies**: Step 1 (Project structure)
  - **User Instructions**: Configure Serilog with structured logging, implement request/response logging middleware with correlation IDs, and set up log filtering and levels for different environments

### Section 5: Health Check System
- [ ] Step 5: Implement Health Check Endpoints
  - **Task**: Create health check endpoints for all services, configure dependency health checks, set up readiness and liveness probes, and implement health check aggregation
  - **Files**:
    - `apps/IntelliFin.ApiGateway/HealthChecks/ServiceHealthCheck.cs`: Service health check
    - `apps/IntelliFin.ApiGateway/HealthChecks/DatabaseHealthCheck.cs`: Database health check
    - `apps/IntelliFin.ApiGateway/HealthChecks/RedisHealthCheck.cs`: Redis health check
    - `apps/IntelliFin.ApiGateway/HealthChecks/ExternalServiceHealthCheck.cs`: External service health check
    - `apps/IntelliFin.ApiGateway/Services/IHealthCheckService.cs`: Health check service interface
    - `apps/IntelliFin.ApiGateway/Services/HealthCheckService.cs`: Health check service implementation
    - `apps/IntelliFin.ApiGateway/Models/HealthStatus.cs`: Health status model
  - **Step Dependencies**: Step 1 (Project structure)
  - **User Instructions**: Implement comprehensive health check system with endpoints for all microservices, configure dependency health checks for databases and external services, and set up Kubernetes-ready health probes

### Section 6: CORS Configuration
- [ ] Step 6: Configure CORS for Frontend
  - **Task**: Set up CORS policies for Next.js frontend, configure allowed origins and methods, set up preflight request handling, and configure CORS headers
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Middleware/CorsMiddleware.cs`: CORS middleware
    - `apps/IntelliFin.ApiGateway/Configuration/CorsConfiguration.cs`: CORS configuration
    - `apps/IntelliFin.ApiGateway/Services/ICorsService.cs`: CORS service interface
    - `apps/IntelliFin.ApiGateway/Services/CorsService.cs`: CORS service implementation
    - `apps/IntelliFin.ApiGateway/Models/CorsPolicy.cs`: CORS policy model
  - **Step Dependencies**: Step 1 (Project structure)
  - **User Instructions**: Configure CORS policies for Next.js frontend, set up allowed origins and methods, implement preflight request handling, and configure proper CORS headers for cross-origin requests

### Section 7: API Routing and Proxy
- [ ] Step 7: Implement API Routing and Proxy Configuration
  - **Task**: Set up API routing to microservices, configure proxy settings, implement load balancing, and set up service discovery
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Routing/ApiRouteConfiguration.cs`: API route configuration
    - `apps/IntelliFin.ApiGateway/Routing/ServiceProxyConfiguration.cs`: Service proxy configuration
    - `apps/IntelliFin.ApiGateway/Middleware/ProxyMiddleware.cs`: Proxy middleware
    - `apps/IntelliFin.ApiGateway/Services/IServiceDiscoveryService.cs`: Service discovery interface
    - `apps/IntelliFin.ApiGateway/Services/ServiceDiscoveryService.cs`: Service discovery implementation
    - `apps/IntelliFin.ApiGateway/Configuration/ServiceConfiguration.cs`: Service configuration
    - `apps/IntelliFin.ApiGateway/Models/ServiceEndpoint.cs`: Service endpoint model
  - **Step Dependencies**: Steps 1-6 (All middleware and configuration)
  - **User Instructions**: Configure API routing to all microservices, implement proxy middleware for request forwarding, set up service discovery for dynamic routing, and configure load balancing for high availability

### Section 8: Error Handling and Response Management
- [ ] Step 8: Implement Error Handling and Response Management
  - **Task**: Set up global error handling, implement standardized error responses, configure error logging, and set up response transformation
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Middleware/ErrorHandlingMiddleware.cs`: Error handling middleware
    - `apps/IntelliFin.ApiGateway/Middleware/ResponseTransformationMiddleware.cs`: Response transformation middleware
    - `apps/IntelliFin.ApiGateway/Services/IErrorHandlingService.cs`: Error handling service interface
    - `apps/IntelliFin.ApiGateway/Services/ErrorHandlingService.cs`: Error handling service implementation
    - `apps/IntelliFin.ApiGateway/Models/ErrorResponse.cs`: Error response model
    - `apps/IntelliFin.ApiGateway/Models/ApiResponse.cs`: Standardized API response model
  - **Step Dependencies**: Steps 1-7 (Complete gateway setup)
  - **User Instructions**: Implement global error handling middleware with standardized error responses, configure error logging and monitoring, and set up response transformation for consistent API responses

### Section 9: Security and Monitoring
- [ ] Step 9: Implement Security and Monitoring Features
  - **Task**: Set up security headers, implement request validation, configure monitoring and metrics, and set up alerting
  - **Files**:
    - `apps/IntelliFin.ApiGateway/Middleware/SecurityHeadersMiddleware.cs`: Security headers middleware
    - `apps/IntelliFin.ApiGateway/Middleware/RequestValidationMiddleware.cs`: Request validation middleware
    - `apps/IntelliFin.ApiGateway/Services/ISecurityService.cs`: Security service interface
    - `apps/IntelliFin.ApiGateway/Services/SecurityService.cs`: Security service implementation
    - `apps/IntelliFin.ApiGateway/Services/IMonitoringService.cs`: Monitoring service interface
    - `apps/IntelliFin.ApiGateway/Services/MonitoringService.cs`: Monitoring service implementation
    - `apps/IntelliFin.ApiGateway/Configuration/SecurityConfiguration.cs`: Security configuration
  - **Step Dependencies**: Steps 1-8 (Complete gateway functionality)
  - **User Instructions**: Implement security headers middleware for OWASP compliance, set up request validation and sanitization, configure monitoring and metrics collection, and implement alerting for security events

### Section 10: Testing and Validation
- [ ] Step 10: Create Comprehensive Tests and Validation
  - **Task**: Create unit tests, integration tests, and end-to-end tests for the API Gateway, validate all acceptance criteria, and set up performance testing
  - **Files**:
    - `apps/IntelliFin.ApiGateway.Tests/Unit/MiddlewareTests.cs`: Middleware unit tests
    - `apps/IntelliFin.ApiGateway.Tests/Unit/ServicesTests.cs`: Service unit tests
    - `apps/IntelliFin.ApiGateway.Tests/Integration/GatewayIntegrationTests.cs`: Integration tests
    - `apps/IntelliFin.ApiGateway.Tests/E2E/GatewayE2ETests.cs`: End-to-end tests
    - `apps/IntelliFin.ApiGateway.Tests/Performance/LoadTests.cs`: Performance tests
    - `apps/IntelliFin.ApiGateway.Tests/TestHelpers/TestServerFactory.cs`: Test server factory
    - `apps/IntelliFin.ApiGateway.Tests/TestHelpers/MockServices.cs`: Mock services
  - **Step Dependencies**: Steps 1-9 (Complete gateway implementation)
  - **User Instructions**: Create comprehensive test suite covering all middleware and services, implement integration tests with real services, set up end-to-end tests for complete workflows, and validate all acceptance criteria are met

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 - Database Schema Creation]
- Database schema is created with all required tables
- EF Core models are available for authentication
- Audit trail tables are set up for logging

### Data Models
[Source: docs/architecture/system-architecture.md#core-data-models]
API Gateway will use:
- Client table for user authentication
- AuditEvent table for request/response logging
- JWT tokens for authentication state

### API Specifications
[Source: docs/architecture/system-architecture.md#api-architecture]
API Gateway will route to all internal APIs:
- Client Management APIs: /api/clients/*
- Loan Origination APIs: /api/origination/*
- Collections APIs: /api/collections/*
- Communications APIs: /api/communications/*
- General Ledger APIs: /api/gl/*
- Offline Sync APIs: /api/sync/*

### Component Specifications
[Source: docs/architecture/tech-stack.md]
API Gateway components:
- ASP.NET Core 9.0 with Ocelot as the gateway library
- JWT authentication with refresh tokens
- Serilog for structured logging
- Rate limiting middleware
- Health check middleware

### File Locations
[Source: docs/architecture/system-architecture.md]
API Gateway files should be located in:
```
lms/
├── apps/
│   └── api-gateway/              # API Gateway project
│       ├── Program.cs            # Main application entry point
│       ├── Middleware/           # Custom middleware components
│       ├── Configuration/        # Configuration classes
│       └── HealthChecks/         # Health check implementations
```

### Testing Requirements
[Source: docs/architecture/tech-stack.md]
API Gateway testing standards:
- **Test Framework**: xUnit 3.0+ with ASP.NET Core TestServer
- **Test Location**: `apps/api-gateway/tests/`
- **Coverage Requirements**: 90% for middleware and routing
- **Test Types**: Unit tests for middleware, integration tests for routing
- **CI Integration**: All API Gateway tests must pass in CI pipeline

### Technical Constraints
[Source: docs/architecture/tech-stack.md]
- .NET 9.0 with ASP.NET Core 9.0
- JWT authentication with step-up support
- Rate limiting for security
- CORS configuration for frontend
- Health checks for Kubernetes deployment
- Load balancer integration
- SSL/TLS termination

## Testing

### Testing Standards
[Source: docs/architecture/tech-stack.md]
- **Test Framework**: xUnit 3.0+ with ASP.NET Core TestServer
- **Test Location**: `apps/api-gateway/tests/`
- **Coverage Requirements**: 90% for middleware and routing
- **Test Types**: Unit tests for middleware, integration tests for routing
- **CI Integration**: All API Gateway tests must pass in CI pipeline

### Test Scenarios
1. **Authentication Testing**
   - Test JWT token validation
   - Test token refresh mechanism
   - Test step-up authentication
   - Test authentication failure handling
2. **Rate Limiting Testing**
   - Test rate limit enforcement
   - Test rate limit headers
   - Test throttling behavior
   - Test rate limit reset
3. **Routing Testing**
   - Test API routing to microservices
   - Test CORS configuration
   - Test health check endpoints
   - Test error handling and responses

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
