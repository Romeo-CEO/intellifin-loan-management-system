# Story 1.4: Collections Workflow Orchestration

## Status
Approved

## Story
**As a** Collections Officer,
**I want** the system to automatically orchestrate collections workflows for overdue loans, including automated reminders, human tasks, and dual control for critical actions like write-offs,
**so that** overdue loans are systematically managed, customer communications are automated, and all actions are auditable and compliant.

## Acceptance Criteria
1. The system shall orchestrate a Camunda-managed Collections workflow for overdue loans, including stages for reminders, call tasks, escalation, and write-off (FR11).
2. Each stage of the Collections workflow shall emit audit events to AdminService (NFR4) and trigger notifications via CommunicationService (SMS/email) (FR12).
3. The system shall send automated customer notifications (payment reminders, payment confirmations, overdue alerts, settlement notices) via CommunicationService, using pre-approved templates and respecting client consent preferences (FR13).
4. The system shall enforce dual control for write-offs and loan restructuring via a Camunda workflow, requiring approvals from specified roles (NFR5).
5. Granular, role-based authorization shall be applied to all collections-specific operations within the workflow (e.g., `collections:manage:writeoffs`, `collections:manage:tasks`).
6. The CollectionsService shall seamlessly integrate with Camunda for workflow orchestration and human task management (CR4).
7. The system shall gracefully handle communication failures with AdminService or CommunicationService, logging errors and continuing workflow execution.

## Tasks / Subtasks
- [ ] Task 1: Design and implement the core Camunda BPMN workflow for collections (`collections_management_v1.bpmn`) (AC: 1, 6)
  - [ ] Subtask 1.1: Define workflow stages (overdue detection, reminder, call task, escalation, write-off).
  - [ ] Subtask 1.2: Implement initial state for overdue loans to trigger workflow start.
- [ ] Task 2: Implement Camunda Workers for workflow stages (AC: 1, 6)
  - [ ] Subtask 2.1: Develop `GenerateReminderWorker` to trigger `CommunicationService`.
  - [ ] Subtask 2.2: Develop `CallTaskWorker` for human task creation and assignment.
  - [ ] Subtask 2.3: Develop `EscalationWorker` for escalating loans.
  - [ ] Subtask 2.4: Develop `WriteOffApprovalWorker` to handle dual control approvals.
- [ ] Task 3: Integrate with AdminService for audit logging (AC: 2, NFR4)
  - [ ] Subtask 3.1: Emit audit events at each significant workflow stage.
  - [ ] Subtask 3.2: Ensure audit events include context (loan ID, workflow stage, user, before/after states).
- [ ] Task 4: Integrate with CommunicationService for notifications (AC: 2, 3)
  - [ ] Subtask 4.1: Implement logic to send payment reminders, overdue alerts, etc.
  - [ ] Subtask 4.2: Retrieve client consent preferences from Client Management (via existing integration).
- [ ] Task 5: Implement dual control for write-offs (AC: 4, NFR5)
  - [ ] Subtask 5.1: Integrate `WriteOffRequest` data model with workflow.
  - [ ] Subtask 5.2: Enforce multiple approval steps within the `WriteOffApprovalWorker`.
  - [ ] Subtask 5.3: Implement API endpoint `/api/v1/collections/loans/{loanId}/writeoff` to initiate the workflow.
- [ ] Task 6: Develop unit and integration tests (AC: All)
  - [ ] Subtask 6.1: Unit tests for Camunda Worker logic.
  - [ ] Subtask 6.2: Integration tests for end-to-end workflow execution in Camunda.
  - [ ] Subtask 6.3: Integration tests for AdminService audit events and CommunicationService notifications.
  - [ ] Subtask 6.4: Integration tests for the dual control write-off process, verifying multiple approval gates.

## Dev Notes
### Previous Story Insights
- Stories 1.1 and 1.3 established the core data models and daily processes, providing the foundation for workflow triggers. Adherence to established integration patterns for Vault and AdminService is crucial.

### Data Models
- **WriteOffRequest**: Manages the workflow and audit trail for loan write-offs.
  - `RequestId`: GUID - Primary key.
  - `LoanId`: GUID - Foreign key to the existing Loan entity.
  - `InitiatedBy`: String - User ID of the Collections Officer initiating.
  - `RequestedDate`: DateTime.
  - `ApprovedByCredit`: String - User ID of Head of Credit approval (nullable).
  - `ApprovedByFinance`: String - User ID of Senior Finance Manager approval (nullable).
  - `ApprovalDateCredit`: DateTime (nullable).
  - `ApprovalDateFinance`: DateTime (nullable).
  - `Status`: String (e.g., 'PendingApprovalCredit', 'PendingApprovalFinance', 'Approved', 'Rejected').
  - `Reason`: String - Reason for write-off.
  - `WriteOffAmount`: Decimal.
  - `CamundaProcessInstanceId`: String - Reference to Camunda process instance.
  - [Source: architecture/data-models-and-schema-changes.md#writeoffrequest]
- **ReconciliationTask**: (Potentially reused for manual intervention within workflow if needed for other scenarios outside of initial payment rec.)
  - [Source: architecture/data-models-and-schema-changes.md#reconciliationtask]

### API Specifications
- **Initiate Write-Off**:
  - Method: `POST`
  - Endpoint: `/api/v1/collections/loans/{loanId}/writeoff`
  - Purpose: To initiate the write-off workflow for a loan deemed uncollectible. Triggers Camunda workflow for dual control.
  - Integration: Integrates with `WriteOffRequestService` and `CollectionsWorkflowService`. Requires `collections:manage:writeoffs` permission and dual control.
  - [Source: architecture/api-design-and-integration.md#initiate-write-off]

### Component Specifications
- **CollectionsWorkflowService**: Orchestrates Camunda-managed collections workflows and interacts with Camunda workers.
  - **Integration Points**: Camunda (Zeebe), PaymentProcessingService, ArrearsClassificationService, CommunicationService, AdminService.
  - **Dependencies**: `CamundaWorkers` (e.g., `GenerateReminderWorker`, `CallTaskWorker`, `EscalationWorker`, `WriteOffApprovalWorker`), `ReconciliationTaskService`.
  - [Source: architecture/component-architecture.md#collectionsworkflowservice]
- **Camunda Workers**: Specific C# implementations for each workflow stage.
  - [Source: architecture/component-architecture.md#component-interaction-diagram]
- **AdminServiceClient**: Publishes audit events.
  - [Source: architecture/component-architecture.md#component-interaction-diagram]
- **CommunicationServiceClient**: Sends customer notifications.
  - [Source: architecture/component-architecture.md#component-interaction-diagram]

### File Locations
- **`apps/IntelliFin.Collections/Workflows/BPMN/collections_management_v1.bpmn`**
- **`apps/IntelliFin.Collections/Workflows/CamundaWorkers/GenerateReminderWorker.cs`**
- **`apps/IntelliFin.Collections/Workflows/CamundaWorkers/CallTaskWorker.cs`**
- **`apps/IntelliFin.Collections/Workflows/CamundaWorkers/EscalationWorker.cs`**
- **`apps/IntelliFin.Collections/Workflows/CamundaWorkers/WriteOffApprovalWorker.cs`**
- **`apps/IntelliFin.Collections/Application/Services/CollectionsWorkflowService.cs`**
- **`apps/IntelliFin.Collections/API/Controllers/CollectionsController.cs`** (For `Initiate Write-Off` endpoint)

### Testing Requirements
- **Unit Tests**:
  - `apps/IntelliFin.Collections.Tests/Unit/CamundaWorkersTests.cs`
  - Cover individual worker logic for various scenarios.
- **Integration Tests**:
  - `apps/IntelliFin.Collections.Tests/Integration/CollectionsWorkflowIntegrationTests.cs`
  - Verify end-to-end execution of the Camunda workflow, including worker interactions.
  - Test audit event publishing to AdminService and notification triggering to CommunicationService.
  - Dedicated integration tests for the dual control write-off workflow, ensuring all approval steps and audit trails are correctly enforced (`Security Integration` section).
- **Regression Tests**:
  - Focus on ensuring that existing loan processes are not negatively impacted by the new workflow.

### Technical Constraints
- **Camunda Integration**: Workflows must be designed and implemented to be compatible with Camunda Zeebe (CR4).
- **Dual Control**: Critical actions like write-offs must enforce dual control (NFR5, `Security Integration` section).
- **AdminService Audit**: All workflow stages and critical actions must be audited (NFR4).
- **CommunicationService**: Notifications must utilize the existing CommunicationService (FR12, FR13).
- **Existing API Patterns**: New API endpoints must adhere to existing IntelliFin API patterns, including JWT authentication, `X-Correlation-Id`, `X-Branch-Id` headers (CR1, `Coding Standards` section).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| {{date}} | 1.0 | Initial draft of Story 1.4: Collections Workflow Orchestration | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
