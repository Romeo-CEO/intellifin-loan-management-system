# Story 1.5: Automated Customer Notifications

## Status
Approved

## Story
**As a** Collections Officer,
**I want** the system to send automated customer notifications for key events like payment reminders, overdue alerts, and payment confirmations,
**so that** customers are kept informed about their loan status, communication is consistent, and compliance requirements are met.

## Acceptance Criteria
1. The system shall send automated customer notifications (payment reminders, payment confirmations, overdue alerts, settlement notices) via `CommunicationService` (FR13).
2. Notifications shall use pre-approved templates configured within `CommunicationService` (FR13).
3. The system shall retrieve and respect each clientâ€™s consent preferences stored in Client Management before sending any notification (FR13).
4. All customer notifications triggered by the CollectionsService shall generate audit events routed to `AdminService` with relevant details (NFR4).
5. The `CollectionsService` shall seamlessly integrate with `CommunicationService` for sending notifications and `Client Management` for consent preferences (CR4).
6. The system shall gracefully handle communication failures with `CommunicationService`, logging errors and retrying notifications or escalating for manual review as appropriate.

## Tasks / Subtasks
- [ ] Task 1: Implement notification triggering logic (AC: 1)
  - [ ] Subtask 1.1: Identify trigger points for payment reminders (e.g., X days before due date).
  - [ ] Subtask 1.2: Identify trigger points for overdue alerts (e.g., DPD thresholds).
  - [ ] Subtask 1.3: Identify trigger points for payment confirmations (e.g., `RepaymentPostedEvent`).
- [ ] Task 2: Integrate with `CommunicationService` (AC: 1, 2, 5)
  - [ ] Subtask 2.1: Develop `CommunicationServiceClient` to interact with `CommunicationService`.
  - [ ] Subtask 2.2: Implement logic to select appropriate pre-approved templates based on event type.
  - [ ] Subtask 2.3: Pass necessary data (loan ID, client details, payment amount, etc.) to `CommunicationService`.
- [ ] Task 3: Retrieve and apply client consent preferences (AC: 3, 5)
  - [ ] Subtask 3.1: Integrate with `Client Management` service to retrieve communication consent preferences for each client.
  - [ ] Subtask 3.2: Implement logic to filter or block notifications based on consent preferences.
- [ ] Task 4: Implement audit logging for notifications (AC: 4, NFR4)
  - [ ] Subtask 4.1: Emit audit events to `AdminService` for each notification sent or attempted.
  - [ ] Subtask 4.2: Ensure audit events include client ID, notification type, status (sent/failed), and channel (SMS/email).
- [ ] Task 5: Develop unit and integration tests (AC: All)
  - [ ] Subtask 5.1: Unit tests for notification triggering logic.
  - [ ] Subtask 5.2: Unit tests for consent preference filtering logic.
  - [ ] Subtask 5.3: Integration tests for `CommunicationServiceClient` interaction.
  - [ ] Subtask 5.4: Integration tests to verify `AdminService` audit event publishing for notifications.
  - [ ] Subtask 5.5: Integration tests to confirm client consent preferences are correctly applied.

## Dev Notes
### Previous Story Insights
- Story 1.2 (`Payment Processing`) provides the `RepaymentPostedEvent` for payment confirmations. Story 1.3 (`Arrears Classification`) provides DPD thresholds for overdue alerts. The underlying `Loan` and `Client` data models are established through existing system integrations.

### Data Models
- No new core data models are introduced by this story. It primarily relies on data from existing `Loan` and `Client` entities, as well as `Installment` and `ArrearsClassificationHistory` for triggering events.

### API Specifications
- This story primarily involves outbound calls to `CommunicationService` and `Client Management` (for consent). No new inbound APIs are introduced by CollectionsService directly for this story.
- **`CommunicationService` Integration**: Assumed to have an API (or message broker endpoint) for sending notifications with template IDs and data payloads.
  - [Source: architecture/component-architecture.md#component-interaction-diagram] (Implied by communication service arrow)
- **`Client Management` Integration**: Assumed to have an API for retrieving client communication preferences.
  - [Source: architecture/component-architecture.md#component-interaction-diagram] (Implied by client management arrow)

### Component Specifications
- **CommunicationServiceClient**: A new client component within `CollectionsService` to interact with the external `CommunicationService`.
  - **Integration Points**: External `CommunicationService`.
  - [Source: architecture/component-architecture.md#component-interaction-diagram]
- **AdminServiceClient**: Publishes audit events.
  - [Source: architecture/component-architecture.md#component-interaction-diagram]
- **CollectionsWorkflowService**: May trigger notifications as part of its workflow stages, leveraging the `CommunicationServiceClient`.
  - [Source: architecture/component-architecture.md#collectionsworkflowservice]

### File Locations
- **`apps/IntelliFin.Collections/Application/Services/NotificationService.cs`** (New service to encapsulate notification logic)
- **`apps/IntelliFin.Collections/Infrastructure/Messaging/CommunicationServiceClient.cs`**
- **`apps/IntelliFin.Collections/Workflows/CamundaWorkers/GenerateReminderWorker.cs`** (If triggered by Camunda workflow)

### Testing Requirements
- **Unit Tests**:
  - `apps/IntelliFin.Collections.Tests/Unit/NotificationServiceTests.cs`
  - Cover logic for notification content generation, trigger conditions, and consent filtering.
- **Integration Tests**:
  - `apps/IntelliFin.Collections.Tests/Integration/NotificationIntegrationTests.cs`
  - Verify end-to-end flow from event trigger to `CommunicationService` call and `AdminService` audit.
  - Test scenarios with various client consent preferences.
- **Regression Tests**:
  - Ensure no unintended side effects on existing processes when notifications are triggered.

### Technical Constraints
- **CommunicationService API**: Must use the existing API/messaging interface of `CommunicationService` (CR4).
- **Client Management Consent**: Must respect client communication preferences (FR13).
- **AdminService Audit**: All notifications must be audited (NFR4).
- **Templates**: `CommunicationService` is responsible for managing pre-approved templates (FR13).

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| {{date}} | 1.0 | Initial draft of Story 1.5: Automated Customer Notifications | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
