# Story 1.6: Collections Reporting and Analytics

## Status
Approved

## Story
**As a** Collections Manager,
**I want** the system to generate comprehensive collections reports including daily aging reports, Portfolio-at-Risk (PAR) summaries, provisioning summaries, and recovery rate analytics,
**so that** I can monitor portfolio health, ensure regulatory compliance, and make data-driven decisions for collections strategy.

## Acceptance Criteria
1. The system shall generate daily aging reports showing loan distribution across BoZ arrears categories (Performing, Watch, Substandard, Doubtful, Loss) (FR14).
2. The system shall generate Portfolio-at-Risk (PAR) summaries showing the percentage and value of loans in each risk category (FR14).
3. The system shall generate provisioning summaries showing calculated provisions based on BoZ rates and loan classifications (FR14).
4. The system shall generate recovery rate analytics showing collection effectiveness over time (FR14).
5. All reports shall be accessible via REST API endpoints with appropriate authentication and authorization (CR1).
6. Report data shall be based on the same schedule and repayment data used throughout the CollectionsService, ensuring consistency (FR14).
7. All report generation activities shall generate audit events routed to AdminService (NFR4).

## Tasks / Subtasks
- [ ] Task 1: Implement ReportingService component (AC: 1-4, 7)
  - [ ] Create ReportingService class in Services namespace
  - [ ] Implement daily aging report generation logic
  - [ ] Implement PAR summary calculation logic
  - [ ] Implement provisioning summary calculation logic
  - [ ] Implement recovery rate analytics calculation logic
  - [ ] Add audit event generation for all report activities

- [ ] Task 2: Create REST API endpoints for reports (AC: 5)
  - [ ] Implement GET /api/v1/reports/aging endpoint
  - [ ] Implement GET /api/v1/reports/par-summary endpoint
  - [ ] Implement GET /api/v1/reports/provisioning-summary endpoint
  - [ ] Implement GET /api/v1/reports/recovery-analytics endpoint
  - [ ] Add JWT authentication and role-based authorization
  - [ ] Add standard IntelliFin headers (X-Correlation-Id, X-Branch-Id)

- [ ] Task 3: Implement data aggregation and caching (AC: 6)
  - [ ] Create data aggregation logic for efficient report generation
  - [ ] Implement caching strategy for frequently accessed report data
  - [ ] Ensure data consistency with CollectionsService database

- [ ] Task 4: Add comprehensive testing (AC: 1-7)
  - [ ] Unit tests for ReportingService methods
  - [ ] Integration tests for API endpoints
  - [ ] Test data consistency across different report types
  - [ ] Test audit event generation

## Dev Notes

### Service Context
- **Service**: IntelliFin.Collections
- **Component**: ReportingService (new)
- **Integration Points**: AdminService (audit logging), existing CollectionsService data models

### Data Models Used
- **RepaymentSchedule**: For loan schedule data
- **Installment**: For payment status and amounts
- **ArrearsClassificationHistory**: For BoZ classification data
- **PaymentTransaction**: For payment and recovery data

### API Design
- **Base URL**: `/api/v1/reports`
- **Authentication**: JWT Bearer token
- **Authorization**: Collections Manager role required
- **Headers**: X-Correlation-Id, X-Branch-Id (standard IntelliFin pattern)
- **Response Format**: JSON with standard IntelliFin response structure

### Report Types and Data Sources
1. **Daily Aging Report**: 
   - Source: ArrearsClassificationHistory (latest classification per loan)
   - Groups loans by BoZ category with counts and values
   
2. **PAR Summary**:
   - Source: ArrearsClassificationHistory + RepaymentSchedule
   - Calculates percentage of portfolio in each risk category
   
3. **Provisioning Summary**:
   - Source: ArrearsClassificationHistory + Vault provisioning rates
   - Calculates total provisions by category
   
4. **Recovery Analytics**:
   - Source: PaymentTransaction + Installment data
   - Tracks collection effectiveness over time periods

### Testing Standards
- **Test Location**: `tests/IntelliFin.Collections.Tests/Services/ReportingServiceTests.cs`
- **Test Framework**: xUnit with Testcontainers for integration tests
- **Test Data**: Use TestDataBuilder pattern for consistent test data
- **Coverage**: Unit tests for all calculation methods, integration tests for API endpoints
- **Mocking**: Mock AdminService for audit event verification

### Security Requirements
- **Authentication**: JWT token validation required
- **Authorization**: Collections Manager role required for all endpoints
- **Audit Logging**: All report generation activities logged to AdminService
- **Data Access**: Read-only access to CollectionsService data models

### Performance Considerations
- **Caching**: Implement caching for frequently accessed report data
- **Pagination**: Support pagination for large datasets
- **Async Processing**: Use async/await for database operations
- **Query Optimization**: Use efficient LINQ queries with proper indexing

## Integration Verification Steps
1. Deploy the updated CollectionsService with ReportingService.
2. Authenticate as a Collections Manager and call each report endpoint.
3. Verify that all four report types return accurate data based on existing loan data.
4. Confirm that audit events are logged to AdminService for each report generation.
5. Validate that report data is consistent with data used by other CollectionsService components.

## Dependencies
- AdminService (for audit logging)
- Vault (for provisioning rates configuration)
- CollectionsService data models (RepaymentSchedule, Installment, ArrearsClassificationHistory, PaymentTransaction)

## Estimated Effort
Medium

## Priority
Medium

## Business Value
High

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_
