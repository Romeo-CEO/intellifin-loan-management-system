# Story 1.3: Daily Arrears Classification and Provisioning

## Status
Approved

## Story
**As a** Collections Officer,
**I want** the system to automatically classify loans into BoZ arrears categories and calculate provisioning nightly,
**so that** I have up-to-date, auditable data for regulatory reporting and can prioritize collections efforts.

## Acceptance Criteria
1. The system shall automatically evaluate loan delinquency days (DPD) nightly via a background job or Camunda batch workflow (FR7).
2. The system shall automatically classify each loan into BoZ arrears categories (Performing, Watch, Substandard, Doubtful, Loss) based on DPD thresholds configured in Vault (FR8).
3. The system shall perform automated provisioning calculations for regulatory reporting based on BoZ provisioning rates configured in Vault (FR9).
4. Loan classification changes and provisioning calculations shall be stored as part of the loan's version history (FR10).
5. All arrears classifications, provisioning percentages, and penalty rules shall be configurable and stored in Vault (NFR1).
6. Daily DPD calculations and BoZ classification must happen automatically each night (NFR3).
7. Audit events for every classification action shall be routed to AdminService with timestamps, user roles, and before/after balances (NFR4).
8. The system shall correctly handle loans with zero DPD, classifying them as 'Performing' and applying no provisioning.

## Tasks / Subtasks
- [ ] Task 1: Design and implement the daily arrears classification background job/Camunda workflow (AC: 1, 6)
  - [ ] Subtask 1.1: Develop logic to retrieve all active loans and their repayment schedules.
  - [ ] Subtask 1.2: Implement DPD calculation based on `Installment` due dates.
  - [ ] Subtask 1.3: Integrate with Vault to fetch BoZ classification rules and provisioning rates.
  - [ ] Subtask 1.4: Implement logic to apply BoZ classification based on DPD and Vault rules.
  - [ ] Subtask 1.5: Implement logic for provisioning calculation.
- [ ] Task 2: Implement persistence for `ArrearsClassificationHistory` (AC: 4)
  - [ ] Subtask 2.1: Create `ArrearsClassificationHistoryRepository`.
  - [ ] Subtask 2.2: Store classification and provisioning details, including `VaultConfigVersion`.
- [ ] Task 3: Implement audit logging for classification changes (AC: 7)
  - [ ] Subtask 3.1: Integrate with AdminService to log audit events for each classification change.
  - [ ] Subtask 3.2: Ensure audit events include loan ID, old/new classification, provisioning details, timestamp, and user context (if manual reclassification).
- [ ] Task 4: Develop unit and integration tests (AC: All)
  - [ ] Subtask 4.1: Unit tests for DPD calculation logic.
  - [ ] Subtask 4.2: Unit tests for BoZ classification logic (various DPD scenarios).
  - [ ] Subtask 4.3: Integration tests for the background job/Camunda workflow triggering and execution.
  - [ ] Subtask 4.4: Integration tests to verify `ArrearsClassificationHistory` persistence.
  - [ ] Subtask 4.5: Integration tests for AdminService audit event publishing.

## Dev Notes
### Previous Story Insights
- No specific insights from previous stories directly impact this story, as it focuses on a new, scheduled process. However, adherence to established data model (`Installment`, `Loan`) and integration patterns (Vault, AdminService) is crucial.

### Data Models
- **ArrearsClassificationHistory**: Stores historical records of a loan's BoZ arrears classification and provisioning.
  - `HistoryId`: GUID - Primary key.
  - `LoanId`: GUID - Foreign key to the existing Loan entity.
  - `ClassificationDate`: DateTime - Date of this classification.
  - `DPD`: Int - Days Past Due at the time of classification.
  - `BoZCategory`: String (e.g., 'Performing', 'Watch', 'Substandard', 'Doubtful', 'Loss').
  - `ProvisionRate`: Decimal - Applicable BoZ provisioning rate.
  - `ProvisionAmount`: Decimal - Calculated provision amount.
  - `NonAccrualStatus`: Boolean - True if loan is in non-accrual status.
  - `VaultConfigVersion`: String - Version/hash of Vault config used for classification.
  - [Source: architecture/data-models-and-schema-changes.md#arrearsclassificationhistory]
- **Installment**: Needed to calculate DPD.
  - `LoanId`: GUID - Foreign key to the existing Loan entity.
  - `DueDate`: DateTime - The date the installment is due.
  - `PaidAmount`: Decimal - Actual amount paid for this installment.
  - [Source: architecture/data-models-and-schema-changes.md#installment]

### API Specifications
- No new API endpoints are introduced by this story directly, as classification is a background process. However, the data generated will be accessible via future reporting or loan detail APIs.

### Component Specifications
- **ArrearsClassificationService**: Calculates Days Past Due (DPD) and classifies loans into BoZ arrears categories nightly.
  - **Integration Points**: CollectionsDbContext, Vault (for BoZ rules), Camunda (batch workflow), AdminService (audit), General Ledger Service (provisioning/interest reversal).
  - **Dependencies**: `InstallmentRepository`, `ArrearsClassificationHistoryRepository`, `VaultConfigService`.
  - [Source: architecture/component-architecture.md#arrearsclassificationservice]
- **CollectionsDbContext**: Manages database interactions for `ArrearsClassificationHistory`.
  - [Source: architecture/component-architecture.md#collectionsdbcontext]
- **VaultConfigService**: Retrieves BoZ rules and provisioning rates.
  - [Source: architecture/component-architecture.md#vaultconfigservice-collections-specific]
- **AdminServiceClient**: Publishes audit events.
  - [Source: architecture/component-architecture.md#component-interaction-diagram]

### File Locations
- **`apps/IntelliFin.Collections/Application/Services/ArrearsClassificationService.cs`**
- **`apps/IntelliFin.Collections/Domain/Aggregates/LoanCollectionSummary.cs`** (New aggregate for classification view)
- **`apps/IntelliFin.Collections/Infrastructure/Persistence/Repositories/ArrearsClassificationHistoryRepository.cs`**
- **`apps/IntelliFin.Collections/Workflows/CamundaWorkers/ArrearsClassificationWorker.cs`** (If Camunda workflow is used)
- **`apps/IntelliFin.Collections/Workflows/BPMN/daily_arrears_classification_v1.bpmn`** (If Camunda workflow is used)

### Testing Requirements
- **Unit Tests**:
  - `apps/IntelliFin.Collections.Tests/Unit/ArrearsClassificationServiceTests.cs`
  - Cover DPD calculation, BoZ category assignment, and provisioning logic.
- **Integration Tests**:
  - `apps/IntelliFin.Collections.Tests/Integration/ArrearsClassificationIntegrationTests.cs`
  - Verify interaction with `CollectionsDbContext`, `VaultConfigService`, and `AdminService`.
  - Test the full flow of the background job/Camunda workflow for various loan states.

### Technical Constraints
- **Vault Configuration**: BoZ rules, DPD thresholds, and provisioning rates must be dynamically retrieved from Vault (NFR1).
- **Scheduled Execution**: The classification process must run nightly (NFR3).
- **AdminService Audit**: All classification changes must be audited (NFR4).
- **Existing System Impact**: No direct impact on Loan Origination or other services, primarily consumes existing loan data and updates CollectionsService's own database.

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| {{date}} | 1.0 | Initial draft of Story 1.3: Daily Arrears Classification and Provisioning | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

## QA Results
