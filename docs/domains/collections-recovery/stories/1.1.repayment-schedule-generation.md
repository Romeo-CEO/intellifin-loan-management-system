# Story 1.1: Repayment Schedule Generation and Persistence

## Status
Approved

## Story
**As a** Loan Operations Specialist,
**I want** the system to automatically generate and persist a detailed repayment schedule for each disbursed loan,
**so that** I have a clear, auditable record of all expected payments.

## Acceptance Criteria
1. The system shall generate a repayment schedule based on loan product configuration (principal, interest, term, frequency) obtained from Vault upon loan disbursement.
2. Each generated installment shall include a unique identifier, due date, expected principal amount, expected interest amount, and an initial status of 'Pending'.
3. The system shall store the complete repayment schedule and individual installments in a dedicated and persistent data store within the CollectionsService.
4. The system shall provide an auditable record of when each repayment schedule was generated and linked to its corresponding loan.
5. Existing loan origination data remains unchanged after repayment schedule generation.
6. The system shall gracefully handle cases where product configuration from Vault is unavailable, potentially using a default or flagging for manual review.

## Tasks / Subtasks
- [ ] **Create Repayment Schedule Data Models (AC: 1, 2, 3)**
    - [ ] Define `RepaymentSchedule` entity with `ScheduleId`, `LoanId`, `GeneratedDate`, `Status`, `Currency`.
    - [ ] Define `Installment` entity with `InstallmentId`, `ScheduleId`, `LoanId`, `DueDate`, `ExpectedPrincipal`, `ExpectedInterest`, `ExpectedTotal`, `PaidAmount`, `Status`, `DaysPastDue`, `Version`.
    - [ ] Establish one-to-many relationship between `RepaymentSchedule` and `Installment`.
- [ ] **Implement Persistence Layer (AC: 3, 4, 5)**
    - [ ] Create `CollectionsDbContext` with `DbSet` for `RepaymentSchedule` and `Installment`.
    - [ ] Implement initial EF Core migration for `RepaymentSchedules` and `Installments` tables.
    - [ ] Develop `IRepaymentScheduleRepository` and `IInstallmentRepository` interfaces.
    - [ ] Implement `RepaymentScheduleRepository` and `InstallmentRepository` using `CollectionsDbContext`.
- [ ] **Implement Vault Configuration Service (AC: 1, 6)**
    - [ ] Create `ICollectionsVaultConfigService` interface.
    - [ ] Implement `CollectionsVaultConfigService` to retrieve product configuration (principal, interest, term, frequency) from Vault.
    - [ ] Implement caching and graceful fallback for Vault configuration unavailability.
- [ ] **Create Repayment Schedule Generation Logic (AC: 1, 2, 3)**
    - [ ] Implement `IRepaymentScheduleService` and `RepaymentScheduleService`.
    - [ ] Develop logic within `RepaymentScheduleService` to calculate and generate `Installment` details based on loan parameters and Vault configuration.
    - [ ] Implement logic for recalculating amortization details upon restructuring or partial prepayment (initial stub/placeholder).
- [ ] **Implement Loan Disbursed Event Consumer (AC: 1, 3, 4, 5)**
    - [ ] Create MassTransit consumer (`LoanDisbursedConsumer`) for `LoanDisbursedEvent`.
    - [ ] Integrate `LoanDisbursedConsumer` to use `RepaymentScheduleService` to generate and persist the schedule upon receiving the event.
    - [ ] Ensure event processing is idempotent.
    - [ ] Publish `RepaymentScheduleGeneratedEvent` (internal event for audit/logging).
- [ ] **Add Audit Logging (AC: 4)**
    - [ ] Ensure `RepaymentScheduleService` and `LoanDisbursedConsumer` publish audit events to `AdminService` for schedule generation.
- [ ] **Implement Unit and Integration Tests**
    - [ ] Write unit tests for `RepaymentScheduleService` methods.
    - [ ] Write integration tests for `LoanDisbursedConsumer` to verify schedule generation and persistence with mock Vault.
    - [ ] Use Testcontainers for integration tests involving the database.

## Dev Notes
The `IntelliFin.Collections` service is a new .NET 9.0 ASP.NET Core microservice. This story focuses on the foundational aspect of generating and persisting repayment schedules.

**Relevant Data Models (from `docs/domains/collections-recovery/architecture/data-models-and-schema-changes.md`):**
- `RepaymentSchedule` (Aggregate Root): Represents the overall repayment plan for a loan.
    - `ScheduleId` (GUID), `LoanId` (GUID), `GeneratedDate` (DateTime), `Status` (String: Active, Restructured, Completed), `Currency` (String).
- `Installment` (Entity within `RepaymentSchedule`): Represents a single scheduled payment.
    - `InstallmentId` (GUID), `ScheduleId` (FK to RepaymentSchedule), `LoanId` (GUID), `DueDate` (DateTime), `ExpectedPrincipal` (Decimal), `ExpectedInterest` (Decimal), `ExpectedTotal` (Decimal), `PaidAmount` (Decimal), `Status` (String: Pending, Paid, Partially Paid, Overdue, WrittenOff), `DaysPastDue` (Int), `Version` (Int for optimistic concurrency).

**Persistence:**
- New tables: `RepaymentSchedules` and `Installments`.
- Use Entity Framework Core for database interactions and migrations.
- Implement `CollectionsDbContext` in `apps/IntelliFin.Collections/Infrastructure/Persistence/CollectionsDbContext.cs`.
- Implement repositories (e.g., `RepaymentScheduleRepository`, `InstallmentRepository`) in `apps/IntelliFin.Collections/Infrastructure/Persistence/Repositories/`.

**Configuration:**
- Loan product configuration (principal, interest, term, frequency) will be retrieved from HashiCorp Vault via `CollectionsVaultConfigService`.
- Implement `ICollectionsVaultConfigService` and `CollectionsVaultConfigService` in `apps/IntelliFin.Collections/Infrastructure/Vault/CollectionsVaultConfigService.cs`.
- Ensure graceful handling (caching, fallback) for Vault unavailability (AC: 6).

**Event-Driven Integration:**
- The primary trigger for schedule generation is the `LoanDisbursedEvent` from `Loan Origination`.
- Implement a MassTransit consumer, `LoanDisbursedConsumer`, in `apps/IntelliFin.Collections/Infrastructure/Messaging/LoanDisbursedConsumer.cs`.
- Ensure event processing is idempotent.

**Core Logic:**
- Develop `RepaymentScheduleService` in `apps/IntelliFin.Collections/Application/Services/RepaymentScheduleService.cs` to encapsulate the business logic for schedule generation and management. This service will use `CollectionsVaultConfigService` and the repositories.
- The service should support recalculation of amortization, initially as a placeholder or basic implementation for this story (AC: 3).

**Audit Logging (AC: 4):**
- All schedule generation events should be audited to `AdminService` using the existing `AuditEventDto` schema and fire-and-forget pattern.

**Source Tree Integration (from `docs/domains/collections-recovery/architecture/source-tree.md`):**
- Adhere to the proposed layered architecture: `Domain/Aggregates`, `Domain/Entities`, `Application/Services`, `Infrastructure/Persistence`, `Infrastructure/Messaging`, `Infrastructure/Vault`.

### Testing
**Relevant Testing Standards (from `docs/domains/collections-recovery/architecture/testing-strategy.md`):**
- **Framework:** xUnit 3.0+ for unit and integration tests.
- **Test Organization:** `apps/IntelliFin.Collections.Tests/Unit/` for unit tests, `apps/IntelliFin.Collections.Tests/Integration/` for integration tests.
- **Coverage:** Aim for 90% coverage for core business logic.
- **Integration Tests:** Use Testcontainers for external dependencies (database, potentially mock Vault/RabbitMQ for more complex scenarios). Focus on verifying `LoanDisbursedConsumer`'s interaction with `RepaymentScheduleService` and database persistence.

## Change Log
| Date       | Version | Description              | Author        |
| :--------- | :------ | :----------------------- | :------------ |
| 2025-10-22 | 1.0     | Initial story draft      | Bob (SM)      |
