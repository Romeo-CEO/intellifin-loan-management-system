# Story 1.2: Payment Processing and Reconciliation

## Status
Approved

## Story
**As a** Collections Officer,
**I want** the system to accurately process incoming payments from various sources and reconcile them against loan installments,
**so that** loan balances are correctly updated, overpayments are flagged for review, and all payment activities are auditable.

## Acceptance Criteria
1.  The system shall process incoming payments from various sources (manual, PMEC, Treasury) and match them to the correct loan installments (FR4).
2.  Upon successful payment, the system shall update installment status (Paid/Partially Paid), adjust outstanding balances, and publish a `RepaymentPosted` event (FR5).
3.  Overpayments or misapplied transactions shall trigger a Camunda reconciliation task for manual correction, with reconciled data flowing to Treasury (FR6).
4.  All payment and reconciliation actions shall generate audit events routed to AdminService with timestamps, user roles, and before/after balances (NFR4).
5.  Only Collections Officers with appropriate permissions can modify payment or reconciliation records (NFR6).
6.  New API endpoints for manual payment posting shall adhere to existing IntelliFin API patterns (JWT auth, `X-Correlation-Id`, `X-Branch-Id` headers, standard HTTP status codes) (CR1).
7.  The CollectionsService shall seamlessly integrate with Treasury and PMEC using established messaging and API patterns (CR4).

## Tasks / Subtasks
- [ ] **Define Payment Transaction and Reconciliation Task Data Models (AC: 1, 2, 3)**
    - [ ] Add `PaymentTransaction` entity to `CollectionsDbContext` with `TransactionId`, `LoanId`, `InstallmentId` (nullable), `Amount`, `PaymentDate`, `Source`, `Reference`, `Status`, `IsReconciled`.
    - [ ] Add `ReconciliationTask` entity to `CollectionsDbContext` with `TaskId`, `TransactionId`, `LoanId`, `AssignedTo`, `Status`, `CreatedDate`, `ResolutionDate`, `Notes`, `CamundaProcessInstanceId`.
    - [ ] Establish relationships with `Installment` entity.
- [ ] **Implement Payment Processing Service (AC: 1, 2, 3, 4, 5)**
    - [ ] Create `IPaymentProcessingService` and `PaymentProcessingService` in `apps/IntelliFin.Collections/Application/Services/PaymentProcessingService.cs`.
    - [ ] Develop logic to match incoming payments to installments, update `Installment` status, and adjust `RepaymentSchedule` outstanding balances.
    - [ ] Implement logic to detect overpayments or misapplied transactions and initiate `ReconciliationTask` via Camunda.
    - [ ] Ensure role-based authorization is applied for modification operations within `PaymentProcessingService`.
- [ ] **Implement Incoming Payment Event Consumers (AC: 1, 2, 7)**
    - [ ] Create MassTransit consumer (`TreasuryPaymentReceivedConsumer`) for `PaymentReceivedEvent` from Treasury Service.
    - [ ] Create MassTransit consumer (`PMECTransactionConfirmedConsumer`) for `PMECTransactionConfirmedEvent` from PMEC Service.
    - [ ] Integrate consumers to call `PaymentProcessingService`.
    - [ ] Ensure event processing is idempotent.
- [ ] **Implement Manual Payment API Endpoint (AC: 1, 6)**
    - [ ] Add `POST /api/v1/collections/payments` endpoint to `CollectionsController`.
    - [ ] Implement endpoint to accept payment details and call `PaymentProcessingService`.
    - [ ] Apply `collections:manage:payments` authorization policy to the endpoint.
- [ ] **Publish RepaymentPosted Event (AC: 2)**
    - [ ] Ensure `PaymentProcessingService` publishes a `RepaymentPostedEvent` upon successful payment processing.
- [ ] **Implement Camunda Reconciliation Task Integration (AC: 3, 7)**
    - [ ] Develop a Camunda Worker (e.g., `ReconciliationWorker`) for `ReconciliationTask` handling.
    - [ ] Integrate `PaymentProcessingService` to start a Camunda process instance for `ReconciliationTask`.
- [ ] **Add Audit Logging (AC: 4)**
    - [ ] Ensure `PaymentProcessingService` and related components publish audit events to `AdminService` for all payment and reconciliation actions.
- [ ] **Implement Unit and Integration Tests**
    - [ ] Write unit tests for `PaymentProcessingService` logic.
    - [ ] Write integration tests for payment consumers (`TreasuryPaymentReceivedConsumer`, `PMECTransactionConfirmedConsumer`) with mock external services and database.
    - [ ] Write integration tests for `POST /api/v1/collections/payments` API endpoint, verifying authorization and business logic.
    - [ ] Use Testcontainers for database and message broker interactions in integration tests.

## Dev Notes
This story builds upon Story 1.1 by introducing payment processing and reconciliation capabilities. The `PaymentProcessingService` will be central to handling incoming payments and managing the reconciliation workflow.

**Relevant Data Models (from `docs/domains/collections-recovery/architecture/data-models-and-schema-changes.md`):**
- `PaymentTransaction`: Records details of incoming payments.
    - `TransactionId` (GUID), `LoanId` (GUID), `InstallmentId` (GUID, nullable), `Amount` (Decimal), `PaymentDate` (DateTime), `Source` (String: Manual, PMEC, Treasury), `Reference` (String), `Status` (String: Completed, Failed, Reversed), `IsReconciled` (Boolean).
- `ReconciliationTask`: Manages manual reconciliation tasks for discrepancies.
    - `TaskId` (GUID), `TransactionId` (GUID), `LoanId` (GUID), `AssignedTo` (String), `Status` (String: Open, InProgress, Completed, Escalated), `CreatedDate` (DateTime), `ResolutionDate` (DateTime, nullable), `Notes` (String), `CamundaProcessInstanceId` (String).

**Persistence:**
- New tables: `PaymentTransactions` and `ReconciliationTasks`.
- Update `CollectionsDbContext` with `DbSet` for these new entities.
- Implement initial EF Core migrations.

**Component Integration (from `docs/domains/collections-recovery/architecture/component-architecture.md`):**
- `PaymentProcessingService` will be the core component, integrating with `Treasury` and `PMEC` via event consumers, `CollectionsDbContext` for persistence, `Camunda` for reconciliation workflows, `AdminService` for audit, and potentially `CommunicationService` for confirmations (though confirmations are part of Story 1.4).
- `CollectionsWorkflowService` will orchestrate Camunda workflows, with specific workers for reconciliation tasks.

**API Integration (from `docs/domains/collections-recovery/architecture/api-design-and-integration.md`):**
- **New API Endpoint:** `POST /api/v1/collections/payments` for manual payment posting.
- Adhere to existing IntelliFin API patterns (JWT auth, `X-Correlation-Id`, `X-Branch-Id` headers).
- Authorization: `collections:manage:payments` for `POST /api/v1/collections/payments`.

**Event-Driven Integration (from `docs/domains/collections-recovery/architecture/messaging.md` - implicit reference):**
- Consume `PaymentReceivedEvent` (Treasury) and `PMECTransactionConfirmedEvent` (PMEC).
- Publish `RepaymentPostedEvent` (internal).
- Ensure idempotent message processing.

**Source Tree Integration (from `docs/domains/collections-recovery/architecture/source-tree.md`):**
- `Application/Services/PaymentProcessingService.cs`
- `Infrastructure/Messaging/TreasuryPaymentReceivedConsumer.cs`, `PMECTransactionConfirmedConsumer.cs`
- `API/Controllers/CollectionsController.cs` (for new API endpoint)
- `Workflows/CamundaWorkers/ReconciliationWorker.cs`

**Security (from `docs/domains/collections-recovery/architecture/security-integration.md`):**
- Granular authorization for modifying payment/reconciliation records (`collections:manage:payments`).

### Testing
**Relevant Testing Standards (from `docs/domains/collections-recovery/architecture/testing-strategy.md`):**
- **Framework:** xUnit 3.0+ for unit and integration tests.
- **Test Organization:** `apps/IntelliFin.Collections.Tests/Unit/` for unit tests, `apps/IntelliFin.Collections.Tests/Integration/` for integration tests.
- **Coverage:** Aim for 90% coverage for `PaymentProcessingService`.
- **Integration Tests:** Use Testcontainers for database, RabbitMQ, and mock Camunda. Focus on: 
    - Verifying `TreasuryPaymentReceivedConsumer` and `PMECTransactionConfirmedConsumer` logic.
    - End-to-end flow for `POST /api/v1/collections/payments` including authorization, processing, and event publishing.
    - Testing overpayment/misapplied transaction scenarios and Camunda task initiation.

## Change Log
| Date       | Version | Description              | Author        |
| :--------- | :------ | :----------------------- | :------------ |
| 2025-10-22 | 1.0     | Initial story draft      | Bob (SM)      |
