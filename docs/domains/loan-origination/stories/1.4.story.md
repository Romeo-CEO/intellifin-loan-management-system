# Story 1.4: Client Management Service Integration for KYC Verification

Status: Draft

## Story

**As a** loan officer,  
**I want** the system to automatically check client KYC status when I select a client for loan application,  
**so that** I'm prevented from initiating loans for unverified clients and maintain compliance.

## Acceptance Criteria

1. `ClientManagementClient` HTTP client implemented with `GetClientVerificationAsync(clientId)` calling `/api/clients/{id}/verification`
2. Circuit breaker configured (3 retries, 30-second timeout, fallback to manual verification)
3. LoanApplicationService.CreateApplicationAsync calls ClientManagementClient before creating loan
4. If KYC status != "Approved", throw `KycNotVerifiedException` with client-friendly message
5. If KYC approved date >12 months ago, throw `KycExpiredException` with renewal guidance
6. API endpoint returns 400 Bad Request with error code `KYC_NOT_VERIFIED` or `KYC_EXPIRED`
7. Unit tests verify exception handling for all KYC states (Pending, Expired, Revoked, Not Found)
8. Integration test mocks Client Management API responses, verifies blocking behavior

## Integration Verification

- **IV1**: Create loan for KYC-verified client - succeeds as before (no breaking change)
- **IV2**: Attempt to create loan for non-verified client - receives clear error message with KYC completion link
- **IV3**: Simulate Client Management Service downtime - verify circuit breaker activates, fallback message displayed

## Dev Notes

### Previous Story Insights
- Story 1.1 completed database schema with versioning columns
- Story 1.2 implemented LoanVersioningService with loan number generation
- Story 1.3 integrated Vault for product configurations with KYC expiration policy in eligibility rules
- Client Management module completed with full KYC/AML verification capabilities [Source: prd.md#1.4 Background Context]

### Current State Problem [Sources]

**Missing KYC/AML Gating** - No verification before loan origination
- ComplianceService exists but has "No real-time KYC gating from Client Management service" [Source: brownfield-architecture.md#✅ Compliance Service, lines 274-277]
- Current compliance logic calls DocumentVerificationRepository (local database) instead of Client Management Service
- No integration with completed Client Management module [Source: prd.md#1.2 What is MISSING]

**Regulatory Requirement**: Bank of Zambia requires KYC verification before lending [Source: prd.md#1.4 Background Context]

### Client Management Service API Contract [Sources]

**Endpoint**: `GET /api/clients/{id}/verification`
**Timeout**: 3 seconds with circuit breaker fallback [Source: prd.md#4.2 API Integration Strategy]
**Authentication**: OAuth2 client credentials flow using Keycloak tokens (1-hour expiration) [Source: prd.md#4.2 API Integration Strategy]

**Expected Response Schema**:
```json
{
  "clientId": "guid",
  "kycStatus": "Approved|Pending|Expired|Revoked",
  "amlStatus": "Cleared|Pending|Flagged",
  "kycApprovedAt": "2024-05-15T10:30:00Z",
  "kycExpiryDate": "2025-05-15T10:30:00Z",
  "verificationLevel": "Basic|Enhanced|Full",
  "riskRating": "Low|Medium|High"
}
```

**KYC Status Values**:
- `Approved` - KYC verified, loan creation allowed
- `Pending` - KYC in progress, loan creation blocked
- `Expired` - KYC >12 months old, renewal required
- `Revoked` - KYC revoked due to compliance issue, loan creation blocked
[Source: prd.md#UCR4 - KYC status values inferred from UI requirements]

### Service Implementation Requirements [Sources]

**ClientManagementClient Implementation Pattern**:
```csharp
public class ClientManagementClient : IClientManagementClient
{
    private readonly HttpClient _httpClient;
    private readonly ILogger<ClientManagementClient> _logger;
    
    public async Task<ClientVerificationResponse> GetClientVerificationAsync(
        Guid clientId, 
        CancellationToken cancellationToken)
    {
        try
        {
            var response = await _httpClient.GetAsync(
                $"/api/clients/{clientId}/verification", 
                cancellationToken);
            
            response.EnsureSuccessStatusCode();
            
            var verification = await response.Content
                .ReadFromJsonAsync<ClientVerificationResponse>(cancellationToken);
            
            return verification;
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "Failed to retrieve client verification for {ClientId}", clientId);
            throw new ClientManagementServiceException(
                $"Unable to verify KYC status for client {clientId}", ex);
        }
    }
}
```
[Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 315-364 - pattern adapted for HTTP client]

**Circuit Breaker Configuration**:
- **Retries**: 3 attempts with exponential backoff
- **Timeout**: 30 seconds per attempt (not 3 seconds - that's the fallback threshold)
- **Fallback**: Manual verification fallback message displayed to user
- **Circuit Open**: After 5 consecutive failures, circuit opens for 60 seconds
[Source: prd.md#Story 1.4, AC 2; prd.md#4.2 API Integration Strategy]

### KYC Validation Logic [Sources]

**Validation Rules** - Applied in `LoanApplicationService.CreateApplicationAsync`:

1. **Call Client Management Service** before creating loan [Source: prd.md#Story 1.4, AC 3]
2. **Check KYC Status**:
   - If status != "Approved" → throw `KycNotVerifiedException` [Source: prd.md#Story 1.4, AC 4; prd.md#FR1]
3. **Check KYC Expiration**:
   - If `kycApprovedAt < DateTime.UtcNow.AddMonths(-12)` → throw `KycExpiredException` [Source: prd.md#Story 1.4, AC 5; prd.md#FR10]
4. **Check AML Status** (optional - future enhancement):
   - If amlStatus == "Flagged" → additional review required (not blocking for this story)

**KYC Expiration Policy**: 12 months from approval date [Source: prd.md#FR10; brownfield-architecture.md#❌ 1. KYC/AML Gating, line 336]

### Domain Exceptions [Sources]

**KycNotVerifiedException** - Thrown when KYC status is not "Approved"
```csharp
public class KycNotVerifiedException : Exception
{
    public Guid ClientId { get; }
    public string KycStatus { get; }
    
    public KycNotVerifiedException(Guid clientId, string kycStatus)
        : base($"Client {clientId} KYC status is '{kycStatus}'. KYC approval required before loan application.")
    {
        ClientId = clientId;
        KycStatus = kycStatus;
    }
}
```
[Source: brownfield-architecture.md#4.3 Exception handling - domain exceptions for business rule violations]

**KycExpiredException** - Thrown when KYC >12 months old
```csharp
public class KycExpiredException : Exception
{
    public Guid ClientId { get; }
    public DateTime KycApprovedAt { get; }
    public DateTime ExpiryDate { get; }
    
    public KycExpiredException(Guid clientId, DateTime kycApprovedAt)
        : base($"Client {clientId} KYC verification expired. Approved on {kycApprovedAt:yyyy-MM-dd}, valid for 12 months. Renewal required.")
    {
        ClientId = clientId;
        KycApprovedAt = kycApprovedAt;
        ExpiryDate = kycApprovedAt.AddMonths(12);
    }
}
```
[Source: prd.md#Story 1.4, AC 5; brownfield-architecture.md#4.3 Exception handling]

**ClientManagementServiceException** - Infrastructure exception for service failures
- Thrown when Client Management Service is unreachable or returns errors
- Includes original HttpRequestException as inner exception
[Source: brownfield-architecture.md#4.3 Exception handling - infrastructure exceptions for service failures]

### API Error Response Mapping [Sources]

**Controller Exception Handling** - Map domain exceptions to HTTP responses:

```csharp
[HttpPost]
public async Task<IActionResult> CreateApplication(
    [FromBody] CreateLoanApplicationRequest request,
    CancellationToken cancellationToken)
{
    try
    {
        var application = await _loanApplicationService
            .CreateApplicationAsync(request, cancellationToken);
        return Ok(application);
    }
    catch (KycNotVerifiedException ex)
    {
        return BadRequest(new 
        {
            ErrorCode = "KYC_NOT_VERIFIED",
            Message = ex.Message,
            ClientId = ex.ClientId,
            KycStatus = ex.KycStatus,
            ActionRequired = "Complete KYC verification before applying for loans",
            KycCompletionLink = $"/clients/{ex.ClientId}/kyc"
        });
    }
    catch (KycExpiredException ex)
    {
        return BadRequest(new 
        {
            ErrorCode = "KYC_EXPIRED",
            Message = ex.Message,
            ClientId = ex.ClientId,
            KycApprovedAt = ex.KycApprovedAt,
            ExpiryDate = ex.ExpiryDate,
            ActionRequired = "Renew KYC verification (expired)",
            KycRenewalLink = $"/clients/{ex.ClientId}/kyc/renew"
        });
    }
}
```
[Source: prd.md#Story 1.4, AC 6]

### Integration Points [Sources]

**LoanApplicationService.CreateApplicationAsync Modification**:
1. Inject `IClientManagementClient` dependency
2. **Before** creating loan entity, call `await _clientManagementClient.GetClientVerificationAsync(request.ClientId, cancellationToken)`
3. Validate KYC status and expiration
4. If validation passes, proceed with existing loan creation logic
5. Maintain existing method signature for backward compatibility [Source: prd.md#Story 1.4, AC 3; prd.md#CR1]

**Vault Product Config Integration**:
- Vault product configs include `eligibilityRules.requiredKycStatus = "Approved"` (from Story 1.3)
- This story enforces that requirement via Client Management Service integration
[Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration, lines 409-413]

### File Locations [Sources]

- **New HTTP Client**: `apps/IntelliFin.LoanOriginationService/Services/ClientManagementClient.cs` [NEW]
- **New Interface**: `apps/IntelliFin.LoanOriginationService/Services/IClientManagementClient.cs` [NEW]
- **New Models**: `apps/IntelliFin.LoanOriginationService/Models/ClientVerificationResponse.cs` [NEW]
- **New Exceptions**: `apps/IntelliFin.LoanOriginationService/Exceptions/KycNotVerifiedException.cs` [NEW]
- **New Exceptions**: `apps/IntelliFin.LoanOriginationService/Exceptions/KycExpiredException.cs` [NEW]
- **New Exceptions**: `apps/IntelliFin.LoanOriginationService/Exceptions/ClientManagementServiceException.cs` [NEW]
- **Modify Service**: `apps/IntelliFin.LoanOriginationService/Services/LoanApplicationService.cs` [MODIFY]
- **Modify Controller**: `apps/IntelliFin.LoanOriginationService/Controllers/LoanApplicationController.cs` [MODIFY]
[Source: brownfield-architecture.md#4.3 Code Organization and Standards, prd.md#4.3]

### Technology Stack [Sources]

**HTTP Client**: .NET `HttpClient` with `IHttpClientFactory`
- Use typed client pattern: `services.AddHttpClient<IClientManagementClient, ClientManagementClient>`
- Base address configured in `appsettings.json`: `ClientManagementService:BaseUrl`
[Source: prd.md#4.2 API Integration Strategy]

**Circuit Breaker**: Polly library
- Package: `Microsoft.Extensions.Http.Polly`
- Policies: Retry (3 attempts, exponential backoff), Timeout (30s), Circuit Breaker (5 failures threshold)
[Source: prd.md#Story 1.4, AC 2]

**Authentication**: OAuth2 Client Credentials
- Keycloak token acquisition via `IdentityModel.AspNetCore.OAuth2Introspection`
- Token cached with 1-hour expiration
[Source: prd.md#4.2 API Integration Strategy, Service-to-service auth]

### Coding Standards [Sources]

- **Async/await**: All HTTP operations async with CancellationToken propagation [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Structured logging**: Use Serilog with correlation IDs for HTTP requests, KYC validation results, circuit breaker events [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Exception handling**: Domain exceptions (`KycNotVerifiedException`, `KycExpiredException`) for business rule violations; infrastructure exceptions (`ClientManagementServiceException`) for service failures [Source: brownfield-architecture.md#4.3 Coding Standards]
- **XML comments**: Required for all public interfaces and service classes [Source: brownfield-architecture.md#4.3 Documentation Standards]
- **Correlation IDs**: Propagate across service calls for distributed tracing [Source: prd.md#NFR5]

### Testing Requirements [Sources]

**Unit Tests (xUnit)**
- Test `KycNotVerifiedException` thrown for all non-Approved statuses (Pending, Revoked) [Source: prd.md#Story 1.4, AC 7]
- Test `KycExpiredException` thrown when KYC approved date >12 months ago [Source: prd.md#Story 1.4, AC 7]
- Test KYC approved and recent (<12 months) allows loan creation [Source: prd.md#Story 1.4, IV1]
- Test "Not Found" client throws appropriate exception [Source: prd.md#Story 1.4, AC 7]
- Mock `IClientManagementClient` for unit tests

**Integration Tests (WireMock)**
- Mock Client Management API responses using WireMock or HttpMessageHandler [Source: prd.md#Story 1.4, AC 8]
- Test happy path: verified client → loan creation succeeds [Source: prd.md#Story 1.4, IV1]
- Test blocking path: non-verified client → loan creation blocked with clear error message [Source: prd.md#Story 1.4, IV2, AC 8]
- Test circuit breaker: simulate service downtime → verify fallback behavior [Source: prd.md#Story 1.4, IV3, AC 8]
- Test timeout: simulate slow service response (>30s) → verify timeout handling
- Test framework: xUnit with WireMock or Moq for HTTP mocking [Source: prd.md#4.2 Testing Integration Strategy]

**Backward Compatibility Verification**
- Existing loans created without KYC check remain queryable and valid [Source: prd.md#CR1]
- Existing API endpoints continue working (new validation is additive) [Source: prd.md#CR1]

### Performance Constraints [Sources]

- HTTP call to Client Management Service must complete within 3s at p95 (with circuit breaker fallback if slower) [Source: prd.md#4.2 API Integration Strategy]
- Overall API response time must remain <500ms p95 (excluding external service calls) [Source: prd.md#NFR1]
- Circuit breaker prevents cascade failures from Client Management Service downtime [Source: prd.md#NFR6]

### User Experience Requirements [Sources]

**Error Messages** - Must be client-friendly with actionable guidance:
- "Client KYC verification is pending. Please complete KYC verification before applying for a loan. [Complete KYC]"
- "Client KYC verification expired on 2024-05-15. Please renew KYC verification before applying for a loan. [Renew KYC]"
- "Client KYC status has been revoked. Please contact compliance team before applying for a loan."
[Source: prd.md#Story 1.4, AC 4, 5, 6; prd.md#3.1 Integration Points with Existing UI]

**Inline KYC Check** - Frontend integration (not in scope for this story, documented for future):
- As user types client ID, system checks KYC in background
- If not verified, show inline "Complete KYC First" button
- No page navigation required - open KYC wizard in modal
[Source: prd.md#3.1 Integration Points with Existing UI, point 1]

### Dependencies
- **Story 1.3**: Vault config includes KYC expiration policy in eligibility rules [Source: prd.md#Story 1.4 Dependencies]
- **Client Management Module**: Completed with KYC/AML verification API [Source: prd.md#1.4 Background Context]

## Tasks / Subtasks

- [ ] Create domain models (AC: 1)
  - [ ] Create `Models/ClientVerificationResponse.cs` with properties matching Client Management API schema
  - [ ] Include KycStatus, AmlStatus, KycApprovedAt, KycExpiryDate fields
  - [ ] Add XML documentation comments

- [ ] Create domain exceptions (AC: 4, 5)
  - [ ] Create `Exceptions/KycNotVerifiedException.cs` with ClientId, KycStatus properties [Source: prd.md#Story 1.4, AC 4]
  - [ ] Create `Exceptions/KycExpiredException.cs` with ClientId, KycApprovedAt, ExpiryDate properties [Source: prd.md#Story 1.4, AC 5]
  - [ ] Create `Exceptions/ClientManagementServiceException.cs` as infrastructure exception
  - [ ] Override Message property to format user-friendly error messages

- [ ] Create IClientManagementClient interface (AC: 1)
  - [ ] Define `Task<ClientVerificationResponse> GetClientVerificationAsync(Guid clientId, CancellationToken cancellationToken)` signature
  - [ ] Add XML documentation comments

- [ ] Install required NuGet packages
  - [ ] Add `Microsoft.Extensions.Http.Polly` for circuit breaker/retry policies
  - [ ] Add `IdentityModel.AspNetCore.OAuth2Introspection` for OAuth2 client credentials (if not already present)
  - [ ] Verify packages compatible with .NET 9

- [ ] Implement ClientManagementClient (AC: 1, 2)
  - [ ] Inject `HttpClient` via typed client pattern
  - [ ] Implement `GetClientVerificationAsync` with GET request to `/api/clients/{id}/verification` [Source: prd.md#Story 1.4, AC 1]
  - [ ] Handle 404 Not Found → throw `KycNotVerifiedException` with "Client not found" message
  - [ ] Handle HTTP errors → throw `ClientManagementServiceException` with inner exception
  - [ ] Add structured logging: request start, duration, success/failure, correlation ID [Source: brownfield-architecture.md#4.3 Coding Standards]

- [ ] Configure HttpClient with Polly policies (AC: 2)
  - [ ] Register typed client: `services.AddHttpClient<IClientManagementClient, ClientManagementClient>()` [Source: prd.md#Story 1.4, AC 2]
  - [ ] Configure base address from appsettings: `ClientManagementService:BaseUrl`
  - [ ] Add retry policy: 3 attempts with exponential backoff (2^attempt seconds) [Source: prd.md#Story 1.4, AC 2]
  - [ ] Add timeout policy: 30 seconds per attempt [Source: prd.md#Story 1.4, AC 2]
  - [ ] Add circuit breaker policy: open after 5 consecutive failures, half-open after 60s [Source: prd.md#4.5 Integration Risks]
  - [ ] Add OAuth2 client credentials authentication (Keycloak token) [Source: prd.md#4.2 API Integration Strategy]

- [ ] Modify LoanApplicationService.CreateApplicationAsync (AC: 3, 4, 5)
  - [ ] Inject `IClientManagementClient` dependency
  - [ ] Call `GetClientVerificationAsync` BEFORE creating loan entity [Source: prd.md#Story 1.4, AC 3]
  - [ ] Validate KYC status: if != "Approved" throw `KycNotVerifiedException` [Source: prd.md#Story 1.4, AC 4]
  - [ ] Validate KYC expiration: if `kycApprovedAt < DateTime.UtcNow.AddMonths(-12)` throw `KycExpiredException` [Source: prd.md#Story 1.4, AC 5]
  - [ ] Maintain existing method signature and behavior for verified clients (backward compatibility) [Source: prd.md#CR1]

- [ ] Update LoanApplicationController exception handling (AC: 6)
  - [ ] Add try-catch for `KycNotVerifiedException` → return 400 BadRequest with error code `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.4, AC 6]
  - [ ] Add try-catch for `KycExpiredException` → return 400 BadRequest with error code `KYC_EXPIRED` [Source: prd.md#Story 1.4, AC 6]
  - [ ] Include actionable guidance in error response (KYC completion/renewal links)
  - [ ] Include ClientId, KycStatus, KycApprovedAt in error response for frontend use

- [ ] Write unit tests for KYC validation logic (AC: 7)
  - [ ] Test KYC status "Pending" throws `KycNotVerifiedException` [Source: prd.md#Story 1.4, AC 7]
  - [ ] Test KYC status "Revoked" throws `KycNotVerifiedException` [Source: prd.md#Story 1.4, AC 7]
  - [ ] Test KYC status "Expired" throws `KycNotVerifiedException` [Source: prd.md#Story 1.4, AC 7]
  - [ ] Test KYC approved >12 months ago throws `KycExpiredException` [Source: prd.md#Story 1.4, AC 7]
  - [ ] Test KYC approved <12 months ago allows loan creation [Source: prd.md#Story 1.4, IV1]
  - [ ] Test "Not Found" client throws `KycNotVerifiedException` [Source: prd.md#Story 1.4, AC 7]
  - [ ] Mock `IClientManagementClient` to return test verification responses

- [ ] Write integration tests with HTTP mocking (AC: 8)
  - [ ] Set up WireMock or HttpMessageHandler mock for Client Management API [Source: prd.md#Story 1.4, AC 8]
  - [ ] Test happy path: KYC verified client → loan creation succeeds [Source: prd.md#Story 1.4, IV1]
  - [ ] Test blocking path: non-verified client → loan creation blocked with clear error message [Source: prd.md#Story 1.4, IV2, AC 8]
  - [ ] Test circuit breaker: simulate 5 consecutive failures → verify circuit opens, fallback message displayed [Source: prd.md#Story 1.4, IV3, AC 8]
  - [ ] Test timeout: simulate slow response (>30s) → verify timeout exception and retry
  - [ ] Test retry policy: simulate transient failure (500 error) → verify 3 retry attempts

- [ ] Integration verification: KYC verified client succeeds (IV1)
  - [ ] Create loan application via existing `/api/loanapplication` endpoint with KYC-verified client
  - [ ] Verify loan creation succeeds as before (no breaking change) [Source: prd.md#Story 1.4, IV1]
  - [ ] Verify API response includes LoanNumber from Story 1.2 (backward compatibility check)

- [ ] Integration verification: Non-verified client blocked (IV2)
  - [ ] Attempt to create loan for client with KYC status "Pending"
  - [ ] Verify 400 Bad Request response with error code `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.4, IV2]
  - [ ] Verify error message includes actionable guidance and KYC completion link
  - [ ] Verify loan NOT created in database

- [ ] Integration verification: Circuit breaker fallback (IV3)
  - [ ] Stop or disable Client Management Service to simulate downtime
  - [ ] Attempt to create loan
  - [ ] Verify circuit breaker activates after threshold failures [Source: prd.md#Story 1.4, IV3]
  - [ ] Verify fallback message displayed to user (manual verification option)
  - [ ] Verify structured logging captures circuit breaker state changes

- [ ] Configure appsettings for Client Management Service
  - [ ] Add `ClientManagementService:BaseUrl` configuration
  - [ ] Add OAuth2 client credentials settings (ClientId, ClientSecret, TokenEndpoint)
  - [ ] Add circuit breaker thresholds (optional, with sensible defaults in code)
  - [ ] Document configuration in README

## Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-10-17 | 0.1     | Initial draft created            | SM     |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(To be filled by QA agent)*
