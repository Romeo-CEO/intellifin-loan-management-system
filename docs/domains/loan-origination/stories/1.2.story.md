# Story 1.2: Loan Number Generation and Versioning Service

Status: Draft

## Story

**As a** loan officer,  
**I want** the system to automatically assign unique, auditable loan numbers to new applications,  
**so that** I can reference loans by human-readable identifiers and the system maintains version history for compliance.

## Acceptance Criteria

1. `LoanVersioningService` implemented with `GenerateLoanNumberAsync(branchCode)` method producing format `{BranchCode}-{Year}-{Sequence}`
2. Sequence generation is thread-safe using database-level locking (SQL UPDATE with OUTPUT clause)
3. `CreateNewVersionAsync(loanId, reason, changes)` creates new version record, marks previous version IsCurrentVersion=false, stores JSON snapshot of previous state
4. LoanApplicationService.CreateApplicationAsync calls GenerateLoanNumberAsync to assign LoanNumber on new loans
5. API response includes LoanNumber field (backward compatible - new optional field)
6. Unit tests verify concurrent loan creation assigns unique sequential numbers
7. Integration test creates loan, modifies it twice, verifies version history chain (3 versions total)

## Integration Verification

- **IV1**: Create loan via existing `/api/loanapplication` endpoint - verify LoanNumber present in response, existing fields unchanged
- **IV2**: Retrieve loan by Id using existing endpoint - verify all existing fields intact, new LoanNumber field added
- **IV3**: Load test with 50 concurrent loan creations - verify all receive unique sequential loan numbers

## Dev Notes

### Previous Story Insights
- Story 1.1 completed database schema changes adding versioning columns (LoanNumber, Version, ParentVersionId, IsCurrentVersion, ModificationReason, SnapshotJson, AgreementFileHash, AgreementMinioPath) to LoanApplications table
- LoanNumberSequence table created with composite PK (BranchCode, Year) and NextSequence column for thread-safe incrementing
- Repository interface extended with `GetCurrentVersionAsync(loanNumber)` and `GetVersionHistoryAsync(loanNumber)` methods

### Service Implementation Requirements [Sources]

**LoanVersioningService** - Core service for loan number generation and version management
- `GenerateLoanNumberAsync(branchCode)`: Generate unique loan number in format `{BranchCode}-{Year}-{Sequence}` (e.g., "LUS-2025-00123") [Source: prd.md#Story 1.2, AC 1]
- Thread-safe sequence generation using database-level locking with SQL UPDATE...OUTPUT clause to atomically increment and return NextSequence [Source: prd.md#Story 1.2, AC 2]
- `CreateNewVersionAsync(loanId, reason, changes)`: Create new version of loan, mark previous IsCurrentVersion=false, store JSON snapshot of previous state in SnapshotJson column [Source: prd.md#Story 1.2, AC 3; brownfield-architecture.md#❌ 4. Loan Versioning]

**LoanApplicationService Integration**
- Modify `CreateApplicationAsync` to call `LoanVersioningService.GenerateLoanNumberAsync` before saving new loan [Source: prd.md#Story 1.2, AC 4]
- Set Version=1, IsCurrentVersion=true, ParentVersionId=null for new applications [Source: brownfield-architecture.md#❌ 4. Loan Versioning]

### API Response Compatibility [Sources]
- Extend existing API response DTOs with optional `LoanNumber` field (backward compatible - existing clients ignore new field) [Source: prd.md#Story 1.2, AC 5; prd.md#CR1: Existing API Compatibility]
- All existing fields remain unchanged; new LoanNumber field added as optional property [Source: prd.md#CR1]

### Technical Implementation Details [Sources]

**Thread-Safe Sequence Generation Strategy**
```sql
-- Use SQL UPDATE with OUTPUT clause for atomic increment
UPDATE LoanNumberSequence 
SET NextSequence = NextSequence + 1 
OUTPUT INSERTED.NextSequence 
WHERE BranchCode = @BranchCode AND Year = @Year;
```
[Source: brownfield-architecture.md#❌ 4. Loan Versioning]

**Version Creation Process**
1. Fetch current version using `GetCurrentVersionAsync(loanId)`
2. Mark current version IsCurrentVersion = false
3. Create new LoanApplication entity with:
   - New GUID Id
   - Same LoanNumber as previous version
   - Version = previousVersion + 1
   - ParentVersionId = previous version's Id
   - IsCurrentVersion = true
   - SnapshotJson = JSON serialization of previous state
   - ModifiedReason, ModifiedAtUtc populated
4. Save both records in single transaction
[Source: brownfield-architecture.md#❌ 4. Loan Versioning, lines 653-684]

### File Locations [Sources]

- **New Service**: `apps/IntelliFin.LoanOriginationService/Services/LoanVersioningService.cs` [NEW]
- **New Interface**: `apps/IntelliFin.LoanOriginationService/Services/ILoanVersioningService.cs` [NEW]
- **Modify Service**: `apps/IntelliFin.LoanOriginationService/Services/LoanApplicationService.cs` [MODIFY]
- **Repository Usage**: Existing `ILoanApplicationRepository` with new methods from Story 1.1
[Source: brownfield-architecture.md#4.3 Code Organization and Standards, prd.md#4.3]

### Coding Standards [Sources]

- **Async/await**: All I/O operations async (database, HTTP, Vault, MinIO) with CancellationToken propagation [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Structured logging**: Use Serilog with correlation IDs in all log entries [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Exception handling**: Domain exceptions for business rule violations; infrastructure exceptions for service failures [Source: brownfield-architecture.md#4.3 Coding Standards]
- **XML comments**: Required for all public interfaces and service classes [Source: brownfield-architecture.md#4.3 Documentation Standards]
- **Transaction boundaries**: Version creation + audit event publishing within single database transaction for consistency [Source: prd.md#4.2 Integration Approach]

### Testing Requirements [Sources]

**Unit Tests (xUnit)**
- Verify `GenerateLoanNumberAsync` produces correct format: `{BranchCode}-{Year}-{Sequence}` [Source: prd.md#Story 1.2, AC 6]
- Test concurrent loan creation (50 threads) assigns unique sequential numbers without duplicates or gaps [Source: prd.md#Story 1.2, AC 6]
- Verify `CreateNewVersionAsync` correctly chains versions (ParentVersionId linkage) [Source: prd.md#Story 1.2, AC 7]
- Test version history retrieval returns versions in correct order [Source: prd.md#Story 1.2, AC 7]

**Integration Tests (Testcontainers)**
- Full workflow: Create loan → Modify → Modify → Verify 3 versions with correct chain [Source: prd.md#Story 1.2, AC 7]
- Load test: 50 concurrent loan creations verify unique sequential loan numbers [Source: prd.md#Story 1.2, Integration Verification IV3]
- Test framework: xUnit with Testcontainers for SQL Server [Source: prd.md#4.2 Testing Integration Strategy]

**Backward Compatibility Verification**
- Existing `/api/loanapplication` endpoints continue working with new LoanNumber field as optional [Source: prd.md#Story 1.2, IV1-IV2]
- Performance impact <10% for existing queries [Source: prd.md#CR2: Database Schema Compatibility]

### Performance Constraints [Sources]
- Maintain <10% performance impact for existing `GetByIdAsync` queries [Source: prd.md#CR2]
- Loan number generation must complete within existing API response SLA (500ms p95) [Source: prd.md#NFR1]
- Version history queries complete within 200ms for up to 50 versions [Source: prd.md#NFR7]

### Dependencies
- **Story 1.1**: Database schema changes (LoanApplications versioning columns, LoanNumberSequence table) must be deployed [Source: prd.md#Story 1.2 Dependencies]
- **Shared.DomainModels**: Changes to LoanApplication entity must maintain binary compatibility with other services (AdminService, ReportingService) [Source: prd.md#4.1 Critical Constraints]

## Tasks / Subtasks

- [ ] Create ILoanVersioningService interface (AC: 1, 3)
  - [ ] Define `Task<string> GenerateLoanNumberAsync(string branchCode, CancellationToken cancellationToken)` signature
  - [ ] Define `Task<LoanApplication> CreateNewVersionAsync(Guid loanId, string reason, Dictionary<string, object> changes, CancellationToken cancellationToken)` signature
  - [ ] Add XML documentation comments [Source: brownfield-architecture.md#4.3 Documentation Standards]

- [ ] Implement LoanVersioningService.GenerateLoanNumberAsync (AC: 1, 2)
  - [ ] Inject ILoanApplicationRepository for database access
  - [ ] Execute SQL UPDATE with OUTPUT clause on LoanNumberSequence table for atomic increment [Source: brownfield-architecture.md#❌ 4. Loan Versioning]
  - [ ] Handle case where BranchCode-Year row doesn't exist (INSERT with NextSequence=1)
  - [ ] Format loan number as `{BranchCode}-{Year}-{Sequence:D5}` (e.g., "LUS-2025-00123") [Source: prd.md#Story 1.2, AC 1]
  - [ ] Add structured logging with correlation ID [Source: brownfield-architecture.md#4.3 Coding Standards]

- [ ] Implement LoanVersioningService.CreateNewVersionAsync (AC: 3)
  - [ ] Fetch current version using `GetCurrentVersionAsync(loanId)` from Story 1.1
  - [ ] Mark current version IsCurrentVersion=false
  - [ ] Create new LoanApplication entity with incremented Version, ParentVersionId linkage [Source: brownfield-architecture.md#❌ 4. Loan Versioning, lines 669-684]
  - [ ] Serialize previous state to SnapshotJson using System.Text.Json
  - [ ] Save both records in single transaction (EF Core SaveChangesAsync)
  - [ ] Add structured logging for version creation event [Source: brownfield-architecture.md#4.3 Coding Standards]

- [ ] Modify LoanApplicationService.CreateApplicationAsync (AC: 4)
  - [ ] Inject ILoanVersioningService
  - [ ] Call `GenerateLoanNumberAsync` before creating loan entity
  - [ ] Set Version=1, IsCurrentVersion=true, ParentVersionId=null for new applications
  - [ ] Maintain existing behavior for all other fields (no breaking changes) [Source: prd.md#CR1]

- [ ] Update API response DTOs (AC: 5)
  - [ ] Add optional `LoanNumber` property to `LoanApplicationResponse` DTO
  - [ ] Ensure existing clients can ignore new field (backward compatible serialization)
  - [ ] Verify existing fields remain unchanged [Source: prd.md#CR1]

- [ ] Register services in DI container (Program.cs)
  - [ ] Add `builder.Services.AddScoped<ILoanVersioningService, LoanVersioningService>();`
  - [ ] Verify dependency injection configuration

- [ ] Write unit tests for GenerateLoanNumberAsync (AC: 6)
  - [ ] Test correct format: `{BranchCode}-{Year}-{Sequence}`
  - [ ] Test sequence increments correctly (1 → 2 → 3)
  - [ ] Test new year creates new sequence starting at 1
  - [ ] Test concurrent access (50 threads) produces unique sequential numbers [Source: prd.md#Story 1.2, AC 6]
  - [ ] Mock repository for unit tests

- [ ] Write unit tests for CreateNewVersionAsync (AC: 7)
  - [ ] Test version chaining (ParentVersionId linkage)
  - [ ] Test IsCurrentVersion toggle (old=false, new=true)
  - [ ] Test SnapshotJson contains previous state
  - [ ] Test ModifiedReason and ModifiedAtUtc populated

- [ ] Write integration tests (AC: 7, IV1-IV3)
  - [ ] Test full version chain: Create → Modify → Modify → Verify 3 versions [Source: prd.md#Story 1.2, AC 7]
  - [ ] Test API endpoint returns LoanNumber field [Source: prd.md#Story 1.2, IV1]
  - [ ] Test existing endpoints still work (backward compatibility) [Source: prd.md#Story 1.2, IV2]
  - [ ] Load test: 50 concurrent loan creations verify unique loan numbers [Source: prd.md#Story 1.2, IV3]
  - [ ] Use Testcontainers for SQL Server [Source: prd.md#4.2 Testing Integration Strategy]

- [ ] Verify performance impact <10% for existing queries (AC: 5)
  - [ ] Benchmark GetByIdAsync before and after changes
  - [ ] Verify query execution plans remain efficient [Source: prd.md#CR2]

## Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-10-17 | 0.1     | Initial draft created            | SM     |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(To be filled by QA agent)*
