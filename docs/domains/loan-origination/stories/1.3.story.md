# Story 1.3: Vault Product Configuration Service Integration

Status: Draft

## Story

**As a** system administrator,  
**I want** loan product configurations (interest rates, EAR caps, eligibility rules) stored in Vault and loaded dynamically,  
**so that** we can update product rules without code deployment and enforce EAR compliance automatically.

## Acceptance Criteria

1. `VaultProductConfigService` implemented with `GetProductConfigAsync(productCode)` fetching from `kv/intellifin/loan-products/{productCode}/rules`
2. In-memory caching with 5-minute TTL using IMemoryCache
3. EAR compliance validation on config load - throw `ComplianceException` if calculatedEAR > earLimit (48%)
4. LoanProductService refactored to use VaultProductConfigService instead of hardcoded product definitions
5. Vault schema documented with example configurations for GEPL-001 and SMEABL-001 products
6. Configuration change workflow documented (dual control approval process for Vault updates)
7. Unit tests verify EAR validation rejects non-compliant configs, accepts compliant configs
8. Integration test loads config from actual Vault instance (Testcontainers), verifies caching behavior

## Integration Verification

- **IV1**: Create loan application via existing endpoint - verify product validation uses Vault config (update Vault config, wait 5 minutes, verify new limits enforced)
- **IV2**: Attempt to load product with EAR >48% from Vault - verify ComplianceException thrown, loan creation blocked
- **IV3**: Existing loans created before Vault migration remain queryable and valid (backward compatibility)

## Dev Notes

### Previous Story Insights
- Story 1.1 completed database schema with versioning columns
- Story 1.2 implemented LoanVersioningService with loan number generation
- Vault is part of Control Plane infrastructure (already operational, needs product config extension)

### Current State Problem [Sources]

**Hardcoded Product Definitions** - Product rules currently in `LoanProductService.cs`
```csharp
// Hardcoded product definitions
private readonly List<LoanProduct> _products = new()
{
    new() {
        Code = "GEPL-001",
        MaxAmount = 50000m,
        BaseInterestRate = 0.15m,  // ❌ HARDCODED
        // ...
    }
};
```
**Problem**: Configuration changes require code deployment and service restart [Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration]

### Vault Schema Design [Sources]

**Vault Path Structure**: `kv/intellifin/loan-products/{productCode}/rules`

**Complete Product Configuration Schema**:
```json
{
  "productName": "Government Employee Payroll Loan",
  "minAmount": 1000,
  "maxAmount": 50000,
  "minTermMonths": 1,
  "maxTermMonths": 60,
  "baseInterestRate": 0.12,
  "adminFee": 0.02,
  "managementFee": 0.01,
  "calculatedEAR": 0.152,
  "earCapCompliance": true,
  "earLimit": 0.48,
  "eligibilityRules": {
    "requiredKycStatus": "Approved",
    "minMonthlyIncome": 5000,
    "maxDtiRatio": 0.40,
    "pmecRegistrationRequired": true
  }
}
```
[Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration, lines 392-421]

**Required Vault Paths**:
- `kv/intellifin/loan-products/GEPL-001/rules` - Government Employee Payroll Loan config
- `kv/intellifin/loan-products/SMEABL-001/rules` - SME Asset-Backed Loan config
[Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration]

### Service Implementation Requirements [Sources]

**VaultProductConfigService Implementation Pattern**:
```csharp
public class VaultProductConfigService : IProductConfigService
{
    private readonly IVaultClient _vaultClient;
    private readonly IMemoryCache _cache;
    
    public async Task<LoanProductConfig> GetProductConfigAsync(string productCode)
    {
        var cacheKey = $"product-config:{productCode}";
        if (_cache.TryGetValue(cacheKey, out LoanProductConfig config))
            return config;
        
        // Read from Vault KV v2
        var secret = await _vaultClient.V1.Secrets.KeyValue.V2
            .ReadSecretAsync($"loan-products/{productCode}/rules");
        
        config = JsonSerializer.Deserialize<LoanProductConfig>(
            secret.Data.Data["rules"].ToString());
        
        // Validate EAR compliance before returning
        if (config.CalculatedEAR > config.EarLimit)
        {
            throw new ComplianceException(
                $"Product {productCode} EAR {config.CalculatedEAR:P} exceeds limit {config.EarLimit:P}");
        }
        
        // Cache for 5 minutes
        _cache.Set(cacheKey, config, TimeSpan.FromMinutes(5));
        return config;
    }
}
```
[Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration, lines 423-454]

**Key Implementation Requirements**:
- Use Vault KV v2 engine (not v1) for versioning support
- Implement 5-minute in-memory cache using `IMemoryCache` [Source: prd.md#Story 1.3, AC 2; prd.md#NFR2]
- EAR compliance validation MUST happen before caching (fail-fast) [Source: prd.md#Story 1.3, AC 3; prd.md#FR4]
- Throw `ComplianceException` domain exception for EAR violations [Source: brownfield-architecture.md#4.3 Coding Standards]

### EAR Compliance Enforcement [Sources]

**Regulatory Requirement**: Bank of Zambia Money Lenders Act mandates 48% EAR cap [Source: prd.md#FR4]

**Validation Logic**:
- `calculatedEAR` field in Vault config represents Effective Annual Rate including ALL recurring fees
- If `calculatedEAR > earLimit` (0.48 / 48%), reject configuration load
- Block loan creation attempts using non-compliant product configs [Source: prd.md#FR4, prd.md#Story 1.3, AC 3]

**Error Handling**:
- Throw `ComplianceException` with descriptive message including product code, calculated EAR, and limit
- Log EAR validation failures with structured logging (correlation ID, product code, EAR values) [Source: brownfield-architecture.md#4.3 Coding Standards]

### Integration Points [Sources]

**LoanProductService Refactoring** - Replace hardcoded definitions with Vault service
- Inject `IVaultProductConfigService` (previously had hardcoded list)
- Modify `GetProductAsync(productCode)` to call `VaultProductConfigService.GetProductConfigAsync`
- Maintain existing method signatures for backward compatibility [Source: prd.md#Story 1.3, AC 4; prd.md#CR1]

**LoanApplicationService Usage**:
- Product validation during loan creation will transparently use Vault configs
- No changes required to LoanApplicationService (dependency injection handles it)
- Existing API contracts remain unchanged [Source: prd.md#CR1]

### New Models Required [Sources]

**LoanProductConfig.cs** - Domain model for Vault product configuration
```csharp
public class LoanProductConfig
{
    public string ProductName { get; set; }
    public decimal MinAmount { get; set; }
    public decimal MaxAmount { get; set; }
    public int MinTermMonths { get; set; }
    public int MaxTermMonths { get; set; }
    public decimal BaseInterestRate { get; set; }
    public decimal AdminFee { get; set; }
    public decimal ManagementFee { get; set; }
    public decimal CalculatedEAR { get; set; }
    public bool EarCapCompliance { get; set; }
    public decimal EarLimit { get; set; }
    public EligibilityRules EligibilityRules { get; set; }
}

public class EligibilityRules
{
    public string RequiredKycStatus { get; set; }
    public decimal MinMonthlyIncome { get; set; }
    public decimal MaxDtiRatio { get; set; }
    public bool PmecRegistrationRequired { get; set; }
}
```
[Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration, Impact section]

### File Locations [Sources]

- **New Service**: `apps/IntelliFin.LoanOriginationService/Services/VaultProductConfigService.cs` [NEW]
- **New Interface**: `apps/IntelliFin.LoanOriginationService/Services/IVaultProductConfigService.cs` [NEW]
- **New Models**: `apps/IntelliFin.LoanOriginationService/Models/LoanProductConfig.cs` [NEW]
- **New Models**: `apps/IntelliFin.LoanOriginationService/Models/EligibilityRules.cs` [NEW]
- **New Exception**: `apps/IntelliFin.LoanOriginationService/Exceptions/ComplianceException.cs` [NEW]
- **Modify Service**: `apps/IntelliFin.LoanOriginationService/Services/LoanProductService.cs` [MODIFY]
[Source: brownfield-architecture.md#4.3 Code Organization and Standards, prd.md#4.3]

### Technology Stack [Sources]

**Vault Client Library**: Use VaultSharp NuGet package for Vault API access
- Package: `VaultSharp` (latest stable version)
- Uses `IVaultClient` interface from VaultSharp
- Vault API version: KV Secrets Engine v2 [Source: prd.md#4.1 Existing Technology Stack]

**Caching**: .NET `IMemoryCache` from `Microsoft.Extensions.Caching.Memory`
- 5-minute TTL via `TimeSpan.FromMinutes(5)`
- In-memory caching (not Redis for this story - Redis optional for future enhancement) [Source: prd.md#NFR2]

**Vault Infrastructure**: HashiCorp Vault 1.15+ (existing Control Plane infrastructure)
- Vault Agent sidecar pattern (CSI driver + init containers) for credential injection
- Service authenticates via Kubernetes Service Account or AppRole [Source: prd.md#4.1 Critical Constraints]

### Coding Standards [Sources]

- **Async/await**: All Vault I/O operations async with CancellationToken propagation [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Structured logging**: Use Serilog with correlation IDs for Vault read operations, cache hits/misses, EAR validation results [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Exception handling**: Domain exceptions (`ComplianceException`) for business rule violations; Vault client exceptions wrapped as infrastructure exceptions [Source: brownfield-architecture.md#4.3 Coding Standards]
- **XML comments**: Required for all public interfaces and service classes [Source: brownfield-architecture.md#4.3 Documentation Standards]

### Testing Requirements [Sources]

**Unit Tests (xUnit)**
- Test EAR validation rejects configs with calculatedEAR > 0.48 [Source: prd.md#Story 1.3, AC 7]
- Test EAR validation accepts compliant configs (calculatedEAR ≤ 0.48) [Source: prd.md#Story 1.3, AC 7]
- Test caching behavior (first call reads Vault, subsequent calls return cached value within 5 minutes)
- Mock `IVaultClient` for unit tests to avoid actual Vault dependency

**Integration Tests (Testcontainers)**
- Load config from actual Vault instance using Testcontainers Vault image [Source: prd.md#Story 1.3, AC 8]
- Verify caching behavior (cache expiration after 5 minutes forces Vault re-read) [Source: prd.md#Story 1.3, AC 8]
- Test full integration: LoanApplicationService → LoanProductService → VaultProductConfigService → Vault [Source: prd.md#Story 1.3, IV1]
- Test framework: xUnit with Testcontainers for Vault [Source: prd.md#4.2 Testing Integration Strategy]

**Backward Compatibility Verification**
- Existing loans created before Vault migration remain queryable and valid [Source: prd.md#Story 1.3, IV3]
- Existing API endpoints continue working with Vault-based product validation [Source: prd.md#Story 1.3, IV1]

### Documentation Requirements [Sources]

**Vault Schema Documentation** - Document example configurations for products:
- `GEPL-001` (Government Employee Payroll Loan) - full JSON schema with all fields
- `SMEABL-001` (SME Asset-Backed Loan) - full JSON schema with all fields
- Document Vault path structure: `kv/intellifin/loan-products/{productCode}/rules`
- Include EAR calculation methodology explanation [Source: prd.md#Story 1.3, AC 5]

**Configuration Change Workflow** - Document dual control process for Vault updates:
- Product Owner proposes config changes
- Compliance Officer reviews EAR compliance
- Dual approval required (Product Owner + Compliance Officer)
- Vault audit trail captures all config changes
- Version history tracked in Vault KV v2 engine [Source: prd.md#Story 1.3, AC 6; brownfield-architecture.md#❌ 2. Vault-Based Product Configuration]

### Performance Constraints [Sources]

- Cache TTL 5 minutes to balance freshness vs. performance [Source: prd.md#NFR2]
- Vault read operations must not block API responses >500ms p95 (cache hits should be <1ms) [Source: prd.md#NFR1]
- Cache invalidation on config update events (future enhancement - not in this story)

### Dependencies
- **Story 1.2**: Versioning service operational (config version tracking in Vault aligns with loan versioning approach) [Source: prd.md#Story 1.3 Dependencies]
- **Vault Infrastructure**: Existing Control Plane Vault instance operational [Source: prd.md#4.1 Critical Constraints]

## Tasks / Subtasks

- [ ] Create domain models (AC: 5)
  - [ ] Create `Models/LoanProductConfig.cs` with properties matching Vault schema [Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration]
  - [ ] Create `Models/EligibilityRules.cs` nested model for eligibility rules
  - [ ] Add XML documentation comments for all properties

- [ ] Create ComplianceException domain exception (AC: 3)
  - [ ] Create `Exceptions/ComplianceException.cs` extending `Exception`
  - [ ] Include ProductCode, CalculatedEAR, EarLimit properties
  - [ ] Override Message property to format compliance violation message [Source: brownfield-architecture.md#4.3 Exception handling]

- [ ] Create IVaultProductConfigService interface (AC: 1)
  - [ ] Define `Task<LoanProductConfig> GetProductConfigAsync(string productCode, CancellationToken cancellationToken)` signature
  - [ ] Add XML documentation comments

- [ ] Install VaultSharp NuGet package
  - [ ] Add `VaultSharp` package to IntelliFin.LoanOriginationService project
  - [ ] Verify package version compatibility with .NET 9

- [ ] Implement VaultProductConfigService.GetProductConfigAsync (AC: 1, 2, 3)
  - [ ] Inject `IVaultClient` and `IMemoryCache` dependencies
  - [ ] Implement cache lookup using key `product-config:{productCode}` [Source: brownfield-architecture.md#❌ 2. Vault-Based Product Configuration]
  - [ ] Read from Vault KV v2 at path `loan-products/{productCode}/rules` [Source: prd.md#Story 1.3, AC 1]
  - [ ] Deserialize JSON to `LoanProductConfig` using System.Text.Json
  - [ ] Validate EAR compliance: if `config.CalculatedEAR > config.EarLimit` throw `ComplianceException` [Source: prd.md#Story 1.3, AC 3]
  - [ ] Cache config with 5-minute TTL using `_cache.Set(cacheKey, config, TimeSpan.FromMinutes(5))` [Source: prd.md#Story 1.3, AC 2]
  - [ ] Add structured logging: cache hits, Vault reads, EAR validation results [Source: brownfield-architecture.md#4.3 Coding Standards]

- [ ] Refactor LoanProductService to use VaultProductConfigService (AC: 4)
  - [ ] Inject `IVaultProductConfigService` instead of hardcoded product list
  - [ ] Modify `GetProductAsync(productCode)` to call `VaultProductConfigService.GetProductConfigAsync`
  - [ ] Remove hardcoded `_products` list
  - [ ] Maintain existing method signatures (backward compatibility) [Source: prd.md#CR1]

- [ ] Register services in DI container (Program.cs)
  - [ ] Configure VaultSharp `IVaultClient` with Vault address and authentication
  - [ ] Register `builder.Services.AddScoped<IVaultProductConfigService, VaultProductConfigService>();`
  - [ ] Verify `IMemoryCache` already registered (part of ASP.NET Core)
  - [ ] Configure Vault authentication (Kubernetes Service Account or AppRole)

- [ ] Document Vault schema (AC: 5)
  - [ ] Create `docs/domains/loan-origination/vault-product-config-schema.md`
  - [ ] Document complete JSON schema with field descriptions
  - [ ] Include example configurations for GEPL-001 and SMEABL-001 [Source: prd.md#Story 1.3, AC 5]
  - [ ] Document Vault path structure: `kv/intellifin/loan-products/{productCode}/rules`
  - [ ] Include EAR calculation methodology explanation

- [ ] Document configuration change workflow (AC: 6)
  - [ ] Create `docs/domains/loan-origination/vault-config-change-workflow.md`
  - [ ] Document dual control approval process [Source: prd.md#Story 1.3, AC 6]
  - [ ] Include step-by-step instructions for updating product configs in Vault
  - [ ] Document audit trail requirements and version history tracking

- [ ] Seed Vault with initial product configurations
  - [ ] Create Vault CLI script or initialization job
  - [ ] Seed `kv/intellifin/loan-products/GEPL-001/rules` with GEPL config
  - [ ] Seed `kv/intellifin/loan-products/SMEABL-001/rules` with SMEABL config
  - [ ] Verify configs accessible via Vault UI and CLI

- [ ] Write unit tests for EAR validation (AC: 7)
  - [ ] Test non-compliant config (calculatedEAR = 0.50, earLimit = 0.48) throws `ComplianceException` [Source: prd.md#Story 1.3, AC 7]
  - [ ] Test compliant config (calculatedEAR = 0.15, earLimit = 0.48) returns config successfully [Source: prd.md#Story 1.3, AC 7]
  - [ ] Test edge case (calculatedEAR = 0.48, earLimit = 0.48) is compliant (boundary condition)
  - [ ] Mock `IVaultClient` to return test configurations

- [ ] Write unit tests for caching behavior
  - [ ] Test first call reads from Vault, subsequent call returns cached value (verify Vault client called once)
  - [ ] Test cache expiration after 5 minutes forces Vault re-read
  - [ ] Test cache key isolation (different product codes use separate cache entries)
  - [ ] Mock `IMemoryCache` and `IVaultClient`

- [ ] Write integration tests with Testcontainers Vault (AC: 8)
  - [ ] Set up Testcontainers Vault instance in test fixture [Source: prd.md#Story 1.3, AC 8]
  - [ ] Seed test Vault with sample product configs
  - [ ] Test full integration: call `GetProductConfigAsync` and verify config loaded from Vault
  - [ ] Test caching behavior with actual cache (verify performance improvement on cache hit) [Source: prd.md#Story 1.3, AC 8]
  - [ ] Test EAR compliance validation with actual Vault data [Source: prd.md#Story 1.3, IV2]

- [ ] Integration verification: Product validation uses Vault config (IV1)
  - [ ] Create loan application via existing `/api/loanapplication` endpoint
  - [ ] Verify product validation uses Vault config (update Vault config, wait 5 minutes, verify new limits enforced) [Source: prd.md#Story 1.3, IV1]
  - [ ] Verify existing fields in API response unchanged (backward compatibility)

- [ ] Integration verification: EAR compliance blocking (IV2)
  - [ ] Temporarily seed Vault with non-compliant product config (EAR > 48%)
  - [ ] Attempt to create loan with that product code
  - [ ] Verify `ComplianceException` thrown and loan creation blocked [Source: prd.md#Story 1.3, IV2]
  - [ ] Verify error message includes product code and EAR values

- [ ] Integration verification: Backward compatibility (IV3)
  - [ ] Query existing loans created before Vault migration
  - [ ] Verify all loans remain queryable and valid [Source: prd.md#Story 1.3, IV3]
  - [ ] Verify no data corruption or schema issues

## Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-10-17 | 0.1     | Initial draft created            | SM     |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(To be filled by QA agent)*
