# Story 1.6: KYC Verification Worker and Event Subscription

Status: Draft

## Story

**As a** credit analyst,  
**I want** the loan origination workflow to automatically verify KYC status before proceeding and pause workflows when KYC is revoked,  
**so that** no loans advance without valid KYC verification and compliance is maintained in real-time.

## Acceptance Criteria

1. `KycVerificationWorker` implemented as Zeebe job worker handling `verify-kyc` service tasks
2. Worker calls `IClientManagementClient.GetClientVerificationAsync(clientId)` to check KYC status
3. If KYC status is "Approved" and not expired (<12 months), complete job with `kycVerified: true` variable
4. If KYC status is NOT "Approved" (Pending, Revoked, Expired), throw workflow error with code `KYC_NOT_VERIFIED`
5. If KYC approved date >12 months ago, throw workflow error with code `KYC_EXPIRED`
6. Worker is idempotent - multiple executions for same job do not cause side effects
7. `ClientKycRevokedConsumer` implemented as MassTransit consumer subscribing to `ClientKycRevoked` events from RabbitMQ
8. When KYC revoked event received, consumer pauses all active loan workflows for affected client via Camunda API
9. Consumer publishes `LoanApplicationPaused` audit event to AdminService with reason "KYC_REVOKED"
10. Unit tests verify all KYC status branches (Approved, Pending, Expired, Revoked) and idempotency
11. Integration tests verify workflow progression for verified/unverified clients and workflow pause on revocation

## Integration Verification

- **IV1**: Deploy BPMN with KYC verification gate → start loan workflow for verified client → verify workflow passes KYC gate and advances to next task
- **IV2**: Start loan workflow for client with expired KYC → verify workflow stops at KYC gate with error incident `KYC_EXPIRED` visible in Camunda Cockpit
- **IV3**: Start loan workflow for client with pending KYC → verify workflow stops at KYC gate with error incident `KYC_NOT_VERIFIED`
- **IV4**: Start multiple loan workflows for same client → publish `ClientKycRevoked` event → verify all active workflows paused, audit events published to AdminService

## Dev Notes

### Previous Story Insights
- Story 1.2 implemented LoanVersioningService with loan number generation
- Story 1.3 integrated Vault for product configurations with KYC expiration policy
- Story 1.4 implemented `IClientManagementClient` HTTP client with circuit breaker for KYC verification API
- Story 1.5 designed and deployed Camunda BPMN workflow with KYC verification service task at start
- Existing `InitialValidationWorker` registered as HostedService demonstrates worker pattern [Source: brownfield-architecture.md#✅ Service Scaffolding and Infrastructure, line 221]

### Current State Problem [Sources]

**Missing KYC/AML Workflow Gating** - BPMN deployed but no worker to handle KYC service task
- Architecture document specifies `KycVerificationWorker` pattern for workflow integration [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 317-349]
- Worker must call Client Management Service API in real-time during workflow execution
- Worker must throw Zeebe error codes `KYC_NOT_VERIFIED` or `KYC_EXPIRED` to trigger workflow error boundary events [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 328-343]

**Missing Event-Driven KYC Revocation Handling**
- No subscriber for `ClientKycRevoked` events from Client Management service [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 351-363]
- When KYC is revoked, active loans must be paused immediately to prevent non-compliant disbursements [Source: prd.md#FR10]
- Architecture specifies `KycStatusEventConsumer` pattern for event subscription [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 352-363]

**Regulatory Requirement**: Bank of Zambia requires real-time KYC verification and immediate action when KYC status changes [Source: prd.md#1.4 Background Context, prd.md#FR10]

### Worker Implementation Pattern [Sources]

**KycVerificationWorker Implementation**:
```csharp
public class KycVerificationWorker : BackgroundService
{
    private readonly IZeebeClient _zeebeClient;
    private readonly IClientManagementClient _clientManagementClient;
    private readonly ILogger<KycVerificationWorker> _logger;
    
    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        // Register job worker for "verify-kyc" task type
        await _zeebeClient.NewWorker()
            .JobType("verify-kyc")
            .Handler(HandleKycVerificationAsync)
            .MaxJobsActive(10) // Process up to 10 KYC checks concurrently
            .Name("kyc-verification-worker")
            .AutoComplete(false) // Manual completion after validation
            .PollInterval(TimeSpan.FromSeconds(1))
            .Timeout(TimeSpan.FromSeconds(10))
            .Open();
        
        // Keep service running
        await Task.Delay(Timeout.Infinite, stoppingToken);
    }
    
    private async Task HandleKycVerificationAsync(
        IJobClient jobClient, 
        IJob job)
    {
        var clientId = Guid.Parse(job.Variables["clientId"].ToString());
        
        _logger.LogInformation(
            "Processing KYC verification for client {ClientId}, Job Key: {JobKey}",
            clientId, job.Key);
        
        try
        {
            // Call Client Management Service
            var verification = await _clientManagementClient
                .GetClientVerificationAsync(clientId, CancellationToken.None);
            
            // Check KYC status
            if (verification.KycStatus != "Approved")
            {
                await jobClient.NewThrowErrorCommand(job.Key)
                    .ErrorCode("KYC_NOT_VERIFIED")
                    .ErrorMessage($"Client {clientId} KYC status is '{verification.KycStatus}'. KYC approval required.")
                    .Send();
                
                _logger.LogWarning(
                    "KYC verification failed for client {ClientId}: Status = {Status}",
                    clientId, verification.KycStatus);
                return;
            }
            
            // Check KYC expiration (12 months)
            if (verification.KycApprovedAt < DateTime.UtcNow.AddMonths(-12))
            {
                await jobClient.NewThrowErrorCommand(job.Key)
                    .ErrorCode("KYC_EXPIRED")
                    .ErrorMessage($"Client {clientId} KYC verification expired. Approved on {verification.KycApprovedAt:yyyy-MM-dd}, valid for 12 months.")
                    .Send();
                
                _logger.LogWarning(
                    "KYC verification expired for client {ClientId}: Approved = {ApprovedAt}",
                    clientId, verification.KycApprovedAt);
                return;
            }
            
            // KYC verified and not expired - complete job with success
            await jobClient.NewCompleteCommand(job.Key)
                .Variables("{\"kycVerified\": true, \"kycApprovedAt\": \"" + 
                    verification.KycApprovedAt.ToString("o") + "\"}")
                .Send();
            
            _logger.LogInformation(
                "KYC verification successful for client {ClientId}",
                clientId);
        }
        catch (ClientManagementServiceException ex)
        {
            // Circuit breaker or service unavailable - fail job with retry
            _logger.LogError(ex,
                "Client Management Service unavailable for client {ClientId}",
                clientId);
            
            await jobClient.NewFailCommand(job.Key)
                .Retries(job.Retries - 1) // Decrement retries
                .ErrorMessage($"Client Management Service unavailable: {ex.Message}")
                .Send();
        }
        catch (Exception ex)
        {
            // Unexpected error - fail job with retry
            _logger.LogError(ex,
                "Unexpected error during KYC verification for client {ClientId}",
                clientId);
            
            await jobClient.NewFailCommand(job.Key)
                .Retries(job.Retries - 1)
                .ErrorMessage($"Unexpected error: {ex.Message}")
                .Send();
        }
    }
}
```
[Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 317-349 - pattern adapted for Zeebe 8.x API]

**Worker Configuration in Program.cs**:
```csharp
builder.Services.AddHostedService<KycVerificationWorker>();
```
[Source: brownfield-architecture.md#✅ Service Scaffolding and Infrastructure, line 221]

**Idempotency Strategy**:
- Zeebe guarantees exactly-once delivery per job activation
- Worker can be called multiple times for same job (retries)
- Read-only operation (KYC check) is inherently idempotent
- `NewCompleteCommand` and `NewThrowErrorCommand` are idempotent (Zeebe deduplicates)
[Source: Zeebe documentation - job workers are designed for idempotency via Zeebe's internal deduplication]

### Event Consumer Implementation [Sources]

**ClientKycRevokedConsumer Implementation**:
```csharp
public class ClientKycRevokedConsumer : IConsumer<ClientKycRevoked>
{
    private readonly IZeebeClient _zeebeClient;
    private readonly LmsDbContext _dbContext;
    private readonly IPublishEndpoint _publishEndpoint;
    private readonly ILogger<ClientKycRevokedConsumer> _logger;
    
    public async Task Consume(ConsumeContext<ClientKycRevoked> context)
    {
        var clientId = context.Message.ClientId;
        var revokedAt = context.Message.RevokedAt;
        var reason = context.Message.Reason;
        
        _logger.LogInformation(
            "Processing ClientKycRevoked event for client {ClientId}, Reason: {Reason}",
            clientId, reason);
        
        try
        {
            // Find all active loan workflows for this client
            var activeLoans = await _dbContext.LoanApplications
                .Where(la => la.ClientId == clientId 
                    && la.WorkflowInstanceId != null 
                    && la.Status != LoanApplicationStatus.Approved
                    && la.Status != LoanApplicationStatus.Rejected
                    && la.Status != LoanApplicationStatus.Cancelled)
                .ToListAsync();
            
            if (!activeLoans.Any())
            {
                _logger.LogInformation(
                    "No active loan workflows found for client {ClientId}",
                    clientId);
                return;
            }
            
            // Pause each active workflow
            foreach (var loan in activeLoans)
            {
                try
                {
                    // Update workflow variables to mark KYC as revoked
                    await _zeebeClient.NewSetVariablesCommand(
                        long.Parse(loan.WorkflowInstanceId))
                        .Variables("{\"kycRevoked\": true, \"kycRevokedAt\": \"" + 
                            revokedAt.ToString("o") + "\", \"kycRevokedReason\": \"" + reason + "\"}")
                        .Send();
                    
                    // Publish workflow incident (manual intervention required)
                    await _zeebeClient.NewPublishMessageCommand()
                        .MessageName("kyc-revoked")
                        .CorrelationKey(loan.Id.ToString())
                        .Variables("{\"action\": \"pause_workflow\"}")
                        .Send();
                    
                    // Update loan status
                    loan.Status = LoanApplicationStatus.Paused;
                    loan.PausedReason = $"KYC_REVOKED: {reason}";
                    loan.PausedAt = DateTime.UtcNow;
                    
                    // Publish audit event to AdminService
                    await _publishEndpoint.Publish(new LoanApplicationPaused
                    {
                        LoanApplicationId = loan.Id,
                        ClientId = clientId,
                        LoanNumber = loan.LoanNumber,
                        WorkflowInstanceId = loan.WorkflowInstanceId,
                        PausedReason = $"KYC_REVOKED: {reason}",
                        PausedAt = DateTime.UtcNow,
                        KycRevokedAt = revokedAt
                    });
                    
                    _logger.LogInformation(
                        "Paused workflow for loan {LoanNumber} due to KYC revocation",
                        loan.LoanNumber);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex,
                        "Failed to pause workflow for loan {LoanNumber}",
                        loan.LoanNumber);
                    // Continue processing other loans even if one fails
                }
            }
            
            // Save all changes
            await _dbContext.SaveChangesAsync();
            
            _logger.LogInformation(
                "Paused {Count} loan workflows for client {ClientId}",
                activeLoans.Count, clientId);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "Error processing ClientKycRevoked event for client {ClientId}",
                clientId);
            throw; // Trigger MassTransit retry mechanism
        }
    }
}
```
[Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 351-363 - pattern adapted for Zeebe 8.x + MassTransit]

**Consumer Configuration in Program.cs**:
```csharp
builder.Services.AddMassTransit(x => {
    x.AddConsumer<ClientKycRevokedConsumer>();
    
    x.UsingRabbitMq((context, cfg) => {
        cfg.Host("rabbitmq://localhost", h => {
            h.Username("guest");
            h.Password("guest");
        });
        
        cfg.ReceiveEndpoint("loan-origination-kyc-revoked", e => {
            e.ConfigureConsumer<ClientKycRevokedConsumer>(context);
            e.UseMessageRetry(r => r.Interval(3, TimeSpan.FromSeconds(5)));
        });
        
        cfg.ConfigureEndpoints(context);
    });
});
```
[Source: brownfield-architecture.md#✅ Service Scaffolding and Infrastructure, lines 215-218 - MassTransit already configured]

### Event Schema [Sources]

**ClientKycRevoked Event** (from Client Management Service):
```csharp
public class ClientKycRevoked
{
    public Guid ClientId { get; set; }
    public DateTime RevokedAt { get; set; }
    public string Reason { get; set; } // "COMPLIANCE_ISSUE", "DOCUMENT_EXPIRED", "FRAUD_DETECTED", etc.
    public string RevokedBy { get; set; } // User ID who revoked KYC
    public Guid CorrelationId { get; set; }
}
```
[Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, line 352 - event structure inferred from architecture pattern]

**LoanApplicationPaused Event** (published to AdminService):
```csharp
public class LoanApplicationPaused
{
    public Guid LoanApplicationId { get; set; }
    public Guid ClientId { get; set; }
    public string LoanNumber { get; set; }
    public string WorkflowInstanceId { get; set; }
    public string PausedReason { get; set; }
    public DateTime PausedAt { get; set; }
    public DateTime? KycRevokedAt { get; set; }
    public Guid CorrelationId { get; set; }
}
```
[Source: prd.md#FR9 - audit events for state changes; brownfield-architecture.md#❌ 1. KYC/AML Gating, line 361]

### Database Schema Changes [Sources]

**Add LoanApplication columns for pause tracking**:
```sql
ALTER TABLE LoanApplications 
ADD PausedReason NVARCHAR(500) NULL,
    PausedAt DATETIME2 NULL;
```
[Source: prd.md#CR2 - additive schema changes]

### File Locations [Sources]

- **New Worker**: `apps/IntelliFin.LoanOriginationService/Workers/KycVerificationWorker.cs` [NEW]
- **New Consumer**: `apps/IntelliFin.LoanOriginationService/Consumers/ClientKycRevokedConsumer.cs` [NEW]
- **New Event Model**: `apps/IntelliFin.LoanOriginationService/Events/ClientKycRevoked.cs` [NEW]
- **New Event Model**: `apps/IntelliFin.LoanOriginationService/Events/LoanApplicationPaused.cs` [NEW]
- **New Enum Value**: `apps/IntelliFin.LoanOriginationService/Models/LoanApplicationStatus.cs` - Add `Paused` [MODIFY]
- **Modify Entity**: `apps/IntelliFin.LoanOriginationService/Models/LoanApplicationModels.cs` - Add `PausedReason`, `PausedAt` properties [MODIFY]
- **Modify Configuration**: `apps/IntelliFin.LoanOriginationService/Program.cs` - Register worker and consumer [MODIFY]
[Source: brownfield-architecture.md#4.3 Code Organization]

### Technology Stack [Sources]

**Zeebe Job Worker**: Zeebe.Client library (already configured)
- Worker registration: `.NewWorker().JobType("verify-kyc").Handler(...)`
- Manual completion: `.AutoComplete(false)`
- Error handling: `NewThrowErrorCommand` and `NewFailCommand`
[Source: brownfield-architecture.md#✅ Service Scaffolding and Infrastructure, lines 208-213]

**MassTransit Event Consumer**: MassTransit with RabbitMQ (already configured)
- Consumer registration: `x.AddConsumer<ClientKycRevokedConsumer>()`
- Retry policy: 3 attempts with 5-second interval
- Dead-letter exchange for failed messages
[Source: brownfield-architecture.md#✅ Service Scaffolding and Infrastructure, lines 215-218; prd.md#NFR4]

**Structured Logging**: Serilog with correlation IDs
- Log all worker job activations, completions, errors
- Log all event consumption with client ID, loan numbers, workflow instance IDs
[Source: brownfield-architecture.md#4.3 Coding Standards; prd.md#NFR5]

### Coding Standards [Sources]

- **Async/await**: All operations async with CancellationToken propagation [Source: brownfield-architecture.md#4.3 Coding Standards]
- **Error handling**: Use Zeebe error codes for business rule violations (`KYC_NOT_VERIFIED`, `KYC_EXPIRED`); use `NewFailCommand` for transient failures [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 328-343]
- **Idempotency**: Workers must handle duplicate job activations (Zeebe retries) [Source: Zeebe worker best practices]
- **Structured logging**: Use Serilog with correlation IDs, job keys, client IDs for traceability [Source: prd.md#NFR5]
- **Exception handling**: Catch `ClientManagementServiceException` separately from general exceptions [Source: Story 1.4 exception handling pattern]
- **XML comments**: Required for all public classes and methods [Source: brownfield-architecture.md#4.3 Documentation Standards]

### Testing Requirements [Sources]

**Unit Tests (xUnit)**
- Test worker handles KYC status "Approved" and not expired → job completed with `kycVerified: true` [Source: prd.md#Story 1.6, AC 3]
- Test worker handles KYC status "Pending" → throws error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
- Test worker handles KYC status "Revoked" → throws error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
- Test worker handles KYC status "Expired" → throws error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
- Test worker handles KYC approved >12 months ago → throws error `KYC_EXPIRED` [Source: prd.md#Story 1.6, AC 5]
- Test worker handles `ClientManagementServiceException` → fails job with retry [Source: prd.md#Story 1.6, AC 6]
- Test worker idempotency: multiple calls for same job do not cause side effects [Source: prd.md#Story 1.6, AC 6]
- Test consumer receives `ClientKycRevoked` event → pauses all active workflows [Source: prd.md#Story 1.6, AC 8]
- Test consumer publishes `LoanApplicationPaused` audit event [Source: prd.md#Story 1.6, AC 9]
- Test consumer handles no active loans gracefully (no error) [Source: prd.md#Story 1.6, AC 8]
- Mock `IZeebeClient`, `IClientManagementClient`, `IPublishEndpoint` for unit tests

**Integration Tests**
- Test BPMN workflow with KYC gate: verified client → workflow advances [Source: prd.md#Story 1.6, IV1]
- Test BPMN workflow with KYC gate: expired KYC → workflow stops with error incident [Source: prd.md#Story 1.6, IV2]
- Test BPMN workflow with KYC gate: pending KYC → workflow stops with error incident [Source: prd.md#Story 1.6, IV3]
- Test `ClientKycRevoked` event: multiple active workflows → all paused, audit events published [Source: prd.md#Story 1.6, IV4]
- Test framework: xUnit with TestContainers for Camunda and RabbitMQ [Source: prd.md#4.2 Testing Integration Strategy]

### Performance Constraints [Sources]

- Worker must process KYC verification within 10 seconds (Zeebe job timeout) [Source: prd.md#NFR3]
- Worker can handle up to 10 concurrent KYC checks (MaxJobsActive = 10) [Source: prd.md#NFR3]
- Consumer must process `ClientKycRevoked` events within 30 seconds (MassTransit default timeout) [Source: prd.md#NFR4]
- Correlation IDs must be propagated across all service calls and event publications [Source: prd.md#NFR5]

### Dependencies
- **Story 1.4**: `IClientManagementClient` HTTP client with circuit breaker [Source: prd.md#Story 1.6 Dependencies]
- **Story 1.5**: Camunda BPMN workflow deployed with `verify-kyc` service task [Source: prd.md#Story 1.6 Dependencies]
- **Client Management Module**: Publishes `ClientKycRevoked` events via RabbitMQ [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating]

## Tasks / Subtasks

- [ ] Add database migration for pause tracking (Schema)
  - [ ] Create migration: Add `PausedReason` (NVARCHAR(500) NULL) and `PausedAt` (DATETIME2 NULL) columns to LoanApplications table
  - [ ] Update `LoanApplicationModels.cs` with `PausedReason` and `PausedAt` properties
  - [ ] Add `Paused` value to `LoanApplicationStatus` enum
  - [ ] Run migration and verify schema changes

- [ ] Create event models (AC: 7, 9)
  - [ ] Create `Events/ClientKycRevoked.cs` with properties: ClientId, RevokedAt, Reason, RevokedBy, CorrelationId
  - [ ] Create `Events/LoanApplicationPaused.cs` with properties: LoanApplicationId, ClientId, LoanNumber, WorkflowInstanceId, PausedReason, PausedAt, KycRevokedAt, CorrelationId
  - [ ] Add XML documentation comments for all event properties

- [ ] Implement KycVerificationWorker (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `Workers/KycVerificationWorker.cs` inheriting from `BackgroundService`
  - [ ] Inject `IZeebeClient`, `IClientManagementClient`, `ILogger<KycVerificationWorker>` dependencies
  - [ ] Implement `ExecuteAsync` to register Zeebe worker for `verify-kyc` job type [Source: brownfield-architecture.md#❌ 1. KYC/AML Gating, lines 317-349]
  - [ ] Configure worker: `MaxJobsActive(10)`, `AutoComplete(false)`, `Timeout(10 seconds)`, `PollInterval(1 second)`
  - [ ] Implement `HandleKycVerificationAsync` handler method
  - [ ] Extract `clientId` from job variables
  - [ ] Call `_clientManagementClient.GetClientVerificationAsync(clientId)` [Source: prd.md#Story 1.6, AC 2]
  - [ ] Validate KYC status: if != "Approved" → throw error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
  - [ ] Validate KYC expiration: if >12 months → throw error `KYC_EXPIRED` [Source: prd.md#Story 1.6, AC 5]
  - [ ] Complete job with `kycVerified: true` variable if validation passes [Source: prd.md#Story 1.6, AC 3]
  - [ ] Handle `ClientManagementServiceException` → fail job with retry [Source: prd.md#Story 1.6, AC 6]
  - [ ] Add structured logging: job start, completion, errors with correlation IDs [Source: prd.md#NFR5]
  - [ ] Ensure idempotency: read-only operations, Zeebe deduplication [Source: prd.md#Story 1.6, AC 6]

- [ ] Implement ClientKycRevokedConsumer (AC: 7, 8, 9)
  - [ ] Create `Consumers/ClientKycRevokedConsumer.cs` implementing `IConsumer<ClientKycRevoked>`
  - [ ] Inject `IZeebeClient`, `LmsDbContext`, `IPublishEndpoint`, `ILogger<ClientKycRevokedConsumer>` dependencies
  - [ ] Implement `Consume` method
  - [ ] Query all active loan workflows for affected client [Source: prd.md#Story 1.6, AC 8]
  - [ ] For each active loan:
    - [ ] Update workflow variables with `kycRevoked: true`, `kycRevokedAt`, `kycRevokedReason`
    - [ ] Publish `kyc-revoked` message to workflow via Zeebe
    - [ ] Update loan status to `Paused` with `PausedReason` and `PausedAt`
    - [ ] Publish `LoanApplicationPaused` event to AdminService [Source: prd.md#Story 1.6, AC 9]
  - [ ] Save all database changes
  - [ ] Add structured logging: event received, workflows paused, audit events published [Source: prd.md#NFR5]
  - [ ] Handle exceptions with retry via MassTransit retry policy

- [ ] Register worker and consumer in Program.cs
  - [ ] Add `builder.Services.AddHostedService<KycVerificationWorker>();` to register worker
  - [ ] Add `x.AddConsumer<ClientKycRevokedConsumer>();` to MassTransit configuration
  - [ ] Configure RabbitMQ receive endpoint: `loan-origination-kyc-revoked` with retry policy (3 attempts, 5-second interval)
  - [ ] Verify MassTransit configuration includes `ConfigureEndpoints(context)` for automatic endpoint setup

- [ ] Write unit tests for KycVerificationWorker (AC: 10)
  - [ ] Test KYC status "Approved" and not expired → job completed with `kycVerified: true` [Source: prd.md#Story 1.6, AC 3]
  - [ ] Test KYC status "Pending" → throws error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
  - [ ] Test KYC status "Revoked" → throws error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
  - [ ] Test KYC status "Expired" (non-Approved) → throws error `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, AC 4]
  - [ ] Test KYC approved >12 months ago → throws error `KYC_EXPIRED` [Source: prd.md#Story 1.6, AC 5]
  - [ ] Test `ClientManagementServiceException` → fails job with retry (retries decremented) [Source: prd.md#Story 1.6, AC 6]
  - [ ] Test worker idempotency: multiple handler calls for same job do not cause side effects [Source: prd.md#Story 1.6, AC 6]
  - [ ] Mock `IZeebeClient`, `IClientManagementClient` for unit tests

- [ ] Write unit tests for ClientKycRevokedConsumer (AC: 10)
  - [ ] Test event received → all active workflows for client paused [Source: prd.md#Story 1.6, AC 8]
  - [ ] Test event received → `LoanApplicationPaused` events published to AdminService [Source: prd.md#Story 1.6, AC 9]
  - [ ] Test event received but no active loans → no error, graceful completion
  - [ ] Test partial failure (one workflow pause fails) → other workflows still paused
  - [ ] Mock `IZeebeClient`, `LmsDbContext`, `IPublishEndpoint` for unit tests

- [ ] Write integration tests with TestContainers (AC: 11)
  - [ ] Set up TestContainers for Camunda (Zeebe + Operate) and RabbitMQ
  - [ ] Integration test IV1: Deploy BPMN → start workflow for verified client → verify workflow passes KYC gate [Source: prd.md#Story 1.6, IV1]
  - [ ] Integration test IV2: Start workflow for client with expired KYC → verify workflow stops at KYC gate with error incident `KYC_EXPIRED` [Source: prd.md#Story 1.6, IV2]
  - [ ] Integration test IV3: Start workflow for client with pending KYC → verify workflow stops at KYC gate with error incident `KYC_NOT_VERIFIED` [Source: prd.md#Story 1.6, IV3]
  - [ ] Integration test IV4: Start multiple workflows → publish `ClientKycRevoked` event → verify all workflows paused, audit events published [Source: prd.md#Story 1.6, IV4]
  - [ ] Verify error incidents visible in Camunda Cockpit (integration verification)
  - [ ] Verify audit events received by AdminService mock subscriber

- [ ] Integration verification: Verified client workflow progression (IV1)
  - [ ] Deploy BPMN with KYC verification gate (from Story 1.5) to Camunda
  - [ ] Start loan workflow for KYC-verified client (status = "Approved", approved <12 months ago)
  - [ ] Verify workflow passes KYC gate and advances to next task [Source: prd.md#Story 1.6, IV1]
  - [ ] Verify workflow variables include `kycVerified: true` and `kycApprovedAt`

- [ ] Integration verification: Expired KYC workflow incident (IV2)
  - [ ] Start loan workflow for client with KYC approved >12 months ago
  - [ ] Verify workflow stops at KYC gate with error incident [Source: prd.md#Story 1.6, IV2]
  - [ ] Verify error code = `KYC_EXPIRED` in Camunda Cockpit
  - [ ] Verify error message includes expiration details

- [ ] Integration verification: Pending KYC workflow incident (IV3)
  - [ ] Start loan workflow for client with KYC status "Pending"
  - [ ] Verify workflow stops at KYC gate with error incident [Source: prd.md#Story 1.6, IV3]
  - [ ] Verify error code = `KYC_NOT_VERIFIED` in Camunda Cockpit
  - [ ] Verify error message includes KYC status

- [ ] Integration verification: KYC revocation pauses workflows (IV4)
  - [ ] Start multiple loan workflows for same client (e.g., 3 workflows)
  - [ ] Publish `ClientKycRevoked` event to RabbitMQ [Source: prd.md#Story 1.6, IV4]
  - [ ] Verify all active workflows for client paused (status = Paused, workflow variables updated)
  - [ ] Verify `LoanApplicationPaused` audit events published to AdminService for each loan
  - [ ] Verify workflows NOT paused if already completed (Approved, Rejected, Cancelled)

- [ ] Performance verification
  - [ ] Verify worker can handle 10 concurrent KYC verifications without timeout [Source: prd.md#NFR3]
  - [ ] Verify consumer processes revocation events within 30 seconds [Source: prd.md#NFR4]
  - [ ] Verify correlation IDs propagated across all service calls and events [Source: prd.md#NFR5]

- [ ] Documentation
  - [ ] Add README section: "KYC Verification Worker" with job type, error codes, configuration
  - [ ] Add README section: "Event Subscriptions" with event schemas, retry policies
  - [ ] Document Camunda error boundary events for `KYC_NOT_VERIFIED` and `KYC_EXPIRED` in BPMN design documentation

## Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-10-17 | 0.1     | Initial draft created            | SM     |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(To be filled by QA agent)*
