# Story 1.10: End-to-End Workflow Testing and Feature Flag Activation

Status: Draft

## Story

**As a** product owner,  
**I want** comprehensive E2E tests validating the complete loan workflow,  
**so that** we can confidently activate workflow orchestration in production.

## Acceptance Criteria

1. Playwright E2E test: Happy path - KYC verified client → Application → Auto Credit Assessment → Approval (Credit Analyst) → Agreement Generation → Complete
2. Playwright E2E test: KYC block path - Unverified client → Application blocked with clear error message
3. Playwright E2E test: Dual control path - High-value loan → Approval (Head of Credit) → Second Approval (CEO) → Agreement
4. Playwright E2E test: Self-approval block - Loan creator attempts approval → Blocked at both UI and API
5. Load test: 100 concurrent loan applications → All receive unique loan numbers, workflows complete within 24 hours target
6. Rollback test: Disable feature flag `EnableWorkflowOrchestration=false` → CRUD APIs work as before
7. Feature flag activated in staging environment, smoke tests pass
8. Monitoring dashboards configured for workflow metrics (instances by state, approval latencies, agreement generation duration)

## Integration Verification

- **IV1**: Run full regression test suite for existing CRUD APIs → 100% pass rate (no breaking changes)
- **IV2**: Run new E2E workflow tests → 100% pass rate (all scenarios covered)
- **IV3**: Verify monitoring dashboards show real-time workflow state, event counts, performance metrics

## Dev Notes

### Previous Story Insights
- All Stories 1.1-1.9 completed: Foundation (versioning, Vault), Integration (KYC, JasperReports), Workflow (Camunda BPMN), Compliance (dual control), Audit (comprehensive events)
- Feature flag approach allows gradual rollout: workflow can be enabled/disabled without redeployment
- Existing CRUD APIs must remain functional for backward compatibility [Source: prd.md#CR1]

### Current State Problem [Sources]

**Missing Production Readiness Validation**
- No E2E tests validating complete workflow [Source: prd.md#Story 1.10]
- No load testing to verify scalability targets [Source: prd.md#Story 1.10, AC 5]
- No monitoring dashboards for workflow observability [Source: prd.md#Story 1.10, AC 8]
- No feature flag strategy for controlled rollout [Source: prd.md#4.4 Deployment Strategy]

**Business Target**: Sub-24-hour application-to-decision time [Source: prd.md#Epic Success Criteria, line 536]

### E2E Test Scenarios [Sources]

**Test 1: Happy Path** (AC: 1):
```typescript
test('Complete loan workflow - Happy path', async ({ page }) => {
  // 1. Login as loan officer
  await page.goto('/login');
  await page.fill('[name="email"]', 'officer@intellifin.com');
  await page.fill('[name="password"]', 'test123');
  await page.click('button[type="submit"]');
  
  // 2. Create loan application for KYC-verified client
  await page.goto('/loans/new');
  await page.fill('[name="clientId"]', VERIFIED_CLIENT_ID);
  await page.waitForSelector('.client-details-loaded'); // Auto-populated
  await page.fill('[name="amount"]', '25000');
  await page.fill('[name="termMonths"]', '12');
  await page.selectOption('[name="productCode"]', 'GEPL-001');
  
  // Verify EAR calculated and displayed
  await expect(page.locator('.calculated-ear')).toContainText('15.2%');
  
  // Submit application
  await page.click('button:has-text("Submit Application")');
  await expect(page).toHaveURL(/\/loans\/\w+/);
  
  // Verify loan number assigned
  const loanNumber = await page.textContent('.loan-number');
  expect(loanNumber).toMatch(/LUS-2025-\d{5}/);
  
  // 3. Wait for automatic credit assessment
  await page.waitForSelector('.assessment-complete', { timeout: 30000 });
  await expect(page.locator('.risk-grade')).toContainText('Grade: A');
  
  // 4. Login as credit analyst
  await logout(page);
  await login(page, 'analyst@intellifin.com');
  
  // 5. Navigate to approval queue
  await page.goto('/loans/approval-queue');
  await expect(page.locator(`[data-loan-number="${loanNumber}"]`)).toBeVisible();
  
  // 6. Approve loan
  await page.click(`[data-loan-number="${loanNumber}"] button:has-text("Approve")`);
  await page.fill('textarea[name="approvalNotes"]', 'Approved - meets criteria');
  await page.click('button:has-text("Confirm Approval")');
  
  // 7. Verify agreement generation progress
  await page.waitForSelector('.agreement-generating', { timeout: 5000 });
  await page.waitForSelector('.agreement-ready', { timeout: 15000 });
  
  // 8. Verify agreement downloadable
  const downloadPromise = page.waitForEvent('download');
  await page.click('button:has-text("Download Agreement")');
  const download = await downloadPromise;
  expect(download.suggestedFilename()).toContain('.pdf');
  
  // 9. Verify loan status
  await expect(page.locator('.loan-status')).toContainText('Approved');
  
  // 10. Verify audit events published
  // Check AdminService or RabbitMQ for event sequence
});
```
[Source: prd.md#Story 1.10, AC 1]

**Test 2: KYC Block Path** (AC: 2):
```typescript
test('KYC verification blocks loan creation', async ({ page }) => {
  await login(page, 'officer@intellifin.com');
  await page.goto('/loans/new');
  
  // Attempt to create loan for non-verified client
  await page.fill('[name="clientId"]', UNVERIFIED_CLIENT_ID);
  await page.fill('[name="amount"]', '25000');
  await page.click('button:has-text("Submit")');
  
  // Verify error message displayed
  await expect(page.locator('.error-message')).toContainText(
    'KYC verification required'
  );
  await expect(page.locator('.error-code')).toContainText('KYC_NOT_VERIFIED');
  
  // Verify actionable link displayed
  await expect(page.locator('a:has-text("Complete KYC")')).toBeVisible();
  
  // Verify loan NOT created in database
  const response = await fetch(`/api/loanapplication?clientId=${UNVERIFIED_CLIENT_ID}`);
  const loans = await response.json();
  expect(loans.length).toBe(0);
});
```
[Source: prd.md#Story 1.10, AC 2]

**Test 3: Dual Control Path** (AC: 3):
```typescript
test('High-value loan requires dual control approval', async ({ page }) => {
  // Create high-value loan (>250K)
  await login(page, 'officer@intellifin.com');
  const loanNumber = await createLoan(page, { amount: 300000, productCode: 'GEPL-001' });
  
  // Complete credit assessment (simulate or wait)
  await waitForAssessment(page, loanNumber);
  
  // First approval: Head of Credit
  await logout(page);
  await login(page, 'headofcredit@intellifin.com');
  await page.goto('/loans/approval-queue');
  await approveLoan(page, loanNumber, 'First approval - high value');
  
  // Verify loan NOT yet approved (awaiting CEO)
  await expect(page.locator('.loan-status')).toContainText('Pending CEO Approval');
  
  // Verify Head of Credit cannot see CEO approval task (excluded)
  await expect(page.locator('.approval-queue')).not.toContainText(loanNumber);
  
  // Second approval: CEO
  await logout(page);
  await login(page, 'ceo@intellifin.com');
  await page.goto('/loans/approval-queue');
  await approveLoan(page, loanNumber, 'Final approval - CEO authorization');
  
  // Verify loan approved after dual control
  await expect(page.locator('.loan-status')).toContainText('Approved');
  
  // Verify agreement generation triggered
  await page.waitForSelector('.agreement-ready', { timeout: 15000 });
});
```
[Source: prd.md#Story 1.10, AC 3]

**Test 4: Self-Approval Block** (AC: 4):
```typescript
test('Self-approval is blocked', async ({ page, request }) => {
  // Create loan as user A
  await login(page, 'creator@intellifin.com');
  const loanNumber = await createLoan(page, { amount: 25000 });
  await waitForAssessment(page, loanNumber);
  
  // Attempt approval via UI - task should not appear in queue
  await page.goto('/loans/approval-queue');
  await expect(page.locator('.approval-queue')).not.toContainText(loanNumber);
  
  // Attempt approval via API - should be blocked
  const loanId = await getLoanIdByNumber(loanNumber);
  const apiResponse = await request.post(`/api/loanapplication/${loanId}/approve`, {
    data: { approvalNotes: 'Self-approval attempt' },
    headers: { 'Authorization': `Bearer ${await getToken('creator@intellifin.com')}` }
  });
  
  expect(apiResponse.status()).toBe(403);
  const errorBody = await apiResponse.json();
  expect(errorBody.ErrorCode).toBe('DUAL_CONTROL_VIOLATION');
  expect(errorBody.Message).toContain('cannot approve');
  
  // Verify loan status unchanged
  const loanStatus = await getLoanStatus(loanId);
  expect(loanStatus).not.toBe('Approved');
});
```
[Source: prd.md#Story 1.10, AC 4]

### Load Testing [Sources]

**Load Test Configuration** (AC: 5):
```typescript
// Using k6 or Artillery for load testing
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: 100, // 100 virtual users
  duration: '5m',
  thresholds: {
    http_req_duration: ['p(95)<500'], // 95% under 500ms
    http_req_failed: ['rate<0.01'], // <1% failure rate
  },
};

export default function () {
  const payload = JSON.stringify({
    clientId: randomVerifiedClientId(),
    productCode: 'GEPL-001',
    amount: randomBetween(5000, 50000),
    termMonths: randomChoice([6, 12, 18, 24]),
  });
  
  const params = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${__ENV.TEST_TOKEN}`,
    },
  };
  
  const res = http.post('http://localhost:5000/api/loanapplication', payload, params);
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'loan number assigned': (r) => JSON.parse(r.body).loanNumber !== null,
    'response time OK': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}
```

**Load Test Verification**:
- All 100 concurrent requests succeed
- All loan numbers unique (no duplicates from sequence generation)
- Response times <500ms at p95 [Source: prd.md#NFR1]
- All workflows created in Camunda (verify via Operate dashboard)
[Source: prd.md#Story 1.10, AC 5]

### Rollback Testing [Sources]

**Feature Flag Configuration** (AC: 6, 7):
```json
// appsettings.json
{
  "FeatureFlags": {
    "EnableWorkflowOrchestration": false
  }
}
```

**Rollback Test**:
```csharp
// Test with feature flag disabled
[Fact]
public async Task When_WorkflowDisabled_CRUD_APIs_Work()
{
    // Set feature flag to false
    _configuration["FeatureFlags:EnableWorkflowOrchestration"] = "false";
    
    // Create loan via existing API
    var request = new CreateLoanApplicationRequest
    {
        ClientId = Guid.NewGuid(),
        ProductCode = "GEPL-001",
        Amount = 25000,
        TermMonths = 12
    };
    
    var response = await _client.PostAsJsonAsync("/api/loanapplication", request);
    
    // Should succeed without workflow
    response.EnsureSuccessStatusCode();
    var loan = await response.Content.ReadFromJsonAsync<LoanApplicationResponse>();
    
    // Verify loan created with loan number (versioning still works)
    Assert.NotNull(loan.LoanNumber);
    Assert.Equal("Draft", loan.Status);
    
    // Verify NO workflow instance created
    Assert.Null(loan.WorkflowInstanceId);
    
    // Verify existing CRUD operations work
    var getResponse = await _client.GetAsync($"/api/loanapplication/{loan.Id}");
    getResponse.EnsureSuccessStatusCode();
}
```
[Source: prd.md#Story 1.10, AC 6; prd.md#4.4 Deployment Strategy]

### Monitoring Dashboards [Sources]

**Dashboard Requirements** (AC: 8):

**Dashboard 1: Workflow Instances by State**
- Graph: Pie chart or bar chart
- Metrics: Count of loans by Camunda workflow state
  - Active (in progress)
  - Completed
  - Incidents (errors)
  - Paused (KYC revoked)
- Refresh: Real-time (5-second poll)
- Data Source: Camunda Operate API

**Dashboard 2: Approval Latencies**
- Graph: Time series line chart
- Metrics: 
  - p50, p95, p99 approval times (from submission to approval)
  - Broken down by approval level (Credit Analyst, Head of Credit, CEO)
- Alert: If p95 > 4 hours (single approval) or 8 hours (dual control)
- Data Source: AdminService audit events (LoanApplicationSubmitted → LoanApprovalGranted timestamps)

**Dashboard 3: Agreement Generation Duration**
- Graph: Time series histogram
- Metrics:
  - p50, p95, p99 generation times
  - Success rate vs. timeout rate
- Alert: If p95 > 3 seconds or failure rate > 1%
- Data Source: LoanApprovalGranted → LoanAgreementGenerated event timestamps

**Dashboard 4: Loan Numbers Issued**
- Graph: Counter + time series
- Metrics: Total loans created by day/hour, sequence number usage
- Alert: If sequence gaps detected (duplicate prevention verification)
- Data Source: LoanApplicationCreated events

**Dashboard 5: Event Publishing Metrics**
- Graph: Time series line chart
- Metrics:
  - Events published per minute
  - Dead-letter queue depth
  - Event publishing latency
- Alert: If DLQ depth > 100 or publishing latency > 10ms p95
- Data Source: RabbitMQ Management API + AdminService metrics

[Source: prd.md#Story 1.10, AC 8; prd.md#4.4 Monitoring and Logging]

### File Locations [Sources]

- **New E2E Tests**: `tests/E2E/LoanWorkflow.spec.ts` [NEW]
- **New E2E Tests**: `tests/E2E/KYCGating.spec.ts` [NEW]
- **New E2E Tests**: `tests/E2E/DualControl.spec.ts` [NEW]
- **New E2E Tests**: `tests/E2E/SelfApprovalBlock.spec.ts` [NEW]
- **New Load Tests**: `tests/LoadTests/ConcurrentLoans.k6.js` [NEW]
- **New Integration Tests**: `tests/Integration/FeatureFlagRollback.cs` [NEW]
- **Monitoring Config**: `infrastructure/monitoring/dashboards/` [NEW]
  - `workflow-instances.json`
  - `approval-latencies.json`
  - `agreement-generation.json`
  - `event-publishing.json`
- **Feature Flag Config**: `apps/IntelliFin.LoanOriginationService/appsettings.json` [MODIFY]

### Technology Stack [Sources]

**E2E Testing**: Playwright (TypeScript)
- Browser automation for UI testing
- API testing via `request` fixture
- Parallel test execution
- Screenshot/video capture on failure

**Load Testing**: k6 or Artillery
- Simulates 100+ concurrent users
- HTTP request load generation
- Performance metrics collection
- Threshold validation

**Monitoring**: Grafana + Prometheus (or Application Insights)
- Real-time dashboards
- Alert configuration
- Metric aggregation from multiple sources
- Integration with Camunda Operate API

**Feature Flags**: Configuration-based or LaunchDarkly
- `EnableWorkflowOrchestration` flag
- No code changes for rollback
- Environment-specific configuration

### Dependencies
- **Stories 1.1-1.9**: All components operational
- **Camunda 8**: Deployed with monitoring enabled
- **RabbitMQ**: Management API accessible
- **AdminService**: Consuming and storing audit events

## Tasks / Subtasks

- [ ] Set up Playwright test framework
  - [ ] Install Playwright: `npm install -D @playwright/test`
  - [ ] Configure `playwright.config.ts` with test environments
  - [ ] Create test fixtures for authentication, test data
  - [ ] Set up database seeding for test clients (verified/unverified)

- [ ] Write E2E test: Happy path (AC: 1)
  - [ ] Test loan creation with KYC-verified client
  - [ ] Test automatic credit assessment completion
  - [ ] Test approval by credit analyst
  - [ ] Test automatic agreement generation
  - [ ] Verify all UI states and transitions
  - [ ] Verify loan status progression

- [ ] Write E2E test: KYC block path (AC: 2)
  - [ ] Test loan creation attempt with unverified client
  - [ ] Verify error message displayed with error code
  - [ ] Verify actionable guidance (KYC completion link)
  - [ ] Verify loan NOT created in database

- [ ] Write E2E test: Dual control path (AC: 3)
  - [ ] Test high-value loan creation (>250K)
  - [ ] Test first approval by Head of Credit
  - [ ] Verify loan status "Pending CEO Approval"
  - [ ] Test second approval by CEO
  - [ ] Verify loan approved after dual control
  - [ ] Verify agreement generation triggered

- [ ] Write E2E test: Self-approval block (AC: 4)
  - [ ] Test loan creation by user A
  - [ ] Verify approval task NOT in user A's queue (UI)
  - [ ] Test API approval attempt by user A
  - [ ] Verify 403 Forbidden with error code `DUAL_CONTROL_VIOLATION`
  - [ ] Verify loan status unchanged

- [ ] Set up load testing framework (AC: 5)
  - [ ] Install k6 or Artillery
  - [ ] Create load test script for concurrent loan creation
  - [ ] Configure 100 virtual users, 5-minute duration
  - [ ] Set performance thresholds (p95 < 500ms, failure rate < 1%)
  - [ ] Create test data: 100+ verified clients

- [ ] Run load test and verify results (AC: 5)
  - [ ] Execute load test: 100 concurrent loan applications
  - [ ] Verify all requests succeed
  - [ ] Verify all loan numbers unique (query database)
  - [ ] Verify response times meet thresholds
  - [ ] Verify all workflows created in Camunda Operate
  - [ ] Verify system stability (no crashes, no memory leaks)

- [ ] Implement feature flag support
  - [ ] Add `FeatureFlags` section to appsettings.json
  - [ ] Add `EnableWorkflowOrchestration` flag (default: false)
  - [ ] Create `IFeatureFlagProvider` interface
  - [ ] Implement `ConfigurationFeatureFlagProvider`
  - [ ] Register in DI container

- [ ] Modify LoanApplicationService for feature flag (AC: 6)
  - [ ] Inject `IFeatureFlagProvider`
  - [ ] In `CreateApplicationAsync`: Check feature flag
  - [ ] If enabled: Start workflow via WorkflowService
  - [ ] If disabled: Use existing CRUD logic (no workflow)
  - [ ] Maintain backward compatibility

- [ ] Write rollback test (AC: 6)
  - [ ] Test with `EnableWorkflowOrchestration=false`
  - [ ] Verify CRUD APIs work as before
  - [ ] Verify loan created without workflow instance
  - [ ] Verify versioning and loan number generation still work
  - [ ] Verify no workflow events published

- [ ] Configure monitoring dashboards (AC: 8)
  - [ ] Set up Grafana or Application Insights
  - [ ] Create dashboard: Workflow Instances by State
  - [ ] Create dashboard: Approval Latencies (p50, p95, p99)
  - [ ] Create dashboard: Agreement Generation Duration
  - [ ] Create dashboard: Loan Numbers Issued
  - [ ] Create dashboard: Event Publishing Metrics
  - [ ] Configure alerts for threshold violations

- [ ] Integrate with Camunda Operate API
  - [ ] Query workflow instances by state
  - [ ] Query workflow incidents
  - [ ] Aggregate metrics for dashboards
  - [ ] Set up periodic polling (5-second refresh)

- [ ] Integrate with AdminService metrics
  - [ ] Query audit events for latency calculations
  - [ ] Calculate approval times (submission → approval)
  - [ ] Calculate agreement generation times
  - [ ] Export metrics to monitoring system

- [ ] Deploy to staging environment (AC: 7)
  - [ ] Deploy all services (LoanOriginationService, Camunda, RabbitMQ, MinIO, JasperReports)
  - [ ] Configure `EnableWorkflowOrchestration=true` in staging
  - [ ] Run smoke tests: Create 10 loans with various scenarios
  - [ ] Verify all workflows complete successfully
  - [ ] Verify agreements generated
  - [ ] Verify audit events published to AdminService

- [ ] Integration verification: Regression tests (IV1)
  - [ ] Run full regression test suite for existing CRUD APIs
  - [ ] Test loan creation (without workflow)
  - [ ] Test loan retrieval, update, status changes
  - [ ] Test version history queries
  - [ ] Verify 100% pass rate (no breaking changes)

- [ ] Integration verification: E2E tests (IV2)
  - [ ] Run all Playwright E2E tests (4 scenarios)
  - [ ] Verify 100% pass rate
  - [ ] Review test reports for any flaky tests
  - [ ] Fix any test failures or instabilities

- [ ] Integration verification: Monitoring dashboards (IV3)
  - [ ] Verify Workflow Instances dashboard shows real-time data
  - [ ] Verify Approval Latencies dashboard calculates metrics correctly
  - [ ] Verify Agreement Generation dashboard tracks durations
  - [ ] Verify Event Publishing dashboard shows throughput
  - [ ] Test alert triggers (simulate threshold violations)

- [ ] Performance verification
  - [ ] Load test: 100 concurrent loans complete within 24 hours target
  - [ ] Verify database performance (no deadlocks, no slow queries)
  - [ ] Verify Camunda performance (no workflow backlogs)
  - [ ] Verify RabbitMQ performance (no queue backlogs)
  - [ ] Verify MinIO performance (agreement storage)

- [ ] Production readiness checklist
  - [ ] All E2E tests passing
  - [ ] Load tests passing (100 concurrent users)
  - [ ] Monitoring dashboards operational
  - [ ] Alerts configured and tested
  - [ ] Feature flag strategy documented
  - [ ] Rollback procedure documented
  - [ ] Runbook for operations team
  - [ ] Training materials for users

- [ ] Documentation
  - [ ] Add README section: "End-to-End Testing" with test execution instructions
  - [ ] Document load testing procedure and thresholds
  - [ ] Document feature flag strategy and rollback procedure
  - [ ] Document monitoring dashboards and alert thresholds
  - [ ] Create operations runbook for incident response
  - [ ] Create user training guide for new workflow features

## Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-10-17 | 0.1     | Initial draft created            | SM     |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(To be filled by QA agent)*
