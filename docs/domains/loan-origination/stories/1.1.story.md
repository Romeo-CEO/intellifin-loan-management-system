# Story 1.1: Database Schema Enhancement for Loan Versioning

Status: Draft

Story

- As a system architect,
- I want to extend the LoanApplications table with versioning columns and loan number sequencing,
- so that the system can maintain immutable audit history of all loan state changes and generate predictable, auditable loan numbers.

Acceptance Criteria

1. ALTER TABLE migration adds versioning columns (LoanNumber, Version, ParentVersionId, IsCurrentVersion, ModificationReason, SnapshotJson, AgreementFileHash, AgreementMinioPath) as NULLABLE to LoanApplications table
2. LoanNumberSequence table created with BranchCode, Year, NextSequence columns for thread-safe sequence generation
3. Backfill script generates LoanNumber for existing records using format `LUS-2025-{sequence}` ordered by CreatedAtUtc
4. Repository interface extended with `GetCurrentVersionAsync(loanNumber)` and `GetVersionHistoryAsync(loanNumber)` methods
5. All existing queries using `GetByIdAsync(guid)` continue working with <10% performance impact
6. Unit tests verify sequence generation is thread-safe for concurrent requests
7. Rollback migration script tested to remove columns without data loss

Dev Notes

Previous Story Insights
- First story in epic. No prior Dev Agent Record.

Data Models [Sources]
- Required schema additions to LoanApplications: LoanNumber (unique), Version (int), ParentVersionId (GUID, nullable), IsCurrentVersion (bit), SnapshotJson (NVARCHAR(MAX)), AgreementFileHash (NVARCHAR(64)), AgreementMinioPath (NVARCHAR(500)), ModifiedReason, timestamps. Add unique constraint to ensure only one current version per LoanNumber. [Source: domains/loan-origination/brownfield-architecture.md#❌ 4. Loan Versioning]
- Create LoanNumberSequence table with composite PK (BranchCode, Year) and NextSequence integer for thread-safe incrementing. [Source: domains/loan-origination/brownfield-architecture.md#❌ 4. Loan Versioning]
- Maintain backward compatibility: new columns initially nullable; backfill existing records. [Source: domains/loan-origination/prd.md#CR2: Database Schema Compatibility]

API/Repository Specifications [Sources]
- Extend repository with:
  - GetCurrentVersionAsync(loanNumber)
  - GetVersionHistoryAsync(loanNumber)
  - Efficient indexed queries on (LoanNumber, IsCurrentVersion) and LoanNumber for history. [Source: domains/loan-origination/prd.md#Story 1.1]

Component/Service Impact [Sources]
- No API contract breakage; responses unchanged for existing endpoints. Future stories will surface LoanNumber as optional field. [Source: domains/loan-origination/prd.md#CR1: Existing API Compatibility]
- Transactions: version creation and audit publishing are coordinated in later stories; this story focuses on schema only. [Source: domains/loan-origination/prd.md#4.2 Integration Approach]

File Locations (Project Structure Alignment) [Sources]
- EF Core migration files: apps/IntelliFin.LoanOriginationService/Migrations [Source: domains/loan-origination/brownfield-architecture.md#File Structure Approach]
- Domain models (if needed for new fields): apps/IntelliFin.LoanOriginationService/Models/LoanApplicationModels.cs [Source: domains/loan-origination/brownfield-architecture.md#Existing Implementation Files]
- Repository interfaces/impl: apps/IntelliFin.LoanOriginationService/Services or Repositories folders as per existing pattern [Source: domains/loan-origination/brownfield-architecture.md#Existing Implementation Files]

Testing Requirements [Sources]
- Unit tests (xUnit) to validate thread-safe sequence reservation under concurrency for LoanNumberSequence. [Source: domains/loan-origination/prd.md#Story 1.1]
- Integration verification: existing repo tests must pass unchanged; new queries return consistent results. [Source: domains/loan-origination/prd.md#Story 1.1]

Technical Constraints [Sources]
- SQL Server 2022; use ALTER TABLE additive changes, nullable columns, single-transaction migration with rollback on failure. [Source: domains/loan-origination/prd.md#4.2 Integration Approach]
- Performance: maintain <10% degradation for existing GetById queries; add appropriate indexes for new lookups. [Source: domains/loan-origination/prd.md#CR2]

Tasks / Subtasks

- [ ] Create EF Core migration to add versioning columns to LoanApplications (nullable) (AC: 1)
  - [ ] Columns: LoanNumber NVARCHAR(50) UNIQUE (allow NULL initially), Version INT DEFAULT 1, ParentVersionId UNIQUEIDENTIFIER NULL, IsCurrentVersion BIT DEFAULT 1, SnapshotJson NVARCHAR(MAX) NULL, AgreementFileHash NVARCHAR(64) NULL, AgreementMinioPath NVARCHAR(500) NULL, ModifiedReason NVARCHAR(500) NULL, ModifiedAtUtc DATETIME2 NULL (AC: 1) [Source: domains/loan-origination/brownfield-architecture.md#❌ 4. Loan Versioning]
  - [ ] Add filtered unique constraint UQ_CurrentVersion on (LoanNumber, IsCurrentVersion) WHERE IsCurrentVersion = 1 (AC: 1) [Source: domains/loan-origination/brownfield-architecture.md#❌ 4. Loan Versioning]
- [ ] Create migration for LoanNumberSequence table with PK (BranchCode, Year) and NextSequence INT NOT NULL (AC: 2) [Source: domains/loan-origination/brownfield-architecture.md#❌ 4. Loan Versioning]
- [ ] Create nonclustered indexes to preserve performance (AC: 5)
  - [ ] IX_LoanApplications_LoanNumber_IsCurrentVersion
  - [ ] IX_LoanApplications_CreatedAtUtc (if not present) [Source: domains/loan-origination/prd.md#CR2]
- [ ] Backfill script within migration (or seeded job) to populate LoanNumber for existing records ordered by CreatedAtUtc, format LUS-2025-{sequence} (AC: 3) [Source: domains/loan-origination/prd.md#Story 1.1]
- [ ] Update repository interface and implementation with GetCurrentVersionAsync and GetVersionHistoryAsync (AC: 4) [Source: domains/loan-origination/prd.md#Story 1.1]
- [ ] Verify existing queries (GetByIdAsync) still performant; update query hints/indexes if required (AC: 5) [Source: domains/loan-origination/prd.md#CR2]
- [ ] Write unit tests to validate concurrent sequence increments are unique and ordered (50 concurrent tasks) (AC: 6) [Source: domains/loan-origination/prd.md#Story 1.1]
- [ ] Provide rollback migration to drop added columns and table safely (AC: 7)

Project Structure Notes
- Align with apps/IntelliFin.LoanOriginationService structure; do not modify external service contracts. [Source: domains/loan-origination/brownfield-architecture.md#File Structure Approach]

Change Log

| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-10-17 | 0.1     | Initial draft created            | SM     |
