# Story 1.9: Camunda Worker Infrastructure and Topic Registration

## Status
Draft

## Story
**As a** System Architect,  
**I want** to integrate Camunda Zeebe client and register background workers for KYC workflow tasks,  
**so that** the service can participate in BPMN-orchestrated business processes.

## Acceptance Criteria
1. Zeebe .NET Client NuGet package added (version 2.6+)
2. `CamundaWorkerHostedService` created as BackgroundService in `Workflows/CamundaWorkers/`
3. Camunda connection configuration added to appsettings.json: GatewayAddress, WorkerName, MaxJobsToActivate, PollingIntervalSeconds
4. Base worker interface `ICamundaJobHandler` created with HandleJobAsync method
5. Worker registration method created: RegisterWorker<THandler>(topicName, jobType)
6. Example worker `HealthCheckWorker` created for topic `client.health.check` to validate infrastructure
7. Health check endpoint `/health/camunda` added to verify Zeebe gateway connectivity
8. Integration tests with Camunda Test SDK validate worker registration and job handling
9. Configuration includes error handling: retry with exponential backoff, DLQ after 3 failures

## Tasks / Subtasks

- [ ] **Task 1: Add Zeebe .NET Client Package** (AC: 1)
  - [ ] Add NuGet package `Zeebe.Client` version 2.6+
  - [ ] Update `IntelliFin.ClientManagement.csproj` with package reference
  - [ ] Verify package compatibility with .NET 9.0 and other existing dependencies

- [ ] **Task 2: Create Camunda Configuration Section** (AC: 3)
  - [ ] Add `Camunda` section to `appsettings.json` with:
    - `GatewayAddress`: Zeebe gateway endpoint
    - `WorkerName`: Service identifier for worker registration
    - `MaxJobsToActivate`: Concurrent job processing limit (default: 32)
    - `PollingIntervalSeconds`: Job polling frequency (default: 5)
    - `RequestTimeoutSeconds`: Zeebe client timeout (default: 30)
  - [ ] Add development configuration in `appsettings.Development.json`
  - [ ] Create `CamundaOptions` configuration class in `Infrastructure/Configuration/`

- [ ] **Task 3: Create Base Worker Infrastructure** (AC: 4, 5)
  - [ ] Create `ICamundaJobHandler` interface in `Workflows/CamundaWorkers/`
    - Method: `Task HandleJobAsync(IJobClient jobClient, IJob job)`
    - Method: `string GetTopicName()`
    - Method: `string GetJobType()`
  - [ ] Create `CamundaWorkerRegistration` class for worker configuration:
    - Properties: TopicName, JobType, HandlerType, MaxJobsToActivate, TimeoutSeconds
  - [ ] Create worker factory pattern: `ICamundaWorkerFactory` and implementation
  - [ ] Add worker registration extension method: `RegisterWorker<THandler>(topicName, jobType)`

- [ ] **Task 4: Create CamundaWorkerHostedService** (AC: 2)
  - [ ] Create `CamundaWorkerHostedService` inheriting from `BackgroundService`
  - [ ] Implement worker lifecycle:
    - Register all workers with Zeebe client on startup
    - Start long-polling for jobs
    - Handle graceful shutdown (complete in-flight jobs)
  - [ ] Implement error handling with exponential backoff:
    - Retry failed jobs 3 times with 1s, 2s, 4s delays
    - Send to DLQ after max retries exceeded
  - [ ] Add structured logging for worker lifecycle events
  - [ ] Register service in DI container with proper scoping

- [ ] **Task 5: Create Example Health Check Worker** (AC: 6)
  - [ ] Create `HealthCheckWorker` implementing `ICamundaJobHandler`
  - [ ] Configure for topic: `client.health.check`
  - [ ] Implementation:
    - Validate database connectivity
    - Validate MinIO connectivity (if configured)
    - Return job completion with health status
  - [ ] Add unit tests for worker logic
  - [ ] Register worker in DI container

- [ ] **Task 6: Add Camunda Health Check Endpoint** (AC: 7)
  - [ ] Create `CamundaHealthCheck` implementing `IHealthCheck`
  - [ ] Verify Zeebe gateway connectivity:
    - Test connection to configured GatewayAddress
    - Verify worker registration status
    - Check for active job polling
  - [ ] Register health check: `services.AddHealthChecks().AddCheck<CamundaHealthCheck>("camunda")`
  - [ ] Map endpoint: `/health/camunda`
  - [ ] Return appropriate HTTP status codes and diagnostic information

- [ ] **Task 7: Create Zeebe Client Configuration and DI Setup**
  - [ ] Create `ZeebeClientConfiguration` class in `Infrastructure/Configuration/`
  - [ ] Configure Zeebe client with:
    - Gateway address from configuration
    - Authentication (if required)
    - Connection timeout and retry settings
  - [ ] Register Zeebe client in DI as singleton: `IZeebeClient`
  - [ ] Create extension method: `AddCamundaWorkers(this IServiceCollection services, IConfiguration configuration)`
  - [ ] Update `Program.cs` to register Camunda services

- [ ] **Task 8: Implement Error Handling and DLQ Pattern** (AC: 9)
  - [ ] Create `CamundaJobException` custom exception class
  - [ ] Implement retry logic in worker base class:
    - Track retry attempts in job variables
    - Apply exponential backoff between retries
    - Log retry attempts with correlation ID
  - [ ] Implement DLQ handling:
    - After 3 failed attempts, publish job details to DLQ topic
    - Log DLQ events to AdminService (if available)
    - Create admin endpoint to requeue DLQ jobs
  - [ ] Add metrics for job processing:
    - Jobs completed successfully
    - Jobs failed and retried
    - Jobs sent to DLQ

- [ ] **Task 9: Create Integration Tests** (AC: 8)
  - [ ] Add NuGet package: `Camunda.SDK.Test` or equivalent test framework
  - [ ] Create `CamundaWorkerIntegrationTests` test class
  - [ ] Set up test fixtures:
    - Mock or embedded Zeebe test environment
    - Test database container for worker dependencies
  - [ ] Test scenarios:
    - Worker registration and topic subscription
    - Job processing with successful completion
    - Job processing with failure and retry logic
    - DLQ handling after max retries
    - Health check endpoint validation
  - [ ] Verify worker isolation (one worker failure doesn't affect others)

- [ ] **Task 10: Update Service Registration and Startup**
  - [ ] Update `Extensions/ServiceCollectionExtensions.cs` with Camunda registration method
  - [ ] Update `Program.cs` to:
    - Register Camunda services
    - Add Camunda health check
    - Configure logging for Zeebe client
  - [ ] Ensure proper service startup order:
    - Database migrations first
    - Camunda worker registration after all dependencies
  - [ ] Add configuration validation for required Camunda settings

## Dev Notes

### Camunda Integration Architecture
**Source:** [docs/domains/client-management/brownfield-architecture.md#camunda-workflow-architecture]

**Control-Plane Pattern (Reuse from AdminService):**
- **Topic Naming:** `client.{process}.{taskName}` (e.g., `client.kyc.verify-documents`)
- **Correlation:** Always include `CorrelationId` in workflow variables
- **Error Handling:** Retries with exponential backoff → DLQ after max attempts
- **Audit:** Every human task completion → AdminService audit event
- **Worker Pattern:** Long-polling workers in background hosted service

### Zeebe Client Configuration
**Source:** [docs/domains/client-management/brownfield-architecture.md#known-constraint-3]

**Connection Configuration:**
```json
{
  "Camunda": {
    "GatewayAddress": "http://camunda-zeebe-gateway:26500",
    "WorkerName": "IntelliFin.ClientManagement",
    "MaxJobsToActivate": 32,
    "PollingIntervalSeconds": 5,
    "RequestTimeoutSeconds": 30,
    "Topics": [
      "client.kyc.verify-documents",
      "client.kyc.aml-screening", 
      "client.kyc.risk-assessment",
      "client.edd.generate-report"
    ]
  }
}
```

### Worker Implementation Pattern
**Source:** [docs/domains/client-management/brownfield-architecture.md#camunda-worker-infrastructure]

**Base Worker Interface:**
```csharp
public interface ICamundaJobHandler
{
    Task HandleJobAsync(IJobClient jobClient, IJob job);
    string GetTopicName();
    string GetJobType();
}

public class KycVerificationWorker : ICamundaJobHandler
{
    public async Task HandleJobAsync(IJobClient jobClient, IJob job)
    {
        var clientId = job.Variables["clientId"];
        // Execute KYC verification logic
        await jobClient.CompleteJob(job.Key, new { verified = true });
    }
    
    public string GetTopicName() => "client.kyc.verify-documents";
    public string GetJobType() => "io.intellifin.kyc.verify";
}
```

### Error Handling Strategy
**Critical Implementation Details:**

**Retry Pattern:**
- First attempt: Immediate processing
- Retry 1: 1 second delay
- Retry 2: 2 second delay  
- Retry 3: 4 second delay
- After 3 retries: Send to DLQ and fail job permanently

**DLQ Implementation:**
- Publish failed job details to RabbitMQ DLQ exchange
- Include: JobKey, TopicName, Variables, ErrorMessage, AttemptCount
- Log DLQ event to AdminService for audit trail
- Provide admin endpoint to requeue DLQ jobs after fixes

### Health Check Implementation
**Zeebe Gateway Connectivity:**
```csharp
public class CamundaHealthCheck : IHealthCheck
{
    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        try 
        {
            // Test connection to Zeebe gateway
            var topology = await _zeebeClient.TopologyRequestWithRetry()
                .RequestTimeoutSeconds(5)
                .Send(cancellationToken);
                
            return HealthCheckResult.Healthy($"Connected to Zeebe cluster with {topology.Brokers.Count} brokers");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy($"Failed to connect to Zeebe gateway: {ex.Message}", ex);
        }
    }
}
```

### Service Lifecycle Management
**Background Service Pattern:**
- Start workers after all dependencies are ready
- Graceful shutdown: Allow in-flight jobs to complete (max 30s timeout)
- Worker isolation: Failed worker doesn't crash entire service
- Logging: Structured logs with correlation IDs for all worker activities

### Future BPMN Processes
**Planned Workflows (Stories 1.11-1.12):**
- `client_kyc_v1.bpmn` - Standard KYC verification flow
- `client_edd_v1.bpmn` - Enhanced Due Diligence escalation
- `client_document_verification_v1.bpmn` - Dual-control document approval

**Worker Topics to Support:**
- `client.kyc.check-documents` - Document completeness validation
- `client.kyc.aml-screening` - AML sanctions/PEP screening
- `client.kyc.risk-assessment` - Vault-based risk scoring
- `client.edd.generate-report` - EDD report generation

### Tech Stack Integration
**Source:** [docs/domains/client-management/brownfield-architecture.md#enhancement-tech-stack]

**Dependencies:**
- **Zeebe .NET Client:** Version 2.6+ for .NET 9 compatibility
- **Testing:** Camunda Test SDK for BPMN validation
- **Logging:** Structured logging via Serilog (already configured)
- **Monitoring:** OpenTelemetry traces for cross-service workflows

**Service Integration:**
- Workers will call `ClientService`, `DocumentLifecycleService`, etc.
- All database operations through existing EF Core context
- Audit events sent to AdminService via existing audit middleware
- Background processing doesn't block REST API endpoints

### Project Structure After This Story
```
apps/IntelliFin.ClientManagement/
├── Workflows/
│   ├── CamundaWorkers/
│   │   ├── ICamundaJobHandler.cs                   # NEW - Base interface
│   │   ├── CamundaWorkerRegistration.cs            # NEW - Configuration
│   │   ├── CamundaWorkerHostedService.cs           # NEW - Background service
│   │   ├── CamundaWorkerFactory.cs                 # NEW - Worker factory
│   │   └── HealthCheckWorker.cs                    # NEW - Example worker
│   └── BPMN/                                       # Future - BPMN files
├── Infrastructure/
│   ├── Configuration/
│   │   ├── CamundaOptions.cs                       # NEW - Configuration
│   │   └── ZeebeClientConfiguration.cs             # NEW - Client config
│   └── HealthChecks/
│       └── CamundaHealthCheck.cs                   # NEW - Health check
├── Extensions/
│   └── ServiceCollectionExtensions.cs              # UPDATED - Add Camunda DI
└── [existing files from Stories 1.1-1.8]
```

## Testing

### Testing Standards
**Source:** [docs/domains/client-management/prd.md#testing-integration-strategy]

- **Test Framework:** xUnit
- **Integration Tests:** TestContainers for dependencies, Camunda Test SDK for workflows
- **Coverage Target:** 80% for Camunda workers (as specified for workflow components)
- **Test Database:** Separate test database using TestContainers SQL Server
- **Mocking:** WireMock for external service dependencies

### Specific Test Requirements

**Unit Tests:**
1. **Worker Registration Tests:**
   - Verify worker registration with correct topic names
   - Test worker factory creates correct handler instances
   - Validate error handling configuration

2. **Background Service Tests:**
   - Test service startup and shutdown lifecycle
   - Verify graceful handling of worker failures
   - Test retry and DLQ logic with mocked failures

3. **Health Check Tests:**
   - Test successful Zeebe gateway connection
   - Test failure scenarios (gateway unavailable)
   - Verify health check endpoint returns correct status codes

**Integration Tests:**
1. **End-to-End Worker Tests:**
   - Deploy test BPMN with simple service task
   - Verify worker receives and processes jobs
   - Test job completion with variables

2. **Error Handling Tests:**
   - Trigger worker exceptions and verify retry behavior
   - Test DLQ functionality with max retries exceeded
   - Verify error logging and correlation IDs

3. **Service Integration Tests:**
   - Test workers can access database through EF Core
   - Verify workers can call other application services
   - Test audit logging integration (when available)

### Test File Locations
```
tests/IntelliFin.ClientManagement.Tests/
├── Workflows/
│   ├── CamundaWorkers/
│   │   ├── CamundaWorkerHostedServiceTests.cs
│   │   ├── CamundaWorkerFactoryTests.cs
│   │   └── HealthCheckWorkerTests.cs
│   └── Infrastructure/
│       └── CamundaHealthCheckTests.cs

tests/IntelliFin.ClientManagement.IntegrationTests/
├── Workflows/
│   └── CamundaWorkerIntegrationTests.cs
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review.*