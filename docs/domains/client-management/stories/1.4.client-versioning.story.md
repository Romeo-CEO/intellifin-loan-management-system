# Story 1.4: Client Versioning with SCD-2 Temporal Tracking

## Status
Draft

## Story
**As a** Compliance Officer,  
**I want** every client profile change to create a full snapshot version record with ValidFrom/ValidTo timestamps,  
**so that** I can query the customer's profile at any point in time for regulatory audits.

## Acceptance Criteria
1. `ClientVersion` entity class created in `Domain/Entities` with full snapshot fields plus ValidFrom, ValidTo, IsCurrent, VersionNumber, ChangeSummaryJson, ChangeReason, CreatedBy, IpAddress, CorrelationId
2. `ClientVersionConfiguration` EF Core configuration with composite unique index on `(ClientId, VersionNumber)`, index on `(ClientId, ValidFrom, ValidTo)`, index on `(ClientId, IsCurrent)`
3. Database trigger or check constraint ensures only one version can have `IsCurrent = true` per ClientId
4. `ClientVersioningService` created with methods: CreateVersionAsync, GetVersionHistoryAsync, GetVersionAtTimestampAsync
5. ClientService.UpdateClientAsync modified to:
   - Set current version's `IsCurrent = false` and `ValidTo = NOW()`
   - Create new ClientVersion with `IsCurrent = true`, `ValidFrom = NOW()`, `VersionNumber = previous + 1`
   - Update Client entity's `VersionNumber` field
6. New API endpoints:
   - GET /api/clients/{id}/versions (list all versions)
   - GET /api/clients/{id}/versions/{versionNumber} (get specific version)
   - GET /api/clients/{id}/versions/at/{timestamp} (point-in-time query)
7. Unit tests validate versioning logic, including SCD-2 constraints
8. Integration tests verify temporal queries return correct historical snapshots

## Tasks / Subtasks
- [ ] **Task 1: Create ClientVersion Entity** (AC: 1)
  - [ ] Create `ClientVersion.cs` in `Domain/Entities/`
  - [ ] Copy all client data fields from Client entity (full snapshot)
  - [ ] Add temporal tracking fields: ValidFrom, ValidTo, IsCurrent, VersionNumber
  - [ ] Add change tracking fields: ChangeSummaryJson, ChangeReason, CreatedBy, IpAddress, CorrelationId
  - [ ] Add navigation property to Client entity
  - [ ] Add XML comments documenting SCD-2 pattern

- [ ] **Task 2: Create EF Core Configuration for ClientVersion** (AC: 2)
  - [ ] Create `ClientVersionConfiguration.cs` in `Infrastructure/Persistence/Configurations/`
  - [ ] Configure table name `ClientVersions` (plural)
  - [ ] Configure primary key on `Id`
  - [ ] Configure foreign key to Clients table on `ClientId` with cascade delete
  - [ ] Add composite unique index on `(ClientId, VersionNumber)`
  - [ ] Add index on `(ClientId, ValidFrom, ValidTo)` for temporal queries
  - [ ] Add index on `(ClientId, IsCurrent)` for fast current version lookup
  - [ ] Configure all string max lengths matching Client configuration
  - [ ] Register configuration in DbContext

- [ ] **Task 3: Add Database Constraint for Single Current Version** (AC: 3)
  - [ ] Create SQL migration script with check constraint or unique filtered index
  - [ ] Add constraint: `CREATE UNIQUE INDEX IX_ClientVersions_ClientId_IsCurrent ON ClientVersions(ClientId) WHERE IsCurrent = 1`
  - [ ] Test constraint prevents multiple IsCurrent=true versions for same client
  - [ ] Document constraint behavior in migration comments

- [ ] **Task 4: Generate and Apply Migration**
  - [ ] Run `dotnet ef migrations add AddClientVersioning`
  - [ ] Review generated migration for correctness
  - [ ] Apply migration to local development database
  - [ ] Verify ClientVersions table created with all indexes and constraints

- [ ] **Task 5: Create ClientVersioningService** (AC: 4)
  - [ ] Create `IClientVersioningService.cs` interface in `Services/`
  - [ ] Create `ClientVersioningService.cs` implementation
  - [ ] Implement `CreateVersionAsync(Client client, string changeReason, string userId, string ipAddress, string correlationId)`:
    - Create ClientVersion record with full client snapshot
    - Calculate ChangeSummaryJson by comparing with previous version
    - Set ValidFrom = DateTime.UtcNow
    - Set IsCurrent = true
    - Set VersionNumber = (max existing version + 1)
    - Save to database
  - [ ] Implement `GetVersionHistoryAsync(Guid clientId)`:
    - Return all versions ordered by VersionNumber descending
    - Include ValidFrom/ValidTo timestamps
  - [ ] Implement `GetVersionAtTimestampAsync(Guid clientId, DateTime asOfDate)`:
    - Query WHERE ValidFrom <= @asOfDate AND (ValidTo IS NULL OR ValidTo > @asOfDate)
    - Return single version or null if not found
  - [ ] Register service in DI container

- [ ] **Task 6: Modify ClientService.UpdateClientAsync** (AC: 5)
  - [ ] Inject IClientVersioningService into ClientService
  - [ ] Wrap update logic in database transaction
  - [ ] Before updating Client:
    - Load current ClientVersion (WHERE ClientId = @id AND IsCurrent = true)
    - Set current version's IsCurrent = false
    - Set current version's ValidTo = DateTime.UtcNow
    - Save changes
  - [ ] Update Client entity fields
  - [ ] Increment Client.VersionNumber
  - [ ] Call ClientVersioningService.CreateVersionAsync with updated client data
  - [ ] Commit transaction
  - [ ] Handle concurrency conflicts (optimistic concurrency)

- [ ] **Task 7: Create API Endpoints for Version History** (AC: 6)
  - [ ] Add GET /api/clients/{id}/versions endpoint to ClientController:
    - Call ClientVersioningService.GetVersionHistoryAsync
    - Return 200 OK with list of ClientVersionResponse DTOs
  - [ ] Add GET /api/clients/{id}/versions/{versionNumber} endpoint:
    - Query ClientVersion by ClientId and VersionNumber
    - Return 200 OK or 404 Not Found
  - [ ] Add GET /api/clients/{id}/versions/at/{timestamp} endpoint:
    - Parse timestamp from route (ISO 8601 format)
    - Call ClientVersioningService.GetVersionAtTimestampAsync
    - Return 200 OK or 404 Not Found
  - [ ] Create `ClientVersionResponse` DTO with all version fields
  - [ ] Add XML comments for API documentation

- [ ] **Task 8: Create Unit Tests for Versioning Logic** (AC: 7)
  - [ ] Create `ClientVersioningServiceTests.cs`
  - [ ] Test CreateVersionAsync creates version with correct VersionNumber
  - [ ] Test CreateVersionAsync sets ValidFrom to current UTC time
  - [ ] Test CreateVersionAsync calculates ChangeSummaryJson correctly
  - [ ] Test GetVersionHistoryAsync returns versions in descending order
  - [ ] Test GetVersionAtTimestampAsync returns correct historical version
  - [ ] Test GetVersionAtTimestampAsync returns null for future dates
  - [ ] Test UpdateClientAsync creates new version and closes previous version
  - [ ] Test UpdateClientAsync increments VersionNumber
  - [ ] Test database constraint prevents multiple IsCurrent=true versions

- [ ] **Task 9: Create Integration Tests for Temporal Queries** (AC: 8)
  - [ ] Create `ClientVersioningIntegrationTests.cs`
  - [ ] Test update client creates version history
  - [ ] Test GET /api/clients/{id}/versions returns all versions
  - [ ] Test multiple updates create sequential versions (1, 2, 3...)
  - [ ] Test point-in-time query returns version valid at that timestamp
  - [ ] Test point-in-time query for current time returns latest version
  - [ ] Test ValidFrom/ValidTo timestamps are set correctly
  - [ ] Test only one version has IsCurrent=true after updates
  - [ ] Verify temporal query performance < 2 seconds

## Dev Notes

### Previous Story Context
**From Story 1.3:**
- Client entity created with basic CRUD operations
- ClientService implements CreateClientAsync, GetClientByIdAsync, UpdateClientAsync
- Client entity has VersionNumber field (always set to 1 in Story 1.3)
- No versioning logic implemented yetâ€”direct updates to Client table

### ClientVersion Entity Specification
**Source:** [docs/domains/client-management/brownfield-architecture.md#clientversion-entity]

Full ClientVersion entity structure with SCD-2 temporal tracking:

```csharp
public class ClientVersion
{
    public Guid Id { get; set; }                    // Version record ID
    public Guid ClientId { get; set; }              // FK to Client
    public int VersionNumber { get; set; }          // Incremental version (1, 2, 3...)
    
    // Full snapshot of client data at this version
    public string Nrc { get; set; }
    public string? PayrollNumber { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public string? OtherNames { get; set; }
    public DateTime DateOfBirth { get; set; }
    public string Gender { get; set; }
    public string MaritalStatus { get; set; }
    public string? Nationality { get; set; }
    public string? Ministry { get; set; }
    public string? EmployerType { get; set; }
    public string? EmploymentStatus { get; set; }
    public string PrimaryPhone { get; set; }
    public string? SecondaryPhone { get; set; }
    public string? Email { get; set; }
    public string PhysicalAddress { get; set; }
    public string City { get; set; }
    public string Province { get; set; }
    public string KycStatus { get; set; }
    public DateTime? KycCompletedAt { get; set; }
    public string? KycCompletedBy { get; set; }
    public string AmlRiskLevel { get; set; }
    public bool IsPep { get; set; }
    public bool IsSanctioned { get; set; }
    public string RiskRating { get; set; }
    public DateTime? RiskLastAssessedAt { get; set; }
    public string Status { get; set; }
    public Guid BranchId { get; set; }
    
    // Temporal tracking (SCD-2)
    public DateTime ValidFrom { get; set; }         // Start of version validity
    public DateTime? ValidTo { get; set; }          // End of validity (null = current)
    public bool IsCurrent { get; set; }             // Flag for current version
    
    // Change tracking
    public string ChangeSummaryJson { get; set; }   // JSON: {"fields": ["Phone", "Address"], "reason": "..."}
    public string ChangeReason { get; set; }        // Free text reason
    public DateTime CreatedAt { get; set; }
    public string CreatedBy { get; set; }           // User who made the change
    public string? IpAddress { get; set; }
    public string? CorrelationId { get; set; }      // Audit correlation
    
    // Navigation
    public Client Client { get; set; }
}
```

### SCD-2 Versioning Strategy
**Source:** [docs/domains/client-management/brownfield-architecture.md#versioning-strategy]

**Slowly Changing Dimension Type 2 (SCD-2) Pattern:**
- **Full snapshot**: Every version stores complete client state (no deltas)
- **Change summary**: Lightweight JSON for quick diff view without deserializing full records
- **Temporal validity**: ValidFrom/ValidTo timestamps define when version was active
- **Current flag**: IsCurrent=true for latest version, false for historical versions

**Temporal Query Pattern:**
```sql
SELECT * FROM ClientVersions 
WHERE ClientId = @id 
AND @asOfDate BETWEEN ValidFrom AND COALESCE(ValidTo, '9999-12-31')
```

**Version Update Flow:**
1. Client record is updated (e.g., phone number changes)
2. Load current version (IsCurrent=true)
3. Close current version: Set IsCurrent=false, ValidTo=NOW()
4. Create new version: Full snapshot, IsCurrent=true, ValidFrom=NOW(), VersionNumber++
5. Update Client.VersionNumber to match new version

### Database Constraints
**Source:** [docs/domains/client-management/brownfield-architecture.md#database-constraints]

**Indexes:**
- Composite unique index on `(ClientId, VersionNumber)` - ensures no duplicate version numbers
- Index on `(ClientId, ValidFrom, ValidTo)` - optimizes temporal queries
- Index on `(ClientId, IsCurrent)` - fast current version lookup
- Unique filtered index on `(ClientId) WHERE IsCurrent = 1` - ensures only one current version

**Constraints:**
- Foreign key ClientId â†’ Clients(Id) with CASCADE DELETE
- Check constraint: `ValidFrom < ValidTo` (when ValidTo is not null)
- Unique filtered index prevents multiple IsCurrent=true for same ClientId

### ChangeSummaryJson Format
Example ChangeSummaryJson when phone and address are updated:

```json
{
  "fields": ["PrimaryPhone", "PhysicalAddress", "City"],
  "changes": [
    {"field": "PrimaryPhone", "oldValue": "+260211123456", "newValue": "+260211654321"},
    {"field": "PhysicalAddress", "oldValue": "123 Old St", "newValue": "456 New St"},
    {"field": "City", "oldValue": "Lusaka", "newValue": "Kitwe"}
  ],
  "reason": "Customer request",
  "timestamp": "2025-10-16T22:00:00Z"
}
```

### Performance Requirements
**Source:** [docs/domains/client-management/prd.md#database-performance]

- **Current Record Retrieval:** Sub-second (from Client table directly)
- **Temporal Queries:** < 2 seconds for version history (indexed ValidFrom/ValidTo)
- **Point-in-Time Query:** < 2 seconds using temporal index
- **Version History List:** < 1 second for typical client (< 50 versions)

### Transaction Management
**CRITICAL:** Version creation must be transactional:

```csharp
using var transaction = await _context.Database.BeginTransactionAsync();
try
{
    // 1. Close current version (set IsCurrent=false, ValidTo=NOW)
    // 2. Update Client entity
    // 3. Create new ClientVersion (IsCurrent=true, ValidFrom=NOW)
    await _context.SaveChangesAsync();
    await transaction.CommitAsync();
}
catch
{
    await transaction.RollbackAsync();
    throw;
}
```

### Concurrency Handling
- Use optimistic concurrency token on Client entity (RowVersion or Timestamp column)
- If concurrent update detected, retry version creation
- Log concurrency conflicts for monitoring

### Integration Verification Requirements
From PRD Story 1.4:
- **IV1: Existing CRUD Intact:** Client creation and retrieval without versioning parameters still work correctly
- **IV2: Data Integrity:** Check constraint prevents multiple IsCurrent=true versions (test with duplicate insert attempt)
- **IV3: Performance:** Point-in-time queries complete in < 2 seconds with indexed ValidFrom/ValidTo columns

### API Response Format
**ClientVersionResponse DTO:**
```json
{
  "id": "guid",
  "clientId": "guid",
  "versionNumber": 2,
  "firstName": "John",
  "lastName": "Doe",
  "nrc": "123456/78/9",
  "primaryPhone": "+260211123456",
  "validFrom": "2025-10-15T10:00:00Z",
  "validTo": "2025-10-16T14:30:00Z",
  "isCurrent": false,
  "changeSummaryJson": "{...}",
  "changeReason": "Customer request",
  "createdBy": "user-guid",
  "createdAt": "2025-10-15T10:00:00Z"
}
```

### Project Structure After This Story
```
apps/IntelliFin.ClientManagement/
â”œâ”€â”€ Domain/
â”‚   â””â”€â”€ Entities/
â”‚       â”œâ”€â”€ Client.cs                              # From Story 1.3
â”‚       â””â”€â”€ ClientVersion.cs                        # NEW - Versioning entity
â”œâ”€â”€ Infrastructure/
â”‚   â””â”€â”€ Persistence/
â”‚       â”œâ”€â”€ Configurations/
â”‚       â”‚   â”œâ”€â”€ ClientConfiguration.cs              # From Story 1.3
â”‚       â”‚   â””â”€â”€ ClientVersionConfiguration.cs       # NEW - EF Core config
â”‚       â”œâ”€â”€ Migrations/
â”‚       â”‚   â””â”€â”€ YYYYMMDDHHMMSS_AddClientVersioning.cs  # NEW
â”‚       â””â”€â”€ ClientManagementDbContext.cs            # UPDATED - Add DbSet<ClientVersion>
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IClientService.cs                           # From Story 1.3
â”‚   â”œâ”€â”€ ClientService.cs                            # UPDATED - Add versioning logic
â”‚   â”œâ”€â”€ IClientVersioningService.cs                 # NEW
â”‚   â””â”€â”€ ClientVersioningService.cs                  # NEW
â”œâ”€â”€ Controllers/
â”‚   â”œâ”€â”€ DTOs/
â”‚   â”‚   â””â”€â”€ ClientVersionResponse.cs                # NEW
â”‚   â””â”€â”€ ClientController.cs                         # UPDATED - Add version endpoints
â””â”€â”€ [existing files]
```

## Testing

### Testing Standards
**Source:** [docs/domains/client-management/prd.md#testing-integration-strategy]

- **Test Framework:** xUnit
- **Unit Tests:** Test versioning logic in isolation with mocked DbContext
- **Integration Tests:** Use TestContainers with real SQL Server to test temporal queries
- **Coverage Target:** 90% for ClientVersioningService

### Specific Test Cases for This Story

**Unit Tests:**
1. CreateVersionAsync - Creates version with incremented VersionNumber
2. CreateVersionAsync - Sets ValidFrom to current UTC time
3. CreateVersionAsync - Sets IsCurrent=true for new version
4. CreateVersionAsync - Calculates ChangeSummaryJson correctly
5. GetVersionHistoryAsync - Returns versions ordered by VersionNumber descending
6. GetVersionAtTimestampAsync - Returns version valid at specified timestamp
7. GetVersionAtTimestampAsync - Returns null for date before first version
8. UpdateClientAsync - Closes previous version and creates new version atomically
9. UpdateClientAsync - Updates Client.VersionNumber to match new version

**Integration Tests:**
1. Create client â†’ Update client â†’ Verify 2 versions exist
2. Update client 3 times â†’ Verify versions 1, 2, 3, 4 exist with correct VersionNumbers
3. Query version history â†’ Verify all versions returned in correct order
4. Point-in-time query at timestamp T â†’ Verify returns version valid at T
5. Query current version â†’ Verify only latest version has IsCurrent=true
6. Attempt to insert duplicate IsCurrent=true â†’ Verify constraint violation
7. Verify ValidFrom/ValidTo timestamps form continuous timeline without gaps
8. Performance test: Query version history for client with 100 versions < 1 second

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review.*
