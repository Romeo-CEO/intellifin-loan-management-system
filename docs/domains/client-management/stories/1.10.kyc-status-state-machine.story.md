# Story 1.10: KYC Status Entity and State Machine

## Status
Draft

## Story
**As a** KYC Officer,  
**I want** to track the KYC compliance state for each client (Pending, InProgress, Completed, EDD_Required, Rejected),  
**so that** I can see which clients need KYC review and what stage they're in.

## Acceptance Criteria
1. `KycStatus` entity created in `Domain/Entities` with fields: Id, ClientId (unique), CurrentState, KycStartedAt, KycCompletedAt, KycCompletedBy, CamundaProcessInstanceId, HasNrc, HasProofOfAddress, HasPayslip, IsDocumentComplete, AmlScreeningComplete, RequiresEdd, EddReason
2. `KycStatusConfiguration` EF Core configuration with unique index on ClientId
3. `KycWorkflowService` created with methods: InitiateKycAsync, UpdateKycStateAsync, GetKycStatusAsync
4. API endpoints created:
   - POST /api/clients/{id}/kyc/initiate (start KYC workflow)
   - GET /api/clients/{id}/kyc-status (get current state)
   - PUT /api/clients/{id}/kyc/state (update state - called by Camunda workers)
5. State machine validation: Only valid state transitions allowed (e.g., Pending → InProgress → Completed, not Pending → Completed)
6. When KYC initiated: Create KycStatus record with CurrentState=Pending, KycStartedAt=NOW()
7. Unit tests validate state machine transitions

## Tasks / Subtasks

- [ ] **Task 1: Create KycStatus Entity** (AC: 1)
  - [ ] Create `KycStatus.cs` in `Domain/Entities/`
  - [ ] Add properties:
    - `Guid Id` (Primary key)
    - `Guid ClientId` (Foreign key, unique)
    - `string CurrentState` (Pending, InProgress, Completed, EDD_Required, Rejected)
    - `DateTime? KycStartedAt`
    - `DateTime? KycCompletedAt`
    - `string? KycCompletedBy` (User ID who completed KYC)
    - `string? CamundaProcessInstanceId` (Workflow tracking)
  - [ ] Add document completeness flags:
    - `bool HasNrc`
    - `bool HasProofOfAddress`
    - `bool HasPayslip`
    - `bool HasEmploymentLetter`
    - `bool IsDocumentComplete` (Computed field)
  - [ ] Add AML and EDD tracking:
    - `bool AmlScreeningComplete`
    - `DateTime? AmlScreenedAt`
    - `string? AmlScreenedBy`
    - `bool RequiresEdd`
    - `string? EddReason` (PEP, Sanctions, HighRisk, TamperedDoc)
    - `DateTime? EddEscalatedAt`
    - `string? EddReportObjectKey` (MinIO path to EDD report PDF)
    - `string? EddApprovedBy` (Compliance officer)
    - `string? EddCeoApprovedBy` (CEO sign-off)
    - `DateTime? EddApprovedAt`
  - [ ] Add audit fields:
    - `DateTime CreatedAt`
    - `DateTime UpdatedAt`
  - [ ] Add navigation property to `Client` entity

- [ ] **Task 2: Create KycStatus EF Core Configuration** (AC: 2)
  - [ ] Create `KycStatusConfiguration.cs` in `Infrastructure/Persistence/Configurations/`
  - [ ] Configure entity mapping:
    - Set table name to `KycStatuses`
    - Configure `Id` as primary key with `NEWSEQUENTIALID()`
    - Configure `ClientId` as foreign key to `Clients` table
    - Add unique index on `ClientId`
  - [ ] Configure string properties:
    - `CurrentState`: varchar(50), not null
    - `KycCompletedBy`: varchar(256), nullable
    - `CamundaProcessInstanceId`: varchar(128), nullable
    - `EddReason`: varchar(100), nullable
    - `EddReportObjectKey`: varchar(500), nullable
    - `EddApprovedBy`: varchar(256), nullable
    - `EddCeoApprovedBy`: varchar(256), nullable
    - `AmlScreenedBy`: varchar(256), nullable
  - [ ] Add check constraint for valid states:
    - `CHECK (CurrentState IN ('Pending', 'InProgress', 'Completed', 'EDD_Required', 'Rejected'))`
  - [ ] Configure indexes for performance:
    - Index on `(ClientId, CurrentState)` for filtering
    - Index on `KycStartedAt` for reporting

- [ ] **Task 3: Create KYC State Enum and Validation** (AC: 5)
  - [ ] Create `KycState.cs` enum in `Domain/Enums/`
  - [ ] Define enum values:
    - `Pending` - Initial state when KYC is initiated
    - `InProgress` - Document collection and verification started
    - `Completed` - KYC successfully completed
    - `EDD_Required` - Enhanced Due Diligence required
    - `Rejected` - KYC rejected, client cannot proceed
  - [ ] Create `KycStateTransition.cs` class for validation
  - [ ] Define valid state transitions:
    - `Pending → InProgress` (documents being collected)
    - `InProgress → Completed` (successful verification)
    - `InProgress → EDD_Required` (high risk detected)
    - `InProgress → Rejected` (verification failed)
    - `EDD_Required → Completed` (EDD approved)
    - `EDD_Required → Rejected` (EDD rejected)
  - [ ] Create `ValidateStateTransition` method with business logic
  - [ ] Add XML documentation explaining each state and valid transitions

- [ ] **Task 4: Create KycWorkflowService Interface and Implementation** (AC: 3)
  - [ ] Create `IKycWorkflowService.cs` interface in `Services/`
  - [ ] Define service methods:
    - `Task<KycStatusResponse> InitiateKycAsync(Guid clientId, string initiatedBy)`
    - `Task<KycStatusResponse> UpdateKycStateAsync(Guid clientId, KycState newState, UpdateKycStateRequest request)`
    - `Task<KycStatusResponse> GetKycStatusAsync(Guid clientId)`
    - `Task<bool> ValidateStateTransitionAsync(Guid clientId, KycState newState)`
  - [ ] Create `KycWorkflowService.cs` implementation in `Services/`
  - [ ] Implement `InitiateKycAsync`:
    - Check if KycStatus already exists for client
    - If exists and state is not Terminal (Completed/Rejected), throw exception
    - Create new KycStatus with CurrentState=Pending, KycStartedAt=NOW()
    - Save to database and return response
  - [ ] Implement `UpdateKycStateAsync`:
    - Load existing KycStatus
    - Validate state transition is allowed
    - Update state and relevant timestamps/fields
    - Save changes and return updated status
  - [ ] Implement `GetKycStatusAsync`:
    - Load KycStatus with Client navigation property
    - Map to response DTO
  - [ ] Add proper error handling and logging throughout

- [ ] **Task 5: Create DTOs for KYC Operations** 
  - [ ] Create `KycStatusResponse.cs` in `Controllers/DTOs/`
  - [ ] Add properties:
    - `Guid Id`
    - `Guid ClientId`
    - `string ClientName` (from Client navigation)
    - `string CurrentState`
    - `DateTime? KycStartedAt`
    - `DateTime? KycCompletedAt`
    - `string? KycCompletedBy`
    - `bool IsDocumentComplete`
    - `bool AmlScreeningComplete`
    - `bool RequiresEdd`
    - `string? EddReason`
    - `DateTime CreatedAt`
    - `DateTime UpdatedAt`
  - [ ] Create `InitiateKycRequest.cs`:
    - `string? Notes` (optional initiation notes)
  - [ ] Create `UpdateKycStateRequest.cs`:
    - `string NewState`
    - `string? Notes` (reason for state change)
    - `string? CompletedBy` (for completion states)
    - Document completeness flags (for InProgress updates)
    - EDD-related fields (for EDD_Required state)
  - [ ] Add FluentValidation validators for each DTO

- [ ] **Task 6: Create KYC API Endpoints** (AC: 4)
  - [ ] Create `KycController.cs` in `Controllers/`
  - [ ] Add `[Route("api/clients/{clientId:guid}/kyc")]` attribute
  - [ ] Implement `POST /api/clients/{id}/kyc/initiate`:
    - Extract client ID from route
    - Extract user ID from JWT claims
    - Call `KycWorkflowService.InitiateKycAsync`
    - Return 201 Created with KycStatusResponse
    - Handle exceptions: 409 Conflict if KYC already in progress
  - [ ] Implement `GET /api/clients/{id}/kyc-status`:
    - Call `KycWorkflowService.GetKycStatusAsync`
    - Return 200 OK with KycStatusResponse
    - Handle 404 Not Found if client or KYC status doesn't exist
  - [ ] Implement `PUT /api/clients/{id}/kyc/state`:
    - Extract client ID from route
    - Extract user ID from JWT claims (for audit)
    - Call `KycWorkflowService.UpdateKycStateAsync`
    - Return 200 OK with updated KycStatusResponse
    - Handle validation errors: 400 Bad Request for invalid transitions
  - [ ] Add `[Authorize]` attributes and proper error handling
  - [ ] Add XML comments for API documentation

- [ ] **Task 7: Add KycStatus to ClientManagementDbContext**
  - [ ] Update `ClientManagementDbContext.cs` to include `DbSet<KycStatus> KycStatuses`
  - [ ] Register `KycStatusConfiguration` in `OnModelCreating`
  - [ ] Create EF Core migration: `AddKycStatusEntity`
  - [ ] Verify migration creates proper table structure and constraints
  - [ ] Test migration on development database

- [ ] **Task 8: Update Client Entity with KYC Navigation**
  - [ ] Update `Client.cs` entity in `Domain/Entities/`
  - [ ] Add navigation property: `public KycStatus? KycStatus { get; set; }`
  - [ ] Update `ClientConfiguration.cs` to configure relationship:
    - One-to-Zero-or-One relationship between Client and KycStatus
    - Foreign key on KycStatus.ClientId
    - Delete behavior: Cascade (if Client deleted, delete KycStatus)
  - [ ] Update existing Client-related services to optionally include KYC status
  - [ ] Create migration for relationship configuration

- [ ] **Task 9: Implement State Machine Logic and Business Rules**
  - [ ] Create `KycStateMachine.cs` class in `Domain/BusinessRules/`
  - [ ] Implement transition validation logic:
    - Define allowed transitions matrix
    - Implement `CanTransition(KycState from, KycState to)` method
    - Add business rules for each transition
  - [ ] Add document completeness validation:
    - `IsDocumentComplete` computed as `HasNrc && HasProofOfAddress && HasPayslip`
    - Cannot transition to Completed without document completeness
    - Cannot transition to InProgress without at least one document
  - [ ] Add AML screening requirements:
    - Cannot transition to Completed without AML screening
    - High-risk AML results force transition to EDD_Required
  - [ ] Add EDD validation rules:
    - EDD_Required state requires EddReason
    - EDD completion requires both compliance officer and CEO approval
  - [ ] Create unit tests for all business rules

- [ ] **Task 10: Create Comprehensive Unit Tests** (AC: 7)
  - [ ] Create `KycWorkflowServiceTests.cs` in test project
  - [ ] Test `InitiateKycAsync`:
    - Successful initiation creates KycStatus with Pending state
    - Cannot initiate if KYC already exists and not in terminal state
    - Can re-initiate if previous KYC was Completed or Rejected
  - [ ] Test `UpdateKycStateAsync`:
    - Valid transitions succeed and update state correctly
    - Invalid transitions throw appropriate exceptions
    - Document flags are updated correctly for InProgress state
    - Timestamps are set correctly for each state
  - [ ] Test state transition validation:
    - All valid transitions pass validation
    - Invalid transitions (e.g., Pending → Completed) are rejected
    - Business rules are enforced (e.g., documents required for completion)
  - [ ] Test edge cases:
    - Updating non-existent KYC status
    - Concurrent state updates
    - Malformed state values
  - [ ] Create `KycStateMachineTests.cs` for business rule validation
  - [ ] Mock dependencies: DbContext, audit service, user context

- [ ] **Task 11: Create Integration Tests**
  - [ ] Create `KycWorkflowIntegrationTests.cs` 
  - [ ] Set up TestContainers for SQL Server database
  - [ ] Test complete KYC workflow scenarios:
    - Happy path: Initiate → InProgress → Completed
    - EDD path: Initiate → InProgress → EDD_Required → Completed
    - Rejection path: Initiate → InProgress → Rejected
  - [ ] Test API endpoints end-to-end:
    - POST /kyc/initiate creates proper database records
    - GET /kyc-status returns correct status
    - PUT /kyc/state updates database correctly
  - [ ] Test database constraints:
    - Unique constraint on ClientId
    - Foreign key constraints work correctly
    - Check constraints prevent invalid states
  - [ ] Test audit logging integration (if available)

- [ ] **Task 12: Update Service Registration and DI**
  - [ ] Update `Extensions/ServiceCollectionExtensions.cs`
  - [ ] Register `IKycWorkflowService` and `KycWorkflowService`
  - [ ] Register FluentValidation validators for KYC DTOs
  - [ ] Update `Program.cs` if needed for additional configuration
  - [ ] Verify all dependencies are properly injected

## Dev Notes

### KYC Status State Machine Design
**Source:** [docs/domains/client-management/brownfield-architecture.md#kycstatus-compliance-state-machine]

**Entity Purpose:** Track KYC/AML workflow state per client

**State Definitions:**
- **Pending:** KYC initiated but document collection not started
- **InProgress:** Documents being collected and verified  
- **Completed:** KYC successfully completed, client approved
- **EDD_Required:** Enhanced Due Diligence required (high risk, PEP, sanctions)
- **Rejected:** KYC rejected, client cannot proceed with services

**Valid State Transitions:**
```
Pending → InProgress (documents being collected)
InProgress → Completed (successful verification)
InProgress → EDD_Required (high risk detected)
InProgress → Rejected (verification failed)
EDD_Required → Completed (EDD approved by compliance + CEO)
EDD_Required → Rejected (EDD rejected)
```

**Invalid Transitions:**
- Cannot go directly from Pending to Completed (must collect documents)
- Cannot go from Completed to any other state (terminal state)
- Cannot go from Rejected to any other state without re-initiation

### Document Completeness Logic
**Source:** [docs/domains/client-management/prd.md#fr6-kyc-workflow-orchestration]

**Required Documents for KYC:**
- **HasNrc:** National Registration Card (identity document)
- **HasProofOfAddress:** Utility bill, bank statement (address verification)
- **HasPayslip:** Employment verification for salaried clients
- **HasEmploymentLetter:** Alternative employment verification

**Computed Field Logic:**
```csharp
public bool IsDocumentComplete => HasNrc && HasProofOfAddress && 
    (HasPayslip || HasEmploymentLetter);
```

**Business Rules:**
- Cannot transition from Pending to InProgress without at least one document uploaded
- Cannot transition to Completed without `IsDocumentComplete = true`
- Document flags updated when documents are uploaded/verified via Story 1.8

### Integration with Previous Stories
**Client Entity Integration (Story 1.3-1.4):**
- KycStatus has foreign key to Client.Id
- Client entity gets navigation property to KycStatus
- Client.KycStatus field updated when KYC state changes

**Document Integration (Stories 1.6-1.8):**
- Document upload triggers update to HasNrc, HasProofOfAddress, etc.
- Document verification (dual-control) updates IsDocumentComplete
- ClientDocument.DocumentType maps to KycStatus document flags

**Audit Integration (Story 1.5):**
- All KYC state changes logged to AdminService
- Include previous state, new state, user who made change
- Correlation ID tracking for audit trail

### Future Camunda Integration
**Source:** [docs/domains/client-management/prd.md#story-111-kyc-verification-workflow-implementation]

**Workflow Integration Points:**
- `InitiateKycAsync` will eventually trigger Camunda workflow start
- Camunda workers will call `UpdateKycStateAsync` during workflow execution
- `CamundaProcessInstanceId` field tracks which workflow instance is processing this KYC
- State updates will publish domain events for workflow coordination

**Reserved for Future Stories:**
- AML screening logic (Story 1.12)
- EDD escalation workflow (Story 1.12) 
- Risk assessment integration (Story 1.13)
- Event-driven notifications (Story 1.14)

### Database Schema Details
**Table: KycStatuses**
```sql
CREATE TABLE KycStatuses (
    Id uniqueidentifier PRIMARY KEY DEFAULT NEWSEQUENTIALID(),
    ClientId uniqueidentifier NOT NULL,
    CurrentState varchar(50) NOT NULL CHECK (CurrentState IN ('Pending', 'InProgress', 'Completed', 'EDD_Required', 'Rejected')),
    KycStartedAt datetime2(7),
    KycCompletedAt datetime2(7), 
    KycCompletedBy varchar(256),
    CamundaProcessInstanceId varchar(128),
    HasNrc bit NOT NULL DEFAULT 0,
    HasProofOfAddress bit NOT NULL DEFAULT 0,
    HasPayslip bit NOT NULL DEFAULT 0,
    HasEmploymentLetter bit NOT NULL DEFAULT 0,
    IsDocumentComplete AS (CASE WHEN HasNrc = 1 AND HasProofOfAddress = 1 AND (HasPayslip = 1 OR HasEmploymentLetter = 1) THEN 1 ELSE 0 END),
    AmlScreeningComplete bit NOT NULL DEFAULT 0,
    AmlScreenedAt datetime2(7),
    AmlScreenedBy varchar(256),
    RequiresEdd bit NOT NULL DEFAULT 0,
    EddReason varchar(100),
    EddEscalatedAt datetime2(7),
    EddReportObjectKey varchar(500),
    EddApprovedBy varchar(256),
    EddCeoApprovedBy varchar(256), 
    EddApprovedAt datetime2(7),
    CreatedAt datetime2(7) NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt datetime2(7) NOT NULL DEFAULT GETUTCDATE(),
    CONSTRAINT FK_KycStatuses_ClientId FOREIGN KEY (ClientId) REFERENCES Clients(Id) ON DELETE CASCADE,
    CONSTRAINT UQ_KycStatuses_ClientId UNIQUE (ClientId)
);

CREATE INDEX IX_KycStatuses_ClientId_CurrentState ON KycStatuses(ClientId, CurrentState);
CREATE INDEX IX_KycStatuses_KycStartedAt ON KycStatuses(KycStartedAt);
```

### API Response Examples
**GET /api/clients/{id}/kyc-status Response:**
```json
{
  "id": "guid",
  "clientId": "guid",
  "clientName": "John Banda",
  "currentState": "InProgress",
  "kycStartedAt": "2025-10-17T08:30:00Z",
  "kycCompletedAt": null,
  "kycCompletedBy": null,
  "isDocumentComplete": false,
  "amlScreeningComplete": false,
  "requiresEdd": false,
  "eddReason": null,
  "createdAt": "2025-10-17T08:30:00Z",
  "updatedAt": "2025-10-17T08:45:00Z"
}
```

**PUT /api/clients/{id}/kyc/state Request:**
```json
{
  "newState": "InProgress",
  "notes": "Documents uploaded, starting verification",
  "hasNrc": true,
  "hasProofOfAddress": true,
  "hasPayslip": false,
  "hasEmploymentLetter": true
}
```

### Error Handling Patterns
**State Transition Validation:**
```csharp
public class InvalidKycStateTransitionException : Exception
{
    public KycState FromState { get; }
    public KycState ToState { get; }
    public string Reason { get; }
    
    public InvalidKycStateTransitionException(KycState from, KycState to, string reason)
        : base($"Invalid KYC state transition from {from} to {to}: {reason}")
    {
        FromState = from;
        ToState = to; 
        Reason = reason;
    }
}
```

**Business Rule Violations:**
- 409 Conflict: KYC already exists and in progress
- 400 Bad Request: Invalid state transition
- 422 Unprocessable Entity: Business rule violation (e.g., documents incomplete)
- 404 Not Found: Client or KYC status not found

### Performance Considerations
**Database Indexes:**
- Primary key on Id (clustered)
- Unique index on ClientId (most common lookup)
- Composite index on (ClientId, CurrentState) for filtering
- Index on KycStartedAt for reporting queries

**Query Patterns:**
- Most queries will be by ClientId (1:1 relationship)
- Reporting queries by CurrentState and date ranges
- Computed column `IsDocumentComplete` avoids repeated calculation

### Project Structure After This Story
```
apps/IntelliFin.ClientManagement/
├── Domain/
│   ├── Entities/
│   │   ├── KycStatus.cs                        # NEW - KYC state entity
│   │   └── Client.cs                           # UPDATED - Add KYC navigation
│   ├── Enums/
│   │   └── KycState.cs                         # NEW - State enumeration
│   └── BusinessRules/
│       ├── KycStateMachine.cs                  # NEW - State transition logic
│       └── KycStateTransition.cs               # NEW - Validation rules
├── Services/
│   ├── IKycWorkflowService.cs                  # NEW - Service interface
│   └── KycWorkflowService.cs                   # NEW - Service implementation
├── Controllers/
│   ├── KycController.cs                        # NEW - KYC API endpoints
│   └── DTOs/
│       ├── KycStatusResponse.cs                # NEW - Response DTO
│       ├── InitiateKycRequest.cs               # NEW - Initiation request
│       └── UpdateKycStateRequest.cs            # NEW - State update request
├── Infrastructure/
│   └── Persistence/
│       ├── Configurations/
│       │   └── KycStatusConfiguration.cs       # NEW - EF configuration
│       ├── ClientManagementDbContext.cs        # UPDATED - Add KycStatus DbSet
│       └── Migrations/
│           └── {timestamp}_AddKycStatusEntity.cs # NEW - Migration
└── [existing files from Stories 1.1-1.9]
```

## Testing

### Testing Standards
**Source:** [docs/domains/client-management/prd.md#testing-integration-strategy]

- **Test Framework:** xUnit with Moq for mocking
- **Coverage Target:** 100% for domain entities (KYC is critical compliance feature)
- **Integration Tests:** TestContainers for SQL Server to test EF Core configurations
- **Test Database:** Separate test database with proper schema

### Specific Test Cases for This Story

**Unit Tests - KycWorkflowService:**
1. **InitiateKycAsync Tests:**
   - Successful initiation creates KycStatus with Pending state
   - Cannot initiate KYC if already exists and not in terminal state  
   - Can re-initiate if previous KYC was Completed or Rejected
   - Proper audit logging and timestamp setting

2. **UpdateKycStateAsync Tests:**
   - Valid state transitions update state and timestamps correctly
   - Invalid transitions throw InvalidKycStateTransitionException
   - Document completeness flags updated correctly
   - Business rules enforced (documents required for completion)

3. **GetKycStatusAsync Tests:**
   - Returns correct KycStatusResponse with client information
   - Handles non-existent KYC status gracefully
   - Navigation properties loaded correctly

**Unit Tests - KycStateMachine:**
1. **State Transition Validation:**
   - All valid transitions pass validation
   - Invalid transitions properly rejected with clear reasons
   - Business rule validation (documents, AML screening)

2. **Document Completeness Logic:**
   - IsDocumentComplete computed correctly
   - Different combinations of required documents
   - Edge cases with missing documents

**Integration Tests:**
1. **Database Integration:**
   - EF Core mapping works correctly
   - Unique constraints enforced
   - Check constraints prevent invalid states
   - Cascade delete behavior works

2. **API Integration:**
   - End-to-end KYC workflow through API endpoints
   - Proper HTTP status codes returned
   - Request/response serialization correct
   - Authentication and authorization working

3. **Complete KYC Scenarios:**
   - Happy path: Pending → InProgress → Completed
   - EDD escalation path
   - Rejection scenarios
   - Re-initiation after completion/rejection

### Test File Structure
```
tests/IntelliFin.ClientManagement.Tests/
├── Services/
│   └── KycWorkflowServiceTests.cs
├── Domain/
│   ├── Entities/
│   │   └── KycStatusTests.cs
│   └── BusinessRules/
│       └── KycStateMachineTests.cs
└── Controllers/
    └── KycControllerTests.cs

tests/IntelliFin.ClientManagement.IntegrationTests/
├── Services/
│   └── KycWorkflowIntegrationTests.cs
└── Controllers/
    └── KycApiIntegrationTests.cs
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review.*