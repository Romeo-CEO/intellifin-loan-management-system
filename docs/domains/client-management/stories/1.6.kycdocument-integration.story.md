# Story 1.6: KycDocumentService Integration (Phase 1 - HTTP Client)

## Status
Draft

## Story
**As a** Loan Officer,  
**I want** to upload KYC documents for a client and have them stored in MinIO via KycDocumentService,  
**so that** I can attach supporting documents to customer profiles without duplicating MinIO integration logic.

## Acceptance Criteria
1. `KycDocumentServiceClient.cs` Refit interface created in `Integration/` with:
   - POST /documents (upload document)
   - GET /documents/{id} (retrieve document metadata)
   - GET /documents/{id}/download (get pre-signed URL)
2. `ClientDocument` entity created in `Domain/Entities` with fields: Id, ClientId, DocumentType, Category, ObjectKey (MinIO path), BucketName, FileName, ContentType, FileSizeBytes, FileHashSha256, UploadStatus, UploadedAt, UploadedBy, VerifiedAt, VerifiedBy, ExpiryDate, RetentionUntil
3. `DocumentLifecycleService` created with methods: UploadDocumentAsync (calls KycDocumentService), GetDocumentMetadataAsync, GenerateDownloadUrlAsync
4. API endpoints created:
   - POST /api/clients/{id}/documents (multipart/form-data file upload)
   - GET /api/clients/{id}/documents (list documents for client)
   - GET /api/clients/{id}/documents/{docId} (get document metadata)
   - GET /api/clients/{id}/documents/{docId}/download (get pre-signed URL)
5. Document upload flow:
   - Validate file size (max 10MB), content type (PDF, JPG, PNG)
   - Call KycDocumentService to store in MinIO
   - Store metadata in ClientDocument table with ObjectKey from response
   - Set RetentionUntil = NOW() + 7 years
6. Integration tests with WireMock for KycDocumentService

## Tasks / Subtasks
- [ ] **Task 1: Create KycDocumentService Client Interface** (AC: 1)
  - [ ] Add `IKycDocumentServiceClient.cs` in `Integration/`
  - [ ] Define Refit method `Task<UploadDocumentResponse> UploadDocumentAsync([Body] MultipartFormDataContent content)`
  - [ ] Define method `Task<DocumentMetadataResponse> GetDocumentMetadataAsync(Guid documentId)`
  - [ ] Define method `Task<DownloadUrlResponse> GetDownloadUrlAsync(Guid documentId)`
  - [ ] Add Refit attributes: `[Post("/documents")]`, `[Get("/documents/{documentId}")]`, `[Get("/documents/{documentId}/download")]`
  - [ ] Configure Refit client in DI with KycDocumentService base URL from appsettings.json
  - [ ] Add timeout configuration (60 seconds for uploads)

- [ ] **Task 2: Create DTOs for KycDocumentService** 
  - [ ] Create `UploadDocumentRequest.cs` (metadata for upload)
  - [ ] Create `UploadDocumentResponse.cs` (documentId, objectKey, bucket, hash)
  - [ ] Create `DocumentMetadataResponse.cs` (all document properties)
  - [ ] Create `DownloadUrlResponse.cs` (presignedUrl, expiresAt)
  - [ ] Ensure DTOs match existing KycDocumentService schema (no breaking changes)

- [ ] **Task 3: Create ClientDocument Entity** (AC: 2)
  - [ ] Create `ClientDocument.cs` in `Domain/Entities/`
  - [ ] Add all properties from architecture specification:
    - Id, ClientId, DocumentType, Category
    - ObjectKey, BucketName, FileName, ContentType, FileSizeBytes, FileHashSha256
    - UploadStatus (enum: Uploaded, PendingVerification, Verified, Rejected)
    - UploadedAt, UploadedBy, VerifiedAt, VerifiedBy, RejectionReason
    - ExpiryDate, RetentionUntil, IsArchived, ArchivedAt
    - ExtractedDataJson, OcrConfidenceScore
    - CamundaProcessInstanceId, CorrelationId
  - [ ] Add navigation property to Client entity
  - [ ] Add XML comments for all properties

- [ ] **Task 4: Create EF Core Configuration for ClientDocument** 
  - [ ] Create `ClientDocumentConfiguration.cs` in `Infrastructure/Persistence/Configurations/`
  - [ ] Configure table name `ClientDocuments` (plural)
  - [ ] Configure foreign key to Clients table with CASCADE DELETE
  - [ ] Configure indexes on: ClientId, UploadStatus, ExpiryDate
  - [ ] Configure string max lengths matching requirements
  - [ ] Configure required vs optional fields
  - [ ] Register configuration in DbContext

- [ ] **Task 5: Generate and Apply Migration** 
  - [ ] Run `dotnet ef migrations add AddClientDocument`
  - [ ] Review generated migration
  - [ ] Apply migration to local development database
  - [ ] Verify ClientDocuments table created with all constraints

- [ ] **Task 6: Create DocumentLifecycleService** (AC: 3)
  - [ ] Create `IDocumentLifecycleService.cs` interface in `Services/`
  - [ ] Create `DocumentLifecycleService.cs` implementation
  - [ ] Implement `UploadDocumentAsync(Guid clientId, IFormFile file, string documentType, string userId)`:
    - Validate file size (max 10MB)
    - Validate content type (PDF, JPG, PNG)
    - Calculate SHA256 hash of file content
    - Create MultipartFormDataContent with file and metadata
    - Call KycDocumentServiceClient.UploadDocumentAsync
    - Create ClientDocument entity with response data
    - Set RetentionUntil = DateTime.UtcNow.AddYears(7)
    - Set UploadedBy = userId, UploadStatus = Uploaded
    - Save to database
    - Return DocumentMetadataResponse
  - [ ] Implement `GetDocumentMetadataAsync(Guid clientId, Guid documentId)`:
    - Load ClientDocument from database
    - Verify document belongs to client
    - Return metadata
  - [ ] Implement `GenerateDownloadUrlAsync(Guid clientId, Guid documentId, string userId)`:
    - Load ClientDocument from database
    - Call KycDocumentServiceClient.GetDownloadUrlAsync
    - Log download access to audit (Story 1.5)
    - Return pre-signed URL
  - [ ] Implement `ListDocumentsAsync(Guid clientId)`:
    - Query all documents for client
    - Return list of DocumentMetadataResponse
  - [ ] Register service in DI container

- [ ] **Task 7: Create API Endpoints for Document Management** (AC: 4)
  - [ ] Create `ClientDocumentController.cs` in `Controllers/`
  - [ ] Add POST /api/clients/{id}/documents endpoint:
    - Accept IFormFile from multipart/form-data
    - Extract userId from JWT claims
    - Call DocumentLifecycleService.UploadDocumentAsync
    - Return 201 Created with document metadata
  - [ ] Add GET /api/clients/{id}/documents endpoint:
    - Call DocumentLifecycleService.ListDocumentsAsync
    - Return 200 OK with list of documents
  - [ ] Add GET /api/clients/{id}/documents/{docId} endpoint:
    - Call DocumentLifecycleService.GetDocumentMetadataAsync
    - Return 200 OK or 404 Not Found
  - [ ] Add GET /api/clients/{id}/documents/{docId}/download endpoint:
    - Extract userId from JWT claims
    - Call DocumentLifecycleService.GenerateDownloadUrlAsync
    - Return 200 OK with pre-signed URL
  - [ ] Add `[Authorize]` attribute to all endpoints
  - [ ] Add XML comments for API documentation

- [ ] **Task 8: Implement File Validation Logic** (AC: 5)
  - [ ] Create `DocumentValidator.cs` helper class
  - [ ] Validate file size: max 10MB (10 * 1024 * 1024 bytes)
  - [ ] Validate content types: application/pdf, image/jpeg, image/png
  - [ ] Validate file extension matches content type
  - [ ] Calculate SHA256 hash for integrity verification
  - [ ] Return validation errors with clear messages

- [ ] **Task 9: Integrate with Audit Service** 
  - [ ] Call AuditService.LogAuditEventAsync after document upload (Action: DocumentUploaded)
  - [ ] Include EventData: documentType, fileName, fileSize, hash
  - [ ] Call AuditService for document download (Action: DocumentDownloaded)
  - [ ] Include EventData: documentId, downloadedBy

- [ ] **Task 10: Create Integration Tests with WireMock** (AC: 6)
  - [ ] Create `KycDocumentServiceIntegrationTests.cs`
  - [ ] Start WireMock server for KycDocumentService
  - [ ] Stub POST /documents endpoint to return success response
  - [ ] Stub GET /documents/{id} endpoint
  - [ ] Stub GET /documents/{id}/download endpoint with pre-signed URL
  - [ ] Test document upload → Verify KycDocumentService called correctly
  - [ ] Test document upload → Verify ClientDocument record created in database
  - [ ] Test document upload → Verify SHA256 hash computed correctly
  - [ ] Test document upload → Verify RetentionUntil set to 7 years from now
  - [ ] Test file size validation → Files > 10MB rejected with 400 Bad Request
  - [ ] Test content type validation → Invalid types rejected
  - [ ] Test download URL generation → Verify pre-signed URL returned
  - [ ] Test audit logging → Verify DocumentUploaded and DocumentDownloaded events logged

## Dev Notes

### Previous Story Context
**From Story 1.3:**
- Client entity created with navigation property for Documents collection

**From Story 1.5:**
- AuditService available for logging document actions
- Audit events batched and sent to AdminService

### KycDocumentService Overview
**Source:** [docs/domains/client-management/brownfield-architecture.md#related-services]

**KycDocumentService Purpose:**
- Existing service for document upload/verification
- Already has MinIO integration working
- Handles SHA256 hashing, Object Lock, and pre-signed URLs

**Why Phase 1 Uses KycDocumentService:**
- Avoid duplicating MinIO client logic initially
- Leverage existing, tested document storage patterns
- Reduce initial implementation complexity
- Phase 2 (Story 1.17) will migrate to internal MinIO integration

### ClientDocument Entity Specification
**Source:** [docs/domains/client-management/brownfield-architecture.md#clientdocument-entity]

Full ClientDocument entity structure:

```csharp
public class ClientDocument
{
    public Guid Id { get; set; }
    public Guid ClientId { get; set; }              // FK to Client
    
    // Document classification
    public string DocumentType { get; set; }        // NRC, Payslip, ProofOfResidence, etc.
    public string Category { get; set; }            // KYC, Loan, Compliance, General
    
    // MinIO storage
    public string ObjectKey { get; set; }           // MinIO object path (e.g., clients/{clientId}/nrc-{guid}.pdf)
    public string BucketName { get; set; }          // MinIO bucket (e.g., kyc-documents)
    public string FileName { get; set; }            // Original filename
    public string ContentType { get; set; }         // MIME type
    public long FileSizeBytes { get; set; }
    public string FileHashSha256 { get; set; }      // Content hash for integrity
    
    // Dual-control workflow (Story 1.8)
    public string UploadStatus { get; set; }        // Uploaded, PendingVerification, Verified, Rejected
    public DateTime UploadedAt { get; set; }
    public string UploadedBy { get; set; }          // Officer who uploaded
    public DateTime? VerifiedAt { get; set; }
    public string? VerifiedBy { get; set; }         // Different officer (Story 1.8)
    public string? RejectionReason { get; set; }
    public string? CamundaProcessInstanceId { get; set; }  // Workflow tracking (Story 1.11)
    
    // Compliance
    public DateTime? ExpiryDate { get; set; }       // For expiring documents (e.g., NRC)
    public DateTime RetentionUntil { get; set; }    // BoZ 7-year retention (auto-calculated)
    public bool IsArchived { get; set; }
    public DateTime? ArchivedAt { get; set; }
    
    // Metadata (future OCR integration)
    public string? ExtractedDataJson { get; set; }  // OCR results
    public float? OcrConfidenceScore { get; set; }
    
    // Audit
    public DateTime CreatedAt { get; set; }
    public string? CorrelationId { get; set; }
    
    // Navigation
    public Client Client { get; set; }
}
```

### KycDocumentService API Contract
**Expected Existing API (from KycDocumentService):**

```
POST /documents
Content-Type: multipart/form-data
Fields: file (binary), documentType (string), clientId (string)
Response: UploadDocumentResponse
{
  "documentId": "guid",
  "objectKey": "clients/{clientId}/nrc-{guid}.pdf",
  "bucketName": "kyc-documents",
  "fileHashSha256": "abc123...",
  "fileSizeBytes": 123456,
  "uploadedAt": "2025-10-16T22:00:00Z"
}

GET /documents/{documentId}
Response: DocumentMetadataResponse
{
  "id": "guid",
  "objectKey": "...",
  "bucketName": "...",
  "fileName": "nrc.pdf",
  "contentType": "application/pdf",
  "fileSizeBytes": 123456,
  "fileHashSha256": "abc123...",
  "uploadedAt": "2025-10-16T22:00:00Z"
}

GET /documents/{documentId}/download
Response: DownloadUrlResponse
{
  "presignedUrl": "https://minio.../...",
  "expiresAt": "2025-10-16T23:00:00Z"  // 1 hour expiry
}
```

### Document Type Categories
**Source:** [docs/domains/client-management/prd.md#document-upload-and-metadata-storage]

**Document Types (KYC):**
- `NRC` - National Registration Card
- `Payslip` - Recent payslip (last 3 months)
- `ProofOfResidence` - Utility bill, tenancy agreement
- `EmploymentLetter` - Official employment letter
- `BankStatement` - Bank statement (optional)

**Categories:**
- `KYC` - Know Your Customer documents
- `Loan` - Loan-specific documents
- `Compliance` - Regulatory compliance documents
- `General` - Other documents

### File Validation Requirements
**Source:** [docs/domains/client-management/prd.md#document-upload-and-metadata-storage]

**File Size:**
- Maximum: 10MB (10 * 1024 * 1024 bytes)
- Rationale: Balance between quality and upload time

**Content Types (Allowed):**
- `application/pdf` - PDF documents
- `image/jpeg` - JPEG images
- `image/png` - PNG images

**Security:**
- Validate file extension matches content type (prevent spoofing)
- Calculate SHA256 hash for integrity verification
- Scan for malware (future enhancement, not in this story)

### BoZ 7-Year Retention Compliance
**Source:** [docs/domains/client-management/prd.md#minio-object-lock-retention]

**Retention Policy:**
- All KYC documents must be retained for 7 years from upload date
- Enforced via MinIO Object Lock in COMPLIANCE mode
- RetentionUntil = UploadedAt + 7 years
- Documents cannot be deleted before RetentionUntil expires

**MinIO Object Lock Configuration:**
- Mode: COMPLIANCE (cannot be bypassed even by admin)
- Alternative: GOVERNANCE mode (admin can override with special permission)
- Retention period set at object level, not bucket level

### Pre-Signed URL Pattern
**Purpose:** Secure document downloads without exposing MinIO credentials

**Flow:**
1. Client requests download URL via API
2. DocumentLifecycleService calls KycDocumentService
3. KycDocumentService generates pre-signed MinIO URL (1 hour expiry)
4. Client uses pre-signed URL to download directly from MinIO
5. Pre-signed URL expires after 1 hour (configurable)

**Security:**
- Pre-signed URLs are time-limited (1 hour default)
- Download access logged to audit trail
- No MinIO credentials exposed to clients

### Integration Verification Requirements
From PRD Story 1.6:
- **IV1: KycDocumentService Contract:** HTTP requests match existing KycDocumentService API schema
- **IV2: MinIO Storage:** Documents successfully stored in MinIO bucket with 7-year Object Lock retention
- **IV3: Metadata Consistency:** ClientDocument SQL records match MinIO object metadata (FileHashSha256, FileSizeBytes)

### Error Handling
- **400 Bad Request:** File size exceeds 10MB, invalid content type, missing required fields
- **404 Not Found:** Client not found, document not found
- **409 Conflict:** Document with same hash already exists for client (duplicate upload)
- **413 Payload Too Large:** File exceeds maximum size
- **500 Internal Server Error:** KycDocumentService unavailable, MinIO error

### Configuration in appsettings.json
```json
{
  "KycDocumentService": {
    "BaseUrl": "https://kyc-docs.intellifin.local",
    "Timeout": "00:01:00",
    "MaxFileSizeBytes": 10485760,
    "AllowedContentTypes": ["application/pdf", "image/jpeg", "image/png"]
  },
  "DocumentRetention": {
    "RetentionYears": 7
  }
}
```

### Project Structure After This Story
```
apps/IntelliFin.ClientManagement/
├── Domain/
│   └── Entities/
│       ├── Client.cs                              # From Story 1.3
│       └── ClientDocument.cs                       # NEW - Document entity
├── Infrastructure/
│   └── Persistence/
│       ├── Configurations/
│       │   └── ClientDocumentConfiguration.cs      # NEW - EF Core config
│       ├── Migrations/
│       │   └── YYYYMMDDHHMMSS_AddClientDocument.cs # NEW
│       └── ClientManagementDbContext.cs            # UPDATED - Add DbSet<ClientDocument>
├── Integration/
│   ├── DTOs/
│   │   ├── UploadDocumentRequest.cs                # NEW
│   │   ├── UploadDocumentResponse.cs               # NEW
│   │   ├── DocumentMetadataResponse.cs             # NEW
│   │   └── DownloadUrlResponse.cs                  # NEW
│   └── IKycDocumentServiceClient.cs                # NEW - Refit interface
├── Services/
│   ├── IDocumentLifecycleService.cs                # NEW
│   ├── DocumentLifecycleService.cs                 # NEW
│   └── DocumentValidator.cs                        # NEW - Helper class
├── Controllers/
│   └── ClientDocumentController.cs                 # NEW - Document API
└── [existing files from Stories 1.1-1.5]
```

## Testing

### Testing Standards
**Source:** [docs/domains/client-management/prd.md#testing-integration-strategy]

- **Test Framework:** xUnit
- **Mocking:** WireMock for KycDocumentService, Moq for services
- **Integration Tests:** TestContainers for SQL Server
- **Coverage Target:** 90% for DocumentLifecycleService

### Specific Test Cases for This Story

**Unit Tests:**
1. UploadDocumentAsync - Valid file → Document uploaded and metadata saved
2. UploadDocumentAsync - File > 10MB → Throws validation exception
3. UploadDocumentAsync - Invalid content type → Throws validation exception
4. GetDocumentMetadataAsync - Existing document → Returns metadata
5. GetDocumentMetadataAsync - Non-existent document → Returns null
6. GenerateDownloadUrlAsync - Valid document → Returns pre-signed URL
7. SHA256 hash calculation → Verifies hash matches file content

**Integration Tests with WireMock:**
1. **Document Upload Flow:**
   - Upload PDF file via API
   - Verify WireMock received POST /documents
   - Verify ClientDocument record created with correct metadata
   - Verify RetentionUntil set to 7 years from now
   - Verify audit event logged

2. **File Validation:**
   - Upload 11MB file → 400 Bad Request
   - Upload .exe file → 400 Bad Request
   - Upload file with mismatched extension/content → 400 Bad Request

3. **Document Retrieval:**
   - List documents for client → Returns all documents
   - Get document metadata → Returns correct metadata
   - Get download URL → Returns pre-signed URL from KycDocumentService

4. **Error Handling:**
   - KycDocumentService unavailable → Retry with exponential backoff
   - MinIO error → Clear error message returned to client

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review.*
