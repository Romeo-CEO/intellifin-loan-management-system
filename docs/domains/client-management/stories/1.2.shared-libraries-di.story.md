# Story 1.2: Shared Library References and Dependency Injection Configuration

## Status
Draft

## Story
**As a** Backend Developer,  
**I want** to add all required shared library references and configure dependency injection for core services,  
**so that** the service can use common authentication, audit, validation, and infrastructure patterns from other IntelliFin services.

## Acceptance Criteria
1. Project references added for:
   - `IntelliFin.Shared.Authentication` (JWT validation)
   - `IntelliFin.Shared.Audit` (audit abstractions)
   - `IntelliFin.Shared.DomainModels` (shared types)
   - `IntelliFin.Shared.Infrastructure` (common utilities)
   - `IntelliFin.Shared.Validation` (FluentValidation helpers)
2. `ServiceCollectionExtensions.cs` created in `Extensions/` folder with DI registration methods
3. JWT authentication configured in `Program.cs` with IdentityService as token authority
4. Global exception handling middleware registered
5. FluentValidation configured for automatic model validation
6. Correlation ID middleware added to inject correlation IDs into all log entries

## Tasks / Subtasks
- [ ] **Task 1: Add Shared Library Project References** (AC: 1)
  - [ ] Add project reference to `IntelliFin.Shared.Authentication`
  - [ ] Add project reference to `IntelliFin.Shared.Audit`
  - [ ] Add project reference to `IntelliFin.Shared.DomainModels`
  - [ ] Add project reference to `IntelliFin.Shared.Infrastructure`
  - [ ] Add project reference to `IntelliFin.Shared.Validation`
  - [ ] Add NuGet package `FluentValidation.AspNetCore` version 11.9+
  - [ ] Verify all packages restore correctly

- [ ] **Task 2: Create DI Extension Methods** (AC: 2)
  - [ ] Create directory `Extensions/` in project root
  - [ ] Create `ServiceCollectionExtensions.cs` class with static extension methods
  - [ ] Create method `AddClientManagementServices(this IServiceCollection services, IConfiguration configuration)`
  - [ ] Register placeholder service interfaces (to be implemented in future stories)
  - [ ] Add method `AddClientManagementInfrastructure(this IServiceCollection services, IConfiguration configuration)` for infrastructure registration
  - [ ] Document each registration method with XML comments

- [ ] **Task 3: Configure JWT Authentication** (AC: 3)
  - [ ] Add authentication configuration section to appsettings.json with IdentityService endpoint
  - [ ] Call `AddAuthentication()` and `AddJwtBearer()` in Program.cs
  - [ ] Configure JWT validation parameters: issuer, audience, signing key
  - [ ] Add `app.UseAuthentication()` to request pipeline before endpoints
  - [ ] Add `app.UseAuthorization()` to request pipeline
  - [ ] Test authentication with mock JWT token (unauthorized without token, authorized with valid token)

- [ ] **Task 4: Add Global Exception Handling Middleware** (AC: 4)
  - [ ] Create `Middleware/GlobalExceptionHandlerMiddleware.cs` class
  - [ ] Implement middleware to catch all unhandled exceptions
  - [ ] Log exceptions with correlation ID and stack trace
  - [ ] Return consistent error response format: `{ "error": "message", "correlationId": "...", "timestamp": "..." }`
  - [ ] Register middleware early in pipeline (after logging, before authentication)
  - [ ] Test middleware catches exceptions and returns 500 Internal Server Error

- [ ] **Task 5: Configure FluentValidation** (AC: 5)
  - [ ] Call `AddFluentValidationAutoValidation()` in Program.cs
  - [ ] Configure validation to return 400 Bad Request with validation errors
  - [ ] Create example validator class `CreateClientRequestValidator` (placeholder for Story 1.3)
  - [ ] Test validation with invalid request (should return 400 with validation errors)

- [ ] **Task 6: Add Correlation ID Middleware** (AC: 6)
  - [ ] Create `Middleware/CorrelationIdMiddleware.cs` class
  - [ ] Check for `X-Correlation-ID` header in incoming request
  - [ ] Generate new correlation ID (GUID) if not present
  - [ ] Add correlation ID to `HttpContext.Items` and response headers
  - [ ] Configure Serilog to enrich all log entries with correlation ID from HttpContext
  - [ ] Register middleware early in pipeline (first middleware)
  - [ ] Test correlation ID appears in logs and response headers

## Dev Notes

### Previous Story Context
**From Story 1.1:**
- Database foundation and EF Core setup completed
- `ClientManagementDbContext` registered in DI
- Vault integration for connection strings implemented
- Health check for database connectivity added

### Shared Library Architecture
**Source:** [docs/domains/client-management/brownfield-architecture.md#key-shared-libraries]

The IntelliFin platform provides several shared libraries that encapsulate common functionality:

| Library | Purpose | Usage in Client Management |
|---------|---------|---------------------------|
| `IntelliFin.Shared.Observability` | Serilog + OTEL | ✅ Already configured in Story 1.1 |
| `IntelliFin.Shared.Audit` | Audit abstractions | Will use for audit event creation (Story 1.5) |
| `IntelliFin.Shared.Authentication` | JWT validation | **THIS STORY** - API authentication |
| `IntelliFin.Shared.DomainModels` | Shared domain types | **THIS STORY** - Extend with Client types |
| `IntelliFin.Shared.Infrastructure` | Common infra utilities | **THIS STORY** - DbContext base, retry policies |
| `IntelliFin.Shared.Validation` | Validation helpers | **THIS STORY** - FluentValidation integration |

### Authentication Requirements
**Source:** [docs/domains/client-management/prd.md#api-integration-strategy]

- **Authentication:** JWT bearer tokens from IdentityService with claims-based authorization
- **Token Authority:** IdentityService (endpoint configured in appsettings.json)
- **Claims Structure:** 
  - `sub` - User ID
  - `role` - User role (kyc-officer, compliance-officer, ceo, admin)
  - `branch_id` - Branch ID for multi-branch support
- **Authorization:** Claims-based authorization on endpoints (e.g., `[Authorize(Roles = "kyc-officer")]`)

**Expected JWT Configuration:**
```json
{
  "Authentication": {
    "Authority": "https://identity.intellifin.local",
    "Audience": "intellifin.client-management",
    "RequireHttpsMetadata": true,
    "ValidateIssuer": true,
    "ValidateAudience": true,
    "ValidateLifetime": true
  }
}
```

### Middleware Order Requirements
**Source:** [docs/domains/client-management/brownfield-architecture.md#coding-standards]

Middleware must be registered in the correct order in the request pipeline:

1. **Correlation ID Middleware** (first - tracks all requests)
2. **Global Exception Handler** (early - catches all downstream errors)
3. **Logging Middleware** (from Shared.Observability - already configured)
4. **Authentication Middleware** (`UseAuthentication()`)
5. **Authorization Middleware** (`UseAuthorization()`)
6. **Endpoints** (`MapControllers()`, health checks, etc.)

**CRITICAL:** Incorrect middleware order can cause authentication failures or missing correlation IDs in logs.

### Coding Standards
**Source:** [docs/domains/client-management/prd.md#coding-standards]

- Follow existing `IntelliFin.Shared.*` patterns from other services
- Nullable reference types enabled (`<Nullable>enable</Nullable>`) - already set
- Async/await for all I/O operations
- Use Result<T> pattern for operation outcomes (from Shared.Infrastructure if available)
- Global exception handling via middleware
- FluentValidation for input validation
- Structured logging with Serilog (correlation IDs on all log entries)

### Exception Handling Pattern
The global exception handler should:
- Log exceptions with ERROR level including correlation ID, user ID (if authenticated), request path
- Return consistent error response structure
- Hide sensitive stack traces in production
- Include detailed error info in Development environment only
- Return HTTP status codes:
  - 400 Bad Request - Validation errors
  - 401 Unauthorized - Missing/invalid JWT token
  - 403 Forbidden - Insufficient permissions
  - 404 Not Found - Resource not found
  - 500 Internal Server Error - Unhandled exceptions

### FluentValidation Configuration
**Source:** [docs/domains/client-management/prd.md#validation]

- **NuGet Package:** FluentValidation.AspNetCore 11.9+
- **Auto-Validation:** Enabled for all API endpoints
- **Validator Naming:** `{DtoName}Validator` (e.g., `CreateClientRequestValidator`)
- **Validator Location:** Co-located with DTOs in `Controllers/` or separate `Validators/` directory
- **Error Format:** Consistent with ASP.NET Core ModelState errors

Example validator structure:
```csharp
public class CreateClientRequestValidator : AbstractValidator<CreateClientRequest>
{
    public CreateClientRequestValidator()
    {
        RuleFor(x => x.Nrc).NotEmpty().Length(11).WithMessage("NRC must be 11 characters");
        RuleFor(x => x.FirstName).NotEmpty().MaximumLength(100);
        // ... other rules
    }
}
```

### Correlation ID Pattern
**Source:** [docs/domains/client-management/prd.md#observability]

- **Header Name:** `X-Correlation-ID`
- **Format:** GUID (e.g., `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)
- **Behavior:**
  - If present in request → Use it
  - If not present → Generate new GUID
  - Always include in response headers
  - Always enrich Serilog log entries with correlation ID
- **Purpose:** Enable distributed tracing across services and correlate logs for troubleshooting

### Integration Verification Requirements
From PRD Story 1.2:
- **IV1: Authentication Works:** Protected endpoints return 401 Unauthorized without valid JWT token
- **IV2: Logging Consistency:** Correlation IDs appear in all log entries matching pattern from other services
- **IV3: Shared Behavior:** Exception handling returns consistent error responses matching other IntelliFin services

### Testing Requirements
- **Unit Tests:** Not applicable (infrastructure configuration)
- **Integration Tests:**
  - Test authentication with valid JWT returns 200 OK
  - Test authentication without JWT returns 401 Unauthorized
  - Test exception handler catches unhandled errors and returns 500
  - Test correlation ID generated when missing
  - Test correlation ID preserved from request header
  - Test FluentValidation returns 400 Bad Request with validation errors

### Project Structure After This Story
```
apps/IntelliFin.ClientManagement/
├── Extensions/
│   └── ServiceCollectionExtensions.cs        # NEW - DI registration
├── Middleware/
│   ├── CorrelationIdMiddleware.cs            # NEW - Correlation ID injection
│   └── GlobalExceptionHandlerMiddleware.cs    # NEW - Global error handling
├── Infrastructure/
│   └── Persistence/
│       └── ClientManagementDbContext.cs       # From Story 1.1
├── Program.cs                                 # UPDATED - Add authentication, middleware
├── appsettings.json                           # UPDATED - Add authentication config
└── [existing files]
```

## Testing

### Testing Standards
**Source:** [docs/domains/client-management/prd.md#testing-integration-strategy]

- **Test Framework:** xUnit
- **Mocking:** Moq or NSubstitute for service mocks
- **Integration Tests:** Use WebApplicationFactory for in-memory API testing
- **Test Coverage:** Not applicable for this story (infrastructure configuration)

### Specific Test Cases for This Story

1. **Authentication Test - Valid Token:**
   - Create mock JWT token with valid claims
   - Call protected endpoint with Authorization header
   - Assert returns 200 OK

2. **Authentication Test - Missing Token:**
   - Call protected endpoint without Authorization header
   - Assert returns 401 Unauthorized

3. **Exception Handler Test:**
   - Create endpoint that throws exception
   - Call endpoint
   - Assert returns 500 Internal Server Error with consistent error format

4. **Correlation ID Test - Auto-Generated:**
   - Call any endpoint without `X-Correlation-ID` header
   - Assert response includes `X-Correlation-ID` header with GUID format
   - Assert correlation ID appears in logs

5. **Correlation ID Test - Preserved:**
   - Call endpoint with `X-Correlation-ID: test-123` header
   - Assert response includes same `X-Correlation-ID: test-123` header
   - Assert logs contain same correlation ID

6. **FluentValidation Test:**
   - Create validator for test DTO
   - Call endpoint with invalid data
   - Assert returns 400 Bad Request with validation errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review.*
