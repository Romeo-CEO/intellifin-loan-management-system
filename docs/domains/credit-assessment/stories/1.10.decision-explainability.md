# Story 1.10: Decision Explainability and Human-Readable Reasoning

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to generate human-readable explanations for every credit decision  
**so that** credit officers and clients understand why applications were approved or rejected

## Acceptance Criteria

1. Implement explanation generator service that converts rule evaluation results to natural language
2. List all rules evaluated with pass/fail status and reason
3. Highlight top 3 most impactful rules (by absolute weighted score contribution)
4. Generate decision summary: "Approved because composite score 720 falls in Grade B (650-749)"
5. Include affordability summary: "DTI ratio 35% within 40% threshold, affordable payment ZMW 3,500"
6. List any triggered conditions for conditional approvals
7. Provide clear rejection reasons when decision is "Rejected"
8. Include data sources used (e.g., "TransUnion credit score: 680, PMEC salary: ZMW 12,000")
9. Format explanation in markdown for easy rendering in UI
10. Store full explanation in `score_explanation` field of assessment record

## Tasks / Subtasks

- [ ] Create ExplanationService (AC: 1)
  - [ ] Create `Services/Core/ExplanationService.cs`
  - [ ] Implement `GenerateExplanation` method
  - [ ] Accept assessment, rule results, affordability data as input
  - [ ] Return markdown-formatted string

- [ ] Generate rule evaluation summary (AC: 2)
  - [ ] List all rules that were evaluated
  - [ ] Show pass/fail status with icon (✓ or ✗)
  - [ ] Include brief reason for each rule result
  - [ ] Format as bulleted list in markdown

- [ ] Identify and highlight impactful rules (AC: 3)
  - [ ] Calculate absolute weighted score contribution for each rule
  - [ ] Sort rules by impact (absolute value)
  - [ ] Take top 3 rules
  - [ ] Highlight in explanation with "**Key Factors**" heading
  - [ ] Include both positive and negative impacts

- [ ] Generate decision summary (AC: 4)
  - [ ] Create decision statement based on outcome
  - [ ] Include composite score and risk grade
  - [ ] Explain why grade was assigned (threshold ranges)
  - [ ] State final decision clearly

- [ ] Generate affordability summary (AC: 5)
  - [ ] Show DTI ratio with percentage
  - [ ] Compare against threshold (40%)
  - [ ] Show monthly payment amount
  - [ ] Show disposable income after payment
  - [ ] State if affordable or not

- [ ] Handle conditional approvals (AC: 6)
  - [ ] Check if decision is "Conditional"
  - [ ] List conditions that must be met
  - [ ] Format as numbered list
  - [ ] Explain why conditions are required

- [ ] Generate rejection reasons (AC: 7)
  - [ ] Identify which rules failed most significantly
  - [ ] Provide clear, specific reasons
  - [ ] Avoid jargon, use plain language
  - [ ] Suggest what could improve chances

- [ ] Include data source attribution (AC: 8)
  - [ ] List income source (PMEC vs declared)
  - [ ] List credit score source (TransUnion)
  - [ ] Include verification statuses
  - [ ] Note if any data was unavailable

- [ ] Format as markdown (AC: 9)
  - [ ] Use headings (##, ###)
  - [ ] Use bold for emphasis
  - [ ] Use bullet points for lists
  - [ ] Use tables where appropriate
  - [ ] Ensure readable on both web and PDF

- [ ] Store in assessment record (AC: 10)
  - [ ] Save explanation to `score_explanation` field
  - [ ] Ensure field is large enough (TEXT type)
  - [ ] Include in assessment response DTO

## Dev Notes

### Explanation Generation Implementation
[Source: docs/domains/credit-assessment/prd.md#FR12]

```csharp
public class ExplanationService : IExplanationService
{
    public string GenerateExplanation(
        CreditAssessment assessment,
        RuleEvaluationResult ruleResult,
        AffordabilityResult affordability,
        DataSourceInfo dataSources)
    {
        var sb = new StringBuilder();
        
        // Decision Summary
        sb.AppendLine($"## Credit Assessment Decision: **{ruleResult.Decision}**");
        sb.AppendLine();
        sb.AppendLine($"**Risk Grade**: {ruleResult.RiskGrade}");
        sb.AppendLine($"**Composite Score**: {ruleResult.CompositeScore:F0}");
        sb.AppendLine();
        
        // Decision Explanation
        sb.AppendLine(GenerateDecisionExplanation(ruleResult));
        sb.AppendLine();
        
        // Key Factors
        sb.AppendLine("### Key Factors");
        sb.AppendLine();
        var topRules = ruleResult.RuleEvaluations
            .OrderByDescending(r => Math.Abs(r.WeightedScore))
            .Take(3);
        
        foreach (var rule in topRules)
        {
            var icon = rule.Passed ? "✓" : "✗";
            var impact = rule.WeightedScore > 0 ? "Positive" : "Negative";
            sb.AppendLine($"- {icon} **{rule.RuleName}** ({impact} impact: {rule.WeightedScore:+0;-0} points)");
            sb.AppendLine($"  - {rule.Explanation}");
        }
        sb.AppendLine();
        
        // Affordability Summary
        sb.AppendLine("### Affordability Analysis");
        sb.AppendLine();
        sb.AppendLine($"- **Monthly Income**: ZMW {affordability.MonthlyIncome:N2}");
        sb.AppendLine($"- **Existing Obligations**: ZMW {affordability.ExistingObligations:N2}");
        sb.AppendLine($"- **Proposed Payment**: ZMW {affordability.ProposedPayment:N2}");
        sb.AppendLine($"- **Debt-to-Income Ratio**: {affordability.DebtToIncomeRatio:P1} (Threshold: 40%)");
        sb.AppendLine($"- **Disposable Income**: ZMW {affordability.DisposableIncome:N2}");
        sb.AppendLine();
        
        if (affordability.IsAffordable)
        {
            sb.AppendLine("✓ **Application is affordable** based on income and existing obligations.");
        }
        else
        {
            sb.AppendLine("✗ **Application exceeds affordable payment capacity**.");
        }
        sb.AppendLine();
        
        // Data Sources
        sb.AppendLine("### Data Sources");
        sb.AppendLine();
        sb.AppendLine($"- **Income Source**: {dataSources.IncomeSource}");
        sb.AppendLine($"- **Credit Score**: TransUnion ({dataSources.CreditScore})");
        sb.AppendLine($"- **KYC Status**: {dataSources.KycStatus}");
        sb.AppendLine();
        
        // All Rules Evaluated
        sb.AppendLine("### Detailed Rule Evaluation");
        sb.AppendLine();
        foreach (var rule in ruleResult.RuleEvaluations)
        {
            var icon = rule.Passed ? "✓" : "✗";
            sb.AppendLine($"- {icon} {rule.RuleName}: {rule.Explanation}");
        }
        
        return sb.ToString();
    }
    
    private string GenerateDecisionExplanation(RuleEvaluationResult result)
    {
        return result.Decision switch
        {
            "Approved" => $"Application **approved** with composite score {result.CompositeScore:F0}, " +
                         $"which falls in Grade {result.RiskGrade} (acceptable risk level).",
            
            "Conditional" => $"Application **conditionally approved** with Grade {result.RiskGrade}. " +
                            "Additional conditions must be met before final approval.",
            
            "ManualReview" => $"Application requires **manual review** by credit officer. " +
                             $"Composite score {result.CompositeScore:F0} (Grade {result.RiskGrade}) " +
                             "indicates borderline risk requiring human judgment.",
            
            "Rejected" => $"Application **rejected** with composite score {result.CompositeScore:F0} " +
                         $"(Grade {result.RiskGrade}), indicating risk level exceeds acceptable thresholds.",
            
            _ => "Decision could not be determined."
        };
    }
}
```

### Example Generated Explanation
[Source: docs/domains/credit-assessment/prd.md#FR12]

```markdown
## Credit Assessment Decision: **Approved**

**Risk Grade**: B
**Composite Score**: 720

Application **approved** with composite score 720, which falls in Grade B (acceptable risk level).

### Key Factors

- ✓ **Credit Bureau Score Threshold** (Positive impact: +75 points)
  - Credit score 680 exceeds minimum threshold of 550
- ✓ **Debt-to-Income Ratio** (Positive impact: +90 points)
  - DTI ratio 35% is within 40% threshold
- ✓ **Employment Tenure** (Positive impact: +15 points)
  - Employment tenure 36 months exceeds minimum 12 months

### Affordability Analysis

- **Monthly Income**: ZMW 12,000.00
- **Existing Obligations**: ZMW 2,000.00
- **Proposed Payment**: ZMW 2,500.00
- **Debt-to-Income Ratio**: 37.5% (Threshold: 40%)
- **Disposable Income**: ZMW 7,500.00

✓ **Application is affordable** based on income and existing obligations.

### Data Sources

- **Income Source**: PMEC_VERIFIED
- **Credit Score**: TransUnion (680)
- **KYC Status**: Verified

### Detailed Rule Evaluation

- ✓ Maximum Loan-to-Income Ratio: Requested amount ZMW 50,000 is 4.2x monthly income (within 10x limit)
- ✓ Debt-to-Income Ratio: Total debt 37.5% is within 40% threshold
- ✓ Credit Bureau Score Threshold: Credit score 680 exceeds minimum 550
- ✓ Employment Tenure: 36 months exceeds minimum 12 months
- ✓ Maximum Client Exposure: Total exposure ZMW 50,000 is within limit
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.10]

**IV1**: Explanations are comprehensible to non-technical users (validated by credit officers)  
**IV2**: All key decision factors are included in explanation  
**IV3**: Explanation includes both positive factors (what helped) and negative factors (what hurt)

### Testing

#### Unit Tests
- Explanation generation produces valid markdown
- Top 3 rules correctly identified by impact
- Decision summaries match decision types
- Affordability summary calculations correct

#### Integration Tests
- Generated explanation stored in database
- Explanation included in API response
- Markdown renders correctly in UI

#### User Acceptance Testing
- Credit officers can understand explanations
- Clients can understand rejection reasons
- All decision factors are clear and actionable

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
