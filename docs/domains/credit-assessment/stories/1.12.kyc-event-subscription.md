# Story 1.12: KYC Status Event Subscription and Assessment Invalidation

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to subscribe to KYC status change events and automatically invalidate affected assessments  
**so that** credit decisions are always based on current, valid KYC verification

## Acceptance Criteria

1. Create `KYCStatusEventHandler` consuming RabbitMQ events from Client Management Service
2. Subscribe to event types: `KYCExpired`, `KYCRevoked`, `KYCUpdated`
3. For `KYCExpired` and `KYCRevoked` events, find all active assessments for affected client
4. Update assessments: set `is_valid = false`, set `invalid_reason` with event details
5. Publish audit event to AdminService for each invalidated assessment
6. For `KYCUpdated` events, check if verification status improved and log for potential reassessment
7. Implement idempotent event handling (duplicate events don't cause duplicate invalidations)
8. Log event processing metrics (latency, success rate)
9. Implement dead letter queue for failed event processing
10. Provide admin API to manually invalidate/revalidate assessments

## Tasks / Subtasks

- [ ] Setup RabbitMQ consumer (AC: 1)
  - [ ] Add RabbitMQ client NuGet package
  - [ ] Configure RabbitMQ connection settings
  - [ ] Create exchange and queue bindings for KYC events
  - [ ] Implement consumer service

- [ ] Create KYC event handler (AC: 1, 2)
  - [ ] Create `EventHandlers/KYCStatusEventHandler.cs`
  - [ ] Subscribe to KYC events queue
  - [ ] Deserialize event payloads
  - [ ] Route to appropriate handler method based on event type

- [ ] Handle KYC expired events (AC: 3, 4, 5)
  - [ ] Find all active assessments for client
  - [ ] Update `is_valid = false` and `invalid_reason`
  - [ ] Save to database
  - [ ] Publish `AssessmentInvalidated` audit event
  - [ ] Log invalidation

- [ ] Handle KYC revoked events (AC: 3, 4, 5)
  - [ ] Same as expired handling
  - [ ] Mark reason as "KYC_REVOKED"

- [ ] Handle KYC updated events (AC: 6)
  - [ ] Check if verification status improved
  - [ ] Log improvement for manual review
  - [ ] Don't automatically revalidate

- [ ] Implement idempotency (AC: 7)
  - [ ] Store processed event IDs in database
  - [ ] Check if event already processed
  - [ ] Skip duplicate processing
  - [ ] Clean up old processed event IDs (> 30 days)

- [ ] Add metrics and logging (AC: 8)
  - [ ] Track event processing latency
  - [ ] Track success/failure rate
  - [ ] Log each event with details

- [ ] Setup dead letter queue (AC: 9)
  - [ ] Configure DLQ for failed events
  - [ ] Retry failed events 3 times
  - [ ] Move to DLQ after retries
  - [ ] Alert on DLQ buildup

- [ ] Create admin API (AC: 10)
  - [ ] `POST /api/v1/admin/assessment/{id}/invalidate`
  - [ ] `POST /api/v1/admin/assessment/{id}/revalidate`
  - [ ] Require admin permissions

## Dev Notes

### RabbitMQ Event Handler
[Source: docs/domains/credit-assessment/prd.md#FR15]

```csharp
public class KYCStatusEventHandler : IHostedService
{
    private readonly IConnection _connection;
    private readonly IModel _channel;
    private readonly ICreditAssessmentRepository _repository;
    private readonly IAdminServiceClient _auditClient;

    public Task StartAsync(CancellationToken cancellationToken)
    {
        _channel = _connection.CreateModel();
        _channel.ExchangeDeclare("kyc-events", ExchangeType.Topic);
        _channel.QueueDeclare("credit-assessment-kyc", durable: true);
        _channel.QueueBind("credit-assessment-kyc", "kyc-events", "kyc.*");

        var consumer = new EventingBasicConsumer(_channel);
        consumer.Received += async (model, ea) =>
        {
            var body = ea.Body.ToArray();
            var message = Encoding.UTF8.GetString(body);
            await ProcessKYCEvent(message, ea.RoutingKey);
            _channel.BasicAck(ea.DeliveryTag, false);
        };

        _channel.BasicConsume("credit-assessment-kyc", false, consumer);
        return Task.CompletedTask;
    }

    private async Task ProcessKYCEvent(string message, string routingKey)
    {
        var eventType = routingKey.Split('.').Last();
        
        switch (eventType)
        {
            case "expired":
                await HandleKYCExpired(JsonSerializer.Deserialize<KYCExpiredEvent>(message));
                break;
            case "revoked":
                await HandleKYCRevoked(JsonSerializer.Deserialize<KYCRevokedEvent>(message));
                break;
            case "updated":
                await HandleKYCUpdated(JsonSerializer.Deserialize<KYCUpdatedEvent>(message));
                break;
        }
    }
}
```

### Assessment Invalidation Logic
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Event Bus Integration]

```csharp
private async Task HandleKYCExpired(KYCExpiredEvent @event)
{
    // Check idempotency
    if (await IsEventProcessed(@event.EventId))
    {
        _logger.LogInformation("Event already processed: {EventId}", @event.EventId);
        return;
    }

    var activeAssessments = await _repository.GetActiveAssessmentsForClientAsync(@event.ClientId);
    
    foreach (var assessment in activeAssessments)
    {
        assessment.IsValid = false;
        assessment.InvalidReason = $"KYC expired on {@event.ExpiryDate:yyyy-MM-dd}";
        await _repository.UpdateAsync(assessment);
        
        await _auditClient.PublishAuditEventAsync(new AssessmentInvalidatedEvent
        {
            AssessmentId = assessment.Id,
            Reason = "KYC_EXPIRED",
            TriggerEvent = @event.EventId
        });
        
        _logger.LogWarning("Assessment invalidated due to KYC expiry: {AssessmentId}", assessment.Id);
    }

    await MarkEventAsProcessed(@event.EventId);
}
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.12]

**IV1**: When KYC expires in Client Management Service, assessment is invalidated within 1 minute  
**IV2**: Loan Origination Service attempting to use invalidated assessment receives clear error  
**IV3**: Event handler processes duplicate events idempotently (no duplicate invalidations)

### Testing

#### Unit Tests
- Event deserialization works correctly
- Idempotency check prevents duplicate processing
- Assessment invalidation updates correct fields

#### Integration Tests
- RabbitMQ consumer receives events
- Assessments invalidated when KYC expires
- Audit events published for invalidations
- Duplicate events handled idempotently

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
