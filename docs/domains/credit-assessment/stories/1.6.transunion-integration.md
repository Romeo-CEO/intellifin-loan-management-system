# Story 1.6: TransUnion Credit Bureau API Integration with Smart Routing

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to integrate with TransUnion Zambia API for credit bureau score retrieval  
**so that** first-time applicants get real credit bureau data in assessments

## Acceptance Criteria

1. Create `TransUnionClient` implementing TransUnion API specification
2. Implement smart routing logic: check if client is first-time applicant
3. For first-time applicants, call TransUnion API to retrieve credit score and history
4. For existing clients, skip bureau call and use historical data
5. Cache bureau results in Redis with 90-day TTL
6. Implement API authentication using configured API key from Vault
7. Handle API errors (timeout, unavailable) with retry logic
8. Parse TransUnion response and map to internal `CreditBureauData` model
9. Log API call metrics (success rate, latency, cost tracking)
10. Return null for bureau data if API unavailable (triggers manual review)

## Tasks / Subtasks

- [ ] Create TransUnion HTTP client (AC: 1, 6)
  - [ ] Create `Services/Integration/TransUnionClient.cs`
  - [ ] Configure HTTP client with base URL from configuration
  - [ ] Implement API key authentication (from Vault secrets)
  - [ ] Add required headers (X-API-Key, Content-Type, Accept)
  - [ ] Set timeout to 60 seconds (bureau API can be slow)

- [ ] Implement smart routing logic (AC: 2, 3, 4)
  - [ ] Create `ShouldCallBureauAsync(Guid clientId)` method
  - [ ] Query database for existing credit assessments for client
  - [ ] Check if client has bureau data from last 90 days
  - [ ] Return true if first-time applicant or data stale
  - [ ] Return false if recent bureau data exists

- [ ] Implement credit score retrieval (AC: 3)
  - [ ] Implement `GetCreditScoreAsync(string nrc)` method
  - [ ] Call `POST /api/v1/credit-report` with NRC
  - [ ] Include required fields: nationalId, requestReason, consentDate
  - [ ] Parse JSON response to extract credit score, accounts, payment history
  - [ ] Handle API-specific error codes (404, 429, 503)

- [ ] Implement Redis caching (AC: 5)
  - [ ] Add `IDistributedCache` dependency
  - [ ] Cache key format: `bureau:credit:{nrc}`
  - [ ] Serialize `CreditBureauData` to JSON for caching
  - [ ] Set 90-day expiration (7,776,000 seconds)
  - [ ] Check cache before calling API
  - [ ] Store API response in cache after successful call

- [ ] Add retry and error handling (AC: 7, 10)
  - [ ] Use Polly retry policy: 3 attempts with exponential backoff
  - [ ] Handle rate limiting (429) with longer backoff
  - [ ] Handle timeouts (60-second limit)
  - [ ] Handle service unavailable (503) gracefully
  - [ ] Return null if all retries fail (assessment continues without bureau data)
  - [ ] Log all failures with NRC (hashed) and error details

- [ ] Map TransUnion response to internal model (AC: 8)
  - [ ] Create `Models/Integration/TransUnionResponseDto.cs`
  - [ ] Parse credit score from response
  - [ ] Extract total debt from all accounts
  - [ ] Count active vs delinquent accounts
  - [ ] Extract payment history summary
  - [ ] Map to internal `CreditBureauData` model

- [ ] Implement metrics and cost tracking (AC: 9)
  - [ ] Increment Prometheus counter for bureau API calls
  - [ ] Track API call duration histogram
  - [ ] Track success vs failure rate
  - [ ] Log cost implications (each call = monetary cost)
  - [ ] Alert if daily API call count exceeds budget

- [ ] Test TransUnion integration
  - [ ] Unit test smart routing logic
  - [ ] Unit test response parsing
  - [ ] Integration test with TransUnion sandbox
  - [ ] Test rate limiting handling
  - [ ] Test timeout handling
  - [ ] Verify cache hit/miss behavior

## Dev Notes

### TransUnion API Specification
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Integration Details]

**Endpoint**: `POST https://api.transunion.co.zm/v1/credit-report`

**Authentication**: API Key in header

**Request**:
```json
{
  "nationalId": "123456/78/9",
  "requestReason": "LOAN_APPLICATION",
  "consentDate": "2025-10-20",
  "requestorId": "INTELLIFIN001"
}
```

**Response**:
```json
{
  "reportId": "TU-202510-001",
  "nationalId": "123456/78/9",
  "creditScore": 720,
  "scoreRating": "GOOD",
  "accounts": [
    {
      "accountType": "LOAN",
      "creditor": "Bank XYZ",
      "balance": 15000,
      "status": "CURRENT",
      "monthsOpen": 24,
      "paymentHistory": "PPPPPPPPPP"
    }
  ],
  "delinquentAccounts": 0,
  "totalDebt": 15000,
  "reportDate": "2025-10-20T10:30:00Z"
}
```

### Smart Routing Implementation
[Source: docs/domains/credit-assessment/prd.md#FR3]

```csharp
public class TransUnionClient : ITransUnionClient
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly IDistributedCache _cache;
    private readonly ICreditAssessmentRepository _repository;
    private readonly ILogger<TransUnionClient> _logger;

    public async Task<CreditBureauData?> GetCreditDataAsync(Guid clientId, string nrc)
    {
        // Check if we should call bureau API
        if (!await ShouldCallBureauAsync(clientId))
        {
            _logger.LogInformation("Skipping bureau call - recent data exists for client");
            return await GetCachedBureauDataAsync(nrc);
        }

        // Check cache first
        var cacheKey = $"bureau:credit:{nrc}";
        var cachedData = await _cache.GetStringAsync(cacheKey);
        
        if (cachedData != null)
        {
            _logger.LogInformation("Bureau data retrieved from cache");
            return JsonSerializer.Deserialize<CreditBureauData>(cachedData);
        }

        // Call TransUnion API
        var bureauData = await CallTransUnionApiAsync(nrc);
        
        if (bureauData != null)
        {
            // Cache the result
            var cacheOptions = new DistributedCacheEntryOptions
            {
                AbsoluteExpirationRelativeToNow = TimeSpan.FromDays(90)
            };
            await _cache.SetStringAsync(cacheKey, 
                JsonSerializer.Serialize(bureauData), 
                cacheOptions);
        }

        return bureauData;
    }

    private async Task<bool> ShouldCallBureauAsync(Guid clientId)
    {
        var recentAssessment = await _repository.GetLatestForClientAsync(clientId);
        
        if (recentAssessment == null)
        {
            return true; // First-time applicant
        }

        var daysSinceLastBureauCall = (DateTime.UtcNow - recentAssessment.AssessedAt).TotalDays;
        return daysSinceLastBureauCall > 90; // Refresh if > 90 days
    }

    private async Task<CreditBureauData?> CallTransUnionApiAsync(string nrc)
    {
        var client = _httpClientFactory.CreateClient("TransUnion");
        
        try
        {
            var request = new TransUnionRequest
            {
                NationalId = nrc,
                RequestReason = "LOAN_APPLICATION",
                ConsentDate = DateTime.UtcNow.ToString("yyyy-MM-dd"),
                RequestorId = "INTELLIFIN001"
            };

            var response = await client.PostAsJsonAsync("/v1/credit-report", request);

            if (response.StatusCode == HttpStatusCode.NotFound)
            {
                _logger.LogWarning("No credit history found for NRC");
                return new CreditBureauData { HasHistory = false };
            }

            response.EnsureSuccessStatusCode();

            var tuResponse = await response.Content.ReadFromJsonAsync<TransUnionResponseDto>();
            return MapToCreditBureauData(tuResponse);
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "TransUnion API call failed");
            return null; // Assessment will continue without bureau data
        }
        catch (TaskCanceledException ex)
        {
            _logger.LogError(ex, "TransUnion API timeout");
            return null;
        }
    }
}
```

### Credit Bureau Data Model
[Source: docs/domains/credit-assessment/prd.md#FR3]

```csharp
public class CreditBureauData
{
    public bool HasHistory { get; set; }
    public decimal CreditScore { get; set; }
    public string ScoreRating { get; set; }      // EXCELLENT | GOOD | FAIR | POOR
    public decimal TotalDebt { get; set; }
    public int ActiveAccounts { get; set; }
    public int DelinquentAccounts { get; set; }
    public List<CreditAccount> Accounts { get; set; }
    public DateTime? ReportDate { get; set; }
}

public class CreditAccount
{
    public string AccountType { get; set; }
    public string Creditor { get; set; }
    public decimal Balance { get; set; }
    public string Status { get; set; }          // CURRENT | DELINQUENT | CLOSED
    public int MonthsOpen { get; set; }
}
```

### HTTP Client Configuration
[Source: docs/domains/credit-assessment/prd.md#3.1 Existing Technology Stack]

```csharp
// Program.cs
builder.Services.AddHttpClient("TransUnion", client =>
{
    client.BaseAddress = new Uri(builder.Configuration["ExternalServices:TransUnion:BaseUrl"]);
    client.DefaultRequestHeaders.Add("X-API-Key", builder.Configuration["ExternalServices:TransUnion:ApiKey"]);
    client.Timeout = TimeSpan.FromSeconds(60);
})
.AddPolicyHandler(GetTransUnionRetryPolicy());

static IAsyncPolicy<HttpResponseMessage> GetTransUnionRetryPolicy()
{
    return HttpPolicyExtensions
        .HandleTransientHttpError()
        .Or<TaskCanceledException>()
        .OrResult(r => r.StatusCode == HttpStatusCode.TooManyRequests)
        .WaitAndRetryAsync(3, retryAttempt =>
        {
            if (retryAttempt == 3) // Rate limiting
                return TimeSpan.FromSeconds(30);
            return TimeSpan.FromSeconds(Math.Pow(2, retryAttempt));
        });
}
```

### Cost Tracking and Metrics
[Source: docs/domains/credit-assessment/prd.md#FR3]

```csharp
private readonly Counter _bureauApiCalls = Metrics.CreateCounter(
    "credit_bureau_api_calls_total", 
    "Total TransUnion API calls",
    new CounterConfiguration { LabelNames = new[] { "result" } });

private readonly Histogram _bureauApiDuration = Metrics.CreateHistogram(
    "credit_bureau_api_duration_seconds",
    "TransUnion API call duration");

public async Task<CreditBureauData?> GetCreditDataAsync(Guid clientId, string nrc)
{
    using (_bureauApiDuration.NewTimer())
    {
        var result = await CallTransUnionApiAsync(nrc);
        _bureauApiCalls.WithLabels(result != null ? "success" : "failure").Inc();
        return result;
    }
}
```

### Caching Strategy
[Source: docs/domains/credit-assessment/prd.md#FR3]

- **Cache Key**: `bureau:credit:{nrc}` (hash NRC for privacy)
- **TTL**: 90 days (credit reports are relatively stable)
- **Cache Miss**: Call TransUnion API
- **Cache Hit**: Return cached data, skip API call (cost savings)
- **Invalidation**: Manual invalidation via admin API if needed

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.6]

**IV1**: TransUnion API calls succeed for test NRCs in sandbox environment  
**IV2**: Cached bureau data retrieved from Redis on subsequent assessment for same client (no duplicate API calls)  
**IV3**: Assessment continues with "no bureau data" flag when TransUnion API is unavailable

### Testing

#### Unit Tests
- Smart routing logic decides correctly when to call API
- Response parsing extracts all required fields
- Cache key generation is consistent
- Error handling returns null without throwing

#### Integration Tests
- Successful API call with sandbox credentials
- Response caching in Redis works correctly
- Cache hit retrieves data without API call
- 404 response (no credit history) handled gracefully
- Rate limiting (429) triggers backoff and retry
- Timeout triggers retry then fallback

#### Manual Testing
- Test with TransUnion sandbox: `https://sandbox.transunion.co.zm`
- Use test NRC from TransUnion documentation
- Verify API call appears in TransUnion dashboard
- Verify cost tracking metrics increment
- Test cache behavior with Redis CLI: `GET bureau:credit:{hash}`
- Simulate API unavailability (disconnect network) and verify graceful fallback

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
