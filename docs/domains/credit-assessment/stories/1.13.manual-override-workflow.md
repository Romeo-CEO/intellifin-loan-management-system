# Story 1.13: Manual Override Workflow with Audit Trail

## Status
Draft

## Story
**As a** Credit Manager  
**I want** to manually override automated credit decisions with full audit trail and approval workflow  
**so that** exceptional cases can be handled appropriately while maintaining compliance

## Acceptance Criteria

1. Add `manual_override` field to assessment table with reason, approver, timestamp
2. Create API endpoint to submit manual override request
3. Implement approval workflow: requires senior credit manager approval
4. Store override history in audit trail via AdminService
5. Override changes final decision but preserves original automated decision
6. Display both automated and manual decision in response
7. Require justification text (min 50 chars) for all overrides
8. Implement role-based access control (only credit managers can override)
9. Send notification to approver when override submitted
10. Create API to query override history for an assessment
11. Add override statistics to monitoring dashboard

## Tasks / Subtasks

- [ ] Extend schema (AC: 1)
  - [ ] Add migration to create `manual_overrides` table
  - [ ] Fields: `id`, `assessment_id`, `original_decision`, `override_decision`, `reason`, `requested_by`, `requested_at`, `approved_by`, `approved_at`, `status`
  - [ ] Add index on `assessment_id`

- [ ] Create override request API (AC: 2, 7)
  - [ ] Create `POST /api/v1/assessment/{id}/override` endpoint
  - [ ] Validate justification text (min 50 chars)
  - [ ] Validate requester has credit manager role
  - [ ] Create override record with "PENDING" status
  - [ ] Return override request ID

- [ ] Implement approval workflow (AC: 3, 9)
  - [ ] Create `POST /api/v1/override/{id}/approve` endpoint
  - [ ] Validate approver has senior credit manager role
  - [ ] Update override status to "APPROVED"
  - [ ] Apply override to assessment
  - [ ] Send notification to requester

- [ ] Integrate with AdminService audit (AC: 4)
  - [ ] Publish `OverrideRequested` event
  - [ ] Publish `OverrideApproved` or `OverrideRejected` event
  - [ ] Include all override details in event

- [ ] Update assessment model (AC: 5, 6)
  - [ ] Add `original_decision` field
  - [ ] Add `final_decision` field
  - [ ] Add `is_overridden` boolean flag
  - [ ] When override approved, set these fields appropriately

- [ ] Implement RBAC (AC: 8)
  - [ ] Check requester role before allowing override
  - [ ] Check approver role before allowing approval
  - [ ] Return 403 if unauthorized

- [ ] Create override history API (AC: 10)
  - [ ] Create `GET /api/v1/assessment/{id}/overrides` endpoint
  - [ ] Return list of all override attempts
  - [ ] Include status, reason, timestamps, users

- [ ] Add monitoring (AC: 11)
  - [ ] Track override request count
  - [ ] Track approval rate
  - [ ] Track average approval time
  - [ ] Add to Grafana dashboard

## Dev Notes

### Manual Override Schema
[Source: docs/domains/credit-assessment/prd.md#FR16]

```sql
CREATE TABLE manual_overrides (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    assessment_id UUID NOT NULL REFERENCES credit_assessments(id),
    original_decision VARCHAR(50) NOT NULL,
    override_decision VARCHAR(50) NOT NULL,
    reason TEXT NOT NULL CHECK (char_length(reason) >= 50),
    requested_by UUID NOT NULL,
    requested_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    approved_by UUID,
    approved_at TIMESTAMP,
    status VARCHAR(20) NOT NULL CHECK (status IN ('PENDING', 'APPROVED', 'REJECTED')),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_manual_overrides_assessment_id ON manual_overrides(assessment_id);
CREATE INDEX idx_manual_overrides_status ON manual_overrides(status);
```

### Override Request Controller
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Manual Override]

```csharp
[HttpPost("{id}/override")]
[Authorize(Roles = "CreditManager")]
public async Task<IActionResult> RequestOverride(
    Guid id,
    [FromBody] OverrideRequest request)
{
    if (request.Reason.Length < 50)
    {
        return BadRequest("Justification must be at least 50 characters");
    }

    var assessment = await _repository.GetByIdAsync(id);
    if (assessment == null)
    {
        return NotFound();
    }

    var overrideRecord = new ManualOverride
    {
        AssessmentId = id,
        OriginalDecision = assessment.Decision,
        OverrideDecision = request.NewDecision,
        Reason = request.Reason,
        RequestedBy = User.GetUserId(),
        Status = "PENDING"
    };

    await _overrideRepository.CreateAsync(overrideRecord);

    // Publish audit event
    await _auditClient.PublishEventAsync(new OverrideRequestedEvent
    {
        OverrideId = overrideRecord.Id,
        AssessmentId = id,
        RequestedBy = User.GetUserId(),
        Reason = request.Reason
    });

    // Send notification to approvers
    await _notificationService.NotifyApproversAsync(overrideRecord);

    return Ok(new { overrideId = overrideRecord.Id, status = "PENDING" });
}
```

### Approval Workflow
[Source: docs/domains/credit-assessment/prd.md Story 1.13]

```csharp
[HttpPost("override/{id}/approve")]
[Authorize(Roles = "SeniorCreditManager")]
public async Task<IActionResult> ApproveOverride(
    Guid id,
    [FromBody] ApprovalRequest request)
{
    var overrideRecord = await _overrideRepository.GetByIdAsync(id);
    if (overrideRecord == null)
    {
        return NotFound();
    }

    if (overrideRecord.Status != "PENDING")
    {
        return BadRequest("Override is not in pending state");
    }

    overrideRecord.Status = request.Approved ? "APPROVED" : "REJECTED";
    overrideRecord.ApprovedBy = User.GetUserId();
    overrideRecord.ApprovedAt = DateTime.UtcNow;
    await _overrideRepository.UpdateAsync(overrideRecord);

    if (request.Approved)
    {
        var assessment = await _assessmentRepository.GetByIdAsync(overrideRecord.AssessmentId);
        assessment.OriginalDecision = assessment.Decision;
        assessment.Decision = overrideRecord.OverrideDecision;
        assessment.IsOverridden = true;
        await _assessmentRepository.UpdateAsync(assessment);
    }

    await _auditClient.PublishEventAsync(new OverrideDecisionEvent
    {
        OverrideId = id,
        Decision = request.Approved ? "APPROVED" : "REJECTED",
        ApprovedBy = User.GetUserId()
    });

    return Ok();
}
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.13]

**IV1**: Credit manager can submit override request, senior manager can approve/reject  
**IV2**: All override requests and approvals logged to AdminService audit trail  
**IV3**: Overridden assessment returns both original and final decisions in response

### Testing

#### Unit Tests
- Override request validation (minimum justification length)
- RBAC enforcement for override and approval
- Assessment updated correctly when override approved

#### Integration Tests
- Complete override workflow from request to approval
- Audit events published for all steps
- Override history retrieval works
- Notification sent to approvers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
