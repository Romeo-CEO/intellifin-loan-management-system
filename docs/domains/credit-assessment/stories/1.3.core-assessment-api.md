# Story 1.3: Core Assessment Service API with Basic Endpoints

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to create the REST API endpoints for credit assessment operations  
**so that** Loan Origination Service can invoke assessments via HTTP

## Acceptance Criteria

1. Create `CreditAssessmentController` with minimal API endpoints
2. Implement `POST /api/v1/credit-assessment/assess` endpoint
3. Implement `GET /api/v1/credit-assessment/{assessmentId}` endpoint
4. Implement `GET /api/v1/credit-assessment/client/{clientId}/latest` endpoint
5. Define request/response DTOs (`AssessmentRequest`, `AssessmentResponse`, `DecisionPayload`)
6. Add OpenAPI/Swagger annotations for API documentation
7. Implement JWT bearer token authentication
8. Implement permission check (`credit:assess`) via IdentityService integration
9. Add request validation with FluentValidation
10. Return structured error responses matching IntelliFin error format

## Tasks / Subtasks

- [ ] Create request/response DTOs (AC: 5)
  - [ ] Create `Models/Requests/AssessmentRequest.cs` with all required fields
  - [ ] Create `Models/Responses/AssessmentResponse.cs` with decision payload
  - [ ] Create `Models/Responses/DecisionPayload.cs` with detailed decision data
  - [ ] Create `Models/Responses/RuleEvaluationDto.cs` for rule results
  - [ ] Add data annotations for OpenAPI documentation

- [ ] Create CreditAssessmentController (AC: 1, 2, 3, 4)
  - [ ] Create `Controllers/CreditAssessmentController.cs`
  - [ ] Add controller-level attributes: `[ApiController]`, `[Route("api/v1/credit-assessment")]`, `[Authorize]`
  - [ ] Implement `POST /assess` endpoint accepting `AssessmentRequest`
  - [ ] Implement `GET /{assessmentId}` endpoint returning assessment details
  - [ ] Implement `GET /client/{clientId}/latest` endpoint returning most recent assessment
  - [ ] Add HTTP status code responses (200, 400, 401, 403, 404, 500)

- [ ] Add OpenAPI/Swagger documentation (AC: 6)
  - [ ] Add NuGet package: `Swashbuckle.AspNetCore`
  - [ ] Configure Swagger in `Program.cs` with JWT bearer support
  - [ ] Add XML documentation generation to project file
  - [ ] Add `[ProducesResponseType]` attributes to all endpoints
  - [ ] Add `[SwaggerOperation]` attributes with detailed descriptions
  - [ ] Add example request/response payloads with `[SwaggerSchema]`

- [ ] Implement JWT authentication (AC: 7)
  - [ ] Add NuGet package: `Microsoft.AspNetCore.Authentication.JwtBearer`
  - [ ] Configure JWT authentication in `Program.cs` with IdentityService issuer
  - [ ] Add `[Authorize]` attribute to controller
  - [ ] Extract user ID from JWT claims for audit tracking
  - [ ] Test with valid and invalid tokens

- [ ] Implement permission-based authorization (AC: 8)
  - [ ] Create `RequirePermissionAttribute` custom authorization filter
  - [ ] Check for `credit:assess` permission in user claims
  - [ ] Return 403 Forbidden if permission missing
  - [ ] Add `[RequirePermission("credit:assess")]` to assess endpoint
  - [ ] Add `[RequirePermission("credit:override")]` placeholder for override endpoint

- [ ] Add request validation (AC: 9)
  - [ ] Add NuGet package: `FluentValidation.AspNetCore`
  - [ ] Create `AssessmentRequestValidator` class
  - [ ] Validate required fields: `LoanApplicationId`, `ClientId`, `RequestedAmount`, `TermMonths`, `ProductType`
  - [ ] Validate business rules: `RequestedAmount > 0`, `TermMonths > 0`, `ProductType in ['PAYROLL', 'BUSINESS']`
  - [ ] Register validators in dependency injection
  - [ ] Return 400 Bad Request with validation errors

- [ ] Implement structured error responses (AC: 10)
  - [ ] Create `Models/Responses/ErrorResponse.cs` matching IntelliFin format
  - [ ] Create global exception handler middleware
  - [ ] Map exceptions to appropriate HTTP status codes
  - [ ] Include correlation ID in error responses
  - [ ] Log errors with contextual information
  - [ ] Mask sensitive data in error messages

- [ ] Create stub service implementation
  - [ ] Create `Services/Core/ICreditAssessmentService.cs` interface
  - [ ] Create `Services/Core/CreditAssessmentService.cs` with stub methods
  - [ ] Return mock assessment results for now (real logic in Story 1.4)
  - [ ] Register service in dependency injection

- [ ] Test API endpoints
  - [ ] Unit test controller methods with mocked service
  - [ ] Unit test request validation rules
  - [ ] Integration test API endpoints with TestServer
  - [ ] Test authentication and authorization
  - [ ] Verify Swagger UI renders correctly

## Dev Notes

### API Specification
[Source: docs/domains/credit-assessment/brownfield-architecture.md#API Specifications]

**POST /api/v1/credit-assessment/assess**
```http
POST /api/v1/credit-assessment/assess
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "loanApplicationId": "uuid",
  "clientId": "uuid",
  "employerId": "uuid",
  "requestedAmount": 50000,
  "termMonths": 24,
  "productType": "PAYROLL"
}

Response (200 OK):
{
  "assessmentId": "uuid",
  "decision": "Approved",
  "riskGrade": "B",
  "compositeScore": 720,
  "debtToIncomeRatio": 0.35,
  "affordableAmount": 50000,
  "rulesFired": [
    {
      "ruleId": "R001",
      "ruleName": "Max LTI Ratio",
      "result": "Pass",
      "weight": 0.25
    }
  ],
  "explanation": "Application meets all criteria...",
  "assessedAt": "2025-10-17T13:30:00Z"
}
```

**GET /api/v1/credit-assessment/{assessmentId}**
```http
GET /api/v1/credit-assessment/{assessmentId}
Authorization: Bearer {token}

Response (200 OK):
{
  "assessmentId": "uuid",
  "loanApplicationId": "uuid",
  "clientId": "uuid",
  "decision": "Approved",
  "riskGrade": "B",
  ...full assessment details...
}
```

**GET /api/v1/credit-assessment/client/{clientId}/latest**
```http
GET /api/v1/credit-assessment/client/{clientId}/latest
Authorization: Bearer {token}

Response (200 OK):
{
  ...latest assessment for client...
}
```

### Request DTOs
[Source: docs/domains/credit-assessment/brownfield-architecture.md#New Models]

```csharp
public class AssessmentRequest
{
    [Required]
    public Guid LoanApplicationId { get; set; }
    
    [Required]
    public Guid ClientId { get; set; }
    
    [Required]
    public Guid EmployerId { get; set; }
    
    [Required]
    [Range(1, double.MaxValue)]
    public decimal RequestedAmount { get; set; }
    
    [Required]
    [Range(1, 360)]
    public int TermMonths { get; set; }
    
    [Required]
    [AllowedValues("PAYROLL", "BUSINESS")]
    public string ProductType { get; set; }
    
    public Dictionary<string, object>? AdditionalData { get; set; }
}
```

### Response DTOs
[Source: docs/domains/credit-assessment/brownfield-architecture.md#New Models]

```csharp
public class AssessmentResponse
{
    public Guid AssessmentId { get; set; }
    public string Decision { get; set; }              // Approved | Conditional | ManualReview | Rejected
    public string RiskGrade { get; set; }             // A, B, C, D, F
    public decimal CompositeScore { get; set; }
    public decimal DebtToIncomeRatio { get; set; }
    public decimal AffordableAmount { get; set; }
    public List<RuleEvaluationDto> RulesFired { get; set; }
    public List<string>? Conditions { get; set; }     // If conditional approval
    public string Explanation { get; set; }
    public DateTime AssessedAt { get; set; }
}

public class RuleEvaluationDto
{
    public string RuleId { get; set; }
    public string RuleName { get; set; }
    public string Result { get; set; }                // Pass | Fail
    public decimal Weight { get; set; }
    public decimal Score { get; set; }
    public string? Explanation { get; set; }
}
```

### JWT Authentication Configuration
[Source: docs/domains/credit-assessment/prd.md#NFR6]

```csharp
// Program.cs
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.Authority = builder.Configuration["IdentityService:Authority"];
        options.Audience = "credit-assessment-service";
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ClockSkew = TimeSpan.Zero
        };
    });

builder.Services.AddAuthorization();
```

### Permission-Based Authorization
[Source: docs/domains/credit-assessment/prd.md#NFR6, NFR7]

```csharp
public class RequirePermissionAttribute : TypeFilterAttribute
{
    public RequirePermissionAttribute(string permission) 
        : base(typeof(PermissionAuthorizationFilter))
    {
        Arguments = new object[] { permission };
    }
}

public class PermissionAuthorizationFilter : IAuthorizationFilter
{
    private readonly string _permission;

    public PermissionAuthorizationFilter(string permission)
    {
        _permission = permission;
    }

    public void OnAuthorization(AuthorizationFilterContext context)
    {
        var permissions = context.HttpContext.User
            .FindAll("permission")
            .Select(c => c.Value);

        if (!permissions.Contains(_permission))
        {
            context.Result = new ForbidResult();
        }
    }
}
```

### FluentValidation Configuration
[Source: docs/domains/credit-assessment/prd.md#AC9]

```csharp
public class AssessmentRequestValidator : AbstractValidator<AssessmentRequest>
{
    public AssessmentRequestValidator()
    {
        RuleFor(x => x.LoanApplicationId)
            .NotEmpty()
            .WithMessage("Loan application ID is required");

        RuleFor(x => x.ClientId)
            .NotEmpty()
            .WithMessage("Client ID is required");

        RuleFor(x => x.RequestedAmount)
            .GreaterThan(0)
            .WithMessage("Requested amount must be greater than zero");

        RuleFor(x => x.TermMonths)
            .InclusiveBetween(1, 360)
            .WithMessage("Term must be between 1 and 360 months");

        RuleFor(x => x.ProductType)
            .Must(x => x == "PAYROLL" || x == "BUSINESS")
            .WithMessage("Product type must be PAYROLL or BUSINESS");
    }
}
```

### Error Response Format
[Source: docs/domains/credit-assessment/prd.md#AC10]

```csharp
public class ErrorResponse
{
    public string Type { get; set; }                  // e.g., "ValidationError", "ServiceError"
    public string Title { get; set; }
    public int Status { get; set; }
    public string Detail { get; set; }
    public string TraceId { get; set; }
    public Dictionary<string, string[]>? Errors { get; set; }  // Validation errors
}
```

### Swagger Configuration
[Source: docs/domains/credit-assessment/prd.md#3.3 Documentation Standards]

```csharp
// Program.cs
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "Credit Assessment Service API",
        Version = "v1",
        Description = "Intelligent credit scoring and risk assessment for IntelliFin LMS"
    });

    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.Http,
        Scheme = "bearer"
    });

    c.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            Array.Empty<string>()
        }
    });

    var xmlFile = $"{Assembly.GetExecutingAssembly().GetName().Name}.xml";
    var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile);
    c.IncludeXmlComments(xmlPath);
});

app.UseSwagger();
app.UseSwaggerUI(c =>
{
    c.SwaggerEndpoint("/swagger/v1/swagger.json", "Credit Assessment API v1");
    c.RoutePrefix = "swagger";
});
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.3]

**IV1**: API endpoints accessible with valid JWT token from IdentityService  
**IV2**: API documentation renders correctly in Swagger UI  
**IV3**: Unauthorized requests (no token or insufficient permissions) return 401/403 as expected

### Testing

#### Unit Tests
- Controller action methods return correct status codes
- Request validation catches invalid inputs
- Permission authorization filter blocks unauthorized users
- Error responses follow IntelliFin format

#### Integration Tests
- POST /assess returns 200 with valid request and token
- POST /assess returns 401 without token
- POST /assess returns 403 without credit:assess permission
- POST /assess returns 400 with invalid request
- GET /{assessmentId} returns 200 with existing assessment
- GET /{assessmentId} returns 404 with non-existent ID
- GET /client/{clientId}/latest returns most recent assessment

#### Manual Testing
- Test Swagger UI: Navigate to `https://localhost:8080/swagger`
- Obtain JWT token from IdentityService
- Use Swagger "Authorize" button to add token
- Test POST /assess with sample request
- Verify response structure matches documentation
- Test error scenarios (invalid token, missing permission, bad request)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
