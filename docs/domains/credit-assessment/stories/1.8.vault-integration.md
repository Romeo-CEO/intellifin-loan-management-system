# Story 1.8: Vault Integration for Rule Configuration Management

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to integrate with HashiCorp Vault to load credit scoring rules and thresholds  
**so that** business teams can update risk policies without code deployment

## Acceptance Criteria

1. Create `VaultConfigService` with AppRole authentication
2. Implement configuration loading from Vault path `secret/intellifin/credit-assessment/config`
3. Parse JSON rule configuration into strongly-typed C# models (`ScoringRuleConfig`, `ThresholdConfig`)
4. Validate configuration schema on load (required fields, data types, value ranges)
5. Implement configuration caching with 5-minute refresh interval
6. Support manual configuration refresh via admin API endpoint `POST /api/v1/admin/config/refresh`
7. Track configuration version in assessment records
8. Log configuration changes with before/after comparison
9. Implement graceful fallback to last-known-good configuration if Vault unavailable
10. Provide configuration health check showing current version and last refresh time

## Tasks / Subtasks

- [ ] Add Vault NuGet package and configure (AC: 1)
  - [ ] Add `VaultSharp` NuGet package
  - [ ] Configure Vault connection settings in appsettings.json
  - [ ] Implement AppRole authentication with role ID and secret ID
  - [ ] Test Vault connection on service startup

- [ ] Create Vault configuration models (AC: 3)
  - [ ] Create `Models/Configuration/ScoringRuleConfig.cs`
  - [ ] Create `Models/Configuration/ThresholdConfig.cs`
  - [ ] Create `Models/Configuration/GradeThresholdConfig.cs`
  - [ ] Create `Models/Configuration/DecisionMatrixConfig.cs`
  - [ ] Create `Models/Configuration/CreditAssessmentConfig.cs` (root model)

- [ ] Implement VaultConfigService (AC: 2, 5, 9)
  - [ ] Create `Services/Configuration/VaultConfigService.cs`
  - [ ] Implement `LoadConfigurationAsync()` method
  - [ ] Read from Vault path: `secret/intellifin/credit-assessment/config`
  - [ ] Parse JSON to strongly-typed models
  - [ ] Cache configuration in memory with 5-minute expiration
  - [ ] Implement background service for automatic refresh
  - [ ] Store last-known-good configuration for fallback

- [ ] Add configuration validation (AC: 4)
  - [ ] Create `ConfigurationValidator` class
  - [ ] Validate required fields are present
  - [ ] Validate data types match schema
  - [ ] Validate value ranges (weights 0-1, scores > 0, etc.)
  - [ ] Validate product types are valid (PAYROLL | BUSINESS)
  - [ ] Throw `InvalidConfigurationException` if validation fails

- [ ] Implement configuration versioning (AC: 7)
  - [ ] Extract version from Vault config JSON
  - [ ] Store version in `AssessmentConfigVersion` table
  - [ ] Include version in all assessment records
  - [ ] Track when config was loaded and by which service instance

- [ ] Add configuration change logging (AC: 8)
  - [ ] Compare new config with previous config
  - [ ] Log changed rules with before/after values
  - [ ] Log changed thresholds
  - [ ] Publish config change event to AdminService
  - [ ] Include diff in structured log

- [ ] Implement manual refresh endpoint (AC: 6)
  - [ ] Create admin controller: `AdminController.cs`
  - [ ] Add `POST /api/v1/admin/config/refresh` endpoint
  - [ ] Require `admin:config` permission
  - [ ] Force reload from Vault immediately
  - [ ] Return new configuration version and summary
  - [ ] Log who triggered manual refresh

- [ ] Add configuration health check (AC: 10)
  - [ ] Add to health check endpoint: `/health/ready`
  - [ ] Include current config version
  - [ ] Include last refresh timestamp
  - [ ] Include time since last successful refresh
  - [ ] Flag as unhealthy if > 10 minutes since last refresh

- [ ] Test Vault integration
  - [ ] Unit test configuration parsing
  - [ ] Unit test validation logic
  - [ ] Integration test with Vault dev server
  - [ ] Test auto-refresh every 5 minutes
  - [ ] Test manual refresh endpoint
  - [ ] Test fallback when Vault unavailable

## Dev Notes

### Vault Configuration Structure
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Vault-Based Rule Engine Design]

**Vault Path**: `secret/intellifin/credit-assessment/config`

**Configuration JSON** (stored in Vault):
```json
{
  "version": "1.0.0",
  "effectiveDate": "2025-10-17",
  "rules": {
    "payroll": [
      {
        "ruleId": "PR-001",
        "name": "Maximum Loan-to-Income Ratio",
        "description": "Loan amount should not exceed 10x monthly gross income",
        "weight": 0.25,
        "condition": {
          "type": "comparison",
          "expression": "requestedAmount / monthlyIncome",
          "operator": "<=",
          "threshold": 10.0
        },
        "isActive": true,
        "passScore": 100,
        "failScore": 0
      }
    ],
    "business": [ /* business rules */ ]
  },
  "thresholds": {
    "maxLoanToIncomeRatio": 10.0,
    "maxDebtToIncomeRatio": 0.40,
    "maxClientExposure": 500000
  },
  "gradeThresholds": {
    "A": { "minScore": 750, "maxScore": 1000 },
    "B": { "minScore": 650, "maxScore": 749 },
    "C": { "minScore": 550, "maxScore": 649 },
    "D": { "minScore": 450, "maxScore": 549 },
    "F": { "minScore": 0, "maxScore": 449 }
  },
  "decisionMatrix": {
    "A": "Approved",
    "B": "Approved",
    "C": "ManualReview",
    "D": "ManualReview",
    "F": "Rejected"
  }
}
```

### VaultConfigService Implementation
[Source: docs/domains/credit-assessment/prd.md#FR5]

```csharp
public class VaultConfigService : IVaultConfigService
{
    private readonly IVaultClient _vaultClient;
    private readonly ILogger<VaultConfigService> _logger;
    private readonly IMemoryCache _cache;
    private CreditAssessmentConfig? _lastKnownGoodConfig;

    public async Task<CreditAssessmentConfig> GetConfigurationAsync()
    {
        // Check cache first
        if (_cache.TryGetValue("vault-config", out CreditAssessmentConfig? cachedConfig))
        {
            return cachedConfig!;
        }

        // Load from Vault
        try
        {
            var secret = await _vaultClient.V1.Secrets.KeyValue.V2
                .ReadSecretAsync(path: "credit-assessment/config", mountPoint: "secret");

            var configJson = secret.Data.Data["config"].ToString();
            var config = JsonSerializer.Deserialize<CreditAssessmentConfig>(configJson);

            // Validate configuration
            ValidateConfiguration(config);

            // Cache for 5 minutes
            _cache.Set("vault-config", config, TimeSpan.FromMinutes(5));

            // Store as last known good
            _lastKnownGoodConfig = config;

            _logger.LogInformation("Vault configuration loaded successfully. Version: {Version}", 
                config.Version);

            return config;
        }
        catch (VaultApiException ex)
        {
            _logger.LogError(ex, "Failed to load configuration from Vault");

            if (_lastKnownGoodConfig != null)
            {
                _logger.LogWarning("Falling back to last-known-good configuration");
                return _lastKnownGoodConfig;
            }

            throw new ConfigurationUnavailableException("Vault unavailable and no fallback config", ex);
        }
    }

    private void ValidateConfiguration(CreditAssessmentConfig config)
    {
        if (string.IsNullOrEmpty(config.Version))
            throw new InvalidConfigurationException("Version is required");

        foreach (var ruleSet in config.Rules.Values)
        {
            foreach (var rule in ruleSet)
            {
                if (rule.Weight < 0 || rule.Weight > 1)
                    throw new InvalidConfigurationException($"Rule {rule.RuleId} has invalid weight");
            }
        }

        // Additional validation...
    }
}
```

### Background Refresh Service
[Source: docs/domains/credit-assessment/prd.md#FR5]

```csharp
public class ConfigurationRefreshService : BackgroundService
{
    private readonly IServiceProvider _serviceProvider;
    private readonly ILogger<ConfigurationRefreshService> _logger;

    protected override async Task ExecuteAsync(CancellationToken stoppingToken)
    {
        while (!stoppingToken.IsCancellationRequested)
        {
            try
            {
                using var scope = _serviceProvider.CreateScope();
                var vaultConfig = scope.ServiceProvider.GetRequiredService<IVaultConfigService>();

                _logger.LogDebug("Refreshing Vault configuration");
                await vaultConfig.RefreshConfigurationAsync();

                await Task.Delay(TimeSpan.FromMinutes(5), stoppingToken);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error refreshing Vault configuration");
                await Task.Delay(TimeSpan.FromMinutes(1), stoppingToken);
            }
        }
    }
}
```

### Configuration Models
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Vault-Based Rule Engine Design]

```csharp
public class CreditAssessmentConfig
{
    public string Version { get; set; }
    public DateTime EffectiveDate { get; set; }
    public Dictionary<string, List<ScoringRuleConfig>> Rules { get; set; }
    public ThresholdConfig Thresholds { get; set; }
    public Dictionary<string, GradeThreshold> GradeThresholds { get; set; }
    public Dictionary<string, string> DecisionMatrix { get; set; }
}

public class ScoringRuleConfig
{
    public string RuleId { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
    public decimal Weight { get; set; }
    public RuleCondition Condition { get; set; }
    public bool IsActive { get; set; }
    public decimal PassScore { get; set; }
    public decimal FailScore { get; set; }
}

public class RuleCondition
{
    public string Type { get; set; }           // "comparison" | "expression"
    public string Expression { get; set; }     // "requestedAmount / monthlyIncome"
    public string Operator { get; set; }       // "<=", ">=", "<", ">", "=="
    public decimal Threshold { get; set; }
}

public class ThresholdConfig
{
    public decimal MaxLoanToIncomeRatio { get; set; }
    public decimal MaxDebtToIncomeRatio { get; set; }
    public decimal MaxClientExposure { get; set; }
}

public class GradeThreshold
{
    public decimal MinScore { get; set; }
    public decimal MaxScore { get; set; }
}
```

### AppRole Authentication
[Source: docs/domains/credit-assessment/prd.md#3.1 Existing Technology Stack]

```csharp
// Program.cs
var vaultSettings = builder.Configuration.GetSection("Vault");

var vaultClientSettings = new VaultClientSettings(
    vaultSettings["Address"],
    new AppRoleAuthMethodInfo(
        roleId: vaultSettings["RoleId"],
        secretId: vaultSettings["SecretId"]
    )
);

builder.Services.AddSingleton<IVaultClient>(new VaultClient(vaultClientSettings));
builder.Services.AddSingleton<IVaultConfigService, VaultConfigService>();
builder.Services.AddHostedService<ConfigurationRefreshService>();
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.8]

**IV1**: Service starts successfully with valid Vault configuration  
**IV2**: Configuration refresh happens automatically every 5 minutes without service disruption  
**IV3**: Service continues operating with cached configuration when Vault is temporarily unavailable

### Testing

#### Unit Tests
- Configuration parsing from JSON works correctly
- Validation catches invalid configurations
- Cache expiration works as expected
- Fallback to last-known-good config when Vault fails

#### Integration Tests
- Load configuration from Vault dev server
- Auto-refresh triggers every 5 minutes
- Manual refresh endpoint updates configuration
- Service continues with cached config when Vault down

#### Manual Testing
- Start Vault dev server: `vault server -dev`
- Store test configuration in Vault
- Verify service loads config on startup
- Update config in Vault, wait 5 minutes, verify refresh
- Test manual refresh: `POST /api/v1/admin/config/refresh`
- Stop Vault, verify fallback to last-known-good

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
