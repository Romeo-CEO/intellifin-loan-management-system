# Story 1.18: Monitoring, Logging, and Alerting Setup

## Status
Draft

## Story
**As a** DevOps Engineer  
**I want** to implement comprehensive monitoring, logging, and alerting for credit assessment service  
**so that** issues can be detected and resolved proactively

## Acceptance Criteria

1. Implement structured logging with Serilog
2. Configure log shipping to centralized logging (ELK or Loki)
3. Create Prometheus metrics for key operations (request rate, latency, errors)
4. Setup Grafana dashboards for service health visualization
5. Implement distributed tracing with OpenTelemetry
6. Create alerting rules for critical conditions (high error rate, slow response)
7. Add health check endpoints (/health, /ready)
8. Log all external service calls with correlation IDs
9. Track business metrics (assessments per day, approval rate)
10. Document monitoring runbooks for on-call engineers

## Tasks / Subtasks

- [ ] Setup structured logging (AC: 1)
  - [ ] Add Serilog NuGet packages
  - [ ] Configure JSON formatting
  - [ ] Add context enrichers (request ID, user ID, timestamp)
  - [ ] Configure log levels per environment

- [ ] Configure log shipping (AC: 2)
  - [ ] Setup Filebeat or Promtail agent
  - [ ] Configure shipping to Elasticsearch/Loki
  - [ ] Create log retention policies
  - [ ] Add log parsing rules

- [ ] Implement Prometheus metrics (AC: 3)
  - [ ] Add prometheus-net library
  - [ ] Expose /metrics endpoint
  - [ ] Add counter for total assessments
  - [ ] Add histogram for assessment duration
  - [ ] Add gauge for active requests
  - [ ] Add counter for external API calls

- [ ] Create Grafana dashboards (AC: 4)
  - [ ] Create service overview dashboard
  - [ ] Add request rate panel
  - [ ] Add latency percentiles panel (p50, p95, p99)
  - [ ] Add error rate panel
  - [ ] Add external dependency status panel
  - [ ] Add business metrics panel

- [ ] Setup distributed tracing (AC: 5)
  - [ ] Add OpenTelemetry SDK
  - [ ] Configure Jaeger exporter
  - [ ] Instrument HTTP requests
  - [ ] Instrument database queries
  - [ ] Instrument external API calls
  - [ ] Propagate trace context

- [ ] Create alerting rules (AC: 6)
  - [ ] Alert on error rate > 5% (5 minutes)
  - [ ] Alert on p95 latency > 3 seconds (5 minutes)
  - [ ] Alert on external service failures
  - [ ] Alert on database connection pool exhaustion
  - [ ] Configure alert routing (PagerDuty, Slack)

- [ ] Implement health checks (AC: 7)
  - [ ] Add health check middleware
  - [ ] Create /health endpoint (liveness)
  - [ ] Create /ready endpoint (readiness)
  - [ ] Check database connectivity
  - [ ] Check external service connectivity

- [ ] Add correlation IDs (AC: 8)
  - [ ] Generate correlation ID per request
  - [ ] Propagate in all log entries
  - [ ] Send to external services in headers
  - [ ] Return in API responses

- [ ] Track business metrics (AC: 9)
  - [ ] Counter for assessments by decision type
  - [ ] Counter for manual overrides
  - [ ] Gauge for assessment queue depth
  - [ ] Counter for KYC invalidations

- [ ] Document runbooks (AC: 10)
  - [ ] Create troubleshooting guide
  - [ ] Document common issues and resolutions
  - [ ] Document alert response procedures
  - [ ] Document escalation paths

## Dev Notes

### Serilog Configuration
[Source: docs/domains/credit-assessment/prd.md#NFR4]

```csharp
public static IHostBuilder CreateHostBuilder(string[] args) =>
    Host.CreateDefaultBuilder(args)
        .UseSerilog((context, services, configuration) => configuration
            .ReadFrom.Configuration(context.Configuration)
            .Enrich.FromLogContext()
            .Enrich.WithProperty("ServiceName", "CreditAssessment")
            .Enrich.WithProperty("Environment", context.HostingEnvironment.EnvironmentName)
            .WriteTo.Console(new JsonFormatter())
            .WriteTo.File(
                new JsonFormatter(),
                path: "/logs/credit-assessment.json",
                rollingInterval: RollingInterval.Day,
                retainedFileCountLimit: 30))
        .ConfigureWebHostDefaults(webBuilder =>
        {
            webBuilder.UseStartup<Startup>();
        });
```

### Prometheus Metrics
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Monitoring]

```csharp
public class MetricsService
{
    private static readonly Counter AssessmentsTotal = Metrics
        .CreateCounter("credit_assessments_total", "Total credit assessments", 
            new[] { "decision", "risk_level" });

    private static readonly Histogram AssessmentDuration = Metrics
        .CreateHistogram("credit_assessment_duration_seconds", 
            "Assessment processing duration in seconds");

    private static readonly Gauge ActiveRequests = Metrics
        .CreateGauge("credit_assessment_active_requests", 
            "Number of active assessment requests");

    private static readonly Counter ExternalApiCalls = Metrics
        .CreateCounter("external_api_calls_total", "External API calls",
            new[] { "service", "status" });

    public void RecordAssessment(string decision, string riskLevel, double duration)
    {
        AssessmentsTotal.WithLabels(decision, riskLevel).Inc();
        AssessmentDuration.Observe(duration);
    }

    public void RecordExternalApiCall(string service, string status)
    {
        ExternalApiCalls.WithLabels(service, status).Inc();
    }

    public IDisposable TrackActiveRequest()
    {
        ActiveRequests.Inc();
        return new ActiveRequestTracker(ActiveRequests);
    }
}

public class ActiveRequestTracker : IDisposable
{
    private readonly Gauge _gauge;

    public ActiveRequestTracker(Gauge gauge) => _gauge = gauge;

    public void Dispose() => _gauge.Dec();
}
```

### Health Check Configuration
[Source: docs/domains/credit-assessment/prd.md Story 1.18]

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddHealthChecks()
        .AddNpgSql(Configuration.GetConnectionString("DefaultConnection"), name: "database")
        .AddUrlGroup(new Uri("http://client-management/health"), name: "client-management")
        .AddUrlGroup(new Uri("http://transunion-api/health"), name: "transunion")
        .AddCheck<VaultHealthCheck>("vault");
}

public void Configure(IApplicationBuilder app)
{
    app.UseHealthChecks("/health", new HealthCheckOptions
    {
        Predicate = _ => true,
        ResponseWriter = UIResponseWriter.WriteHealthCheckUIResponse
    });

    app.UseHealthChecks("/ready", new HealthCheckOptions
    {
        Predicate = check => check.Tags.Contains("ready"),
    });
}
```

### OpenTelemetry Configuration
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Tracing]

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddOpenTelemetryTracing(builder =>
    {
        builder
            .SetResourceBuilder(ResourceBuilder.CreateDefault()
                .AddService("CreditAssessmentService"))
            .AddAspNetCoreInstrumentation()
            .AddHttpClientInstrumentation()
            .AddNpgsql()
            .AddJaegerExporter(options =>
            {
                options.AgentHost = Configuration["Jaeger:Host"];
                options.AgentPort = int.Parse(Configuration["Jaeger:Port"]);
            });
    });
}
```

### Alerting Rules (Prometheus)
[Source: docs/domains/credit-assessment/prd.md#NFR4]

```yaml
groups:
  - name: credit_assessment_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(credit_assessments_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate in credit assessment service"
          description: "Error rate is {{ $value | humanizePercentage }}"

      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(credit_assessment_duration_seconds_bucket[5m])) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High p95 latency in credit assessment"
          description: "p95 latency is {{ $value }}s"

      - alert: ExternalServiceDown
        expr: up{job="transunion"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "TransUnion API is down"
          description: "Cannot reach TransUnion credit bureau"
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.18]

**IV1**: All requests logged with correlation ID for traceability  
**IV2**: Alerts fire within 5 minutes of threshold breach  
**IV3**: Grafana dashboards display real-time service metrics  
**IV4**: Distributed traces show complete request flow across services

### Testing

#### Monitoring Tests
- Verify metrics endpoint returns valid Prometheus format
- Verify health checks return correct status
- Verify logs written in JSON format with required fields
- Verify correlation ID propagation

#### Integration Tests
- Simulate high error rate and verify alert fires
- Simulate high latency and verify alert fires
- Test health check failure scenarios
- Verify distributed trace spans created correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
