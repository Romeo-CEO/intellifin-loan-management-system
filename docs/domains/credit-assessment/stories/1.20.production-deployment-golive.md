# Story 1.20: Production Deployment and Go-Live

## Status
Draft

## Story
**As a** Release Manager  
**I want** to deploy the credit assessment service to production and execute go-live procedures  
**so that** the new system is operational and serving production traffic

## Acceptance Criteria

1. Create production deployment runbook with rollback procedures
2. Setup production infrastructure (databases, services, monitoring)
3. Execute database migration to production with zero downtime
4. Deploy application to production Kubernetes cluster
5. Configure production environment variables and secrets
6. Execute smoke tests on production environment
7. Implement blue-green deployment strategy for zero downtime
8. Enable production monitoring and alerting
9. Perform production data validation (compare old vs new system)
10. Execute gradual traffic migration (10%, 50%, 100%)
11. Document go-live results and post-deployment validation
12. Conduct post-deployment review meeting

## Tasks / Subtasks

- [ ] Create deployment runbook (AC: 1)
  - [ ] Document deployment steps
  - [ ] Document rollback procedures
  - [ ] Document smoke test procedures
  - [ ] Document escalation contacts

- [ ] Setup production infrastructure (AC: 2)
  - [ ] Provision production PostgreSQL database
  - [ ] Configure database replication and backups
  - [ ] Setup production Kubernetes namespace
  - [ ] Configure production load balancers
  - [ ] Setup production Redis cache
  - [ ] Configure production monitoring stack

- [ ] Execute database migration (AC: 3)
  - [ ] Backup production database
  - [ ] Test migration on production clone
  - [ ] Execute migration during maintenance window
  - [ ] Verify migration success
  - [ ] Validate data integrity

- [ ] Deploy application (AC: 4)
  - [ ] Build production Docker images
  - [ ] Push images to production registry
  - [ ] Apply Kubernetes manifests
  - [ ] Verify pod health and readiness
  - [ ] Verify service endpoints

- [ ] Configure environment (AC: 5)
  - [ ] Set production environment variables
  - [ ] Configure secrets in Kubernetes
  - [ ] Retrieve secrets from Vault
  - [ ] Configure feature flags (all disabled initially)

- [ ] Execute smoke tests (AC: 6)
  - [ ] Test health endpoints
  - [ ] Test basic assessment API
  - [ ] Test external service connectivity
  - [ ] Verify monitoring data flowing

- [ ] Implement blue-green deployment (AC: 7)
  - [ ] Deploy new version to "green" environment
  - [ ] Run validation tests on green
  - [ ] Switch traffic to green
  - [ ] Keep blue as rollback

- [ ] Enable monitoring (AC: 8)
  - [ ] Verify Prometheus scraping metrics
  - [ ] Verify Grafana dashboards showing data
  - [ ] Verify alerting rules active
  - [ ] Verify log aggregation working

- [ ] Validate production data (AC: 9)
  - [ ] Compare assessment results (new vs legacy)
  - [ ] Verify data consistency
  - [ ] Check for anomalies
  - [ ] Document any discrepancies

- [ ] Execute traffic migration (AC: 10)
  - [ ] Enable feature flag for 10% of traffic
  - [ ] Monitor for 24 hours
  - [ ] Increase to 50% if stable
  - [ ] Monitor for 24 hours
  - [ ] Increase to 100% if stable

- [ ] Document go-live results (AC: 11)
  - [ ] Record deployment timeline
  - [ ] Record any issues encountered
  - [ ] Record performance metrics
  - [ ] Record lessons learned

- [ ] Conduct review meeting (AC: 12)
  - [ ] Schedule post-deployment review
  - [ ] Review deployment success
  - [ ] Review any incidents
  - [ ] Document action items

## Dev Notes

### Deployment Runbook
[Source: docs/domains/credit-assessment/prd.md#Deployment]

```markdown
# Credit Assessment Service - Production Deployment Runbook

## Pre-Deployment Checklist
- [ ] All tests passing in staging
- [ ] Performance tests meet SLA requirements
- [ ] Security scan completed with no critical issues
- [ ] Database backup completed
- [ ] Rollback plan tested
- [ ] On-call team notified
- [ ] Maintenance window scheduled

## Deployment Steps

### 1. Database Migration (15 minutes)
```bash
# Backup database
kubectl exec -it postgres-0 -- pg_dump -U app creditassessment > backup_$(date +%Y%m%d_%H%M%S).sql

# Test migration on clone
kubectl apply -f db-migration-job.yaml --dry-run=client

# Execute migration
kubectl apply -f db-migration-job.yaml

# Verify migration
kubectl logs job/db-migration -f
```

### 2. Application Deployment (30 minutes)
```bash
# Deploy to green environment
kubectl apply -f k8s/production/green/ --namespace=credit-assessment

# Wait for pods to be ready
kubectl wait --for=condition=ready pod -l app=credit-assessment,slot=green --timeout=300s

# Run smoke tests
./scripts/smoke-tests.sh https://credit-assessment-green.internal

# Switch traffic to green
kubectl patch service credit-assessment -p '{"spec":{"selector":{"slot":"green"}}}'
```

### 3. Post-Deployment Validation (15 minutes)
- Verify health endpoints return 200
- Verify metrics endpoint accessible
- Verify sample assessment request succeeds
- Verify external service connectivity
- Check error rates in Grafana

### 4. Rollback Procedure (if needed)
```bash
# Switch traffic back to blue
kubectl patch service credit-assessment -p '{"spec":{"selector":{"slot":"blue"}}}'

# Rollback database if needed
psql -U app creditassessment < backup_TIMESTAMP.sql
```

## Post-Deployment
- Monitor error rates for 2 hours
- Monitor latency for 2 hours
- Verify all alerts functioning
- Update status page
```

### Kubernetes Manifests
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Deployment]

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: credit-assessment-green
  namespace: credit-assessment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: credit-assessment
      slot: green
  template:
    metadata:
      labels:
        app: credit-assessment
        slot: green
    spec:
      containers:
      - name: credit-assessment
        image: registry.intellifin.com/credit-assessment:v2.0.0
        ports:
        - containerPort: 8080
        env:
        - name: ASPNETCORE_ENVIRONMENT
          value: "Production"
        - name: DATABASE_CONNECTION
          valueFrom:
            secretKeyRef:
              name: credit-assessment-secrets
              key: database-connection
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: credit-assessment
  namespace: credit-assessment
spec:
  selector:
    app: credit-assessment
    slot: green
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
```

### Traffic Migration Script
[Source: docs/domains/credit-assessment/prd.md Story 1.20]

```bash
#!/bin/bash
# traffic-migration.sh

set -e

FEATURE_FLAG="new-credit-assessment-enabled"
LAUNCHDARKLY_API_KEY="${LD_API_KEY}"

# Function to update feature flag percentage
update_percentage() {
    local percentage=$1
    echo "Updating traffic to ${percentage}%..."
    
    curl -X PATCH \
      "https://app.launchdarkly.com/api/v2/flags/production/${FEATURE_FLAG}" \
      -H "Authorization: ${LAUNCHDARKLY_API_KEY}" \
      -H "Content-Type: application/json" \
      -d "{
        \"patch\": [
          {
            \"op\": \"replace\",
            \"path\": \"/environments/production/rules/0/rollout/variations/0/weight\",
            \"value\": ${percentage}000
          }
        ]
      }"
}

# Stage 1: 10% traffic
echo "=== Stage 1: Migrating 10% of traffic ==="
update_percentage 10
echo "Monitoring for 24 hours..."
echo "Check Grafana dashboard and error rates before proceeding."
read -p "Press Enter to continue to 50% or Ctrl+C to abort..."

# Stage 2: 50% traffic
echo "=== Stage 2: Migrating 50% of traffic ==="
update_percentage 50
echo "Monitoring for 24 hours..."
read -p "Press Enter to continue to 100% or Ctrl+C to abort..."

# Stage 3: 100% traffic
echo "=== Stage 3: Migrating 100% of traffic ==="
update_percentage 100
echo "Migration complete! New system is serving all traffic."
```

### Smoke Test Script
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Testing]

```bash
#!/bin/bash
# smoke-tests.sh

set -e

BASE_URL=$1
TOKEN="${API_TOKEN}"

echo "Running smoke tests against ${BASE_URL}"

# Test 1: Health endpoint
echo "Test 1: Health check..."
curl -f "${BASE_URL}/health" || exit 1
echo "✓ Health check passed"

# Test 2: Ready endpoint
echo "Test 2: Readiness check..."
curl -f "${BASE_URL}/ready" || exit 1
echo "✓ Readiness check passed"

# Test 3: Metrics endpoint
echo "Test 3: Metrics endpoint..."
curl -f "${BASE_URL}/metrics" | grep -q "credit_assessments_total" || exit 1
echo "✓ Metrics endpoint passed"

# Test 4: Assessment API
echo "Test 4: Assessment API..."
ASSESSMENT_ID=$(curl -s -X POST "${BASE_URL}/api/v1/assessment" \
  -H "Authorization: Bearer ${TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "123e4567-e89b-12d3-a456-426614174000",
    "loanAmount": 50000,
    "loanTerm": 12
  }' | jq -r '.id')

if [ -z "$ASSESSMENT_ID" ]; then
  echo "✗ Assessment API failed"
  exit 1
fi
echo "✓ Assessment API passed (ID: ${ASSESSMENT_ID})"

echo ""
echo "All smoke tests passed!"
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.20]

**IV1**: Zero downtime during deployment (blue-green switch)  
**IV2**: All production services healthy after deployment  
**IV3**: Gradual traffic migration completes successfully  
**IV4**: Production monitoring and alerting operational

### Testing

#### Pre-Production Tests
- Staging environment fully tested
- Performance tests meet SLA
- Security scan passed
- Database migration tested on production clone

#### Post-Production Tests
- Smoke tests passed
- Health checks return 200
- Sample requests succeed
- Monitoring data flowing
- Alerts functional

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
