# Story 1.5: Client Management API Integration for KYC and Employment Data

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to integrate with Client Management Service to retrieve verified KYC and employment data  
**so that** assessments use real client verification status and income information

## Acceptance Criteria

1. Create `ClientManagementClient` with HTTP client configuration
2. Implement `GetKycProfileAsync(clientId)` method calling Client Management API
3. Implement `GetEmploymentDetailsAsync(clientId)` method
4. Implement `GetVerificationStatusAsync(clientId)` method
5. Add circuit breaker pattern (Polly) with 3 retries and 30-second timeout
6. Handle API failures gracefully with fallback to manual review flag
7. Map Client Management response DTOs to internal assessment data models
8. Add logging for integration calls with correlation IDs
9. Validate KYC verification status before allowing assessment
10. Reject assessment requests when KYC is expired or invalid

## Tasks / Subtasks

- [ ] Create Client Management HTTP client (AC: 1)
  - [ ] Create `Services/Integration/ClientManagementClient.cs`
  - [ ] Inject `IHttpClientFactory` and configure named HTTP client
  - [ ] Configure base URL from configuration (`ExternalServices:ClientManagement:BaseUrl`)
  - [ ] Add authorization header with service-to-service token
  - [ ] Add correlation ID header to all requests

- [ ] Implement KYC profile retrieval (AC: 2)
  - [ ] Implement `GetKycProfileAsync(Guid clientId)` method
  - [ ] Call `GET /api/v1/clients/{clientId}/kyc-profile`
  - [ ] Deserialize response to `KycProfileDto`
  - [ ] Handle 404 (client not found) gracefully
  - [ ] Log API call with client ID and response time

- [ ] Implement employment details retrieval (AC: 3)
  - [ ] Implement `GetEmploymentDetailsAsync(Guid clientId)` method
  - [ ] Call `GET /api/v1/clients/{clientId}/employment`
  - [ ] Deserialize response to `EmploymentDetailsDto`
  - [ ] Extract employer ID, income, employment type
  - [ ] Handle missing employment data (return null)

- [ ] Implement verification status check (AC: 4)
  - [ ] Implement `GetVerificationStatusAsync(Guid clientId)` method
  - [ ] Call `GET /api/v1/clients/{clientId}/verification-status`
  - [ ] Deserialize response to `VerificationStatusDto`
  - [ ] Check KYC expiry date, status (Verified | Expired | Revoked)
  - [ ] Return boolean indicating if client is assessment-ready

- [ ] Add Polly resilience policies (AC: 5)
  - [ ] Add NuGet package: `Polly`, `Microsoft.Extensions.Http.Polly`
  - [ ] Configure retry policy: 3 retries with exponential backoff (2s, 4s, 8s)
  - [ ] Configure circuit breaker: break after 5 consecutive failures, 30s duration
  - [ ] Configure timeout policy: 30-second timeout per request
  - [ ] Apply policies to HTTP client via `AddPolicyHandler`

- [ ] Implement graceful failure handling (AC: 6)
  - [ ] Catch `HttpRequestException` for network failures
  - [ ] Catch `TaskCanceledException` for timeouts
  - [ ] Return `ClientDataUnavailable` result with reason
  - [ ] Set `requiresManualReview` flag when data unavailable
  - [ ] Log error details with exception and client ID

- [ ] Create internal data models (AC: 7)
  - [ ] Create `Models/Integration/KycProfileDto.cs`
  - [ ] Create `Models/Integration/EmploymentDetailsDto.cs`
  - [ ] Create `Models/Integration/VerificationStatusDto.cs`
  - [ ] Create mapping methods to internal `ClientData` model
  - [ ] Handle null/missing fields gracefully in mapping

- [ ] Add comprehensive logging (AC: 8)
  - [ ] Log API call start with correlation ID
  - [ ] Log API call completion with duration
  - [ ] Log API failures with error details
  - [ ] Include client ID (hashed for privacy) in logs
  - [ ] Use structured logging with Serilog

- [ ] Implement KYC validation logic (AC: 9, 10)
  - [ ] Check `VerificationStatus` is "Verified"
  - [ ] Check `ExpiryDate` is in the future
  - [ ] Return validation result with failure reason
  - [ ] Throw `KycInvalidException` if validation fails
  - [ ] Include expiry date and status in exception message

## Dev Notes

### Client Management API Endpoints
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Integration Details]

```http
GET /api/v1/clients/{clientId}/kyc-profile
GET /api/v1/clients/{clientId}/employment
GET /api/v1/clients/{clientId}/verification-status
```

### HTTP Client Configuration
[Source: docs/domains/credit-assessment/prd.md#3.2 Integration Approach]

```csharp
// Program.cs
builder.Services.AddHttpClient("ClientManagement", client =>
{
    client.BaseAddress = new Uri(builder.Configuration["ExternalServices:ClientManagement:BaseUrl"]);
    client.DefaultRequestHeaders.Add("Accept", "application/json");
    client.Timeout = TimeSpan.FromSeconds(30);
})
.AddPolicyHandler(GetRetryPolicy())
.AddPolicyHandler(GetCircuitBreakerPolicy())
.AddPolicyHandler(GetTimeoutPolicy());

static IAsyncPolicy<HttpResponseMessage> GetRetryPolicy()
{
    return HttpPolicyExtensions
        .HandleTransientHttpError()
        .WaitAndRetryAsync(3, retryAttempt => 
            TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)));
}

static IAsyncPolicy<HttpResponseMessage> GetCircuitBreakerPolicy()
{
    return HttpPolicyExtensions
        .HandleTransientHttpError()
        .CircuitBreakerAsync(5, TimeSpan.FromSeconds(30));
}

static IAsyncPolicy<HttpResponseMessage> GetTimeoutPolicy()
{
    return Policy.TimeoutAsync<HttpResponseMessage>(30);
}
```

### Client Implementation
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Integration Details]

```csharp
public class ClientManagementClient : IClientManagementClient
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly ILogger<ClientManagementClient> _logger;

    public async Task<KycProfileDto?> GetKycProfileAsync(Guid clientId)
    {
        var client = _httpClientFactory.CreateClient("ClientManagement");
        var correlationId = Guid.NewGuid().ToString();
        
        using var _ = _logger.BeginScope(new Dictionary<string, object>
        {
            ["CorrelationId"] = correlationId,
            ["ClientId"] = clientId
        });

        try
        {
            _logger.LogInformation("Retrieving KYC profile for client");
            
            var request = new HttpRequestMessage(HttpMethod.Get, $"/api/v1/clients/{clientId}/kyc-profile");
            request.Headers.Add("X-Correlation-Id", correlationId);
            
            var response = await client.SendAsync(request);
            
            if (response.StatusCode == HttpStatusCode.NotFound)
            {
                _logger.LogWarning("Client not found in Client Management Service");
                return null;
            }
            
            response.EnsureSuccessStatusCode();
            
            var kycProfile = await response.Content.ReadFromJsonAsync<KycProfileDto>();
            _logger.LogInformation("Successfully retrieved KYC profile");
            
            return kycProfile;
        }
        catch (HttpRequestException ex)
        {
            _logger.LogError(ex, "HTTP error retrieving KYC profile");
            throw new ClientManagementUnavailableException("Failed to retrieve KYC profile", ex);
        }
        catch (TaskCanceledException ex)
        {
            _logger.LogError(ex, "Timeout retrieving KYC profile");
            throw new ClientManagementUnavailableException("Timeout retrieving KYC profile", ex);
        }
    }

    public async Task<VerificationStatusDto?> GetVerificationStatusAsync(Guid clientId)
    {
        // Similar implementation
    }

    public async Task<EmploymentDetailsDto?> GetEmploymentDetailsAsync(Guid clientId)
    {
        // Similar implementation
    }
}
```

### Data Transfer Objects
[Source: docs/domains/credit-assessment/prd.md#FR2]

```csharp
public class KycProfileDto
{
    public Guid ClientId { get; set; }
    public string NationalId { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public DateTime DateOfBirth { get; set; }
    public string PhoneNumber { get; set; }
    public string Email { get; set; }
}

public class EmploymentDetailsDto
{
    public Guid ClientId { get; set; }
    public Guid? EmployerId { get; set; }
    public string EmployerName { get; set; }
    public string EmploymentType { get; set; }       // PAYROLL | SELF_EMPLOYED | BUSINESS_OWNER
    public decimal MonthlyIncome { get; set; }
    public DateTime? EmploymentStartDate { get; set; }
    public bool IsVerified { get; set; }
}

public class VerificationStatusDto
{
    public Guid ClientId { get; set; }
    public string KycStatus { get; set; }            // Verified | Pending | Expired | Revoked
    public DateTime? KycVerifiedAt { get; set; }
    public DateTime? KycExpiryDate { get; set; }
    public bool IsEmploymentVerified { get; set; }
    public bool IsIdentityVerified { get; set; }
}
```

### KYC Validation Logic
[Source: docs/domains/credit-assessment/prd.md#FR21]

```csharp
public class KycValidator
{
    public KycValidationResult ValidateKyc(VerificationStatusDto status)
    {
        if (status.KycStatus != "Verified")
        {
            return KycValidationResult.Failed($"KYC status is {status.KycStatus}, expected Verified");
        }

        if (status.KycExpiryDate.HasValue && status.KycExpiryDate.Value < DateTime.UtcNow)
        {
            return KycValidationResult.Failed($"KYC expired on {status.KycExpiryDate.Value:yyyy-MM-dd}");
        }

        if (!status.IsIdentityVerified)
        {
            return KycValidationResult.Failed("Identity verification incomplete");
        }

        return KycValidationResult.Success();
    }
}

public class KycValidationResult
{
    public bool IsValid { get; set; }
    public string? FailureReason { get; set; }
    
    public static KycValidationResult Success() => new() { IsValid = true };
    public static KycValidationResult Failed(string reason) => new() { IsValid = false, FailureReason = reason };
}
```

### Circuit Breaker Pattern
[Source: docs/domains/credit-assessment/prd.md#NFR16, FR25]

Circuit breaker prevents cascading failures:
- Opens after 5 consecutive failures
- Stays open for 30 seconds
- Half-opens to test if service recovered
- Closes if test requests succeed

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.5]

**IV1**: Client Management API calls succeed with valid client IDs from test data  
**IV2**: Circuit breaker activates correctly when Client Management Service is unavailable (simulated)  
**IV3**: Assessment fails gracefully with clear error message when KYC data is unavailable

### Testing

#### Unit Tests
- HTTP client sends correct requests with proper headers
- Response deserialization works for all DTO types
- KYC validation logic correctly identifies invalid states
- Exception mapping produces correct error messages

#### Integration Tests
- Successful API call returns expected data
- 404 response handled correctly (returns null)
- Network failure triggers circuit breaker
- Timeout after 30 seconds triggers fallback
- Retry policy attempts 3 times before failing
- KYC validation rejects expired verification

#### Manual Testing with Mock Server
- Start mock Client Management API (WireMock or similar)
- Test successful KYC retrieval
- Test 404 client not found
- Test 500 server error triggering retry
- Test timeout scenario
- Test circuit breaker open state
- Verify correlation IDs in logs

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
