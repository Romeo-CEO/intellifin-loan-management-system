# Story 1.16: Performance Testing and Optimization

## Status
Draft

## Story
**As a** Performance Engineer  
**I want** to conduct comprehensive performance testing and optimize the credit assessment service  
**so that** the system meets SLA requirements under production load

## Acceptance Criteria

1. Setup performance testing environment with production-like data volume
2. Create load test scenarios using k6 or JMeter (100, 500, 1000 concurrent users)
3. Target p95 latency < 2 seconds for assessment API
4. Identify and optimize slow database queries (use EXPLAIN ANALYZE)
5. Implement database connection pooling with appropriate pool size
6. Add database query result caching for frequently accessed data
7. Optimize external API calls (parallel execution where possible)
8. Profile application for memory leaks and excessive allocations
9. Implement request batching for external services
10. Document performance baseline and optimization results
11. Create performance regression tests for CI/CD pipeline

## Tasks / Subtasks

- [ ] Setup performance test environment (AC: 1)
  - [ ] Provision test database with production-like data
  - [ ] Generate 100k test client records
  - [ ] Generate 50k historical assessments
  - [ ] Setup isolated test environment

- [ ] Create load test scenarios (AC: 2)
  - [ ] Install k6 or JMeter
  - [ ] Create test script for assessment API
  - [ ] Configure 100, 500, 1000 concurrent users scenarios
  - [ ] Add realistic think time and ramp-up

- [ ] Execute baseline tests (AC: 3)
  - [ ] Run tests and capture baseline metrics
  - [ ] Measure p50, p95, p99 latency
  - [ ] Measure throughput (requests/sec)
  - [ ] Identify bottlenecks

- [ ] Optimize database queries (AC: 4)
  - [ ] Use EXPLAIN ANALYZE on slow queries
  - [ ] Add missing indexes
  - [ ] Optimize JOIN operations
  - [ ] Consider query plan hints if needed

- [ ] Implement connection pooling (AC: 5)
  - [ ] Configure Npgsql connection pooling
  - [ ] Set min/max pool size appropriately
  - [ ] Monitor connection usage

- [ ] Add database caching (AC: 6)
  - [ ] Cache rule engine rules (30-minute TTL)
  - [ ] Cache client segment data (10-minute TTL)
  - [ ] Cache PMEC results (24-hour TTL)
  - [ ] Use distributed cache (Redis) if needed

- [ ] Optimize external API calls (AC: 7)
  - [ ] Execute TransUnion and PMEC calls in parallel
  - [ ] Use Task.WhenAll for concurrent operations
  - [ ] Add timeout to prevent hanging requests

- [ ] Profile application (AC: 8)
  - [ ] Use dotMemory or Visual Studio profiler
  - [ ] Identify memory leaks
  - [ ] Optimize object allocations
  - [ ] Fix any identified issues

- [ ] Implement request batching (AC: 9)
  - [ ] Batch client management requests
  - [ ] Batch vault rule fetches
  - [ ] Implement debouncing where appropriate

- [ ] Document results (AC: 10)
  - [ ] Create performance report
  - [ ] Document baseline vs optimized metrics
  - [ ] List all optimizations applied
  - [ ] Include recommendations

- [ ] Create regression tests (AC: 11)
  - [ ] Add performance test to CI/CD
  - [ ] Set performance thresholds
  - [ ] Fail build if thresholds exceeded

## Dev Notes

### K6 Load Test Script
[Source: docs/domains/credit-assessment/prd.md#NFR3]

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 },  // Ramp up to 100 users
    { duration: '5m', target: 100 },  // Stay at 100 users
    { duration: '2m', target: 500 },  // Ramp up to 500 users
    { duration: '5m', target: 500 },  // Stay at 500 users
    { duration: '2m', target: 1000 }, // Ramp up to 1000 users
    { duration: '5m', target: 1000 }, // Stay at 1000 users
    { duration: '2m', target: 0 },    // Ramp down
  ],
  thresholds: {
    'http_req_duration': ['p(95)<2000'], // 95% of requests must complete below 2s
    'http_req_failed': ['rate<0.01'],    // Error rate must be below 1%
  },
};

export default function () {
  const url = 'http://localhost:5000/api/v1/assessment';
  const payload = JSON.stringify({
    clientId: '123e4567-e89b-12d3-a456-426614174000',
    loanAmount: 50000,
    loanTerm: 12
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ${__ENV.API_TOKEN}'
    },
  };

  let response = http.post(url, payload, params);
  
  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 2s': (r) => r.timings.duration < 2000,
  });

  sleep(1); // Think time
}
```

### Database Query Optimization Example
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Performance]

```sql
-- Before optimization (slow query)
SELECT * FROM credit_assessments ca
JOIN clients c ON ca.client_id = c.id
WHERE ca.created_at > NOW() - INTERVAL '30 days'
ORDER BY ca.created_at DESC;

-- After optimization
-- Add index
CREATE INDEX idx_credit_assessments_created_at ON credit_assessments(created_at DESC);

-- Optimize query (only select needed columns)
SELECT ca.id, ca.decision, ca.credit_score, ca.created_at, c.name
FROM credit_assessments ca
JOIN clients c ON ca.client_id = c.id
WHERE ca.created_at > NOW() - INTERVAL '30 days'
ORDER BY ca.created_at DESC
LIMIT 100;

-- Verify with EXPLAIN ANALYZE
EXPLAIN ANALYZE
SELECT ca.id, ca.decision, ca.credit_score, ca.created_at, c.name
FROM credit_assessments ca
JOIN clients c ON ca.client_id = c.id
WHERE ca.created_at > NOW() - INTERVAL '30 days'
ORDER BY ca.created_at DESC
LIMIT 100;
```

### Parallel External API Calls
[Source: docs/domains/credit-assessment/prd.md Story 1.16]

```csharp
public async Task<AssessmentData> GatherDataAsync(Guid clientId)
{
    // Execute external calls in parallel instead of sequentially
    var clientTask = _clientManagementClient.GetClientAsync(clientId);
    var creditReportTask = _transUnionClient.GetCreditReportAsync(clientId);
    var pmecTask = _pmecClient.CheckPoliticalExposureAsync(clientId);

    await Task.WhenAll(clientTask, creditReportTask, pmecTask);

    return new AssessmentData
    {
        Client = clientTask.Result,
        CreditReport = creditReportTask.Result,
        PMECResult = pmecTask.Result
    };
}
```

### Connection Pooling Configuration
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Database Configuration]

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=postgres-db;Database=creditassessment;Username=app;Password=${DB_PASSWORD};Pooling=true;Minimum Pool Size=10;Maximum Pool Size=100;Connection Lifetime=300;"
  }
}
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.16]

**IV1**: Assessment API p95 latency < 2 seconds under 1000 concurrent users  
**IV2**: System throughput >= 500 requests/second  
**IV3**: No memory leaks during 1-hour stress test  
**IV4**: Database connection pool efficiently manages connections

### Testing

#### Performance Tests
- Load test with 100 concurrent users
- Load test with 500 concurrent users  
- Load test with 1000 concurrent users
- Stress test to find breaking point
- Endurance test (sustained load for 1+ hours)

#### Metrics to Capture
- Response time (p50, p95, p99)
- Throughput (requests/second)
- Error rate
- CPU utilization
- Memory usage
- Database connection count
- External API latency

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
