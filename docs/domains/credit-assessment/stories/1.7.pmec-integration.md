# Story 1.7: PMEC Government Employee Verification and Payroll Integration

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to integrate with PMEC API to verify government employee status and retrieve payroll data  
**so that** payroll loan assessments use accurate employment and deduction information

## Acceptance Criteria

1. Create `PMECClient` for PMEC API integration
2. Implement `VerifyEmploymentAsync(nrc)` method to confirm government employee status
3. Implement `GetSalaryDetailsAsync(nrc)` to retrieve gross salary, net salary, and payment history
4. Implement `GetExistingDeductionsAsync(nrc)` to retrieve all active payroll deductions
5. Calculate actual disposable income after PMEC deductions
6. Use PMEC data for affordability analysis instead of declared income
7. Handle PMEC API unavailability with fallback to declared income (with warning flag)
8. Validate employment tenure from PMEC data
9. Cache PMEC responses for 24 hours (data refreshes daily)
10. Log discrepancies between declared income and PMEC salary

## Tasks / Subtasks

- [ ] Create PMEC HTTP client (AC: 1)
  - [ ] Create `Services/Integration/PMECClient.cs`
  - [ ] Configure HTTP client with PMEC base URL
  - [ ] Add authentication credentials from Vault
  - [ ] Set timeout to 45 seconds
  - [ ] Add retry policy with exponential backoff

- [ ] Implement employment verification (AC: 2, 8)
  - [ ] Implement `VerifyEmploymentAsync(string nrc)` method
  - [ ] Call `GET /api/v1/employees/{nrc}/verify`
  - [ ] Parse response for employment status (Active | Inactive | Not Found)
  - [ ] Extract employment start date and calculate tenure in months
  - [ ] Validate minimum tenure requirement (12 months for payroll loans)
  - [ ] Return employment verification result with status and tenure

- [ ] Implement salary details retrieval (AC: 3)
  - [ ] Implement `GetSalaryDetailsAsync(string nrc)` method
  - [ ] Call `GET /api/v1/employees/{nrc}/salary`
  - [ ] Extract gross salary, net salary, and basic pay
  - [ ] Extract last 3 months payment history
  - [ ] Calculate average monthly income
  - [ ] Return salary details DTO

- [ ] Implement deductions retrieval (AC: 4)
  - [ ] Implement `GetExistingDeductionsAsync(string nrc)` method
  - [ ] Call `GET /api/v1/employees/{nrc}/deductions`
  - [ ] Extract all active deductions (loans, union, insurance, etc.)
  - [ ] Sum total monthly deductions
  - [ ] Return list of deductions with amounts and purposes
  - [ ] Identify existing IntelliFin loans in deductions

- [ ] Calculate disposable income (AC: 5)
  - [ ] Create `CalculateDisposableIncome` method
  - [ ] Formula: Net Salary - Total Active Deductions
  - [ ] Return disposable income amount
  - [ ] Flag if disposable income is negative (should not happen)
  - [ ] Log calculation for audit

- [ ] Integrate with affordability analysis (AC: 6)
  - [ ] Update `AffordabilityAnalysisService` to accept PMEC data
  - [ ] Use PMEC net salary instead of declared income when available
  - [ ] Use PMEC deductions instead of estimated obligations
  - [ ] Recalculate DTI with actual PMEC figures
  - [ ] Mark assessment as "PMEC-Verified" when using real data

- [ ] Implement fallback logic (AC: 7)
  - [ ] Wrap PMEC calls in try-catch
  - [ ] On failure, use declared income from loan application
  - [ ] Set `incomeSource = "DECLARED"` flag
  - [ ] Set `pmecUnavailable = true` warning flag
  - [ ] Log fallback event with reason
  - [ ] Include warning in assessment explanation

- [ ] Implement Redis caching (AC: 9)
  - [ ] Cache key format: `pmec:employee:{nrc}`
  - [ ] Cache salary details for 24 hours
  - [ ] Cache deductions for 24 hours
  - [ ] Serialize to JSON for caching
  - [ ] Check cache before calling PMEC API

- [ ] Implement discrepancy detection (AC: 10)
  - [ ] Compare declared income from application with PMEC salary
  - [ ] Calculate variance percentage
  - [ ] Log if variance > 10%
  - [ ] Flag assessment for manual review if variance > 20%
  - [ ] Include discrepancy details in assessment notes

## Dev Notes

### PMEC API Endpoints
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Integration Details]

```http
GET /api/v1/employees/{nrc}/verify
GET /api/v1/employees/{nrc}/salary
GET /api/v1/employees/{nrc}/deductions
```

### PMEC Client Implementation
[Source: docs/domains/credit-assessment/prd.md#FR4]

```csharp
public class PMECClient : IPMECClient
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly IDistributedCache _cache;
    private readonly ILogger<PMECClient> _logger;

    public async Task<EmploymentVerificationResult> VerifyEmploymentAsync(string nrc)
    {
        var client = _httpClientFactory.CreateClient("PMEC");
        
        try
        {
            var response = await client.GetAsync($"/api/v1/employees/{nrc}/verify");
            
            if (response.StatusCode == HttpStatusCode.NotFound)
            {
                return new EmploymentVerificationResult
                {
                    IsEmployed = false,
                    Status = "NOT_FOUND"
                };
            }

            response.EnsureSuccessStatusCode();
            
            var data = await response.Content.ReadFromJsonAsync<PMECEmploymentDto>();
            
            return new EmploymentVerificationResult
            {
                IsEmployed = data.Status == "ACTIVE",
                Status = data.Status,
                EmploymentStartDate = data.EmploymentStartDate,
                TenureMonths = CalculateTenureMonths(data.EmploymentStartDate),
                Department = data.Department,
                JobTitle = data.JobTitle
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "PMEC employment verification failed for NRC");
            throw new PMECUnavailableException("Employment verification failed", ex);
        }
    }

    public async Task<SalaryDetailsDto?> GetSalaryDetailsAsync(string nrc)
    {
        // Check cache first
        var cacheKey = $"pmec:salary:{nrc}";
        var cached = await _cache.GetStringAsync(cacheKey);
        
        if (cached != null)
        {
            return JsonSerializer.Deserialize<SalaryDetailsDto>(cached);
        }

        var client = _httpClientFactory.CreateClient("PMEC");
        
        try
        {
            var response = await client.GetAsync($"/api/v1/employees/{nrc}/salary");
            response.EnsureSuccessStatusCode();
            
            var salaryData = await response.Content.ReadFromJsonAsync<SalaryDetailsDto>();
            
            // Cache for 24 hours
            await _cache.SetStringAsync(cacheKey, 
                JsonSerializer.Serialize(salaryData),
                new DistributedCacheEntryOptions
                {
                    AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(24)
                });
            
            return salaryData;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "PMEC salary retrieval failed");
            return null;
        }
    }

    public async Task<List<DeductionDto>> GetExistingDeductionsAsync(string nrc)
    {
        var cacheKey = $"pmec:deductions:{nrc}";
        var cached = await _cache.GetStringAsync(cacheKey);
        
        if (cached != null)
        {
            return JsonSerializer.Deserialize<List<DeductionDto>>(cached);
        }

        var client = _httpClientFactory.CreateClient("PMEC");
        
        try
        {
            var response = await client.GetAsync($"/api/v1/employees/{nrc}/deductions");
            response.EnsureSuccessStatusCode();
            
            var deductions = await response.Content.ReadFromJsonAsync<List<DeductionDto>>();
            
            // Cache for 24 hours
            await _cache.SetStringAsync(cacheKey, 
                JsonSerializer.Serialize(deductions),
                new DistributedCacheEntryOptions
                {
                    AbsoluteExpirationRelativeToNow = TimeSpan.FromHours(24)
                });
            
            return deductions ?? new List<DeductionDto>();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "PMEC deductions retrieval failed");
            return new List<DeductionDto>();
        }
    }
}
```

### Data Models
[Source: docs/domains/credit-assessment/prd.md#FR4]

```csharp
public class SalaryDetailsDto
{
    public string Nrc { get; set; }
    public decimal GrossSalary { get; set; }
    public decimal NetSalary { get; set; }
    public decimal BasicPay { get; set; }
    public List<SalaryPayment> RecentPayments { get; set; }
    public decimal AverageMonthlyIncome { get; set; }
}

public class SalaryPayment
{
    public string PayPeriod { get; set; }           // "2025-10"
    public DateTime PaymentDate { get; set; }
    public decimal Amount { get; set; }
}

public class DeductionDto
{
    public string DeductionCode { get; set; }
    public string Description { get; set; }         // "Loan Repayment - Bank XYZ"
    public decimal MonthlyAmount { get; set; }
    public string Status { get; set; }              // ACTIVE | SUSPENDED
    public DateTime StartDate { get; set; }
    public DateTime? EndDate { get; set; }
}

public class EmploymentVerificationResult
{
    public bool IsEmployed { get; set; }
    public string Status { get; set; }              // ACTIVE | INACTIVE | NOT_FOUND
    public DateTime? EmploymentStartDate { get; set; }
    public int TenureMonths { get; set; }
    public string? Department { get; set; }
    public string? JobTitle { get; set; }
}
```

### Disposable Income Calculation
[Source: docs/domains/credit-assessment/prd.md#FR4]

```csharp
public decimal CalculateDisposableIncome(SalaryDetailsDto salary, List<DeductionDto> deductions)
{
    var totalDeductions = deductions
        .Where(d => d.Status == "ACTIVE")
        .Sum(d => d.MonthlyAmount);

    var disposableIncome = salary.NetSalary - totalDeductions;

    _logger.LogInformation(
        "Disposable income calculated: Net {NetSalary} - Deductions {Deductions} = {Disposable}",
        salary.NetSalary, totalDeductions, disposableIncome);

    return disposableIncome;
}
```

### Affordability Integration
[Source: docs/domains/credit-assessment/prd.md#FR4]

```csharp
public async Task<AffordabilityResult> AnalyzeAffordabilityAsync(
    AssessmentRequest request,
    PMECData pmecData,
    decimal declaredIncome)
{
    decimal monthlyIncome;
    decimal existingObligations;
    string incomeSource;

    if (pmecData != null && pmecData.IsAvailable)
    {
        monthlyIncome = pmecData.Salary.NetSalary;
        existingObligations = pmecData.TotalActiveDeductions;
        incomeSource = "PMEC_VERIFIED";
    }
    else
    {
        monthlyIncome = declaredIncome;
        existingObligations = 0; // Estimate if PMEC unavailable
        incomeSource = "DECLARED";
        
        _logger.LogWarning("PMEC unavailable, using declared income");
    }

    var proposedPayment = CalculateMonthlyPayment(
        request.RequestedAmount, 
        request.TermMonths, 
        GetInterestRate(request.ProductType));

    var disposableIncome = monthlyIncome - existingObligations;
    var dtiRatio = (existingObligations + proposedPayment) / monthlyIncome;

    return new AffordabilityResult
    {
        MonthlyIncome = monthlyIncome,
        IncomeSource = incomeSource,
        ExistingObligations = existingObligations,
        ProposedPayment = proposedPayment,
        DebtToIncomeRatio = dtiRatio,
        DisposableIncome = disposableIncome,
        IsAffordable = dtiRatio <= 0.40m && disposableIncome > proposedPayment
    };
}
```

### Discrepancy Detection
[Source: docs/domains/credit-assessment/prd.md#FR4, AC10]

```csharp
public void LogIncomeDiscrepancy(decimal declared, decimal pmecActual)
{
    var variance = Math.Abs(declared - pmecActual);
    var variancePercent = (variance / pmecActual) * 100;

    if (variancePercent > 10)
    {
        _logger.LogWarning(
            "Income discrepancy detected: Declared {Declared} vs PMEC {Actual} ({Variance}%)",
            declared, pmecActual, variancePercent);

        if (variancePercent > 20)
        {
            _logger.LogWarning("Large discrepancy - flagging for manual review");
            // Set flag in assessment for manual review
        }
    }
}
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.7]

**IV1**: PMEC API calls succeed for test government employee NRCs  
**IV2**: Affordability calculation uses PMEC salary data when available, falls back to declared income when PMEC unavailable  
**IV3**: Assessment captures which income source was used (PMEC vs declared) for audit purposes

### Testing

#### Unit Tests
- Employment verification returns correct status
- Salary details parsing extracts all fields
- Deductions sum calculation is accurate
- Disposable income calculation formula correct
- Discrepancy detection triggers at correct thresholds

#### Integration Tests
- PMEC API calls with test NRCs succeed
- Caching prevents duplicate API calls
- Fallback to declared income when PMEC fails
- Affordability uses PMEC data when available
- Income discrepancy logged when variance > 10%

#### Manual Testing
- Test with PMEC sandbox/test environment
- Use test NRC for government employee
- Verify salary and deduction data returned
- Test with NRC not found (should fallback)
- Simulate PMEC unavailability (timeout)
- Verify cache expiration after 24 hours

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
