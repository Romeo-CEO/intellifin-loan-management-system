# Story 1.14: Workflow Engine Integration with Camunda

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to integrate credit assessment into Camunda workflow  
**so that** credit decisions are properly orchestrated within the loan origination process

## Acceptance Criteria

1. Create Camunda external task worker for credit assessment
2. Worker polls Camunda for "credit-assessment" tasks
3. When task received, extract client ID and loan parameters
4. Call internal assessment logic (reuse existing service)
5. Complete Camunda task with assessment result and decision
6. Handle task failures with retry logic (3 retries with exponential backoff)
7. Set task variables: `creditDecision`, `creditScore`, `assessmentId`
8. Implement timeout handling (task timeout after 2 minutes)
9. Log all workflow interactions for audit
10. Support correlation with loan application process ID

## Tasks / Subtasks

- [ ] Setup Camunda client (AC: 1)
  - [ ] Add Camunda external task client NuGet package
  - [ ] Configure Camunda connection settings
  - [ ] Create worker registration service

- [ ] Implement external task worker (AC: 2, 3)
  - [ ] Create `WorkflowIntegration/CamundaWorker.cs`
  - [ ] Subscribe to "credit-assessment" topic
  - [ ] Poll for tasks every 5 seconds
  - [ ] Extract variables from task

- [ ] Integrate with assessment service (AC: 4)
  - [ ] Extract `clientId`, `loanAmount`, `loanTerm` from task variables
  - [ ] Call `ICreditAssessmentService.AssessAsync()`
  - [ ] Handle service errors gracefully

- [ ] Complete workflow task (AC: 5, 7)
  - [ ] Set output variables on task completion
  - [ ] Map assessment result to workflow variables
  - [ ] Complete task in Camunda

- [ ] Implement retry logic (AC: 6)
  - [ ] Catch exceptions during assessment
  - [ ] Report failure to Camunda with retry count
  - [ ] Use exponential backoff (1s, 2s, 4s)
  - [ ] After 3 failures, send to incident handling

- [ ] Handle timeouts (AC: 8)
  - [ ] Set task lock duration to 2 minutes
  - [ ] If assessment takes longer, unlock task
  - [ ] Log timeout events

- [ ] Add audit logging (AC: 9)
  - [ ] Log when task received
  - [ ] Log when task completed
  - [ ] Log failures and retries
  - [ ] Publish events to AdminService

- [ ] Support process correlation (AC: 10)
  - [ ] Extract `loanApplicationId` from task variables
  - [ ] Include in all logging and events
  - [ ] Allow querying assessments by application ID

## Dev Notes

### Camunda External Task Worker
[Source: docs/domains/credit-assessment/prd.md#FR17]

```csharp
public class CreditAssessmentWorker : IHostedService
{
    private readonly IExternalTaskClient _client;
    private readonly ICreditAssessmentService _assessmentService;
    private readonly ILogger<CreditAssessmentWorker> _logger;

    public Task StartAsync(CancellationToken cancellationToken)
    {
        _client.Subscribe("credit-assessment")
            .Handler(async (externalTask, cancellationToken) =>
            {
                try
                {
                    var clientId = externalTask.Variables["clientId"].Value;
                    var loanAmount = externalTask.Variables["loanAmount"].Value;
                    var loanTerm = externalTask.Variables["loanTerm"].Value;
                    var loanApplicationId = externalTask.Variables["loanApplicationId"].Value;

                    _logger.LogInformation(
                        "Processing credit assessment task for application {ApplicationId}",
                        loanApplicationId);

                    var assessment = await _assessmentService.AssessAsync(
                        clientId,
                        loanAmount,
                        loanTerm);

                    await _client.Complete(externalTask.Id, new Dictionary<string, object>
                    {
                        ["creditDecision"] = assessment.Decision,
                        ["creditScore"] = assessment.CreditScore,
                        ["assessmentId"] = assessment.Id,
                        ["riskLevel"] = assessment.RiskLevel
                    });

                    _logger.LogInformation(
                        "Completed credit assessment for application {ApplicationId}: {Decision}",
                        loanApplicationId,
                        assessment.Decision);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, "Failed to process credit assessment task");
                    
                    await _client.HandleFailure(
                        externalTask.Id,
                        ex.Message,
                        ex.StackTrace,
                        retries: 3,
                        retryTimeout: CalculateRetryTimeout(externalTask.Retries));
                }
            })
            .LockDuration(TimeSpan.FromMinutes(2))
            .PollingInterval(TimeSpan.FromSeconds(5))
            .Execute();

        return Task.CompletedTask;
    }

    private long CalculateRetryTimeout(int currentRetries)
    {
        // Exponential backoff: 1s, 2s, 4s
        return (long)Math.Pow(2, 3 - currentRetries) * 1000;
    }
}
```

### Workflow Configuration
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Workflow Integration]

```json
{
  "Camunda": {
    "BaseUrl": "http://camunda-engine:8080/engine-rest",
    "WorkerId": "credit-assessment-worker",
    "MaxTasks": 10,
    "LockDuration": 120000,
    "PollingInterval": 5000,
    "Topics": [
      {
        "Name": "credit-assessment",
        "LockDuration": 120000,
        "Variables": ["clientId", "loanAmount", "loanTerm", "loanApplicationId"]
      }
    ]
  }
}
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.14]

**IV1**: Camunda workflow task triggers credit assessment correctly  
**IV2**: Assessment result propagated back to workflow with correct variables  
**IV3**: Failed assessments retry 3 times before creating incident  
**IV4**: Loan application process continues correctly after assessment decision

### Testing

#### Unit Tests
- Task variable extraction works correctly
- Output variables mapped correctly
- Retry logic calculates correct backoff

#### Integration Tests
- Worker polls Camunda and receives tasks
- Assessment executed and task completed
- Failure scenarios trigger retries
- Timeout handling works correctly
- Variables propagated to workflow

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
