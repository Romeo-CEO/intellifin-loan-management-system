# Story 1.19: Security Hardening and Compliance

## Status
Draft

## Story
**As a** Security Engineer  
**I want** to implement security hardening and ensure compliance requirements  
**so that** the credit assessment service meets security standards and regulatory requirements

## Acceptance Criteria

1. Implement API authentication with JWT tokens
2. Add role-based authorization for sensitive endpoints
3. Encrypt sensitive data at rest (PII in database)
4. Implement TLS 1.3 for all external communications
5. Add input validation and sanitization to prevent injection attacks
6. Implement rate limiting to prevent abuse (100 requests/minute per user)
7. Add CORS configuration with whitelist
8. Implement security headers (HSTS, CSP, X-Frame-Options)
9. Store secrets in HashiCorp Vault, not config files
10. Add security scanning to CI/CD (SAST, dependency scanning)
11. Document security controls and compliance mappings
12. Implement data retention policies (delete assessments after 7 years)

## Tasks / Subtasks

- [ ] Implement JWT authentication (AC: 1)
  - [ ] Add JWT middleware
  - [ ] Configure JWT validation
  - [ ] Validate token signature and expiry
  - [ ] Extract claims from token

- [ ] Add RBAC authorization (AC: 2)
  - [ ] Create authorization policies
  - [ ] Protect admin endpoints with roles
  - [ ] Protect override endpoints with roles
  - [ ] Add authorization middleware

- [ ] Encrypt sensitive data (AC: 3)
  - [ ] Identify PII fields
  - [ ] Implement column-level encryption
  - [ ] Use AES-256-GCM encryption
  - [ ] Store encryption keys in Vault
  - [ ] Encrypt: client name, ID numbers, contact info

- [ ] Configure TLS (AC: 4)
  - [ ] Configure TLS 1.3 minimum version
  - [ ] Configure strong cipher suites
  - [ ] Disable weak protocols (SSL, TLS 1.0, 1.1)
  - [ ] Configure certificate validation

- [ ] Add input validation (AC: 5)
  - [ ] Validate all API inputs
  - [ ] Sanitize string inputs
  - [ ] Validate UUIDs, amounts, terms
  - [ ] Return 400 for invalid input
  - [ ] Use FluentValidation library

- [ ] Implement rate limiting (AC: 6)
  - [ ] Add AspNetCoreRateLimit package
  - [ ] Configure per-user limits (100 req/min)
  - [ ] Configure per-IP limits (1000 req/min)
  - [ ] Return 429 when exceeded

- [ ] Configure CORS (AC: 7)
  - [ ] Create CORS policy
  - [ ] Whitelist allowed origins
  - [ ] Restrict allowed methods
  - [ ] Restrict allowed headers

- [ ] Add security headers (AC: 8)
  - [ ] Add HSTS header (max-age=31536000)
  - [ ] Add Content-Security-Policy
  - [ ] Add X-Frame-Options: DENY
  - [ ] Add X-Content-Type-Options: nosniff

- [ ] Integrate with Vault for secrets (AC: 9)
  - [ ] Retrieve database password from Vault
  - [ ] Retrieve API keys from Vault
  - [ ] Retrieve encryption keys from Vault
  - [ ] Never store secrets in appsettings.json

- [ ] Add security scanning (AC: 10)
  - [ ] Add SonarQube SAST scanning
  - [ ] Add OWASP Dependency-Check
  - [ ] Add Snyk vulnerability scanning
  - [ ] Fail build on critical vulnerabilities

- [ ] Document security controls (AC: 11)
  - [ ] Create security architecture document
  - [ ] Map controls to compliance frameworks
  - [ ] Document threat model
  - [ ] Document incident response procedures

- [ ] Implement data retention (AC: 12)
  - [ ] Create scheduled job to delete old assessments
  - [ ] Run daily, delete assessments > 7 years old
  - [ ] Log deletions to audit trail
  - [ ] Soft delete with archive option

## Dev Notes

### JWT Authentication
[Source: docs/domains/credit-assessment/prd.md#NFR5]

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
        .AddJwtBearer(options =>
        {
            options.Authority = Configuration["Auth:Authority"];
            options.Audience = Configuration["Auth:Audience"];
            options.RequireHttpsMetadata = true;
            options.TokenValidationParameters = new TokenValidationParameters
            {
                ValidateIssuer = true,
                ValidateAudience = true,
                ValidateLifetime = true,
                ValidateIssuerSigningKey = true,
                ClockSkew = TimeSpan.Zero
            };
        });

    services.AddAuthorization(options =>
    {
        options.AddPolicy("CreditManager", policy =>
            policy.RequireRole("CreditManager"));
        options.AddPolicy("SeniorCreditManager", policy =>
            policy.RequireRole("SeniorCreditManager"));
        options.AddPolicy("Admin", policy =>
            policy.RequireRole("Admin"));
    });
}
```

### Data Encryption
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Security]

```csharp
public class EncryptionService : IEncryptionService
{
    private readonly IVaultClient _vaultClient;
    private byte[] _encryptionKey;

    public async Task InitializeAsync()
    {
        // Retrieve encryption key from Vault
        var secret = await _vaultClient.GetSecretAsync("credit-assessment/encryption-key");
        _encryptionKey = Convert.FromBase64String(secret.Value);
    }

    public string Encrypt(string plaintext)
    {
        if (string.IsNullOrEmpty(plaintext))
            return plaintext;

        using var aes = Aes.Create();
        aes.Key = _encryptionKey;
        aes.Mode = CipherMode.GCM;
        aes.GenerateIV();

        using var encryptor = aes.CreateEncryptor();
        var plaintextBytes = Encoding.UTF8.GetBytes(plaintext);
        var ciphertextBytes = encryptor.TransformFinalBlock(plaintextBytes, 0, plaintextBytes.Length);

        // Return IV + ciphertext as base64
        var combined = new byte[aes.IV.Length + ciphertextBytes.Length];
        Buffer.BlockCopy(aes.IV, 0, combined, 0, aes.IV.Length);
        Buffer.BlockCopy(ciphertextBytes, 0, combined, aes.IV.Length, ciphertextBytes.Length);

        return Convert.ToBase64String(combined);
    }

    public string Decrypt(string ciphertext)
    {
        // Implementation omitted for brevity
    }
}

// Usage in entity
public class CreditAssessment
{
    public Guid Id { get; set; }
    
    [Encrypted] // Custom attribute for encrypted fields
    public string ClientName { get; set; }
    
    [Encrypted]
    public string ClientIdNumber { get; set; }
}
```

### Input Validation
[Source: docs/domains/credit-assessment/prd.md#NFR5]

```csharp
public class AssessmentRequestValidator : AbstractValidator<AssessmentRequest>
{
    public AssessmentRequestValidator()
    {
        RuleFor(x => x.ClientId)
            .NotEmpty()
            .WithMessage("Client ID is required");

        RuleFor(x => x.LoanAmount)
            .GreaterThan(0)
            .LessThanOrEqualTo(10_000_000)
            .WithMessage("Loan amount must be between 0 and 10,000,000");

        RuleFor(x => x.LoanTerm)
            .GreaterThan(0)
            .LessThanOrEqualTo(360)
            .WithMessage("Loan term must be between 1 and 360 months");
    }
}

[ApiController]
[Route("api/v1/[controller]")]
public class AssessmentController : ControllerBase
{
    private readonly IValidator<AssessmentRequest> _validator;

    [HttpPost]
    public async Task<IActionResult> CreateAssessment([FromBody] AssessmentRequest request)
    {
        var validationResult = await _validator.ValidateAsync(request);
        if (!validationResult.IsValid)
        {
            return BadRequest(validationResult.Errors);
        }

        // Process request
    }
}
```

### Rate Limiting Configuration
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Rate Limiting]

```json
{
  "IpRateLimiting": {
    "EnableEndpointRateLimiting": true,
    "StackBlockedRequests": false,
    "RealIpHeader": "X-Real-IP",
    "ClientIdHeader": "X-ClientId",
    "HttpStatusCode": 429,
    "GeneralRules": [
      {
        "Endpoint": "*",
        "Period": "1m",
        "Limit": 100
      },
      {
        "Endpoint": "*",
        "Period": "1h",
        "Limit": 1000
      }
    ]
  }
}
```

### Security Headers
[Source: docs/domains/credit-assessment/prd.md Story 1.19]

```csharp
public void Configure(IApplicationBuilder app)
{
    app.Use(async (context, next) =>
    {
        context.Response.Headers.Add("Strict-Transport-Security", "max-age=31536000; includeSubDomains");
        context.Response.Headers.Add("Content-Security-Policy", "default-src 'self'");
        context.Response.Headers.Add("X-Frame-Options", "DENY");
        context.Response.Headers.Add("X-Content-Type-Options", "nosniff");
        context.Response.Headers.Add("Referrer-Policy", "strict-origin-when-cross-origin");

        await next();
    });
}
```

### Data Retention Job
[Source: docs/domains/credit-assessment/prd.md#Data Retention]

```csharp
public class DataRetentionJob : IHostedService
{
    private readonly IServiceProvider _serviceProvider;
    private Timer _timer;

    public Task StartAsync(CancellationToken cancellationToken)
    {
        // Run daily at 2 AM
        _timer = new Timer(ExecuteRetention, null, TimeSpan.Zero, TimeSpan.FromDays(1));
        return Task.CompletedTask;
    }

    private async void ExecuteRetention(object state)
    {
        using var scope = _serviceProvider.CreateScope();
        var repository = scope.ServiceProvider.GetRequiredService<ICreditAssessmentRepository>();
        var auditClient = scope.ServiceProvider.GetRequiredService<IAdminServiceClient>();

        var cutoffDate = DateTime.UtcNow.AddYears(-7);
        var oldAssessments = await repository.GetAssessmentsOlderThanAsync(cutoffDate);

        foreach (var assessment in oldAssessments)
        {
            await repository.SoftDeleteAsync(assessment.Id);
            await auditClient.PublishEventAsync(new AssessmentDeletedEvent
            {
                AssessmentId = assessment.Id,
                Reason = "DATA_RETENTION_POLICY",
                DeletedAt = DateTime.UtcNow
            });
        }
    }
}
```

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.19]

**IV1**: API rejects requests without valid JWT token  
**IV2**: Sensitive data encrypted at rest in database  
**IV3**: Rate limiting blocks excessive requests  
**IV4**: Security headers present in all HTTP responses  
**IV5**: Old assessments automatically deleted per retention policy

### Testing

#### Security Tests
- Test JWT authentication (valid/invalid tokens)
- Test RBAC authorization (role-based access)
- Test input validation (SQL injection, XSS)
- Test rate limiting enforcement
- Test encryption/decryption
- Test TLS configuration

#### Compliance Tests
- Verify data retention policy execution
- Verify audit trail for sensitive operations
- Verify encryption of PII fields
- Verify secure secret management

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
