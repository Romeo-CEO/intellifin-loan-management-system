# Story 1.2: Database Schema Enhancement for Audit and Configuration Tracking

## Status
Draft

## Story
**As a** Backend Developer  
**I want** to extend the credit assessment database schema with audit and configuration tracking  
**so that** the service can store detailed rule evaluations and track configuration versions

## Acceptance Criteria

1. Create EF Core migration adding columns to `credit_assessments` table:
   - `assessed_by_user_id` (UUID, nullable)
   - `decision_category` (varchar, nullable)
   - `triggered_rules` (JSONB, nullable)
   - `manual_override_by_user_id` (UUID, nullable)
   - `manual_override_reason` (text, nullable)
   - `manual_override_at` (timestamp, nullable)
   - `is_valid` (boolean, default true)
   - `invalid_reason` (varchar, nullable)
   - `vault_config_version` (varchar, nullable)
2. Create new table `credit_assessment_audit` for detailed audit trail
3. Create new table `rule_evaluations` for individual rule results
4. Create new table `assessment_config_versions` for Vault configuration tracking
5. Add appropriate indexes on foreign keys and query columns
6. Test migration in development environment with existing data
7. Verify migration rollback script works correctly
8. Update `CreditAssessment` entity class with new properties
9. Document schema changes in architecture document
10. Migration applies successfully without downtime using blue-green deployment

## Tasks / Subtasks

- [ ] Update CreditAssessment entity class (AC: 8)
  - [ ] Open `libs/IntelliFin.Shared.DomainModels/Entities/CreditAssessment.cs`
  - [ ] Add new properties with appropriate data annotations
  - [ ] Add XML documentation comments for each new property
  - [ ] Ensure nullable properties are correctly marked

- [ ] Create new audit entities (AC: 2, 3, 4)
  - [ ] Create `CreditAssessmentAudit` entity in `Entities` folder
  - [ ] Create `RuleEvaluation` entity with foreign key to CreditAssessment
  - [ ] Create `AssessmentConfigVersion` entity for Vault config tracking
  - [ ] Add DbSet properties to `LmsDbContext`

- [ ] Create EF Core migration (AC: 1)
  - [ ] Run: `dotnet ef migrations add CreditAssessmentAuditEnhancements --context LmsDbContext --project libs/IntelliFin.Shared.DomainModels`
  - [ ] Review generated migration file for correctness
  - [ ] Verify all nullable fields have appropriate defaults
  - [ ] Ensure existing data compatibility (backward compatible changes only)

- [ ] Add database indexes (AC: 5)
  - [ ] Add index on `credit_assessments.loan_application_id`
  - [ ] Add index on `credit_assessments.assessed_by_user_id`
  - [ ] Add index on `credit_assessments.is_valid`
  - [ ] Add composite index on `rule_evaluations(assessment_id, rule_id)`
  - [ ] Add index on `credit_assessment_audit.assessment_id`

- [ ] Test migration in development (AC: 6)
  - [ ] Backup existing test database
  - [ ] Apply migration: `dotnet ef database update --context LmsDbContext`
  - [ ] Verify all new columns exist with correct data types
  - [ ] Insert test records with new fields populated
  - [ ] Query existing records to ensure backward compatibility

- [ ] Create migration rollback script (AC: 7)
  - [ ] Document rollback command: `dotnet ef database update <PreviousMigration>`
  - [ ] Test rollback in isolated development database
  - [ ] Verify data integrity after rollback
  - [ ] Document rollback steps in README

- [ ] Update schema documentation (AC: 9)
  - [ ] Update `docs/domains/credit-assessment/brownfield-architecture.md` with new schema
  - [ ] Document entity relationships (ERD)
  - [ ] Document field purposes and usage
  - [ ] Include example queries for common access patterns

- [ ] Validate production deployment strategy (AC: 10)
  - [ ] Confirm schema changes are additive only (no breaking changes)
  - [ ] Verify existing queries continue working with new schema
  - [ ] Document blue-green deployment approach
  - [ ] Create deployment checklist for production migration

## Dev Notes

### Existing Entity Structure
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Data Models]

Current `CreditAssessment` entity:
```csharp
public class CreditAssessment
{
    public Guid Id { get; set; }
    public Guid LoanApplicationId { get; set; }
    public string RiskGrade { get; set; }
    public decimal CreditScore { get; set; }
    public decimal DebtToIncomeRatio { get; set; }
    public decimal PaymentCapacity { get; set; }
    public bool HasCreditBureauData { get; set; }
    public string ScoreExplanation { get; set; }
    public DateTime AssessedAt { get; set; }
    public string AssessedBy { get; set; }
    public ICollection<CreditFactor> CreditFactors { get; set; }
    public ICollection<RiskIndicator> RiskIndicators { get; set; }
}
```

### New Properties to Add
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Data Models]

```csharp
// Audit and decision tracking
public Guid? AssessedByUserId { get; set; }           // User who triggered (replaces AssessedBy string)
public string? DecisionCategory { get; set; }         // Approved/Conditional/ManualReview/Rejected
public List<string>? TriggeredRules { get; set; }     // Rule IDs that were evaluated (JSONB)

// Manual override tracking
public Guid? ManualOverrideByUserId { get; set; }     // If manually overridden
public string? ManualOverrideReason { get; set; }
public DateTime? ManualOverrideAt { get; set; }

// Validity tracking (for KYC expiry)
public bool IsValid { get; set; } = true;             // False if KYC expired
public string? InvalidReason { get; set; }

// Configuration tracking
public string? VaultConfigVersion { get; set; }       // Track which config version was used
```

### New CreditAssessmentAudit Entity
[Source: docs/domains/credit-assessment/prd.md#FR13]

```csharp
public class CreditAssessmentAudit
{
    public Guid Id { get; set; }
    public Guid AssessmentId { get; set; }
    public string EventType { get; set; }              // Initiated, RuleEvaluated, DecisionMade, Invalidated
    public string EventPayload { get; set; }           // JSON
    public Guid? UserId { get; set; }
    public DateTime Timestamp { get; set; }
    
    // Navigation
    public CreditAssessment Assessment { get; set; }
}
```

### New RuleEvaluation Entity
[Source: docs/domains/credit-assessment/prd.md#FR23]

```csharp
public class RuleEvaluation
{
    public Guid Id { get; set; }
    public Guid AssessmentId { get; set; }
    public string RuleId { get; set; }
    public string RuleName { get; set; }
    public bool Passed { get; set; }
    public decimal Score { get; set; }
    public decimal Weight { get; set; }
    public decimal WeightedScore { get; set; }
    public string InputValues { get; set; }            // JSON
    public string Explanation { get; set; }
    public DateTime EvaluatedAt { get; set; }
    
    // Navigation
    public CreditAssessment Assessment { get; set; }
}
```

### New AssessmentConfigVersion Entity
[Source: docs/domains/credit-assessment/prd.md#FR14, FR24]

```csharp
public class AssessmentConfigVersion
{
    public Guid Id { get; set; }
    public string Version { get; set; }               // e.g., "v1.2.3"
    public string ConfigSnapshot { get; set; }        // Full config JSON from Vault
    public DateTime LoadedAt { get; set; }
    public string LoadedBy { get; set; }              // Service instance or admin user
    public bool IsActive { get; set; }
}
```

### Database Context Updates
[Source: docs/domains/credit-assessment/brownfield-architecture.md#Integration Points]

Add to `LmsDbContext`:
```csharp
public DbSet<CreditAssessmentAudit> CreditAssessmentAudits { get; set; }
public DbSet<RuleEvaluation> RuleEvaluations { get; set; }
public DbSet<AssessmentConfigVersion> AssessmentConfigVersions { get; set; }

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);
    
    // Credit Assessment enhancements
    modelBuilder.Entity<CreditAssessment>()
        .Property(e => e.TriggeredRules)
        .HasColumnType("jsonb");
    
    modelBuilder.Entity<CreditAssessment>()
        .HasIndex(e => e.LoanApplicationId);
    
    modelBuilder.Entity<CreditAssessment>()
        .HasIndex(e => e.IsValid);
    
    // Audit trail
    modelBuilder.Entity<CreditAssessmentAudit>()
        .HasOne(a => a.Assessment)
        .WithMany()
        .HasForeignKey(a => a.AssessmentId)
        .OnDelete(DeleteBehavior.Cascade);
    
    modelBuilder.Entity<CreditAssessmentAudit>()
        .HasIndex(a => a.AssessmentId);
    
    // Rule evaluations
    modelBuilder.Entity<RuleEvaluation>()
        .HasOne(r => r.Assessment)
        .WithMany()
        .HasForeignKey(r => r.AssessmentId)
        .OnDelete(DeleteBehavior.Cascade);
    
    modelBuilder.Entity<RuleEvaluation>()
        .HasIndex(r => new { r.AssessmentId, r.RuleId });
    
    // Config versions
    modelBuilder.Entity<AssessmentConfigVersion>()
        .HasIndex(c => c.Version)
        .IsUnique();
}
```

### Migration Best Practices
[Source: docs/domains/credit-assessment/prd.md#NFR14, CR2]

**Additive-Only Changes**:
- All new columns must have defaults or be nullable
- No removal of existing columns
- No changes to existing column types
- Ensures backward compatibility with running services

**Testing Checklist**:
- ✓ Existing `CreditAssessment` queries still work
- ✓ Migration completes in < 5 seconds on 10,000 record test set
- ✓ Rollback script successfully reverts changes
- ✓ No data loss during migration/rollback cycle

### Integration Verification Requirements
[Source: docs/domains/credit-assessment/prd.md Story 1.2]

**IV1**: Existing queries from Loan Origination, Collections, and Reporting services continue working with new schema (backward compatibility)  
**IV2**: New columns have appropriate default values so existing application code doesn't break  
**IV3**: Database migration completes within 5 seconds on test dataset of 10,000 assessments

### Testing

#### Unit Tests
- Entity class properties have correct data annotations
- DbContext configuration includes new DbSets
- Indexes are correctly configured

#### Integration Tests
- Migration applies successfully to clean database
- Migration applies successfully to database with existing data
- Rollback successfully reverts schema changes
- New entities can be inserted and queried
- Foreign key relationships enforce referential integrity

#### Manual Testing
- Run migration: `dotnet ef database update --context LmsDbContext`
- Verify schema: `SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name = 'credit_assessments'`
- Insert test assessment with new fields
- Query existing assessments (ensure backward compatibility)
- Test rollback: `dotnet ef database update <PreviousMigration>`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used
(To be populated by development agent)

### Debug Log References
(To be populated by development agent)

### Completion Notes List
(To be populated by development agent)

### File List
(To be populated by development agent)

## QA Results
(To be populated by QA agent)
