# Story 1.4: Reconciliation Engine and PMEC Integration

## Status: Draft

## Story

**As a finance officer,**  
**I want automated reconciliation of bank statements and PMEC files,**  
**so that I can efficiently match internal records with external data and identify discrepancies.**

## Acceptance Criteria

1. Bank statement parsing handles multiple formats with fuzzy matching capabilities
2. PMEC file ingestion processes TXT files from email with automated parsing
3. Reconciliation engine matches transactions with configurable date tolerances
4. Partial matches and exceptions are routed to Camunda manual reconciliation workflows
5. Reconciliation results feed back into Collections for provisioning accuracy
6. Comprehensive audit trails track all reconciliation activities and decisions

## Tasks / Subtasks

- [ ] Task 1: Implement Bank Statement Parser (AC: 1)
  - [ ] Create flexible statement parser supporting multiple bank formats
  - [ ] Implement fuzzy matching algorithms for transaction identification
  - [ ] Add configurable parsing rules and field mapping
  - [ ] Create validation for parsed statement data integrity

- [ ] Task 2: Build PMEC File Ingestion Pipeline (AC: 2)
  - [ ] Create email-based file ingestion from CommunicationsService
  - [ ] Implement TXT file parser for PMEC settlement data
  - [ ] Add PMEC-specific data validation and normalization
  - [ ] Create file processing queue with error handling

- [ ] Task 3: Develop Reconciliation Matching Engine (AC: 3)
  - [ ] Implement core reconciliation algorithms with configurable tolerances
  - [ ] Add date tolerance matching for transaction timing differences
  - [ ] Create partial match detection and scoring system
  - [ ] Build exception identification and categorization logic

- [ ] Task 4: Manual Reconciliation Workflow Integration (AC: 4)
  - [ ] Create Camunda BPMN workflow for manual reconciliation review
  - [ ] Implement workflow tasks for finance officer exception handling
  - [ ] Add integration with AdminService for reconciliation approvals
  - [ ] Create workflow for partial match resolution

- [ ] Task 5: Collections Integration and Feedback (AC: 5)
  - [ ] Implement event publishing for reconciliation results to Collections
  - [ ] Create reconciliation status updates for loan provisioning
  - [ ] Add feedback loop for improving reconciliation accuracy
  - [ ] Build reconciliation reporting integration with FinancialService

- [ ] Task 6: Comprehensive Audit Trail System (AC: 6)
  - [ ] Create detailed audit logging for all reconciliation activities
  - [ ] Implement audit event generation for manual reconciliation decisions
  - [ ] Add reconciliation result tracking and reporting
  - [ ] Integrate with AdminService audit patterns for compliance

- [ ] Task 7: File Processing and Storage (AC: All)
  - [ ] Implement MinIO integration for processed statement storage
  - [ ] Add WORM retention for financial documents
  - [ ] Create file processing status tracking and error recovery
  - [ ] Build file validation and integrity checking

- [ ] Task 8: Advanced Reconciliation Features (AC: All)
  - [ ] Implement configurable matching rules and thresholds
  - [ ] Add bulk reconciliation processing capabilities
  - [ ] Create reconciliation performance monitoring and metrics
  - [ ] Build automated reconciliation scheduling and batch processing

- [ ] Task 9: Comprehensive Testing Suite (AC: All)
  - [ ] Create unit tests for reconciliation matching algorithms
  - [ ] Test bank statement parsing with various formats
  - [ ] Validate PMEC file processing and data extraction
  - [ ] Test manual reconciliation workflow integration
  - [ ] Integration testing with Collections and FinancialService

## Dev Notes

### Technical Context from Architecture Documents

**External Data Processing:**
- Handle messy bank statement formats with inconsistent columns and dates
- PMEC TXT files come via email with non-standard formatting
- Implement fuzzy matching with configurable date tolerances
- Follow existing file processing patterns from CommunicationsService [Source: brownfield-architecture.md#workarounds-and-integration-gotchas]

**Reconciliation Patterns:**
- Extend CollectionsService reconciliation patterns for Treasury operations
- Use configurable matching algorithms with scoring systems
- Implement manual exception handling through Camunda workflows
- Maintain audit trails for all reconciliation decisions [Source: brownfield-architecture.md#integration-points]

**File Ingestion Pipeline:**
- Follow CommunicationsService email processing patterns
- Implement MinIO WORM retention for financial documents
- Add comprehensive error handling and retry mechanisms
- Support multiple file formats with validation [Source: brownfield-architecture.md#pmec-data-integration]

**Audit and Compliance:**
- Generate structured audit events for all reconciliation activities
- Follow AdminService audit trail patterns for financial operations
- Implement digital signatures for manual reconciliation approvals
- Maintain BoZ compliance for all reconciliation processes [Source: brownfield-architecture.md#security-and-audit]

### File Locations and Implementation Details

**Core Reconciliation Files:**
- `apps/IntelliFin.TreasuryService/Services/ReconciliationService.cs` - Main reconciliation logic
- `apps/IntelliFin.TreasuryService/Services/BankStatementParser.cs` - External statement processing
- `apps/IntelliFin.TreasuryService/Services/PmecFileProcessor.cs` - PMEC data ingestion
- `apps/IntelliFin.TreasuryService/Services/ReconciliationMatcher.cs` - Matching algorithms

**Workflow Integration:**
- `apps/IntelliFin.TreasuryService/Workers/Camunda/ReconciliationWorker.cs` - Manual review worker
- `apps/IntelliFin.TreasuryService/BPMN/treasury-reconciliation.bpmn` - Reconciliation workflow
- `apps/IntelliFin.TreasuryService/Consumers/StatementUploadConsumer.cs` - File upload processing

**Data Models:**
- `apps/IntelliFin.TreasuryService/Models/ReconciliationEntry.cs` - Reconciliation records
- `apps/IntelliFin.TreasuryService/Models/MatchResult.cs` - Matching results and scores
- `apps/IntelliFin.TreasuryService/Models/ExceptionCase.cs` - Manual review cases
- `apps/IntelliFin.TreasuryService/Models/BankStatement.cs` - Parsed statement data

**File Processing:**
- `apps/IntelliFin.TreasuryService/Infrastructure/FileProcessing/StatementProcessor.cs` - File handling
- `apps/IntelliFin.TreasuryService/Infrastructure/FileProcessing/MinioStorageService.cs` - Document storage

### Testing Requirements

**Unit Testing Standards:**
- Test fuzzy matching algorithms with various data scenarios
- Validate bank statement parsing with multiple formats
- Test PMEC file processing with malformed data
- Verify reconciliation scoring and threshold logic
- Test audit event generation and formatting [Source: brownfield-architecture.md#testing-standards]

**Integration Testing:**
- Test file upload and processing pipeline end-to-end
- Validate reconciliation workflow with Collections integration
- Test manual reconciliation approval processes
- Verify MinIO document storage and retrieval
- CommunicationsService email integration testing

**Data Quality Testing:**
- Test parsing accuracy with real bank statement samples
- Validate matching algorithms with historical transaction data
- Test exception handling with various data anomalies
- Verify audit trail completeness for compliance

**Performance Testing:**
- Load testing for bulk reconciliation processing
- File parsing performance with large statement files
- Database query optimization for reconciliation operations
- Memory usage validation for large data processing

### Technical Constraints and Integration Notes

**Data Quality Challenges:**
- Bank statements have inconsistent formatting and missing data
- PMEC files use non-standard TXT format with encoding issues
- Date formats vary across different banks and systems
- Transaction references may be truncated or inconsistent

**Reconciliation Accuracy:**
- Implement configurable matching rules for different data sources
- Use scoring algorithms for partial match identification
- Allow manual override for business rule exceptions
- Maintain audit trails for all matching decisions

**File Processing Pipeline:**
- Email ingestion must handle various attachment types
- File validation must prevent corrupted data processing
- WORM storage required for compliance retention
- Error recovery must maintain processing state

**Performance Considerations:**
- Large statement files must process efficiently
- Fuzzy matching algorithms must scale with transaction volume
- Database queries must be optimized for reconciliation operations
- Real-time processing must not impact existing system performance

### Integration Verification Points

**Existing System Integrity:**
- Collections repayment processing continues without disruption
- PMEC integration patterns from Collections are properly extended
- CommunicationsService email processing remains functional
- FinancialService compliance reporting includes Treasury reconciliation data
- AdminService audit trails capture reconciliation activities

**Data Quality Validation:**
- Bank statement parsing accuracy meets business requirements
- PMEC data extraction maintains data fidelity
- Reconciliation matching accuracy >99% for automated matches
- Manual exception rate <1% of total transactions

**Compliance Validation:**
- All reconciliation activities generate proper audit trails
- WORM document retention meets BoZ requirements
- Manual reconciliation decisions are properly documented
- Regulatory reporting includes reconciliation status

## Testing

**Testing Standards from Architecture:**
- Unit tests using xUnit framework following FinancialService patterns
- Integration tests with file processing and external data sources
- API testing with comprehensive data validation
- Performance testing for large-scale reconciliation operations
- Security testing for all data processing and audit functions

**Test Coverage Requirements:**
- Business logic components: >95% coverage
- File parsing and data extraction: >90% coverage
- Matching algorithms and reconciliation logic: >95% coverage
- Workflow integration and manual processes: >90% coverage
- Error handling and data validation: 100% coverage

## Change Log

| Date       | Version | Description                          | Author    |
| ---------- | ------- | ------------------------------------ | --------- |
| 2025-01-26 | 1.0     | Initial story creation for reconciliation engine and PMEC integration | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Developer Agent*

### Debug Log References
*To be populated by Developer Agent*

### Completion Notes List
*To be populated by Developer Agent*

### File List
*To be populated by Developer Agent*

## QA Results

*To be populated by QA Agent*
