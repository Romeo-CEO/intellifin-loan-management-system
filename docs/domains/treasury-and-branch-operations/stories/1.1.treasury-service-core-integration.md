# Story 1.1: TreasuryService Core Integration and Database Setup

## Status: Draft

## Story

**As a system administrator,**  
**I want the TreasuryService microservice to be properly integrated with the existing IntelliFin architecture,**  
**so that it can safely handle financial operations without disrupting existing services.**

## Acceptance Criteria

1. TreasuryService microservice is created and deployed following existing .NET 9 patterns
2. Database schema is created with Entity Framework migrations extending existing patterns
3. Basic service-to-service communication is established with Loan Origination and Collections
4. Health checks and monitoring are integrated with existing OpenTelemetry infrastructure
5. Service integrates with existing API Gateway routing and authentication patterns

## Tasks / Subtasks

- [ ] Task 1: Create TreasuryService Project Structure (AC: 1)
  - [ ] Create new .NET 9 microservice project following IntelliFin patterns
  - [ ] Set up project file with proper dependencies and configurations
  - [ ] Configure logging, health checks, and monitoring integration
  - [ ] Add Docker configuration following existing service patterns

- [ ] Task 2: Implement Database Schema and Entity Framework Setup (AC: 2)
  - [ ] Create TreasuryDbContext extending existing Entity Framework patterns
  - [ ] Define Treasury-specific entities (TreasuryTransaction, BranchFloat, etc.)
  - [ ] Create Entity Framework migrations for new schema
  - [ ] Implement repository patterns following FinancialService examples
  - [ ] Add database connection configuration with existing patterns

- [ ] Task 3: Establish Service-to-Service Communication (AC: 3)
  - [ ] Implement event consumers for Loan Origination disbursement requests
  - [ ] Set up RabbitMQ event publishing following ClientManagement patterns
  - [ ] Create service discovery registration with existing infrastructure
  - [ ] Implement circuit breakers for external service dependencies

- [ ] Task 4: Integrate Monitoring and Health Checks (AC: 4)
  - [ ] Add OpenTelemetry integration following existing service patterns
  - [ ] Implement health checks for database and external services
  - [ ] Set up metrics collection for Treasury operations
  - [ ] Configure logging integration with existing ELK stack

- [ ] Task 5: API Gateway and Authentication Integration (AC: 5)
  - [ ] Create REST API controllers following FinancialService patterns
  - [ ] Implement authentication middleware consistent with existing services
  - [ ] Add API documentation with Swagger following established patterns
  - [ ] Configure routing and rate limiting through existing API Gateway

- [ ] Task 6: Add Comprehensive Unit Tests (AC: All)
  - [ ] Create unit tests for all TreasuryService components
  - [ ] Test Entity Framework repository implementations
  - [ ] Validate event publishing and consumption logic
  - [ ] Test health check endpoints and monitoring integration

## Dev Notes

### Technical Context from Architecture Documents

**Project Structure Integration:**
- Follow existing .NET 9 microservice patterns from FinancialService and AdminService
- Place TreasuryService in `apps/IntelliFin.TreasuryService/` directory structure
- Use Entity Framework Core patterns consistent with existing services [Source: brownfield-architecture.md#source-tree-and-module-organization]

**Database Integration:**
- Extend existing SQL Server database schema using Entity Framework migrations
- Follow established migration patterns from existing services
- Implement connection pooling and retry patterns from current infrastructure
- Use existing database backup and recovery procedures [Source: brownfield-architecture.md#integration-points-and-service-dependencies]

**Service Communication:**
- Use RabbitMQ event-driven architecture following ClientManagement patterns
- Implement MassTransit consumers for service integration
- Follow event ordering and deduplication patterns from existing services
- Use existing circuit breaker implementations for resilience [Source: brownfield-architecture.md#event-driven-architecture]

**Monitoring and Observability:**
- Integrate with existing OpenTelemetry infrastructure from FinancialService
- Follow established logging patterns from AdminService
- Use existing Grafana dashboards and alerting systems
- Implement health checks following established patterns [Source: brownfield-architecture.md#monitoring-and-logging]

**Security Integration:**
- Use existing Vault patterns for secret management
- Implement authentication following IdentityService patterns
- Integrate with existing API Gateway security middleware
- Follow established security testing patterns [Source: brownfield-architecture.md#security-and-audit-requirements]

### File Locations and Implementation Details

**Core Service Files:**
- `apps/IntelliFin.TreasuryService/Program.cs` - Main application entry point
- `apps/IntelliFin.TreasuryService/Services/TreasuryService.cs` - Core business logic
- `apps/IntelliFin.TreasuryService/Infrastructure/Persistence/TreasuryDbContext.cs` - Database context
- `apps/IntelliFin.TreasuryService/Infrastructure/Persistence/Repositories/` - Repository implementations
- `apps/IntelliFin.TreasuryService/Controllers/TreasuryController.cs` - REST API endpoints

**Integration Files:**
- `apps/IntelliFin.TreasuryService/Consumers/LoanDisbursementConsumer.cs` - Event consumer for loan origination
- `apps/IntelliFin.TreasuryService/Infrastructure/HealthChecks/` - Service health monitoring
- `apps/IntelliFin.TreasuryService/Infrastructure/Configuration/` - Application configuration

### Testing Requirements

**Unit Testing Standards:**
- Follow existing unit testing patterns from FinancialService
- Test coverage >95% for all business logic components
- Use xUnit testing framework following established patterns
- Mock external dependencies using existing mocking patterns [Source: brownfield-architecture.md#testing-strategy]

**Integration Testing:**
- Test database operations with Entity Framework patterns
- Validate RabbitMQ event publishing and consumption
- Test API endpoints with existing authentication patterns
- Verify health check integration with monitoring systems

**Test File Locations:**
- `tests/IntelliFin.TreasuryService.Tests/` - Main test project
- `tests/IntelliFin.TreasuryService.IntegrationTests/` - Integration tests
- Test files should follow existing naming conventions and structure

### Technical Constraints and Integration Notes

**Performance Considerations:**
- Database queries must not impact existing system performance
- Event processing should handle concurrent operations efficiently
- Memory usage should align with existing service patterns
- Balance updates should use Redis caching for real-time performance [Source: brownfield-architecture.md#performance-considerations]

**Security Requirements:**
- All API endpoints must use mTLS encryption
- Database connections must use existing security patterns
- Authentication must integrate with IdentityService patterns
- Audit logging must follow AdminService comprehensive audit patterns [Source: brownfield-architecture.md#security-implementation]

**Error Handling:**
- Implement circuit breakers for external service failures
- Use structured exception handling following existing patterns
- Provide graceful degradation during service outages
- Log all errors with proper context for debugging

### Project Structure Alignment

**File Organization:**
- Follow established .NET microservice directory structure
- Place in `apps/` directory alongside existing services
- Use consistent naming conventions from FinancialService and AdminService
- Maintain separation of concerns following existing patterns

**Configuration Management:**
- Use Vault for all sensitive configuration following AdminService patterns
- Environment variables must follow existing naming conventions
- Feature flags for gradual rollout of Treasury capabilities
- Integration with existing configuration management systems

## Testing

**Testing Standards from Architecture:**
- Unit tests using xUnit framework following FinancialService patterns
- Integration tests with Entity Framework and RabbitMQ following established patterns
- API testing with authentication and authorization validation
- Performance testing to ensure no impact on existing system benchmarks
- Security testing for all endpoints and data access patterns

**Test Coverage Requirements:**
- Business logic components: >95% coverage
- Repository implementations: >90% coverage
- Event handlers and consumers: >95% coverage
- API controllers: >90% coverage
- Error handling paths: 100% coverage

## Change Log

| Date       | Version | Description                          | Author    |
| ---------- | ------- | ------------------------------------ | --------- |
| 2025-01-26 | 1.0     | Initial story creation for TreasuryService core integration | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Developer Agent*

### Debug Log References
*To be populated by Developer Agent*

### Completion Notes List
*To be populated by Developer Agent*

### File List
*To be populated by Developer Agent*

## QA Results

*To be populated by QA Agent*
