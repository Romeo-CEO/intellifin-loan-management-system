# Story 1.3: Branch Float Management and Liquidity Dashboard

## Status: Draft

## Story

**As a branch manager,**  
**I want real-time visibility of branch cash positions and liquidity management,**  
**so that I can effectively manage branch operations and request top-ups when needed.**

## Acceptance Criteria

1. Real-time branch float balances are maintained and updated via Redis caching
2. Liquidity dashboard provides real-time visibility of all account balances and pending obligations
3. Float top-up requests trigger Camunda workflows with dual authorization
4. Automated alerts are generated for limit breaches and low balance conditions
5. Branch-level cash position reports are generated automatically
6. Integration with CommunicationsService for balance alerts and notifications

## Tasks / Subtasks

- [ ] Task 1: Implement Branch Float Data Model and Repository (AC: 1)
  - [ ] Create BranchFloat entity following FinancialService patterns
  - [ ] Implement Entity Framework repository with caching support
  - [ ] Add Redis integration for real-time balance updates
  - [ ] Create database migration for branch float schema

- [ ] Task 2: Build Liquidity Dashboard API Endpoints (AC: 2)
  - [ ] Create REST API controllers for liquidity data following FinancialService patterns
  - [ ] Implement real-time balance aggregation across all accounts
  - [ ] Add pending obligations calculation and display
  - [ ] Create dashboard data models and DTOs

- [ ] Task 3: Implement Float Top-Up Workflow (AC: 3)
  - [ ] Create Camunda BPMN workflow for float top-up requests
  - [ ] Implement dual authorization through AdminService patterns
  - [ ] Add workflow integration with TreasuryService processing
  - [ ] Create top-up execution and balance update logic

- [ ] Task 4: Automated Alert System (AC: 4)
  - [ ] Implement balance monitoring and threshold checking
  - [ ] Create automated alert generation for limit breaches
  - [ ] Integrate with CommunicationsService notification patterns
  - [ ] Add configurable alert rules and escalation procedures

- [ ] Task 5: Cash Position Reporting (AC: 5)
  - [ ] Create automated report generation for branch cash positions
  - [ ] Implement report scheduling and distribution
  - [ ] Add PDF/Excel export capabilities following existing patterns
  - [ ] Integrate with MinIO for document storage and retention

- [ ] Task 6: Communications Integration (AC: 6)
  - [ ] Implement notification service integration for balance alerts
  - [ ] Create email and SMS templates for treasury notifications
  - [ ] Add notification preferences and delivery tracking
  - [ ] Integrate with existing CommunicationsService patterns

- [ ] Task 7: Dashboard Frontend Integration (AC: 2)
  - [ ] Create liquidity dashboard components following existing UI patterns
  - [ ] Implement real-time data updates with WebSocket or polling
  - [ ] Add responsive design for mobile and desktop access
  - [ ] Integrate with existing authentication and authorization

- [ ] Task 8: Comprehensive Testing Suite (AC: All)
  - [ ] Create unit tests for branch float calculations and updates
  - [ ] Test Redis caching performance and accuracy
  - [ ] Validate Camunda workflow integration for top-ups
  - [ ] Test alert system triggers and notifications
  - [ ] Integration testing with CommunicationsService

## Dev Notes

### Technical Context from Architecture Documents

**Redis Caching Integration:**
- Use Redis for real-time balance caching following FinancialService dashboard patterns
- Implement cache invalidation strategies for financial data consistency
- Follow established Redis key naming conventions and TTL patterns
- Ensure cache performance doesn't impact existing system benchmarks [Source: brownfield-architecture.md#performance-considerations]

**Dashboard Implementation:**
- Follow FinancialService DashboardService patterns for real-time data
- Use existing authentication and authorization patterns for access control
- Implement responsive design following established UI/UX guidelines
- Integrate with existing monitoring and logging infrastructure [Source: brownfield-architecture.md#frontend-integration-strategy]

**Camunda Workflow Extension:**
- Extend existing workflow patterns from ClientManagement for branch operations
- Use Zeebe task definitions: `branch-float-topup`, `liquidity-alert`
- Follow dual authorization patterns from AdminService for financial approvals
- Implement worker classes following established Camunda worker patterns [Source: brownfield-architecture.md#camunda-workflow-integration]

**Communications Integration:**
- Follow CommunicationsService notification patterns for financial alerts
- Use existing email and SMS templates as reference for treasury notifications
- Implement notification queuing and delivery tracking
- Add notification preferences following existing user management patterns [Source: brownfield-architecture.md#integration-points]

### File Locations and Implementation Details

**Core Service Files:**
- `apps/IntelliFin.TreasuryService/Services/LiquidityService.cs` - Real-time balance management
- `apps/IntelliFin.TreasuryService/Services/BranchFloatService.cs` - Branch operations logic
- `apps/IntelliFin.TreasuryService/Services/AlertService.cs` - Automated alert generation
- `apps/IntelliFin.TreasuryService/Controllers/DashboardController.cs` - Liquidity dashboard API

**Workflow Integration:**
- `apps/IntelliFin.TreasuryService/Workers/Camunda/BranchFloatWorker.cs` - Top-up workflow worker
- `apps/IntelliFin.TreasuryService/BPMN/branch-float-management.bpmn` - Top-up workflow definition
- `apps/IntelliFin.TreasuryService/Consumers/BranchOperationConsumer.cs` - Branch event processing

**Data Models:**
- `apps/IntelliFin.TreasuryService/Models/BranchFloat.cs` - Branch cash position tracking
- `apps/IntelliFin.TreasuryService/Models/LiquidityPosition.cs` - Real-time liquidity data
- `apps/IntelliFin.TreasuryService/Models/AlertConfiguration.cs` - Alert rule definitions
- `apps/IntelliFin.TreasuryService/Models/CashPositionReport.cs` - Report data structures

**Caching Implementation:**
- `apps/IntelliFin.TreasuryService/Infrastructure/Caching/RedisBalanceCache.cs` - Balance caching
- `apps/IntelliFin.TreasuryService/Infrastructure/Caching/CacheInvalidationService.cs` - Cache management

### Testing Requirements

**Unit Testing Standards:**
- Test financial calculations with decimal precision validation
- Mock Redis caching for balance update testing
- Validate alert threshold calculations and triggers
- Test Camunda workflow state management for top-ups
- Verify notification template generation and delivery [Source: brownfield-architecture.md#testing-standards]

**Integration Testing:**
- Test Redis cache integration with database consistency
- Validate dashboard API performance under load
- Test Camunda workflow integration with AdminService approvals
- Verify CommunicationsService notification delivery
- End-to-end testing of float top-up workflows

**Performance Testing:**
- Load testing for concurrent balance updates across multiple branches
- Dashboard API response time validation (<500ms required)
- Redis cache performance testing with financial data
- Alert generation performance under various load conditions

**User Interface Testing:**
- Dashboard functionality testing across different devices
- Real-time update validation for balance changes
- Alert notification display and interaction testing
- Accessibility compliance validation

### Technical Constraints and Integration Notes

**Real-Time Balance Updates:**
- All balance updates must be atomic and consistent
- Redis caching must sync with database for persistence
- Cache invalidation must prevent stale data issues
- Performance must meet sub-second requirements for dashboard updates

**Branch Operations Integration:**
- Must integrate with existing ClientManagement branch data
- Follow established patterns for branch-level operations
- Maintain compatibility with existing branch authorization
- Support both automated and manual balance management

**Alert System Requirements:**
- Configurable thresholds for different branch types
- Escalation procedures for persistent low balances
- Integration with existing notification preferences
- Audit trail for all alert generation and acknowledgment

**Dashboard Security:**
- Role-based access control for different dashboard views
- Data encryption for sensitive financial information
- Secure API endpoints with proper authentication
- Integration with existing session management

### Integration Verification Points

**Existing System Integrity:**
- ClientManagement branch operations continue without disruption
- Redis caching performance meets existing benchmarks
- CommunicationsService notification patterns remain functional
- FinancialService dashboard patterns are properly extended
- AdminService approval workflows handle branch authorizations correctly

**Performance Validation:**
- Real-time balance updates don't impact existing transaction processing
- Dashboard queries don't degrade database performance
- Redis cache operations maintain existing memory usage patterns
- Alert processing doesn't interfere with critical financial operations

**Security Validation:**
- Branch access controls properly restrict dashboard visibility
- Notification delivery maintains existing security standards
- Audit trails capture all dashboard access and actions
- API endpoints follow established authentication patterns

## Testing

**Testing Standards from Architecture:**
- Unit tests using xUnit framework following FinancialService patterns
- Integration tests with Redis caching and real-time updates
- API testing with authentication and role-based access validation
- Performance testing to ensure dashboard responsiveness
- Security testing for all branch-level financial operations

**Test Coverage Requirements:**
- Business logic components: >95% coverage
- Caching and real-time updates: >90% coverage
- API controllers and dashboard endpoints: >90% coverage
- Alert system and notifications: >95% coverage
- Error handling and recovery: 100% coverage

## Change Log

| Date       | Version | Description                          | Author    |
| ---------- | ------- | ------------------------------------ | --------- |
| 2025-01-26 | 1.0     | Initial story creation for branch float management and liquidity dashboard | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Developer Agent*

### Debug Log References
*To be populated by Developer Agent*

### Completion Notes List
*To be populated by Developer Agent*

### File List
*To be populated by Developer Agent*

## QA Results

*To be populated by QA Agent*
