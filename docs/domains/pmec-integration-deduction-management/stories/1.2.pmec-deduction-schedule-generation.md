# Story 1.2: PMEC Deduction Schedule Generation and Validation

## Status: Draft

## Story

**As a finance officer,**  
**I want automated monthly PMEC deduction schedule generation,**  
**so that I can efficiently create compliant government payroll deduction files.**

## Acceptance Criteria

1. PMEC deduction schedules are automatically compiled monthly from active government employee loans
2. Government employee data is validated from Client Management (payroll numbers, NRC, ministry)
3. Loan schedule data is extracted from Loan Origination with proper amount calculations
4. PMEC-compliant CSV/TXT files are generated with proper formatting and validation
5. Digital signatures are applied to all generated PMEC files for government compliance
6. File generation is tracked with comprehensive audit trails through AdminService

## Tasks / Subtasks

- [ ] Task 1: Implement PMEC Deduction Schedule Generation (AC: 1)
  - [ ] Create scheduled job for monthly PMEC deduction compilation
  - [ ] Implement government employee loan filtering and aggregation
  - [ ] Build PMEC deduction calculation engine with proper financial precision
  - [ ] Add government data validation and quality checking

- [ ] Task 2: Government Employee Data Validation (AC: 2)
  - [ ] Implement government employee data extraction from Client Management
  - [ ] Add validation for PMEC-specific fields (payroll number, NRC, ministry)
  - [ ] Create government data quality checks and error handling
  - [ ] Build integration with existing government employee verification workflows

- [ ] Task 3: Loan Schedule Data Processing (AC: 3)
  - [ ] Extract loan schedule data from Loan Origination with government filtering
  - [ ] Implement deduction amount calculation with government compliance
  - [ ] Add validation for active government loans and payment schedules
  - [ ] Create government loan status verification and filtering logic

- [ ] Task 4: PMEC File Format Generation (AC: 4)
  - [ ] Create PMEC CSV/TXT file formatter with configurable templates
  - [ ] Implement PMEC-specific field mapping and data transformation
  - [ ] Add file validation against PMEC format specifications
  - [ ] Build government file naming conventions and versioning

- [ ] Task 5: Digital Signature Implementation (AC: 5)
  - [ ] Implement digital signature generation for PMEC files
  - [ ] Add signature validation and integrity checking
  - [ ] Create signature storage and retrieval system for government compliance
  - [ ] Integrate with existing AdminService approval workflows for signing

- [ ] Task 6: Government Audit Trail Integration (AC: 6)
  - [ ] Create comprehensive audit logging for all PMEC deduction generation activities
  - [ ] Implement audit event publishing to AdminService for government operations
  - [ ] Add government file generation tracking and status monitoring
  - [ ] Build audit trail correlation across PMEC operations

- [ ] Task 7: Government File Processing Pipeline (AC: All)
  - [ ] Implement PMEC file generation queue and processing pipeline
  - [ ] Add file generation status tracking and error recovery
  - [ ] Create government file validation and integrity checking
  - [ ] Build integration with MinIO for government document storage

- [ ] Task 8: PMEC Data Validation and Quality Checks (AC: All)
  - [ ] Create comprehensive government data validation for PMEC submissions
  - [ ] Implement PMEC format compliance checking
  - [ ] Add government data quality metrics and monitoring
  - [ ] Build validation error reporting and correction workflows

- [ ] Task 9: Comprehensive Testing Suite (AC: All)
  - [ ] Create unit tests for PMEC deduction calculation algorithms
  - [ ] Test government employee data validation and filtering
  - [ ] Validate PMEC file format generation with various scenarios
  - [ ] Test digital signature generation and validation
  - [ ] Integration testing with Client Management and Loan Origination

## Dev Notes

### Technical Context from Architecture Documents

**Government Data Processing:**
- Process government employee data from Client Management with enhanced validation
- Extract loan schedule information from Loan Origination with government filtering
- Implement PMEC-specific file formatting with configurable templates
- Follow existing government data security patterns for all operations [Source: pmec-brownfield-architecture.md#government-data-integration]

**PMEC File Generation:**
- Generate PMEC-compliant CSV/TXT files with proper government formatting
- Implement digital signatures for all government financial files
- Follow existing file processing patterns from CommunicationsService
- Use MinIO WORM retention for government compliance [Source: pmec-brownfield-architecture.md#file-processing-pipeline]

**Government Audit Integration:**
- Generate comprehensive audit trails for all PMEC deduction activities
- Follow AdminService audit patterns for government financial operations
- Implement structured logging for government compliance monitoring
- Maintain audit correlation across all PMEC operations [Source: pmec-brownfield-architecture.md#admin-service-audit-integration]

**Government Security Implementation:**
- Implement digital signatures for all PMEC financial files
- Use Vault for PMEC credentials and government signing keys
- Add enhanced security for government payroll data processing
- Maintain government compliance audit trails [Source: pmec-brownfield-architecture.md#government-security-implementation]

### File Locations and Implementation Details

**Core PMEC Files:**
- `apps/IntelliFin.PmecService/Services/DeductionScheduleService.cs` - Monthly deduction generation
- `apps/IntelliFin.PmecService/Services/GovernmentEmployeeService.cs` - Employee data validation
- `apps/IntelliFin.PmecService/Services/PmcFileGenerator.cs` - PMEC file formatting
- `apps/IntelliFin.PmecService/Services/DigitalSignatureService.cs` - File signing and validation

**Government Integration:**
- `apps/IntelliFin.PmecService/Consumers/GovernmentEmployeeConsumer.cs` - Employee data updates
- `apps/IntelliFin.PmecService/Consumers/LoanScheduleConsumer.cs` - Loan schedule updates
- `apps/IntelliFin.PmecService/Infrastructure/Audit/GovernmentAuditPublisher.cs` - Audit trail integration

**Government Data Models:**
- `apps/IntelliFin.PmecService/Models/PmcDeduction.cs` - Deduction schedule records
- `apps/IntelliFin.PmecService/Models/GovernmentEmployee.cs` - Enhanced employee data
- `apps/IntelliFin.PmecService/Models/PmcFile.cs` - PMEC file generation tracking
- `apps/IntelliFin.PmecService/Models/DigitalSignature.cs` - Government file signatures

**Government Processing:**
- `apps/IntelliFin.PmecService/Infrastructure/GovernmentProcessing/ScheduleGenerator.cs` - Monthly processing
- `apps/IntelliFin.PmecService/Infrastructure/GovernmentProcessing/FileValidator.cs` - PMEC format validation

### Testing Requirements

**Unit Testing Standards:**
- Test government deduction calculation algorithms with precision validation
- Validate PMEC file format generation with various government scenarios
- Test government employee data filtering and validation logic
- Verify digital signature generation and validation for government files
- Test audit event generation and government compliance formatting [Source: pmec-brownfield-architecture.md#testing-standards]

**Integration Testing:**
- Test government employee data extraction from Client Management
- Validate loan schedule processing with Loan Origination integration
- Test PMEC file generation with various government employee scenarios
- Verify audit trail integration with AdminService for government operations
- Government compliance testing for all deduction processing

**Government Data Testing:**
- Test PMEC file format compliance with government specifications
- Validate government employee data quality and completeness
- Test digital signature integrity for government financial files
- Verify government audit trail completeness and compliance

**Performance Testing:**
- Load testing for monthly government deduction generation
- Government employee data processing performance validation
- PMEC file generation performance with large government datasets
- Database query optimization for government reconciliation operations

### Technical Constraints and Integration Notes

**Government Data Quality:**
- Government employee data from Client Management must be validated for PMEC submission
- PMEC-specific fields (payroll number, ministry) must be complete and accurate
- Loan schedule data must be current and properly formatted
- Government data validation must prevent submission errors

**PMEC Format Compliance:**
- Generated files must strictly comply with PMEC CSV/TXT format specifications
- Field mapping must be configurable for PMEC format changes
- Digital signatures must be applied to all government financial files
- File validation must ensure government compliance before submission

**Government Audit Requirements:**
- Every PMEC deduction generation must be fully audited
- Audit trails must capture government employee data access
- File generation and signing must be traceable for compliance
- Government compliance reporting must include PMEC operations

**Performance Considerations:**
- Monthly processing must handle large government employee datasets efficiently
- Government file generation must complete within compliance timeframes
- Database queries must be optimized for government data operations
- Memory usage must align with existing government service patterns

### Integration Verification Points

**Existing Government System Integrity:**
- Client Management government employee data operations continue without disruption
- Loan Origination government workflows complete successfully with PMEC integration
- AdminService government audit trails capture PMEC file generation activities
- Collections government loan processing continues without interruption
- Treasury government reconciliation patterns remain unaffected

**Government Data Validation:**
- PMEC deduction calculations are accurate and government-compliant
- Government employee data validation prevents submission errors
- PMEC file format meets government specifications
- Digital signatures validate correctly for all government files

**Government Compliance Validation:**
- All PMEC operations generate proper audit trails for government examination
- Government data handling meets BoZ compliance requirements
- Digital signatures maintain integrity for government financial files
- PMEC file generation follows established government security patterns

## Testing

**Testing Standards from Architecture:**
- Unit tests using xUnit framework following FinancialService government patterns
- Integration tests with government data validation and PMEC file generation
- API testing with comprehensive government data validation
- Performance testing for government deduction processing
- Government security testing for all file operations and audit trails

**Test Coverage Requirements:**
- Government business logic components: >95% coverage
- Government data validation and filtering: >95% coverage
- PMEC file generation and formatting: >90% coverage
- Government digital signature and security: 100% coverage
- Government error handling and data validation: 100% coverage

## Change Log

| Date       | Version | Description                          | Author    |
| ---------- | ------- | ------------------------------------ | --------- |
| 2025-01-27 | 1.0     | Initial story creation for PMEC deduction schedule generation | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Developer Agent*

### Debug Log References
*To be populated by Developer Agent*

### Completion Notes List
*To be populated by Developer Agent*

### File List
*To be populated by Developer Agent*

## QA Results

*To be populated by QA Agent*
