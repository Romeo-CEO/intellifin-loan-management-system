# Story 1.1: PMECService Core Integration and Government Data Setup

## Status: Draft

## Story

**As a system administrator,**  
**I want the PMECService microservice to be properly integrated with the existing IntelliFin government architecture,**  
**so that it can safely handle government payroll data without disrupting existing services.**

## Acceptance Criteria

1. PMECService microservice is created and deployed following existing .NET 9 patterns for government operations
2. Database schema is created with Entity Framework migrations extending existing government data patterns
3. Basic service-to-service communication is established with Client Management and Loan Origination
4. Government data security is integrated with existing Vault and audit infrastructure
5. Service integrates with existing API Gateway routing and government authentication patterns

## Tasks / Subtasks

- [ ] Task 1: Create PMECService Project Structure (AC: 1)
  - [ ] Create new .NET 9 microservice project following IntelliFin government patterns
  - [ ] Set up project file with proper dependencies and government configurations
  - [ ] Configure logging, health checks, and government monitoring integration
  - [ ] Add Docker configuration following existing government service patterns

- [ ] Task 2: Implement Government Database Schema and Entity Framework Setup (AC: 2)
  - [ ] Create PmecDbContext extending existing Entity Framework patterns for government data
  - [ ] Define PMEC-specific government entities (PmcDeduction, GovernmentEmployee, etc.)
  - [ ] Create Entity Framework migrations for government data schema
  - [ ] Implement repository patterns following FinancialService government examples
  - [ ] Add government database connection configuration with existing patterns

- [ ] Task 3: Establish Government Service-to-Service Communication (AC: 3)
  - [ ] Implement event consumers for government loan schedule updates from Loan Origination
  - [ ] Set up RabbitMQ event publishing following ClientManagement government patterns
  - [ ] Create service discovery registration with existing government infrastructure
  - [ ] Implement circuit breakers for government service dependencies

- [ ] Task 4: Integrate Government Security and Audit Infrastructure (AC: 4)
  - [ ] Set up Vault integration for PMEC government credentials following AdminService patterns
  - [ ] Implement mTLS client configuration for secure government API communication
  - [ ] Create audit event publishing to AdminService for government operations
  - [ ] Add government data security middleware and validation

- [ ] Task 5: API Gateway and Government Authentication Integration (AC: 5)
  - [ ] Create REST API controllers following ClientManagement government patterns
  - [ ] Implement government authentication middleware consistent with existing services
  - [ ] Add API documentation with Swagger following established government patterns
  - [ ] Configure government routing and rate limiting through existing API Gateway

- [ ] Task 6: Add Comprehensive Unit Tests (AC: All)
  - [ ] Create unit tests for all PMECService government components
  - [ ] Test Entity Framework repository implementations for government data
  - [ ] Validate event publishing and government consumption logic
  - [ ] Test government health check endpoints and monitoring integration

## Dev Notes

### Technical Context from Architecture Documents

**Government Project Structure Integration:**
- Follow existing .NET 9 microservice patterns from FinancialService and AdminService for government operations
- Place PMECService in `apps/IntelliFin.PmecService/` directory structure
- Use Entity Framework Core patterns consistent with existing government services [Source: pmec-brownfield-architecture.md#source-tree-and-module-organization]

**Government Database Integration:**
- Extend existing SQL Server database schema using Entity Framework migrations for government data
- Follow established government migration patterns from existing services
- Implement government connection pooling and retry patterns from current infrastructure
- Use existing government database backup and recovery procedures [Source: pmec-brownfield-architecture.md#integration-points-and-service-dependencies]

**Government Service Communication:**
- Use RabbitMQ event-driven architecture following ClientManagement government patterns
- Implement MassTransit consumers for government service integration
- Follow government event ordering and deduplication patterns from existing services
- Use existing government circuit breaker implementations for resilience [Source: pmec-brownfield-architecture.md#event-driven-architecture]

**Government Security Integration:**
- Implement mTLS for all government API communications
- Use Vault for government credentials following AdminService patterns
- Add enhanced security for government payroll data processing
- Implement comprehensive audit logging with government compliance [Source: pmec-brownfield-architecture.md#government-security-implementation]

### File Locations and Implementation Details

**Core Service Files:**
- `apps/IntelliFin.PmecService/Program.cs` - Main government application entry point
- `apps/IntelliFin.PmecService/Services/PmecService.cs` - Core government PMEC logic
- `apps/IntelliFin.PmecService/Infrastructure/Persistence/PmecDbContext.cs` - Government database context
- `apps/IntelliFin.PmecService/Infrastructure/Persistence/Repositories/` - Government repository implementations
- `apps/IntelliFin.PmecService/Controllers/PmecController.cs` - Government API endpoints

**Government Integration Files:**
- `apps/IntelliFin.PmecService/Consumers/ClientUpdateConsumer.cs` - Government employee data consumer
- `apps/IntelliFin.PmecService/Infrastructure/HealthChecks/` - Government service health monitoring
- `apps/IntelliFin.PmecService/Infrastructure/Security/` - Government security middleware

**Government Data Models:**
- `apps/IntelliFin.PmecService/Models/GovernmentEmployee.cs` - Enhanced employee data for PMEC
- `apps/IntelliFin.PmecService/Models/PmcDeduction.cs` - PMEC deduction records
- `apps/IntelliFin.PmecService/Models/AuditEvent.cs` - Government audit events

### Testing Requirements

**Unit Testing Standards:**
- Test government financial calculations with precision validation
- Mock external government APIs using established patterns
- Test government data validation and integrity checking
- Validate government event publishing and consumption
- Test government audit event generation and formatting [Source: pmec-brownfield-architecture.md#testing-standards]

**Integration Testing:**
- Test government database operations with Entity Framework patterns
- Validate RabbitMQ government event publishing and consumption
- Test government API endpoints with authentication and authorization
- Verify government health check integration with monitoring systems
- Government security testing for all endpoints and data access

**Government Compliance Testing:**
- Test government data security and access controls
- Validate audit trail generation for government operations
- Test government authentication and authorization patterns
- Verify government compliance with BoZ requirements

**Performance Testing:**
- Load testing for government employee data processing
- Database query performance validation for PMEC operations
- Event processing throughput testing for government workflows
- Memory usage validation for government data operations

### Technical Constraints and Integration Notes

**Government Data Handling:**
- All government employee data must follow enhanced security patterns
- PMEC-specific fields must integrate with existing Client Management structures
- Government data validation must ensure PMEC submission accuracy
- Audit trails must capture all government data access and modifications

**Government Security Requirements:**
- All government API endpoints must use mTLS authentication
- Government database connections must use enhanced security patterns
- Government authentication must integrate with IdentityService patterns
- Government audit logging must follow AdminService comprehensive patterns

**Government Integration Safety:**
- PMEC integration must not disrupt existing government employee data operations
- Loan Origination government workflows must continue without interruption
- Collections government loan processing must remain functional
- AdminService government audit trails must be enhanced, not disrupted

### Integration Verification Points

**Existing Government System Integrity:**
- Client Management government employee data operations continue without disruption
- Loan Origination government workflows complete successfully without PMEC integration
- AdminService government audit trails remain fully functional
- Collections government loan processing continues without interruption
- Treasury government reconciliation patterns remain unaffected

**Government Performance Validation:**
- Government database query performance meets existing benchmarks
- Government event processing doesn't introduce delays in existing workflows
- Government balance updates are sub-second as required
- Government memory usage aligns with existing service patterns

## Testing

**Testing Standards from Architecture:**
- Unit tests using xUnit framework following FinancialService government patterns
- Integration tests with Entity Framework and government data validation
- Government API testing with enhanced security and authentication validation
- Performance testing to ensure no impact on existing government operations
- Government security testing for all endpoints and data access patterns

**Test Coverage Requirements:**
- Government business logic components: >95% coverage
- Government event processing and consumers: >95% coverage
- Government API controllers and validation: >90% coverage
- Government error handling and recovery: 100% coverage
- Government security and authorization: 100% coverage

## Change Log

| Date       | Version | Description                          | Author    |
| ---------- | ------- | ------------------------------------ | --------- |
| 2025-01-27 | 1.0     | Initial story creation for PMECService core integration | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Developer Agent*

### Debug Log References
*To be populated by Developer Agent*

### Completion Notes List
*To be populated by Developer Agent*

### File List
*To be populated by Developer Agent*

## QA Results

*To be populated by QA Agent*
