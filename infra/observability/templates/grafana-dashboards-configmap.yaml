{{- if and .Values.kubePrometheusStack.enabled .Values.kubePrometheusStack.grafana.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "observability.fullname" . }}-grafana-dashboards
  labels:
    {{- include "observability.monitoring.labels" . | nindent 4 }}
    grafana_dashboard: "1"
  annotations:
    grafana-folder: IntelliFin
    grafana-folder-uid: intellifin-default
    dashboard-provider: intellifin
    dashboard-provider-folder: IntelliFin
    grafana_folder: IntelliFin
  namespace: {{ .Release.Namespace }}
data:
  kubernetes-cluster-overview.json: |
    {
      "id": null,
      "uid": "intellifin-k8s-overview",
      "title": "Kubernetes Cluster Overview",
      "schemaVersion": 39,
      "version": 1,
      "timezone": "",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "refresh": "15s",
      "panels": [
        {
          "type": "timeseries",
          "title": "Node CPU Utilization",
          "id": 1,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "instance:node_cpu_utilisation:rate5m",
              "legendFormat": "{{instance}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 1
            }
          },
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "bottom"
            }
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Node Memory Utilization",
          "id": 2,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes",
              "legendFormat": "{{instance}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "percent",
              "min": 0,
              "max": 1
            }
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          }
        },
        {
          "type": "stat",
          "title": "Pods Not Ready",
          "id": 3,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(kube_pod_status_phase{phase=\"Pending\"}) + sum(kube_pod_status_phase{phase=\"Failed\"})"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "none"
            }
          },
          "gridPos": {
            "h": 6,
            "w": 6,
            "x": 0,
            "y": 8
          }
        },
        {
          "type": "timeseries",
          "title": "Cluster Network Throughput",
          "id": 4,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(container_network_receive_bytes_total[5m]))",
              "legendFormat": "RX"
            },
            {
              "refId": "B",
              "expr": "sum(rate(container_network_transmit_bytes_total[5m]))",
              "legendFormat": "TX"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "Bps"
            }
          },
          "gridPos": {
            "h": 6,
            "w": 18,
            "x": 6,
            "y": 8
          }
        }
      ]
    }
  service-health-overview.json: |
    {
      "id": null,
      "uid": "intellifin-service-health",
      "title": "Service Health Dashboard",
      "schemaVersion": 39,
      "version": 1,
      "timezone": "",
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "refresh": "15s",
      "panels": [
        {
          "type": "timeseries",
          "title": "Request Rate",
          "id": 5,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(http_server_duration_seconds_count{service=~\"intellifin-.*\"}[5m])) by (service)",
              "legendFormat": "{{service}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "req/s"
            }
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Error Rate",
          "id": 6,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(http_server_duration_seconds_count{service=~\"intellifin-.*\", http_status_code=~\"5..\"}[5m])) by (service)",
              "legendFormat": "{{service}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "req/s"
            }
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          }
        },
        {
          "type": "stat",
          "title": "Latency p95",
          "id": 7,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum(rate(http_server_duration_seconds_bucket{service=~\"intellifin-.*\"}[5m])) by (le, service))"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s"
            }
          },
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 0,
            "y": 8
          }
        },
        {
          "type": "stat",
          "title": "Latency p99",
          "id": 8,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.99, sum(rate(http_server_duration_seconds_bucket{service=~\"intellifin-.*\"}[5m])) by (le, service))"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s"
            }
          },
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 12,
            "y": 8
          }
        }
      ]
    }
  database-performance.json: |
    {
      "id": null,
      "uid": "intellifin-db-performance",
      "title": "Database Performance",
      "schemaVersion": 39,
      "version": 1,
      "timezone": "",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "refresh": "30s",
      "panels": [
        {
          "type": "timeseries",
          "title": "SQL Query Duration p95",
          "id": 9,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "histogram_quantile(0.95, sum(rate(sql_client_duration_seconds_bucket{service=~\"intellifin-.*\"}[5m])) by (le, service))",
              "legendFormat": "{{service}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s"
            }
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Active Connections",
          "id": 10,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(sql_client_pool_open_connections{service=~\"intellifin-.*\"}) by (service)",
              "legendFormat": "{{service}}"
            }
          ],
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          }
        },
        {
          "type": "stat",
          "title": "Deadlocks per Minute",
          "id": 11,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(sql_server_deadlocks_total[5m]))"
            }
          ],
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 0,
            "y": 8
          }
        },
        {
          "type": "timeseries",
          "title": "Average Command Duration",
          "id": 12,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(sql_client_duration_seconds_sum{service=~\"intellifin-.*\"}[5m])) by (service) / sum(rate(sql_client_duration_seconds_count{service=~\"intellifin-.*\"}[5m])) by (service)",
              "legendFormat": "{{service}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s"
            }
          },
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 12,
            "y": 8
          }
        }
      ]
    }
  rabbitmq-monitoring.json: |
    {
      "id": null,
      "uid": "intellifin-rabbitmq",
      "title": "RabbitMQ Monitoring",
      "schemaVersion": 39,
      "version": 1,
      "timezone": "",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "refresh": "30s",
      "panels": [
        {
          "type": "timeseries",
          "title": "Queue Depth",
          "id": 13,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rabbitmq_queue_messages_ready) by (queue)",
              "legendFormat": "{{queue}}"
            }
          ],
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Message Rate",
          "id": 14,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(rabbitmq_queue_messages_published_total[5m])) by (queue)",
              "legendFormat": "Published {{queue}}"
            },
            {
              "refId": "B",
              "expr": "sum(rate(rabbitmq_queue_messages_delivered_total[5m])) by (queue)",
              "legendFormat": "Delivered {{queue}}"
            }
          ],
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          }
        },
        {
          "type": "stat",
          "title": "Consumer Lag",
          "id": 15,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rabbitmq_queue_messages_ready - rabbitmq_queue_messages_unacknowledged)"
            }
          ],
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 0,
            "y": 8
          }
        },
        {
          "type": "timeseries",
          "title": "Connection Count",
          "id": 16,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rabbitmq_connections)",
              "legendFormat": "Connections"
            }
          ],
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 12,
            "y": 8
          }
        }
      ]
    }
  keycloak-metrics.json: |
    {
      "id": null,
      "uid": "intellifin-keycloak",
      "title": "Keycloak Metrics",
      "schemaVersion": 39,
      "version": 1,
      "timezone": "",
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "refresh": "30s",
      "panels": [
        {
          "type": "timeseries",
          "title": "Authentication Rate",
          "id": 17,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(keycloak_authentication_requests_total[5m])) by (realm)",
              "legendFormat": "{{realm}}"
            }
          ],
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "timeseries",
          "title": "Token Issuance",
          "id": 18,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(keycloak_client_registrations_total{outcome=\"success\"}[5m])) by (client_id)",
              "legendFormat": "{{client_id}}"
            }
          ],
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 0
          }
        },
        {
          "type": "stat",
          "title": "Active Sessions",
          "id": 19,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(keycloak_sessions_active)",
              "legendFormat": "Active Sessions"
            }
          ],
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 0,
            "y": 8
          }
        },
        {
          "type": "timeseries",
          "title": "Login Errors",
          "id": 20,
          "datasource": {
            "type": "prometheus",
            "uid": "Prometheus"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "sum(rate(keycloak_authentication_requests_total{outcome=\"failed\"}[5m])) by (realm)",
              "legendFormat": "{{realm}}"
            }
          ],
          "gridPos": {
            "h": 6,
            "w": 12,
            "x": 12,
            "y": 8
          }
        }
      ]
    }
  logging-overview.json: |
    {
      "id": null,
      "uid": "intellifin-logging-overview",
      "title": "Centralized Logging Overview",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "30s",
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "panels": [
        {
          "type": "logs",
          "title": "Error Logs Across Services",
          "id": 100,
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "{namespace=\\\"intellifin\\\"} |= \\\"error\\\" | json"
            }
          ],
          "gridPos": {
            "h": 9,
            "w": 24,
            "x": 0,
            "y": 0
          }
        },
        {
          "type": "logs",
          "title": "Audit Events by Correlation Id",
          "id": 101,
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "{namespace=\\\"admin\\\"} | json | CorrelationId=\\\"$correlationId\\\"",
              "queryType": "range"
            }
          ],
          "gridPos": {
            "h": 9,
            "w": 12,
            "x": 0,
            "y": 9
          }
        },
        {
          "type": "logs",
          "title": "High Latency API Gateway Requests",
          "id": 102,
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "{service_name=\\\"api-gateway\\\"} | json | latency_ms > 1000"
            }
          ],
          "gridPos": {
            "h": 9,
            "w": 12,
            "x": 12,
            "y": 9
          }
        },
        {
          "type": "logs",
          "title": "Failed Authentication Attempts",
          "id": 103,
          "datasource": {
            "type": "loki",
            "uid": "loki"
          },
          "targets": [
            {
              "refId": "A",
              "expr": "{service_name=\\\"keycloak\\\"} |= \\\"authentication failed\\\" | json | line_format \\\"{{.username}} from {{.ip}}\\\""
            }
          ],
          "gridPos": {
            "h": 9,
            "w": 24,
            "x": 0,
            "y": 18
          }
        }
      ],
      "templating": {
        "list": [
          {
            "name": "correlationId",
            "type": "textbox",
            "label": "Correlation Id",
            "query": "",
            "current": {
              "text": "",
              "value": ""
            }
          }
        ]
      }
    }
{{- end }}
